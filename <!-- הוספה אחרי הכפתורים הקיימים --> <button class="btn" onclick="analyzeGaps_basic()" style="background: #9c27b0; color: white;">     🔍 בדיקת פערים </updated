    

<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×©×‘×•×Ÿ ××™×œ×•××™× ××ª×§×“× - ×’×¨×¡×” 2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .upload-section {
            padding: 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-card {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .upload-card.uploaded {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .upload-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .upload-card p {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .upload-btn.success {
            background: #27ae60;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .filters {
            padding: 30px 40px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .filter-group input, .filter-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .results-section {
            padding: 40px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .results-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: #34495e;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #e3f2fd;
        }

      .new-miluim {
            background: #e1f5fe !important;
            border-right: 4px solid #03a9f4;
        }
        .emergency-cluster {
            background: #fff3e0 !important;
            border-right: 4px solid #ff9800;
        }

        .alternative-calc {
            color: #e74c3c;
            font-weight: bold;
        }

        .locked-value {
            background: #ffebee !important;
            color: #c62828;
            font-weight: bold;
        }

        .details-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .details-btn:hover {
            background: #2980b9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .error {
            background: #ffe6e6;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-right: 4px solid #e74c3c;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-right: 4px solid #4caf50;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
 }
            .amount-difference {
                font-weight: bold;
            }
            
            .positive-diff {
                color: #2e7d32; 
            }
            
            .negative-diff {
                color: #c62828; 
            }        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            left: 20px;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .calculation-step {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-right: 4px solid #3498db;
        }

        .step-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .step-detail {
            color: #555;
            line-height: 1.6;
        }

        .export-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .export-btn:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .sheet-status {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sheet-status span {
            padding: 5px 10px;
            border-radius: 15px;
            background: #f0f0f0;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .sheet-loaded {
            background: #d5f4e6 !important;
            color: #2e7d32;
        }
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .upload-section, .filters, .results-section {
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            table {
                font-size: 0.8em;
            }
            
            th, td {
                padding: 8px 5px;
            }
        }
/* ğŸ†• ×¢×™×¦×•×‘ ×œ×›×¤×ª×•×¨ ×”×™×™×¦×•× */
.analysis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.analysis-buttons {
    display: flex;
    gap: 10px;
}
/* ×¨×§×¢ ×©×§×•×£ - ×—×™×•× ×™ ×œ×—×œ×•×Ÿ! */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-btn:hover {
    background: rgba(255,255,255,0.2);
}

.analysis-header h2 {
    margin: 0;
    font-size: 1.5em;
}
/* ×¢×™×¦×•×‘ ×—×œ×•×Ÿ ×× ×œ×™×–×” */
.analysis-window {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 1000px;
    height: 80%;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1001;
    display: none;
    overflow: hidden;
}

.analysis-header {
    background: linear-gradient(45deg, #9c27b0, #673ab7);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.analysis-content {
    padding: 20px;
    height: calc(100% - 80px);
    overflow-y: auto;
}

.analysis-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.summary-stat {
    text-align: center;
    padding: 10px;
    background: white;
    border-radius: 5px;
}

.category-box {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    overflow: hidden;
}

.category-header {
    padding: 15px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.category-ok { background: #e8f5e8; border-color: #4caf50; }
.category-fix { background: #ffebee; border-color: #f44336; }
.category-check { background: #fff3e0; border-color: #ff9800; }

.category-content {
    padding: 15px;
    display: none;
    background: #fafafa;
    max-height: 300px;
    overflow-y: auto;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ–ï¸ ××—×©×‘×•×Ÿ ××™×œ×•××™× ××ª×§×“×</h1>
            <p>×’×¨×¡×” 2.0 - ×—×™×©×•×‘ ××“×•×™×§ ×©×œ ×ª×’××•×œ×™ ××™×œ×•××™× ×œ×¤×™ ×”×ª×§× ×•×ª ×”×™×©×¨××œ×™×•×ª</p>
        </div>
        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-grid">
                <div class="upload-card" onclick="document.getElementById('excelFile').click()" style="grid-column: 1 / -1;">
                    <h3>ğŸ“Š ×§×•×‘×¥ ××§×¡×œ ×¢× 3 ×’×œ×™×•× ×•×ª</h3>
                    <p>×’×œ×™×•×Ÿ 1: ××™×œ×•××™× (90291) | ×’×œ×™×•×Ÿ 2: ×©×›×¨ (94010) | ×’×œ×™×•×Ÿ 3: × ×•×›×—×•×ª (1857)</p>
                    <button class="upload-btn" id="excelBtn">×‘×—×¨ ×§×•×‘×¥ ××§×¡×œ</button>
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls">
                    <div id="sheetsStatus" style="margin-top: 15px; display: none;">
                        <div class="sheet-status">
                            <span id="sheet1Status">ğŸ“Š ×’×œ×™×•×Ÿ ××™×œ×•××™×: âŒ</span>
                            <span id="sheet2Status">ğŸ’° ×’×œ×™×•×Ÿ ×©×›×¨: âŒ</span>
                            <span id="sheet3Status">ğŸ“… ×’×œ×™×•×Ÿ × ×•×›×—×•×ª: âŒ</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" id="calculateBtn" disabled>ğŸ§® ×—×©×‘ ××™×œ×•××™×</button>
                <button class="btn" id="clearBtn">ğŸ—‘ï¸ × ×§×” ×”×›×œ</button>
<!-- ×”×•×¡×¤×” ××—×¨×™ ×”×›×¤×ª×•×¨×™× ×”×§×™×™××™× -->
<button class="btn" onclick="analyzeGaps_basic()" style="background: #9c27b0; color: white;">
    ğŸ” ×‘×“×™×§×ª ×¤×¢×¨×™×
</button>
                <button class="btn" id="singleEmployeeBtn" style="background: linear-gradient(45deg, #8e44ad, #9b59b6); display: none;" onclick="showEmployeeSelector()">
    ğŸ‘¤ ×—×™×©×•×‘ ×œ×¢×•×‘×“ ×‘×•×“×“
</button>
<!-- ×”×§×œ×“×ª ××¡×¤×¨ ×¢×•×‘×“ -->
<div id="employeeSelectorDiv" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
    <label for="employeeInput" style="margin-left: 10px; font-weight: bold;">×”×§×œ×“ ××¡×¤×¨ ×¢×•×‘×“:</label>
    <input type="text" 
           id="employeeInput" 
           placeholder="×œ×“×•×’××”: 12345" 
           style="padding: 8px; margin-left: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; width: 150px;">
  <button class="btn" id="calculateSingleBtn" style="background: #27ae60;" onclick="const emp = document.getElementById('employeeInput').value.trim(); if(emp) calculateMiluim({employeeIds: [emp], addEmployeeHeader: true, batchSize: 0}); else alert('Ã©Ã¹ Ã¬Ã¤Ã¦Ã©Ã¯ Ã®Ã±Ã´Ã¸ Ã²Ã¥Ã¡Ã£');" disabled>
  ğŸ¯ ×—×©×‘
    <span id="employeeValidation" style="margin-right: 10px; color: #e74c3c;"></span>
</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ” ××¡× × ×™ ×ª×¦×•×’×”</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="employeeFilter">××¡×¤×¨ ×¢×•×‘×“:</label>
                    <input type="text" id="employeeFilter" placeholder="×”×–×Ÿ ××¡×¤×¨ ×–×”×•×ª (××• ×—×œ×§ ××× ×•)">
                </div>
                <div class="filter-group">
                    <label for="yearFilter">×©× ×”:</label>
                    <select id="yearFilter">
                        <option value="">×›×œ ×”×©× ×™×</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="miluimTypeFilter">×¡×•×’ ××™×œ×•××™×:</label>
                    <select id="miluimTypeFilter">
                        <option value="">×›×œ ×”×¡×•×’×™×</option>
                        <option value="regular">×¨×’×™×œ×™× (×œ×¤× ×™ 07.10.2023)</option>
                        <option value="emergency">×—×™×¨×•× (07.10.2023 - 30.04.2025)</option>
                        <option value="new">×—×“×©×™× (×-01.05.2025)</option>
                        <option value="locked">× ×¢×•×œ×™× (×¢×¨×š ××•×’×‘×œ)</option>
                        <option value="gap">×¢× ×¤×¢×¨ (×”×¤×¨×© ×‘×ª×©×œ×•×)</option>
                         <option value="crossMonth">××™×œ×•××™× ×’×•×œ×©×™×</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn" onclick="clearFilters()" style="margin-top: 25px; background: #95a5a6;">ğŸ—‘ï¸ × ×§×” ×¡×™× ×•×Ÿ</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div id="summaryStats" class="summary-stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalEmployees">0</div>
                    <div class="stat-label">×¢×•×‘×“×™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPeriods">0</div>
                    <div class="stat-label">×ª×§×•×¤×•×ª ××™×œ×•××™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDays">0</div>
                    <div class="stat-label">×™××™ ××™×œ×•××™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPayment">â‚ª0</div>
                    <div class="stat-label">×¡×”"×› ×ª×©×œ×•×</div>
                </div>
            </div>

            <div id="resultsContainer">
                <div class="loading" id="loadingMessage" style="display: none;">
                    ğŸ”„ ××¢×‘×“ × ×ª×•× ×™×...
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section" id="exportSection" style="display: none;">
            <button class="export-btn" id="exportBtn">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
        </div>
    </div>

    <!-- Modal for detailed calculations -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="detailsContent"></div>
        </div>
    </div>

    <script>
        // Global variables
        let miluimData = [];
        let salaryData = [];
        let attendanceData = [];
        let calculationResults = [];
        let filteredResults = [];
        // ××©×ª× ×™× ×œ×©××™×¨×ª ×”× ×ª×•× ×™× ×”××§×•×¨×™×™×
        let originalMiluimData = [];
        let originalSalaryData = [];
        let originalAttendanceData = []; 
        let showCrossMonthOnly =[] ; 
        let currentDisplayData = [];
        let currentDisplayOptions = {};
       

        // Constants
        const EMERGENCY_START = new Date('2023-10-07');
        //××¢×¨×›×ª CACHE
class MiluimCalculatorCache {
    constructor() {
        this.cache = new Map();
        this.sortedMiluim = null;
        
        console.log('âœ“âœ“âœ“ ××¢×¨×›×ª CACHE ×”×•×¤×¢×œ×”');
    }

    createKey(employeeId, serviceStartDate) {
        return `${employeeId}_${serviceStartDate.toISOString().split('T')[0]}`;
    }

    prepareData() {
       // ×”××¨×” ×œ×¤×•×¨××˜ ××—×™×“ ×¢× ×ª××¨×™×›×™× ××¢×•×‘×“×™×
        const processedMiluim = miluimData.map(m => ({
            employeeId: m.employeeId,
            startDate: parseExcelDate(m.startDate),
            endDate: parseExcelDate(m.endDate),
            miluimDays: m.miluimDays
        })).filter(m => m.startDate && m.endDate);

        // ××™×•×Ÿ ×›×¨×•× ×•×œ×•×’×™ - ×”×›×™ ×—×©×•×‘!
        this.sortedMiluim = processedMiluim.sort((a, b) => a.startDate - b.startDate);
        
        console.log(`? Ã¤Ã¥Ã«Ã¯ CACHE Ã²Ã­ ${this.sortedMiluim.length} Ã®Ã©Ã¬Ã¥Ã Ã©Ã­`);
    }

    calculateWithCache(employeeId, serviceStartDate) {
        const key = this.createKey(employeeId, serviceStartDate);
        
              // ×‘×“×™×§×” ×‘××˜××•×Ÿ
        if (this.cache.has(key)) {
            console.log(`? CACHE HIT: ${key}`);
            return this.cache.get(key);
        }

        console.log(`ğŸ”„ ×—×™×©×•×‘ ×—×“×©: ${key}`);
        
       // ×—×™×©×•×‘ ×¨×’×™×œ ×¢× ×”×¤×•× ×§×¦×™×•×ª ×”×§×™×™××•×ª ×©×œ×š
        const result = this.performOriginalCalculation(employeeId, serviceStartDate);
        
         // ×©××™×¨×” ×‘××˜××•×Ÿ
        this.cache.set(key, result);
        
        return result;
    }

  performOriginalCalculation(employeeId, serviceStartDate) {
     // ğŸ”¥ ×›××Ÿ × ×©×ª××© ×‘×¤×•× ×§×¦×™×•×ª ×”×§×™×™××•×ª ×©×œ×š ×‘×“×™×•×§ ×›××• ×©×”×Ÿ
    const basicResult = calculateBasicDailyValue(employeeId, serviceStartDate);
    const recommendedValue = calculateRecommendedValue(employeeId, serviceStartDate, basicResult.dailyValue);
    
    const allEmployeeRecords = miluimData
        .filter(m => m.employeeId == employeeId)
        .map(m => ({
            startDate: m.startDate,
            endDate: m.endDate
        }));
    
    const isNewMiluim = IsNewMiluim(employeeId, serviceStartDate, allEmployeeRecords);
    
    // ××¦×™××ª ×”× ×ª×•× ×™× ×”××§×•×¨×™×™× ××”××§×¡×œ
    const continuousResult = calculateContinuousValue(employeeId, serviceStartDate, recommendedValue, isNewMiluim);
    const emergencyValues = calculateEmergencyValues(employeeId, serviceStartDate, continuousResult.value);
    
    const originalMiluim = miluimData.find(m =>
        m.employeeId == employeeId && 
        parseExcelDate(m.startDate).getTime() === serviceStartDate.getTime()
    );

    return {
        employeeId,
        startDate: serviceStartDate,
        basicValue: basicResult.dailyValue,
        recommendedValue,
        continuousValue: continuousResult.value,
        isValueLocked: continuousResult.isLocked,
        emergencyValue: emergencyValues.emergencyValue,
        maxEmergencyValue: emergencyValues.maxEmergencyValue,
        emergencyClusterStart: emergencyValues.emergencyClusterStart,
        calculationType: basicResult.calculationType,
        paidAmount: originalMiluim ? originalMiluim.paidAmount : 0,
        isNewMiluim: isNewMiluim,
        compulsion: originalMiluim ? originalMiluim.compulsion || 0 : 0,
        compulsionContinuous: 0 ,
        emergencyCompulsion4405: originalMiluim ? originalMiluim.emergencyCompulsion4405 || 0 : 0 
    };
}
    getStats() {
        return {
            cacheSize: this.cache.size,
            totalCalculated: this.sortedMiluim ? this.sortedMiluim.length : 0,
            hitRate: this.sortedMiluim ? 
                ((this.sortedMiluim.length - this.cache.size) / this.sortedMiluim.length * 100).toFixed(1) + '%' : '0%'
        };
    }
}

// Ã©Ã¶Ã©Ã¸Ãº instance Ã¢Ã¬Ã¥Ã¡Ã¬Ã©
const cacheSystem = new MiluimCalculatorCache();
        const NEW_MILUIM_START = new Date('2025-05-01');
       const PREV_SERVICE_CHECK_DATE = new Date('2025-04-30');
       //const PREV_SERVICE_CHECK_DATE = new Date(2025, 3, 30, 0, 0, 0);
       //const PREV_SERVICE_CHECK_DATE = new Date(excelEpoch.getTime() + (45777 - 1) * 24 * 60 * 60 * 1000);

     function IsNewMiluim(employeeId, serviceStartDate, allEmployeeRecords) {
    // ×ª× ××™ 1: ×”×©×™×¨×•×ª ×—×™×™×‘ ×œ×”×™×•×ª >= 01.05.2025
    if (serviceStartDate < NEW_MILUIM_START) {
        return false;
    }
    
    const sortedRecords = allEmployeeRecords
        .map(record => ({
            start: parseExcelDate(record.startDate),
            end: parseExcelDate(record.endDate)
        }))
        .filter(record => record.start && record.end)
        .sort((a, b) => a.start - b.start);
    
    const currentIndex = sortedRecords.findIndex(record => 
        record.start.getTime() === serviceStartDate.getTime()
    );
    
    if (currentIndex === -1) return false;
    
    // ×‘×“×™×§×” ××—×•×¨×” - ×”×× ×™×© ×¨×¦×£ ×¨×¦×™×£ (×¤×¢×¨ <= 1 ×™×•×)
    for (let i = currentIndex - 1; i >= 0; i--) {
        const current = sortedRecords[i + 1];
        const prev = sortedRecords[i];
        
        const gapDays = (current.start - prev.end) / (1000 * 60 * 60 * 24);
        
        if (gapDays > 1) {
            return true; // ×¤×¢×¨ > 1 ×™×•× = ××™×œ×•××™× ×—×“×©×™×
        }
        
        // ×× ×”×©×™×¨×•×ª ×”×§×•×“× ×”×ª×—×™×œ ×œ×¤× ×™ 01.05.2025 - ×œ× ××™×œ×•××™× ×—×“×©×™×
        if (prev.start < NEW_MILUIM_START) {
            return false;
        }
    }
    
    return true; // ××™×œ×•××™× ×—×“×©×™×
}
        // Minimum bruto by year
        const BRUTO_MINIMUMS = {
            2021: 5987,
            2022: 6131,
            2023: 6455,
            2024: 6668,
            2025: 6895
        };

        // Daily value limits by period
        const DAILY_LIMITS = [
            { start: new Date('2021-01-01'), end: new Date('2021-12-31'), min: 199.57, max: 1502.50 },
            { start: new Date('2022-01-01'), end: new Date('2022-12-31'), min: 204.34, max: 1502.50 },
            { start: new Date('2023-01-01'), end: new Date('2023-10-06'), min: 215.17, max: 1582.17 },
            { start: new Date('2023-10-07'), end: new Date('2023-12-31'), min: 300.61, max: 1582.17 },
            { start: new Date('2024-01-01'), end: new Date('2024-12-31'), min: 310.52, max: 1634.33 },
            { start: new Date('2025-01-01'), end: new Date('2025-12-31'), min: 321.07, max: 1689.83 }
        ];

        // ğŸ”¥ ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ×¤×•× ×§×¦×™×™×ª parseExcelDate ××ª×•×§× ×ª
        function parseExcelDate(value) {
            if (!value) return null;
            
            if (value instanceof Date) return value;
            
            // ğŸ”¥ ×ª×™×§×•×Ÿ: ×©×™× ×•×™ ×-value-2 ×œ-value-1 ×œ×¤×ª×¨×•×Ÿ ×”×‘×¢×™×” ×©×œ ×™×•× ××—×“ ×œ×¤× ×™
            if (typeof value === 'number') {
                const excelEpoch = new Date(1900, 0, 1);
                const days = value - 1; // âœ… ×ª×•×§×Ÿ! ×”×©×ª××© ×‘-1 ×‘××§×•× 2
                return new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
            }
            
            // ×ª××™×›×” ×‘×¤×•×¨××˜×™ ×ª××¨×™×›×™× ×©×•× ×™×
            if (typeof value === 'string') {
                const formats = [
                    /^(\d{4})-(\d{2})-(\d{2})$/,        // YYYY-MM-DD
                    /^(\d{2})\/(\d{2})\/(\d{4})$/,      // DD/MM/YYYY
                    /^(\d{2})-(\d{2})-(\d{4})$/,       // DD-MM-YYYY
                    /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,  // D/M/YYYY
                    /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/   // D.M.YYYY
                ];
                
                for (let format of formats) {
                    const match = value.match(format);
                    if (match) {
                        if (format.source.startsWith('^(\\d{4})')) {
                            // YYYY-MM-DD format
                            return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                        } else {
                            // DD/MM/YYYY or DD-MM-YYYY or D.M.YYYY formats
                            return new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));
                        }
                    }
                }
                
                // Try standard Date parsing as fallback
                const parsed = new Date(value);
                return isNaN(parsed.getTime()) ? null : parsed;
            }
            
            return null;
        }

        function formatDate(date) {
    if (!date) return '';
    
    // ×ª×™×§×•×Ÿ timezone - ×•×•×“× ×©×× ×—× ×• ××§×‘×œ×™× ××ª ×”×ª××¨×™×š ×”× ×›×•×Ÿ
    const adjustedDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
    
    const day = adjustedDate.getDate().toString().padStart(2, '0');
    const month = (adjustedDate.getMonth() + 1).toString().padStart(2, '0');
    const year = adjustedDate.getFullYear();
    
    return `${day}.${month}.${year}`;
}
// ×¤×•× ×§×¦×™×” ×©××—×©×‘×ª ×ª×—×™×œ×ª ×—×•×“×© ×©×œ ×©×™×¨×•×ª 
function getServiceMonthStart(serviceStartDate) {
    const dateObj = serviceStartDate instanceof Date ? serviceStartDate : new Date(serviceStartDate);
    return new Date(dateObj.getFullYear(), dateObj.getMonth(), 1);
}

        function formatCurrency(amount) {
            return new Intl.NumberFormat('he-IL', {
                style: 'currency',
                currency: 'ILS'
            }).format(amount);
        }

        // ğŸ”¥ ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ×”×•×¡×¤×ª ×¤×•× ×§×¦×™×•×ª ×—×¡×¨×•×ª ××”××¤×¨×˜
        function ApplyBrutoMinimumFromCSV(bruto, monthDate) {
            const year = monthDate.getFullYear();
            const minimum = BRUTO_MINIMUMS[year] || BRUTO_MINIMUMS[2025];
            return Math.max(bruto, minimum);
        }

        function ApplyFinalLimitsFromCSV(dailyValue, serviceDate) {
            for (let limit of DAILY_LIMITS) {
                if (serviceDate >= limit.start && serviceDate <= limit.end) {
                    return Math.max(limit.min, Math.min(limit.max, dailyValue));
                }
            }
            // Default to latest limits if no match found
            const latestLimit = DAILY_LIMITS[DAILY_LIMITS.length - 1];
            return Math.max(latestLimit.min, Math.min(latestLimit.max, dailyValue));
        }

        // ğŸ”¥ ×ª×™×§×•×Ÿ: ×¢×“×›×•×Ÿ GetBrutoForMonth ×œ×”×—×™×œ ×‘×¨×•×˜×• ××™× ×™××œ×™
        function GetBrutoForMonth(employeeId, monthDate) {
            const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
            const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
            
            let bestBruto = 0;
            
            for (let salary of salaryData) {
                if (salary.employeeId == employeeId) {
                    const salaryDate = parseExcelDate(salary.monthYear);
                    if (salaryDate && salaryDate >= monthStart && salaryDate <= monthEnd) {
                        bestBruto = Math.max(bestBruto, salary.bruto || 0);
                    }
                }
            }
            
            // ğŸ”¥ ×ª×™×§×•×Ÿ: ×”×—×œ×ª ×‘×¨×•×˜×• ××™× ×™××œ×™
            return ApplyBrutoMinimumFromCSV(bestBruto, monthDate);
        }

        function GetWorkDaysForMonth(employeeId, monthDate, serviceStartDate) {
    const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
    const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
    
    let totalDays = 0;
    
    // ×§×‘×™×¢×” ××™×–×” ×¢××•×“×” ×œ×”×©×ª××© ×‘×” ×œ×¤×™ ×ª××¨×™×š ×”×©×™×¨×•×ª
    const isNewMiluim = serviceStartDate >= new Date(2025, 4, 1); // 1 ×‘×××™ 2025
    
    for (let attendance of attendanceData) {
        if (attendance.employeeId == employeeId) {
            const attendanceDate = parseExcelDate(attendance.monthYear);
            if (attendanceDate >= monthStart && attendanceDate <= monthEnd) {
                // ×‘×—×¨ ××ª ×”×¢××•×“×” ×”× ×›×•× ×” ×œ×¤×™ ×¡×•×’ ×”××™×œ×•××™×
                const workDays = isNewMiluim ? 
                    (attendance.workDaysNew || 0) :  // ×¢××•×“×” D ×œ××™×œ×•××™× ×—×“×©×™×
                    (attendance.workDays || 0);      // ×¢××•×“×” C ×œ××™×œ×•××™× ×¨×’×™×œ×™×
                totalDays += workDays;
            }
        }
    }
    
    return totalDays;
}

        // Core calculation functions - ××ª×•×§×Ÿ ×œ×¤×™ ×”××¤×¨×˜
        function calculateBasicDailyValue(employeeId, serviceStartDate) {
            // ğŸ”¥ ×ª×™×§×•×Ÿ: ×—×™×©×•×‘ 3 ×”×—×•×“×©×™× ×©×œ×¤× ×™ ×ª×—×™×œ×ª ×—×•×“×© ×”×©×™×¨×•×ª (×œ× +1)
            const serviceMonth = new Date(serviceStartDate.getFullYear(), serviceStartDate.getMonth(), 1);
            
            const month1 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 1, 1);
            const month2 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 2, 1);
            const month3 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 3, 1);
            
            // ×‘×“×™×§×ª ×™××™ ×¢×‘×•×“×” ×‘-3 ×—×•×“×©×™×
            const workDays1 = GetWorkDaysForMonth(employeeId, month1, serviceStartDate);
            const workDays2 = GetWorkDaysForMonth(employeeId, month2, serviceStartDate);
            const workDays3 = GetWorkDaysForMonth(employeeId, month3, serviceStartDate);
            const totalWorkDays = workDays1 + workDays2 + workDays3;
            
            let totalBruto = 0;
            let calculation = '×¨×’×™×œ';
            let monthsUsed = [month1, month2, month3];
            
            if (totalWorkDays >= 60) {
                // ×—×™×©×•×‘ ×¨×’×™×œ - 3 ×—×•×“×©×™× ×œ×¤× ×™ ×”×©×™×¨×•×ª
                totalBruto = GetBrutoForMonth(employeeId, month1) +
                           GetBrutoForMonth(employeeId, month2) +
                           GetBrutoForMonth(employeeId, month3);
            } else {
                // ×—×™×©×•×‘ ×—×œ×•×¤×™ - 3 ×”×—×•×“×©×™× ×”×˜×•×‘×™× ×-6 ×—×•×“×©×™× ×œ×¤× ×™
                calculation = '×—×œ×•×¤×™';
                const months = [];
                for (let i = 1; i <= 6; i++) {
                    const month = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - i, 1);
                    months.push({
                        date: month,
                        bruto: GetBrutoForMonth(employeeId, month)
                    });
                }
                
                // ××™×•×Ÿ ×œ×¤×™ ×‘×¨×•×˜×• ×™×•×¨×“ ×•×œ×§×™×—×ª 3 ×”×˜×•×‘×™×
                months.sort((a, b) => b.bruto - a.bruto);
                monthsUsed = months.slice(0, 3).map(m => m.date);
                totalBruto = months.slice(0, 3).reduce((sum, month) => sum + month.bruto, 0);
            }
            
            const dailyValue = totalBruto / 90;
           let finalValue = ApplyFinalLimitsFromCSV(dailyValue, serviceStartDate);
    

    const employeeMiluim = miluimData
        .filter(m => m.employeeId == employeeId)
        .map(m => ({...m, startDate: parseExcelDate(m.startDate), endDate: parseExcelDate(m.endDate)}))
        .filter(m => m.startDate && m.endDate && m.endDate < serviceStartDate)
        .sort((a, b) => b.endDate - a.endDate);
    
    if (employeeMiluim.length > 0) {
        const mostRecentMiluim = employeeMiluim[0];
        const daysDiff = (serviceStartDate - mostRecentMiluim.endDate) / (1000 * 60 * 60 * 24);
        
        if (daysDiff <= 1) {
            
            const prevBasicResult = calculateBasicDailyValue(employeeId, mostRecentMiluim.startDate);
            const minimumDaily = getMinimumDailyForDate(serviceStartDate);
            finalValue = Math.max(prevBasicResult.dailyValue,minimumDaily);
        }
    }
                          
            return {
                dailyValue: finalValue,
                totalBruto,
                calculationType: calculation,
                workDays: totalWorkDays,
                monthsUsed
            };
        }
function calculateRecommendedValue(employeeId, serviceStartDate, basicValue) {
                 // For new miluim (after 01.05.2025) - don't consider previous service
    if (serviceStartDate >= NEW_MILUIM_START) {
        return basicValue;
    }

    // For regular miluim - check previous service in 60 days before
    
    const checkDate = new Date(serviceStartDate);
    checkDate.setDate(checkDate.getDate() - 60);
    
    
    let previousValue = 0;
    
    for (let miluim of miluimData) {
        if (miluim.employeeId === employeeId) {
            const miluimEnd = parseExcelDate(miluim.endDate);
            const miluimStart = parseExcelDate(miluim.startDate);
            
            if (miluimEnd >= checkDate && miluimEnd < serviceStartDate) {
                // ?? Ã«Ã Ã¯ Ã¤Ã¹Ã©Ã®Ã¥Ã¹ Ã¡-CACHE!
                const prevKey = cacheSystem.createKey(employeeId, miluimStart);
                
                if (cacheSystem.cache.has(prevKey)) {
                    // ? Ã¬Ã¥Ã·Ã§ Ã²Ã¸Ãª Ã®Ã¥Ã®Ã¬Ãµ Ã®Ã¤Ã®Ã¨Ã®Ã¥Ã¯
                    const cachedResult = cacheSystem.cache.get(prevKey);
                    previousValue = Math.max(previousValue, cachedResult.recommendedValue);
                } else {
                    // Ã Ã­ Ã Ã©Ã¯ Ã¡Ã®Ã¨Ã®Ã¥Ã¯, Ã§Ã¹Ã¡ Ã¸Ã· Ã¡Ã±Ã©Ã±Ã© (fallback)
                    const prevBasic = calculateBasicDailyValue(employeeId, miluimStart);
                    previousValue = Math.max(previousValue, prevBasic.dailyValue);
                }         
                    }
                }
            }
            
            return Math.max(basicValue, previousValue);
        }

            function calculateContinuousValue(employeeId, serviceStartDate, recommendedValue, isNewMiluim = null) {
   // For miluim before emergency period
   if (serviceStartDate < EMERGENCY_START) {
       return {
           value: recommendedValue,
           isLocked: false
       };
   } 

   // Ã Ã­ Ã¬Ã  Ã·Ã©Ã¡Ã¬Ã°Ã¥ isNewMiluim, Ã§Ã¹Ã¡ Ã Ã¥ÃºÃ¥
   if (isNewMiluim === null) {
       const allEmployeeRecords = miluimData
           .filter(m => m.employeeId == employeeId)
           .map(m => ({
               startDate: m.startDate,
               endDate: m.endDate
           }));
       isNewMiluim = IsNewMiluim(employeeId, serviceStartDate, allEmployeeRecords);
   }   

   // For emergency period - check if part of existing cluster
   let isNewCluster = true;
   
   // Check if this is part of existing emergency cluster
   for (let miluim of miluimData) {
       if (miluim.employeeId == employeeId) {
           const miluimEnd = parseExcelDate(miluim.endDate);
           const miluimStart = parseExcelDate(miluim.startDate);
           
           if (miluimEnd < serviceStartDate && miluimStart >= EMERGENCY_START) {
               const serviceMonthStart = getServiceMonthStart(serviceStartDate);
               const daysDiff = (serviceMonthStart - miluimEnd) / (1000 * 60 * 60 * 24);
               
               // If gap is <= 90 days, same cluster
               if (daysDiff <= 90) {
                   isNewCluster = false;
                   break;
               }
           }
       }
   }
   
   // If part of existing cluster, check if need to limit value
   if (!isNewCluster) {
       // Find cluster start date (same logic as in calculateEmergencyValues)
       const employeeMiluim = miluimData
           .filter(m => m.employeeId == employeeId)
           .map(m => ({...m, startDate: parseExcelDate(m.startDate), endDate: parseExcelDate(m.endDate)}))
           .filter(m => m.endDate < serviceStartDate && m.startDate >= EMERGENCY_START)
           .sort((a, b) => b.endDate - a.endDate);
       
       let clusterStartDate = serviceStartDate;
       let checkDate = getServiceMonthStart(serviceStartDate);
       
       for (let prevMiluim of employeeMiluim) {
           const gap = (checkDate - prevMiluim.endDate) / (1000 * 60 * 60 * 24);
           if (gap <= 90) {
               clusterStartDate = prevMiluim.startDate;
              checkDate = getServiceMonthStart(prevMiluim.startDate);
           } else {
               break;
           }
       }
    
       // ?? Ã¹Ã©Ã®Ã¥Ã¹ Ã¡-CACHE Ã¬Ã§Ã©Ã¹Ã¥Ã¡ Ã²Ã¸Ãª J Ã¹Ã¬ ÃºÃ§Ã©Ã¬Ãº Ã¤Ã Ã¹Ã«Ã¥Ã¬
       let clusterJValue;
       const clusterKey = cacheSystem.createKey(employeeId, clusterStartDate);
       
       if (cacheSystem.cache.has(clusterKey)) {
           // ? Ã·Ã§ Ã®Ã¤Ã®Ã¨Ã®Ã¥Ã¯
           const cachedClusterResult = cacheSystem.cache.get(clusterKey);
           clusterJValue = cachedClusterResult.recommendedValue * 1.2;
           console.log(`? CACHE HIT Ã¬ÃºÃ§Ã©Ã¬Ãº Ã Ã¹Ã«Ã¥Ã¬: ${clusterKey}`);
       } else {
           // fallback - Ã§Ã©Ã¹Ã¥Ã¡ Ã¸Ã¢Ã©Ã¬
           const clusterStartCalc = calculateBasicDailyValue(employeeId, clusterStartDate);
           const clusterRecommendedValue = calculateRecommendedValue(employeeId, clusterStartDate, clusterStartCalc.dailyValue);
           clusterJValue = clusterRecommendedValue * 1.2;
           console.log(`?? Ã§Ã©Ã¹Ã¥Ã¡ fallback Ã¬ÃºÃ§Ã©Ã¬Ãº Ã Ã¹Ã«Ã¥Ã¬: ${clusterKey}`);
       }
      
       // Only limit if current value is higher than cluster J value AND it's new miluim
       if (recommendedValue > clusterJValue && isNewMiluim) {
           return {
               value: clusterJValue,
               isLocked: true // Ã²Ã¸Ãª Ã°Ã²Ã¥Ã¬ Ã¡Ã¢Ã¬Ã¬ Ã²Ã¸Ãª Ã¢Ã¡Ã¥Ã¤
           };
       }
   }
   
   return {
       value: recommendedValue,
       isLocked: false
   };
}
     function calculateEmergencyValues(employeeId, serviceStartDate, continuousValue) {
            if (serviceStartDate < EMERGENCY_START) {
                return {
                    emergencyValue: 0,
                    maxEmergencyValue: 0,
                    emergencyClusterStart: null,
                    isNewCluster: false
                };
            }
            
            // Check if this is start of new emergency cluster
            let isNewCluster = true;
            let clusterStartDate = serviceStartDate;
            
            for (let miluim of miluimData) {
                if (miluim.employeeId == employeeId) {
                    const miluimEnd = parseExcelDate(miluim.endDate);
                    const miluimStart = parseExcelDate(miluim.startDate);
                    
                    if (miluimEnd < serviceStartDate && miluimStart >= EMERGENCY_START) {
                      const serviceMonthStart = getServiceMonthStart(serviceStartDate);
                      const daysDiff = (serviceMonthStart - miluimEnd) / (1000 * 60 * 60 * 24);
                        
                        // If gap is <= 90 days, same cluster
                        if (daysDiff <= 90) {
                    isNewCluster = false;
                    // Don't break - continue to find the real cluster start
                    // Keep going backward to find the actual cluster beginning
}
                    }
                }
            }
            // If not new cluster, find the real cluster start by going backward
if (!isNewCluster) {
    // Create array of all employee miluim before current date
    const employeeMiluim = miluimData
        .filter(m => m.employeeId == employeeId)
        .map(m => ({...m, startDate: parseExcelDate(m.startDate), endDate: parseExcelDate(m.endDate)}))
        .filter(m => m.endDate < serviceStartDate && m.startDate >= EMERGENCY_START)
        .sort((a, b) => b.endDate - a.endDate);
    

   // Go backward to find cluster start
let checkDate = getServiceMonthStart(serviceStartDate);
for (let prevMiluim of employeeMiluim) {
    const gap = (checkDate - prevMiluim.endDate) / (1000 * 60 * 60 * 24);
    if (gap <= 90) {
        clusterStartDate = prevMiluim.startDate;
        checkDate = getServiceMonthStart(prevMiluim.startDate);           
            // If reached pre-emergency period, stop
            if (prevMiluim.startDate < EMERGENCY_START) {
                break;
            }
        } else {
            break;
        }
    }
}
            
            const emergencyValue = isNewCluster ? continuousValue : continuousValue; // Would need cluster start value
            const maxEmergencyValue = emergencyValue * 1.2;
            
            // Apply final limits to max emergency value
            const limitedMaxValue = ApplyFinalLimitsFromCSV(maxEmergencyValue, serviceStartDate);
            
            return {
    emergencyValue,
    maxEmergencyValue: limitedMaxValue,
    emergencyClusterStart: clusterStartDate,  // âš ï¸ ×ª××™×“ ×œ×”×—×–×™×¨ ××ª ×ª×—×™×œ×ª ×”××©×›×•×œ
    isNewCluster
};
}
function calculateCompulsionContinuous() {
    // ×§×™×‘×•×¥ ×œ×¤×™ ×¢×•×‘×“
    const employeeGroups = {};
    calculationResults.forEach(result => {
        if (!employeeGroups[result.employeeId]) {
            employeeGroups[result.employeeId] = [];
        }
        employeeGroups[result.employeeId].push(result);
    });
    
    Object.keys(employeeGroups).forEach(employeeId => {
        const employeeData = employeeGroups[employeeId];
        // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š ×”×ª×—×œ×” - ×‘×“×™×•×§ ×›××• ×‘×¤×•× ×§×¦×™×” ×”×™×©× ×”
        employeeData.sort((a, b) => a.startDate - b.startDate);
        
        let lastCompulsion = 0;
        for (let i = 0; i < employeeData.length; i++) {
            const current = employeeData[i];
            const prev = i > 0 ? employeeData[i-1] : null;
            
            if (prev) {
                const gapDays = (current.startDate - prev.endDate) / (1000 * 60 * 60 * 24);
                if (gapDays <= 1) {
                    // --- ×¨×¦×£ ---
                    if (!current.compulsion || current.compulsion === 0) {
                        // ××™×Ÿ ×¢×¨×š -> ×××©×™×›×™× ××ª ×”×¢×¨×š ×”×§×•×“×
                        current.compulsionContinuous = lastCompulsion;
                    } else {
                        // ×™×© ×¢×¨×š -> ××©×ª××©×™× ×‘×•
                        current.compulsionContinuous = current.compulsion;
                        lastCompulsion = current.compulsion;
                    }
                } else {
                    // --- ×œ× ×¨×¦×£ ---
                    current.compulsionContinuous = current.compulsion || 0;
                    if (current.compulsion && current.compulsion !== 0) {
                        lastCompulsion = current.compulsion;
                    } else {
                        lastCompulsion = 0; // ××™×¤×•×¡ ×—×©×•×‘
                    }
                }
            } else {
                // --- ×”×ª×§×•×¤×” ×”×¨××©×•× ×” ---
                current.compulsionContinuous = current.compulsion || 0;
                if (current.compulsion && current.compulsion !== 0) {
                    lastCompulsion = current.compulsion;
                } else {
                    lastCompulsion = 0;
                }
            }
        }
    });
}
function propagateEmergencyCompulsion4405() {
    console.log("××ª×—×™×œ ×”×¤×¦×ª ×¢×¨×›×™ ×›×¤×™×” ×—×™×¨×•× 4405...");
    
    // ××•×¦× ××ª ×›×œ ×”×¢×¨×›×™× ×”×™×™×—×•×“×™×™× ×‘×¢××•×“×” P ×¢× ×ª×—×™×œ×ª ×”××©×›×•×œ ×©×œ×”×
    const compulsionValues = new Map(); // Key: ×¢×•×‘×“-×ª××¨×™×š ×ª×—×™×œ×ª ××©×›×•×œ, Value: ××™×“×¢ ××œ×

    calculationResults.forEach(result => {
        if (result.emergencyCompulsion4405 && result.emergencyCompulsion4405 > 0 && result.emergencyClusterStart) {
            const clusterStartKey = `${result.employeeId}-${result.emergencyClusterStart.getTime()}`;
            compulsionValues.set(clusterStartKey, {
                employeeId: result.employeeId,
                clusterStart: result.emergencyClusterStart,
                compulsionValue: Math.round(result.emergencyCompulsion4405 * 1.2 * 100) / 100
            });
            
            console.log(`× ××¦× ×¢×¨×š ×›×¤×™×” ${result.emergencyCompulsion4405} ×¢×‘×•×¨ ×¢×•×‘×“ ${result.employeeId} ×œ××©×›×•×œ ××ª××¨×™×š ${formatDate(result.emergencyClusterStart)}`);
        }
    });
    
    // ×”×¤×¥ ××ª ×”×¢×¨×›×™× ×œ×›×œ ×”×ª×§×•×¤×•×ª ×¢× ××•×ª×” ×ª×—×™×œ×ª ××©×›×•×œ ×©×œ ××•×ª×• ×¢×•×‘×“
    compulsionValues.forEach((compulsionData, clusterKey) => {
        let updatedCount = 0;
        
        calculationResults.forEach(result => {
            if (result.employeeId === compulsionData.employeeId &&
                result.emergencyClusterStart && 
                result.emergencyClusterStart.getTime() === compulsionData.clusterStart.getTime()) {
                
                result.emergencyCompulsion4405 = compulsionData.compulsionValue;
                updatedCount++;
            }
        });
        
        console.log(`×”×•×¤×¥ ×¢×¨×š ${compulsionData.compulsionValue} ×œ-${updatedCount} ×ª×§×•×¤×•×ª ×¢×‘×•×¨ ×¢×•×‘×“ ${compulsionData.employeeId} ×¢× ×ª×—×™×œ×ª ××©×›×•×œ ${formatDate(compulsionData.clusterStart)}`);
    });
    
    console.log("×”×•×©×œ××” ×”×¤×¦×ª ×¢×¨×›×™ ×›×¤×™×” ×—×™×¨×•× 4405");
}
                
// ğŸ”¥ ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×ª×§×•×¤×•×ª ×’×•×œ×©×•×ª ××§×•×¨×™×•×ª
function hasOriginalCrossMonthPeriods(employeeId) {
    const employeeOriginalPeriods = miluimData.filter(m => m.employeeId == employeeId);
    
    for (let period of employeeOriginalPeriods) {
        if (typeof period.startDate === 'number' && typeof period.endDate === 'number') {
            // ×”×©×ª××© ×‘×—×™×©×•×‘ ×”×¤×©×•×˜ ×©×¢×‘×“
            const resultDate1 = new Date(1900, 0, 1);
            resultDate1.setDate(resultDate1.getDate() + period.startDate - 2);
            const startDate = new Date(resultDate1.getFullYear(), resultDate1.getMonth(), resultDate1.getDate());
            
            const resultDate2 = new Date(1900, 0, 1);
            resultDate2.setDate(resultDate2.getDate() + period.endDate - 2);
            const endDate = new Date(resultDate2.getFullYear(), resultDate2.getMonth(), resultDate2.getDate());
            
            if (startDate.getMonth() !== endDate.getMonth() || 
                startDate.getFullYear() !== endDate.getFullYear()) {
                return true;
            }
        }
    }
    return false;
}
function isCrossMonthService(result) {
    // ×—×¤×© ××ª ×”×¨×©×•××” ×”××ª××™××” ×‘× ×ª×•× ×™ ×”××™×œ×•××™×
    const miluimRecord = self.miluimData.find(m => 
        m.employeeId == result.employeeId && 
        Math.abs(parseExcelDate(m.startDate) - result.startDate) < 86400000
    );
    
    // ×§×¨× ××¢××•×“×” 13 (××™× ×“×§×¡ 12) - 0 = ×œ× ×’×•×œ×©, 1 = ×’×•×œ×©
    return miluimRecord?.crossMonth === 1;
}
// ğŸ”¥ ×¢×“×›×Ÿ ××ª calculateMiluimForEmployeeWithCache
function calculateMiluimForEmployeeWithCache(employeeId) {
    const employeeMiluim = miluimData.filter(m => m.employeeId == employeeId);
    const results = [];
    
    // ğŸ”¥ ×—×©×‘ ×¤×¢× ××—×ª ×œ×›×œ ×¢×•×‘×“
    const hasCrossMonthPeriods = hasOriginalCrossMonthPeriods(employeeId);
    
    for (let miluim of employeeMiluim) {
        const startDate = parseExcelDate(miluim.startDate);
        const endDate = parseExcelDate(miluim.endDate);
        
        if (!startDate || !endDate) continue;

        const cacheResult = cacheSystem.calculateWithCache(employeeId, startDate);
        
        const result = {
            ...cacheResult,
            endDate: endDate,
            miluimDays: miluim.miluimDays || Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1,
            hasOriginalCrossMonthPeriods: hasCrossMonthPeriods,  // ğŸ”¥ ×”×•×¡×£ ××ª ×”×××¤×™×™×Ÿ!
            isCrossMonth: miluim.crossMonth === 1 
        };
        
        results.push(result);
    }            
    
    return results;
}
        // File upload handlers
        function setupFileUpload() {
            document.getElementById('excelFile').addEventListener('change', function(e) {
                loadExcelFile(e.target.files[0]);
            });
        }
        
  // ğŸš€ ×¤×•× ×§×¦×™×” ××ª×•×§× ×ª ×•××•×©×œ××ª ×œ×—×™×©×•×‘ ××™×œ×•××™×
async function calculateMiluim(config = {}) {
    const {
        employeeIds = null,        // ××¢×¨×š ×¢×•×‘×“×™× ×¡×¤×¦×™×¤×™×™× ××• null ×œ×›×•×œ×
        batchSize = 0,            // 0 = ×œ×œ× batches, >0 = ×¢× batches
        showProgress = false,     // ×”×¦×’×ª progress bar
        enableCancel = false,     // ××¤×©×¨×•×ª ×‘×™×˜×•×œ
        addEmployeeHeader = false, // header ×œ×¢×•×‘×“ ×‘×•×“×“
        autoDisplayResults = true, // ×”×¦×’×” ××•×˜×•××˜×™×ª ×©×œ ×ª×•×¦××•×ª
        returnResults = false     // ×”×—×–×¨×ª ×ª×•×¦××•×ª ×‘××§×•× ×”×¦×’×”
    } = config;

    // === 1. ×”×›× ×” ×•×‘×“×™×§×•×ª ===
    calculationResults = [];
    
    // ×˜×™×¤×•×œ ×‘×¢×•×‘×“×™× ×¡×¤×¦×™×¤×™×™×
    if (employeeIds && employeeIds.length > 0) {
        // ×©××™×¨×ª × ×ª×•× ×™× ××§×•×¨×™×™×
        if (originalMiluimData.length === 0) {
            originalMiluimData = [...miluimData];
            originalSalaryData = [...salaryData];
            originalAttendanceData = [...attendanceData];
        }

        // ×¡×™× ×•×Ÿ ×œ×¢×•×‘×“×™× ×”× ×‘×—×¨×™×
        miluimData = originalMiluimData.filter(m => employeeIds.includes(m.employeeId.toString()));
        salaryData = originalSalaryData.filter(s => employeeIds.includes(s.employeeId.toString()));
        attendanceData = originalAttendanceData.filter(a => employeeIds.includes(a.employeeId.toString()));

        // ×‘×“×™×§×” ×©×™×© × ×ª×•× ×™×
        if (miluimData.length === 0) {
            document.getElementById('resultsContainer').innerHTML = 
                `<div class="error">×œ× × ××¦××• × ×ª×•× ×™ ××™×œ×•××™× ×œ×¢×•×‘×“ ${employeeIds[0]}</div>`;
            return;
        }
    }

    const uniqueEmployees = [...new Set(miluimData.map(m => m.employeeId))];
    const totalEmployees = uniqueEmployees.length;
    console.log(`ğŸ”„ ××ª×—×™×œ ×—×™×©×•×‘ ×¢×‘×•×¨ ${totalEmployees} ×¢×•×‘×“×™×`);

    // === 2. ×”×¦×’×ª Loading ===
    const shouldUseBatches = batchSize > 0 && totalEmployees > batchSize;
    
    if (shouldUseBatches && showProgress) {
        // Progress Bar ××ª×§×“×
        document.getElementById('resultsContainer').innerHTML = `
            <div class="loading" style="padding: 40px;">
                <div style="font-size: 1.8em; margin-bottom: 20px;">ğŸ”„ ××¢×‘×“ ${totalEmployees} ×¢×•×‘×“×™×...</div>
                <div id="progressBar" style="width: 400px; height: 35px; background: #ecf0f1; border-radius: 20px; margin: 20px auto; overflow: hidden;">
                    <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 20px; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="font-size: 1.3em; margin: 15px 0; color: #2c3e50;">
                    <span id="currentCount">0</span> / <span id="totalCount">${totalEmployees}</span> ×¢×•×‘×“×™×
                </div>
                <div id="timeEstimate" style="font-size: 1em; color: #7f8c8d;">×–××Ÿ ××©×•×¢×¨: ××—×©×‘...</div>
                ${enableCancel ? `<button class="btn" style="background: #e74c3c; margin-top: 20px;" onclick="window.cancelBatchCalculation = true">â›” ×‘×˜×œ</button>` : ''}
            </div>`;
        
        if (enableCancel) window.cancelBatchCalculation = false;
    } else {
        // Loading ×¤×©×•×˜
        document.getElementById('resultsContainer').innerHTML = '<div class="loading">ğŸ”„ ××¢×‘×“ × ×ª×•× ×™×...</div>';
    }

    // === 3. ×”×›× ×ª CACHE ===
    cacheSystem.prepareData();

    // === 4. ×¤×•× ×§×¦×™×” ××¨×›×–×™×ª ×œ×¢×™×‘×•×“ ×ª×•×¦××•×ª ===
    const processResults = () => {
        if (autoDisplayResults) {
            // Header ×œ×¢×•×‘×“ ×‘×•×“×“
            if (addEmployeeHeader && employeeIds && employeeIds.length === 1) {
                const header = document.createElement('div');
                header.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; text-align: center;';
                header.innerHTML = `<h2 style="margin: 0; font-size: 1.5em;">ğŸ“Š ×ª×•×¦××•×ª ×¢×•×‘×“ ${employeeIds[0]}</h2>`;
                
                setTimeout(() => {
                    const container = document.getElementById('resultsContainer');
                    container.innerHTML = '';
                    container.appendChild(header);
                    displayResults(calculationResults, { 
                        itemsPerPage: calculationResults.length > 100 ? 50 : null 
                    });
                }, 50);
            } else {
                // ×”×¦×’×” ×¨×’×™×œ×”
                displayResults(calculationResults, { 
                    itemsPerPage: calculationResults.length > 100 ? 50 : null 
                });
            }
       
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×•×™×™×¦×•×
            updateSummaryStats();
            document.getElementById('exportSection').style.display = 'block';
        }

        // ×©×—×–×•×¨ × ×ª×•× ×™× ××§×•×¨×™×™×
        if (employeeIds && employeeIds.length > 0) {
            miluimData = originalMiluimData;
            salaryData = originalSalaryData;
            attendanceData = originalAttendanceData;
        }

        console.log(`âœ… ×”×•×©×œ×! ${calculationResults.length} ×ª×•×¦××•×ª`);
        
        if (returnResults) return calculationResults;
    };

    // === 5. ×”×—×™×©×•×‘ ×”×¨××©×™ ===
    const startTime = performance.now();

    if (shouldUseBatches) {
        // === ×—×™×©×•×‘ ×¢× Batches (×¢×‘×•×¨ ×××•×ª/××œ×¤×™ ×¢×•×‘×“×™×) ===
        const batchStartTime = Date.now();
        
        try {
            for (let i = 0; i < uniqueEmployees.length; i += batchSize) {
                // ×‘×“×™×§×ª ×‘×™×˜×•×œ
                if (enableCancel && window.cancelBatchCalculation) {
                    console.log('âŒ ×—×™×©×•×‘ ×‘×•×˜×œ ×¢×œ ×™×“×™ ×”××©×ª××©');
                    return;
                }

                // ×¢×™×‘×•×“ ×”×‘××¦' ×”× ×•×›×—×™
                const batch = uniqueEmployees.slice(i, i + batchSize);
                
                for (let employeeId of batch) {
                    const results = calculateMiluimForEmployeeWithCache(employeeId);
                    calculationResults.push(...results);
                }
                
                const processedCount = Math.min(i + batchSize, totalEmployees);
                
                // ×¢×“×›×•×Ÿ Progress Bar
                if (showProgress) {
                    const progressPercent = (processedCount / totalEmployees) * 100;
                    const progressFill = document.getElementById('progressFill');
                    const currentCount = document.getElementById('currentCount');
                    const timeEstimate = document.getElementById('timeEstimate');
                    
                    if (progressFill) progressFill.style.width = progressPercent + '%';
                    if (currentCount) currentCount.textContent = processedCount;
                    
                    // ×—×™×©×•×‘ ×–××Ÿ ××©×•×¢×¨
                    if (timeEstimate && processedCount > 0) {
                        const elapsed = Date.now() - batchStartTime;
                        const avgTime = elapsed / processedCount;
                        const remaining = (avgTime * (totalEmployees - processedCount)) / 1000;
                        
                        if (remaining > 60) {
                            const min = Math.floor(remaining / 60);
                            const sec = Math.floor(remaining % 60);
                            timeEstimate.textContent = `×–××Ÿ ××©×•×¢×¨: ${min}:${sec.toString().padStart(2, '0')}`;
                        } else {
                            timeEstimate.textContent = `×–××Ÿ ××©×•×¢×¨: ${Math.floor(remaining)} ×©× ×™×•×ª`;
                        }
                    }
                }
                
                // ×× ×•×—×” ×§×¦×¨×” ×œ×“×¤×“×¤×Ÿ
                await new Promise(resolve => setTimeout(resolve, 30));
            }
            
            // âœ… ×”×ª×™×§×•×Ÿ: ×—×™×©×•×‘ ×¢××•×“×” O ××—×¨×™ ×©×›×œ ×”× ×ª×•× ×™× ××•×›× ×™×
            calculateCompulsionContinuous();
            console.log('×¢×¨×›×™ ×›×¤×™×™×” ×¨×¦×™×¤×” ×—×•×©×‘×• ×•× ×•×¡×¤×• ×œ×˜×‘×œ×”');
            propagateEmergencyCompulsion4405(); // 
            console.log('×¢×¨×›×™ ×›×¤×™×” ×—×™×¨×•× 4405 ×”×•×¤×¦×• ×œ××©×›×•×œ×•×ª');
            
            // ×¡×™×•× ×—×™×©×•×‘ ×¢× Batches - ×”×¦×’×ª ×ª×•×¦××•×ª
            processResults();
            
        } catch (error) {
            console.error('×©×’×™××” ×‘×—×™×©×•×‘ Batches:', error);
            document.getElementById('resultsContainer').innerHTML = 
                `<div class="error">×©×’×™××” ×‘×—×™×©×•×‘: ${error.message}</div>`;
        }
        
    } else {
        // === ×—×™×©×•×‘ ×¨×’×™×œ (×¢×‘×•×¨ ×××•×ª ×¢×•×‘×“×™×) ===
        setTimeout(() => {
            try {
                for (let employeeId of uniqueEmployees) {
                    const results = calculateMiluimForEmployeeWithCache(employeeId);
                    calculationResults.push(...results);
                }
                
                // âœ… ×”×ª×™×§×•×Ÿ: ×—×™×©×•×‘ ×¢××•×“×” O ××—×¨×™ ×©×›×œ ×”× ×ª×•× ×™× ××•×›× ×™×
                calculateCompulsionContinuous();
                console.log('×¢×¨×›×™ ×›×¤×™×™×” ×¨×¦×™×¤×” ×—×•×©×‘×• ×•× ×•×¡×¤×• ×œ×˜×‘×œ×”');
            propagateEmergencyCompulsion4405(); // 
            console.log('×¢×¨×›×™ ×›×¤×™×” ×—×™×¨×•× 4405 ×”×•×¤×¦×• ×œ××©×›×•×œ×•×ª');
                
                // ×”×¦×’×ª ×ª×•×¦××•×ª
                processResults();
                
            } catch (error) {
                console.error('×©×’×™××” ×‘×—×™×©×•×‘ ×¨×’×™×œ:', error);
                document.getElementById('resultsContainer').innerHTML = 
                    `<div class="error">×©×’×™××” ×‘×—×™×©×•×‘: ${error.message}</div>`;
            }
        }, 100);
    }

    return calculationResults;
}

// === ×“×•×’×××•×ª ×©×™××•×© ===

// 1. ×—×™×©×•×‘ ×¨×’×™×œ ×œ×›×œ ×”×¢×•×‘×“×™×
// calculateMiluim();

// 2. ×—×™×©×•×‘ ×¢× progress bar ×œ×××•×ª ×¢×•×‘×“×™×
// calculateMiluim({ batchSize: 20, showProgress: true });

// 3. ×—×™×©×•×‘ ×¢× ××¤×©×¨×•×ª ×‘×™×˜×•×œ ×œ××œ×¤×™ ×¢×•×‘×“×™×  
// calculateMiluim({ batchSize: 50, showProgress: true, enableCancel: true });

// 4. ×—×™×©×•×‘ ×œ×¢×•×‘×“ ×¡×¤×¦×™×¤×™
// calculateMiluim({ employeeIds: ['123456789'], addEmployeeHeader: true });

// 5. ×”×—×–×¨×ª ×ª×•×¦××•×ª ×œ×œ× ×”×¦×’×”
// const results = await calculateMiluim({ returnResults: true });
        function loadExcelFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    console.log('Available sheets:', workbook.SheetNames);
                    
                    // Reset data
                    miluimData = [];
                    salaryData = [];
                    attendanceData = [];
                    
                    let sheetsLoaded = 0;
                    
                    // Try to load each sheet - flexible sheet naming
                    for (let i = 0; i < Math.min(3, workbook.SheetNames.length); i++) {
                        const sheetName = workbook.SheetNames[i];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length > 1) { // Has data beyond header
                            if (i === 0) {
                                // First sheet - Miluim data
                                parseData(jsonData, 'miluim');
                                updateSheetStatus('sheet1Status', true, `ğŸ“Š ×’×œ×™×•×Ÿ ××™×œ×•××™×: âœ… (${miluimData.length} ×¨×©×•××•×ª)`);
                                sheetsLoaded++;
                            } else if (i === 1) {
                                // Second sheet - Salary data
                                parseData(jsonData, 'salary');
                                updateSheetStatus('sheet2Status', true, `ğŸ’° ×’×œ×™×•×Ÿ ×©×›×¨: âœ… (${salaryData.length} ×¨×©×•××•×ª)`);
                                sheetsLoaded++;
                            } else if (i === 2) {
                                // Third sheet - Attendance data
                                parseData(jsonData, 'attendance');
                                updateSheetStatus('sheet3Status', true, `ğŸ“… ×’×œ×™×•×Ÿ × ×•×›×—×•×ª: âœ… (${attendanceData.length} ×¨×©×•××•×ª)`);
                                sheetsLoaded++;
                            }
                        }
                    }
                    
                    document.getElementById('sheetsStatus').style.display = 'block';
                    
                    if (sheetsLoaded === 3) {
                        updateUploadStatus(true);
                        showSuccessMessage(`×”×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ${miluimData.length} ×ª×§×•×¤×•×ª ××™×œ×•××™×, ${salaryData.length} ×¨×©×•××•×ª ×©×›×¨, ${attendanceData.length} ×¨×©×•××•×ª × ×•×›×—×•×ª`);
                    } else {
                        showErrorMessage(`× ×˜×¢× ×• ×¨×§ ${sheetsLoaded} ××ª×•×š 3 ×’×œ×™×•× ×•×ª. ×× × ×•×“× ×©×”×§×•×‘×¥ ××›×™×œ 3 ×’×œ×™×•× ×•×ª ×¢× × ×ª×•× ×™×.`);
                    }
                    
                    checkCalculateButton();
                } catch (error) {
                    console.error('Error loading file:', error);
                    showErrorMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function updateSheetStatus(elementId, success, text) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            if (success) {
                element.classList.add('sheet-loaded');
            } else {
                element.classList.remove('sheet-loaded');
            }
        }

        function showSuccessMessage(message) {
            const container = document.querySelector('.upload-section');
            const existing = container.querySelector('.success, .error');
            if (existing) existing.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'success';
            msgDiv.textContent = message;
            container.appendChild(msgDiv);
            
            setTimeout(() => msgDiv.remove(), 5000);
        }

        function showErrorMessage(message) {
            const container = document.querySelector('.upload-section');
            const existing = container.querySelector('.success, .error');
            if (existing) existing.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'error';
            msgDiv.textContent = message;
            container.appendChild(msgDiv);
        }

        function parseData(jsonData, type) {
            // Skip header row
            const dataRows = jsonData.slice(1);
            
            switch (type) {
                case 'miluim':
                    miluimData = dataRows.map(row => ({
                        employeeId: row[0],
                        startDate: row[1],
                        endDate: row[2],
                        days: row[3],
                        paidAmount: parseFloat(row[11]),
                        compulsion: parseFloat(row[12]),
                        crossMonth:row[13],
                        emergencyCompulsion4405: parseFloat(row[14])

                    })).filter(item => item.employeeId);
                    break;
                    
                case 'salary':
                    salaryData = dataRows.map(row => ({
                        employeeId: row[0],
                        monthYear: row[1],
                        bruto: row[2]
                    })).filter(item => item.employeeId);
                    break;
                    
               case 'attendance':
                    attendanceData = dataRows.map(row => ({
                    employeeId: row[0],
                    monthYear: row[1],
                    workDays: row[2],      // ×¢××•×“×” C - ××™×œ×•××™× ×¨×’×™×œ×™×  
                    workDaysNew: row[3]    // ×¢××•×“×” D - ××™×œ×•××™× ×—×“×©×™×
                 })).filter(item => item.employeeId);
                break;
            }
        }

        function updateUploadStatus(success) {
            const btn = document.getElementById('excelBtn');
            const card = document.querySelector('.upload-card');
            
            if (success) {
                btn.textContent = 'âœ… ×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”';
                btn.classList.add('success');
                card.classList.add('uploaded');
            } else {
                btn.textContent = '×‘×—×¨ ×§×•×‘×¥ ××§×¡×œ';
                btn.classList.remove('success');
                card.classList.remove('uploaded');
            }
        }

        function checkCalculateButton() {
    const hasAllFiles = miluimData.length > 0 && salaryData.length > 0 && attendanceData.length > 0;
    document.getElementById('calculateBtn').disabled = !hasAllFiles;
    
    // ×”×¦×’ ×›×¤×ª×•×¨ ×¢×•×‘×“ ×‘×•×“×“ ×× ×™×© × ×ª×•× ×™×
    if (hasAllFiles) {
        document.getElementById('singleEmployeeBtn').style.display = 'inline-block';
    }
}
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª/×”×¡×ª×¨×ª ×©×“×” ×”×§×œ×“×ª ×¢×•×‘×“
function showEmployeeSelector() {
    const selectorDiv = document.getElementById('employeeSelectorDiv');
    
    // ×”×¦×’/×”×¡×ª×¨ ××ª ×”×©×“×”
    if (selectorDiv.style.display === 'none' || selectorDiv.style.display === '') {
        selectorDiv.style.display = 'block';
        document.getElementById('employeeInput').focus();
    } else {
        selectorDiv.style.display = 'none';
    }
    // ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×”××§×•×¨×™×™×
if (hasAllFiles && originalMiluimData.length === 0) {
    originalMiluimData = [...miluimData];
    originalSalaryData = [...salaryData];
    originalAttendanceData = [...attendanceData];
}
    
}

function validateEmployee() {
    const input = document.getElementById('employeeInput').value.trim();
    const validation = document.getElementById('employeeValidation');
    const calculateBtn = document.getElementById('calculateSingleBtn');
    
    if (!input) {
        validation.textContent = '';
        calculateBtn.disabled = true;
        return;
    }
    
    // ×‘×“×•×§ ×× ×”×¢×•×‘×“ ×§×™×™× - ×•×“× ×©×”×‘×“×™×§×” × ×¢×©×™×ª × ×›×•×Ÿ
    const employeeExists = miluimData.some(m => {
        // ×”×©×•×•×” ×’× ×›××¡×¤×¨ ×•×’× ×›××—×¨×•×–×ª
        return m.employeeId == input || m.employeeId === input.toString();
    });
    
    if (employeeExists) {
        validation.textContent = 'âœ“ ×”×¢×•×‘×“ × ××¦×';
        validation.style.color = '#27ae60';
        calculateBtn.disabled = false;
    } else {
        validation.textContent = 'âœ— ×¢×•×‘×“ ×œ× × ××¦×';
        validation.style.color = '#e74c3c';
        calculateBtn.disabled = true;
    }
    
    // ×”×“×¤×¡ ×œ×§×•× ×¡×•×œ ×œ×‘×“×™×§×”
    console.log(`×‘×“×™×§×ª ×¢×•×‘×“ ${input}: ${employeeExists ? '× ××¦×' : '×œ× × ××¦×'}`);
    console.log('××¡×¤×¨ ×¢×•×‘×“×™× ×›×•×œ×œ:', miluimData.length);
}



// ×¤×•× ×§×¦×™×” ×œ×™×™×¦×•× ×¢×•×‘×“ ×‘×•×“×“
function exportSingleEmployee(employeeId) {
    if (!window.singleEmployeeResults) return;
    
    const exportData = window.singleEmployeeResults.map(r => ({
        '××¡×¤×¨ ×¢×•×‘×“': employeeId,
        '×ª×—×™×œ×ª ×©×™×¨×•×ª': formatDate(r.serviceStartDate),
        '×¡×™×•× ×©×™×¨×•×ª': formatDate(r.serviceEndDate),
        '×™××™ ×©×™×¨×•×ª': r.serviceDays,
        '×¢×¨×š ×™×•××™ ×‘×¡×™×¡×™': r.basicDailyValue,
        '×¢×¨×š ××•××œ×¥': r.recommendedValue,
        '×¡×˜×˜×•×¡': r.finalStatus || '××—×•×©×‘'
    }));
    
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, `×¢×•×‘×“_${employeeId}`);
    XLSX.writeFile(wb, `miluim_employee_${employeeId}_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function backToAllEmployees() {
    // × ×§×” ××ª ×©×“×” ×”×¢×•×‘×“
    document.getElementById('employeeInput').value = '';
    document.getElementById('employeeValidation').textContent = '';
    document.getElementById('calculateSingleBtn').disabled = true;
    document.getElementById('employeeSelectorDiv').style.display = 'none';
    
    // ×—×©×‘ ××—×“×© ×œ×›×œ ×”×¢×•×‘×“×™×
    const uniqueEmployees = [...new Set(miluimData.map(m => m.employeeId))];
if (uniqueEmployees.length > 100) {
    calculateMiluim({ batchSize: 20, showProgress: true, enableCancel: true });
} else {
    calculateMiluim({ batchSize: 0 });
}
}


        function getRowClass(result) {
            let classes = [];
            
            if (result.isNewMiluim) {
                classes.push('new-miluim');
            }
            
            if (result.isNewCluster && result.startDate >= EMERGENCY_START) {
                classes.push('emergency-cluster');
            }
            
            return classes.join(' ');
        }

        function updateSummaryStats() {
            const uniqueEmployees = new Set(calculationResults.map(r => r.employeeId)).size;
            const totalPeriods = calculationResults.length;
            const totalDays = calculationResults.reduce((sum, r) => sum + r.miluimDays, 0);
            const totalPayment = calculationResults.reduce((sum, r) => sum + (r.continuousValue * r.miluimDays), 0);
            
            document.getElementById('totalEmployees').textContent = uniqueEmployees;
            document.getElementById('totalPeriods').textContent = totalPeriods;
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('totalPayment').textContent = formatCurrency(totalPayment);
            
            document.getElementById('summaryStats').style.display = 'grid';
        }
   function getExtendedCalculationDetails(employeeId, serviceStartDate) {
    const serviceMonth = new Date(serviceStartDate.getFullYear(), serviceStartDate.getMonth(), 1);
    
    // ×‘×“×™×§×” ×¨××©×•× ×™×ª - 3 ×”×—×•×“×©×™× ×”××—×¨×•× ×™× ×œ×™××™ ×¢×‘×•×“×”
    const month1 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 1, 1);
    const month2 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 2, 1);
    const month3 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 3, 1);
    
    // ×‘×“×™×§×ª ×™××™ ×¢×‘×•×“×” ×œ×§×‘×™×¢×ª ×¡×•×’ ×”×—×™×©×•×‘
    const workDays1 = GetWorkDaysForMonth(employeeId, month1, serviceStartDate);
    const workDays2 = GetWorkDaysForMonth(employeeId, month2, serviceStartDate);
    const workDays3 = GetWorkDaysForMonth(employeeId, month3, serviceStartDate);
    const totalWorkDays = workDays1 + workDays2 + workDays3;
    
    // *** ×”×©×™× ×•×™ ×”××¨×›×–×™: ×¤×™×¦×•×œ ×‘×™×Ÿ ×‘×¨×•×˜×• ×•×™××™ ×¢×‘×•×“×” ***
    
    // ×™××™ ×¢×‘×•×“×” - ×ª××™×“ 3 ×”×—×•×“×©×™× ×”××—×¨×•× ×™×
    let monthsForWorkDays = [month3, month2, month1];
    
    // ×‘×¨×•×˜×• - ×ª×œ×•×™ ×‘×¡×•×’ ×”×—×™×©×•×‘
    let monthsForBruto = [month3, month2, month1]; // ×‘×¨×™×¨×ª ××—×“×œ
    let calculationType = '×¨×’×™×œ';
    
    // ×× ×–×” ×—×™×©×•×‘ ×—×œ×•×¤×™ - ×”×‘×¨×•×˜×• ×™×™×œ×§×— ×-3 ×”×˜×•×‘×™×, ××‘×œ ×™××™ ×¢×‘×•×“×” × ×©××¨×™× 3 ××—×¨×•× ×™×
    if (totalWorkDays < 60) {
        calculationType = '×—×œ×•×¤×™';
        
        // ×‘× ×™×™×ª ×¨×©×™××ª 6 ×—×•×“×©×™× ×¢× ×”×‘×¨×•×˜×• ×©×œ×”× - ×¨×§ ×œ×‘×¨×•×˜×•
        const allMonths = [];
        for (let i = 1; i <= 6; i++) {
            const month = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - i, 1);
            const bruto = GetBrutoForMonth(employeeId, month);
            allMonths.push({
                date: month,
                bruto: bruto
            });
        }
        
        // ×‘×—×™×¨×ª 3 ×”×—×•×“×©×™× ×¢× ×”×‘×¨×•×˜×• ×”×’×‘×•×” ×‘×™×•×ª×¨ - ×¨×§ ×œ×‘×¨×•×˜×•
        monthsForBruto = allMonths
            .sort((a, b) => b.bruto - a.bruto)  // ××™×•×Ÿ ×œ×¤×™ ×‘×¨×•×˜×• ×™×•×¨×“
            .slice(0, 3)                        // 3 ×”×¨××©×•× ×™×
            .map(m => m.date)                   // ×¨×§ ×”×ª××¨×™×›×™×
            .sort((a, b) => a - b);             // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š ×¢×•×œ×”
    }
    
    // ×‘× ×™×™×ª ×¤×™×¨×•×˜ ×‘×¨×•×˜×• (×œ×¤×™ ×”×—×•×“×©×™× ×©× ×‘×—×¨×•)
    const brutoBTLDetails = [];
    let totalBrutoBTL = 0;
    
    monthsForBruto.forEach(month => {
        // ×‘×¨×•×˜×• ××•×ª×× (×¢× ××™× ×™××•× ×‘×™×˜×•×— ×œ××•××™)
        const adjustedBruto = GetBrutoForMonth(employeeId, month);
        
        // ×‘×¨×•×˜×• ××§×•×¨×™ (×œ×¤× ×™ ×”×ª×××”)
        const monthStart = new Date(month.getFullYear(), month.getMonth(), 1);
        const monthEnd = new Date(month.getFullYear(), month.getMonth() + 1, 0);
        
        let originalBruto = 0;
        for (let salary of salaryData) {
            if (salary.employeeId == employeeId) {
                const salaryDate = parseExcelDate(salary.monthYear);
                if (salaryDate && salaryDate >= monthStart && salaryDate <= monthEnd) {
                    originalBruto = Math.max(originalBruto, salary.bruto || 0);
                }
            }
        }
        
        // ×”×•×¡×¤×” ×œ×¤×™×¨×•×˜ ×‘×¨×•×˜×•
        brutoBTLDetails.push({
            month: (month.getMonth() + 1) + '/' + month.getFullYear(),
            original: originalBruto,
            adjusted: adjustedBruto,
            wasAdjusted: adjustedBruto > originalBruto
        });
        
        totalBrutoBTL += adjustedBruto;
    });
    
    // ×‘× ×™×™×ª ×¤×™×¨×•×˜ ×™××™ ×¢×‘×•×“×” (×ª××™×“ 3 ×—×•×“×©×™× ××—×¨×•× ×™×)
    const workDaysDetails = [];
    let totalWorkDaysCalculated = 0;
    
    monthsForWorkDays.forEach(month => {
        const workDays = GetWorkDaysForMonth(employeeId, month, serviceStartDate);
        
        workDaysDetails.push({
            month: (month.getMonth() + 1) + '/' + month.getFullYear(),
            workDays: workDays
        });
        
        totalWorkDaysCalculated += workDays;
    });
    
    return {
        brutoBTLDetails: brutoBTLDetails,
        totalBrutoBTL: totalBrutoBTL,
        workDaysDetails: workDaysDetails,
        totalWorkDays: totalWorkDaysCalculated,
        calculationType: calculationType,
        monthsUsedForBruto: monthsForBruto.length,  // ×œ××¢×§×‘
        monthsUsedForWorkDays: monthsForWorkDays.length  // ×œ××¢×§×‘
    };
}
function displayResults(data = calculationResults, options = {}) {
    const {
        page = 1,
        itemsPerPage = null,
        showPagination = true,
        title = null,
        subtitle = null,
        showStats = true,
        showExport = true,
        isFiltered = false,
        isSingleEmployee = false,
        employeeId = null,
        sourceData = calculationResults
    } = options;
    
    // ×©××™×¨×ª ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×
    currentDisplayData = data;
    currentDisplayOptions = options;
    
    const container = document.getElementById('resultsContainer');
    
    if (!data || data.length === 0) {
        let emptyMessage = '×œ× × ××¦××• ×ª×•×¦××•×ª';
        if (isFiltered) {
            emptyMessage = '×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×©× ×‘×—×¨';
        }
        container.innerHTML = `<div class="error">${emptyMessage}</div>`;
        return;
    }
    
    let pageData = data;
    let totalPages = 1;
    let start = 0;
    let end = data.length;
    
    if (itemsPerPage && data.length > itemsPerPage) {
        totalPages = Math.ceil(data.length / itemsPerPage);
        start = (page - 1) * itemsPerPage;
        end = start + itemsPerPage;
        pageData = data.slice(start, end);
    }
    
    let html = '';
    
    if (title) {
        html += `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; text-align: center;">
                <h2 style="margin: 0; font-size: 1.5em;">${title}</h2>
                ${subtitle ? `<p style="margin: 5px 0 0 0; opacity: 0.9;">${subtitle}</p>` : ''}
            </div>
        `;
    }
    
    if (isSingleEmployee && employeeId) {
        const totalPeriods = data.length;
        const totalDays = data.reduce((sum, r) => sum + (r.serviceDays || r.miluimDays || 0), 0);
        const totalPayment = data.reduce((sum, r) => sum + ((r.continuousValue || 0) * (r.miluimDays || 0)), 0);
        
        html += `
            <div class="summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="summary-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                    <div class="summary-label" style="color: #666; font-size: 0.9em;">×¡×š ×ª×§×•×¤×•×ª</div>
                    <div class="summary-value" style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">${totalPeriods}</div>
                </div>
                <div class="summary-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                    <div class="summary-label" style="color: #666; font-size: 0.9em;">×¡×š ×™××™ ×©×™×¨×•×ª</div>
                    <div class="summary-value" style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">${totalDays}</div>
                </div>
                <div class="summary-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                    <div class="summary-label" style="color: #666; font-size: 0.9em;">×¡×š ×ª×©×œ×•×</div>
                    <div class="summary-value" style="font-size: 1.5em; font-weight: bold; color: #27ae60;">${formatCurrency(totalPayment)}</div>
                </div>
            </div>
        `;
    }
    
    html += `
        <div class="results-table">
            <table>
                <thead>
                    <tr>
                        <th>×¢×•×‘×“</th>
                        <th>×ª×—×™×œ×”</th>
                        <th>×¡×™×•×</th>
                        <th>×™××™×</th>
                        <th>E - ×¢×¨×š ×‘×¡×™×¡×™</th>
                        <th>F - ×¢×¨×š ××•××œ×¥</th>
                        <th>G - ×¢×¨×š ×¨×¦×™×£</th>
                        <th>I - ×—×™×¨×•× 90</th>
                        <th>J - ××§×¡ 120%</th>
                        <th>K - ×ª×—×™×œ×ª ××©×›×•×œ</th>
                        <th>×¡×š ×ª×©×œ×•×</th>
                        <th>×¤×™×¨×•×˜</th>
                        <th>L-×¢×¨×š ×‘×©×›×¨</th>
                        <th>M-×¤×¢×¨</th>
                        <th>N-×¢×¨×š ×›×¤×™×™×”<th>
                        <th>O -×›×¤×™×™×” ×¨×¦×™×¤×” <th>
                        <th>P - ×›×¤×™×™×” ×—×™×¨×•× 4405</th>

                    </tr>
                </thead>
                <tbody>
    `;
    
    pageData.forEach((result, index) => {
        let correctIndex;
        if (itemsPerPage) {
            correctIndex = start + index;
        } else if (isFiltered) {
            correctIndex = sourceData.findIndex(r => 
                r.employeeId === result.employeeId && 
                r.startDate.getTime() === result.startDate.getTime()
            );
        } else {
            correctIndex = index;
        }
        
        const rowClass = getRowClass ? getRowClass(result) : '';
        
        html += `
            <tr class="${rowClass}">
                <td><strong>${result.employeeId}</strong></td>
                <td>${formatDate(result.startDate)}</td>
                <td>${formatDate(result.endDate)}</td>
                <td>${result.miluimDays || result.serviceDays || 0}</td>
                <td class="${result.calculationType === '×—×œ×•×¤×™' ? 'alternative-calc' : ''}">${result.basicValue ? result.basicValue.toFixed(2) : '0'}</td>
                <td>${result.recommendedValue ? result.recommendedValue.toFixed(2) : '0'}</td>
                <td class="${result.limitedByNewMiluim || result.isValueLocked ? 'locked-value' : ''}">${result.continuousValue ? result.continuousValue.toFixed(2) : '0'} ${result.isValueLocked ? 'ğŸ”’' : ''}</td>
                <td>${result.emergencyValue > 0 ? result.emergencyValue.toFixed(2) : '-'}</td>
                <td>${result.maxEmergencyValue > 0 ? result.maxEmergencyValue.toFixed(2) : '-'}</td>
                <td>${result.emergencyClusterStart ? formatDate(result.emergencyClusterStart) : '-'}</td>
                <td><strong>${formatCurrency((result.continuousValue || 0) * (result.miluimDays || 0))}</strong></td>
                <td><button class="details-btn" onclick="showDetails(${correctIndex})">×¤×™×¨×•×˜</button></td>
                <td>${result.paidAmount || 0}</td>
                <td class="amount-difference ${((result.paidAmount || 0) - (result.continuousValue || 0)) > 0 ? 'positive-diff' : 'negative-diff'}">${((result.paidAmount || 0) - (result.continuousValue || 0)).toFixed(0)}</td>
                <td>${result.compulsion  || 0}</td>
                <td>${result.compulsionContinuous || 0}</td>
                <td>${result.emergencyCompulsion4405 || 0}</td> 
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    if (isFiltered || isSingleEmployee || itemsPerPage) {
        html += `
            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; text-align: center;">
                <strong>××¦×™×’ ${pageData.length} ××ª×•×š ${data.length} ×ª×•×¦××•×ª</strong>
                ${isFiltered && data.length < sourceData.length ? 
                    '<button class="btn" onclick="clearFilters()" style="margin-right: 10px; padding: 5px 15px; font-size: 0.9em;">× ×§×” ×¡×™× ×•×Ÿ</button>' : 
                    ''
                }
                ${isSingleEmployee ? 
                    `<button class="btn" onclick="backToAllEmployees()" style="margin-right: 10px; padding: 5px 15px; font-size: 0.9em;">×—×–×•×¨ ×œ×›×œ ×”×¢×•×‘×“×™×</button>
                     <button class="btn" onclick="exportSingleEmployee('${employeeId}')" style="background: #27ae60; margin-right: 10px; padding: 5px 15px; font-size: 0.9em;">ğŸ“„ ×™×¦× ×œ××§×¡×œ</button>` : 
                    ''
                }
            </div>
        `;
    }
    
    container.innerHTML = html;
    
    // ×”×›×¤×ª×•×¨×™× ×”×—×“×©×™× ×©×œ× ×™×’×¨××• ×œ×©×’×™××•×ª
    if (itemsPerPage && showPagination && totalPages > 1) {
        const paginationDiv = document.createElement('div');
        paginationDiv.style.cssText = 'text-align: center; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;';
        
        paginationDiv.innerHTML = `
            <div style="margin-bottom: 15px; font-size: 1.1em; font-weight: bold;">
                ××¦×™×’ ${start + 1}-${Math.min(end, data.length)} ××ª×•×š ${data.length} ×ª×•×¦××•×ª
            </div>
            <div style="margin-bottom: 15px;">
                ${page > 1 ? `<button class="btn" onclick="navigateToPage(${page-1})" style="margin: 0 5px;">â¬…ï¸ ×¢××•×“ ×§×•×“×</button>` : ''}
                <span style="margin: 0 15px; font-size: 1.1em; font-weight: bold;">×¢××•×“ ${page} ××ª×•×š ${totalPages}</span>
                ${page < totalPages ? `<button class="btn" onclick="navigateToPage(${page+1})" style="margin: 0 5px;">×¢××•×“ ×”×‘× â¡ï¸</button>` : ''}
            </div>
            <div>
                <button class="btn" style="background: #27ae60; margin: 0 5px;" onclick="exportToExcel()">
                    ğŸ“¥ ×™×¦× ×”×›×œ ×œ××§×¡×œ (×›×œ ${sourceData.length} ×”×ª×•×¦××•×ª)
                </button>
                <button class="btn" style="background: #3498db; margin: 0 5px;" onclick="changeItemsPerPage(50)">
                    50 ×‘×¢××•×“
                </button>
                <button class="btn" style="background: #3498db; margin: 0 5px;" onclick="changeItemsPerPage(100)">
                    100 ×‘×¢××•×“
                </button>
                <button class="btn" style="background: #3498db; margin: 0 5px;" onclick="changeItemsPerPage(200)">
                    200 ×‘×¢××•×“
                </button>
            </div>
        `;
        
        container.appendChild(paginationDiv);
    }
    
    if (showStats && typeof updateSummaryStats === 'function') {
        updateSummaryStats(data);
    }
    
    if (showExport) {
        const exportSection = document.getElementById('exportSection');
        if (exportSection) exportSection.style.display = 'block';
    }
    
    if (isSingleEmployee) {
        window.singleEmployeeResults = data;
    }
}

// ğŸ”§ ×”×•×¡×£ 3 ×¤×•× ×§×¦×™×•×ª ×§×˜× ×•×ª ××œ×”:
function navigateToPage(newPage) {
    const newOptions = { ...currentDisplayOptions, page: newPage };
    displayResults(currentDisplayData, newOptions);
}

function changeItemsPerPage(newItemsPerPage) {
    const newOptions = { ...currentDisplayOptions, itemsPerPage: newItemsPerPage, page: 1 };
    displayResults(currentDisplayData, newOptions);
}

console.log('ğŸ”§ ×ª×™×§×•×Ÿ pagination ×˜×¢×•×Ÿ!');

// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
function updateSummaryStats(data = calculationResults) {
    const uniqueEmployees = new Set(data.map(r => r.employeeId)).size;
    const totalPeriods = data.length;
    const totalDays = data.reduce((sum, r) => sum + (r.miluimDays || 0), 0);
    const totalPayment = data.reduce((sum, r) => sum + ((r.continuousValue || 0) * (r.miluimDays || 0)), 0);
    
    const statsElements = {
        totalEmployees: document.getElementById('totalEmployees'),
        totalPeriods: document.getElementById('totalPeriods'),
        totalDays: document.getElementById('totalDays'),
        totalPayment: document.getElementById('totalPayment')
    };
    
    if (statsElements.totalEmployees) statsElements.totalEmployees.textContent = uniqueEmployees;
    if (statsElements.totalPeriods) statsElements.totalPeriods.textContent = totalPeriods;
    if (statsElements.totalDays) statsElements.totalDays.textContent = totalDays;
    if (statsElements.totalPayment) statsElements.totalPayment.textContent = formatCurrency(totalPayment);
    
    const summaryStats = document.getElementById('summaryStats');
    if (summaryStats) summaryStats.style.display = 'grid';
}
function showDetails(index) {
    const result = calculationResults[index];
    
    // ×”×¤×•× ×§×¦×™×” getExtendedCalculationDetails ×©×œ×š (×ª×‘×™× ××ª ×”× ×ª×•× ×™× ×”×—×¡×¨×™×)
    const extendedDetails = getExtendedCalculationDetails(result.employeeId, result.startDate);
  
    // ×‘× ×™×™×ª ×”×¤×™×¨×•×˜ ×”××•×¨×—×‘ ×©×œ×š (××ª×•×§×Ÿ)
    let extendedDetailsHtml = '';
    if (extendedDetails) {
        extendedDetailsHtml = `
            <div class="calculation-step">
                <div class="step-title">×¤×™×¨×•×˜ ××•×¨×—×‘ - ×‘×¨×•×˜×• ×‘×™×˜×•×— ×œ××•××™ ×•×™××™ ×¢×‘×•×“×” âœ…</div>
                <div class="step-detail">
                    <h4>×‘×¨×•×˜×• ×‘×¤×•×¢×œ ×©×©×™××© ×œ×—×™×©×•×‘:</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 14px;">
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <th style="border: 1px solid #ddd; padding: 8px;">×—×•×“×©</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">×‘×¨×•×˜×• ××§×•×¨×™</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">×‘×¨×•×˜×• ×œ×‘×™×˜×•×— ×œ××•××™</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">×”×•×ª××</th>
                        </tr>`;
        
        extendedDetails.brutoBTLDetails.forEach(month => {
            extendedDetailsHtml += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${month.month}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${month.original.toFixed(2)} â‚ª</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center; ${month.wasAdjusted ? 'background: #fff3cd;' : ''}">${month.adjusted.toFixed(2)} â‚ª</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${month.wasAdjusted ? 'V' : ''}</td>
                </tr>`;
        });
        
        extendedDetailsHtml += `
                    </table>
                    <p><strong>×¡×”"×› ×‘×¨×•×˜×• ×œ×‘×™×˜×•×— ×œ××•××™: ${extendedDetails.totalBrutoBTL.toFixed(2)} â‚ª</strong></p>
                    
                    <h4>×™××™ ×¢×‘×•×“×” ×‘-90 ×™××™× ×©×§×“××• ×œ×©×™×¨×•×ª (×œ×¤×™ ×’×™×œ×™×•×Ÿ 1857):</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 14px;">
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <th style="border: 1px solid #ddd; padding: 8px;">×—×•×“×©</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">×™××™ ×¢×‘×•×“×” ×‘×¤×•×¢×œ</th>
                        </tr>`;
        
        extendedDetails.workDaysDetails.forEach(month => {
            extendedDetailsHtml += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${month.month}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${month.workDays}</td>
                </tr>`;
        });
        
        extendedDetailsHtml += `
                    </table>
                    <p><strong>×¡×”"×› ×™××™ ×¢×‘×•×“×”: ${extendedDetails.totalWorkDays} ×™××™×</strong></p>
                    <p><strong>×¡×•×’ ×—×™×©×•×‘: ${extendedDetails.calculationType}</strong></p>
                </div>
            </div>`;
    }
    
    // **×”×—×œ×§ ×”××ª×•×§×Ÿ - ×¢× ×”×©×“×•×ª ×”× ×›×•× ×™× ×©×§×™×™××™× ×‘-result**
    let html = `
        <h2>×¤×™×¨×•×˜ ×—×™×©×•×‘ ××¤×•×¨×˜ âœ…</h2>
        <h3>×¢×•×‘×“ ${result.employeeId} | ${formatDate(result.startDate)} - ${formatDate(result.endDate)}</h3>
        
        ${extendedDetailsHtml}
        
        <div class="calculation-step">
            <div class="step-title">×©×œ×‘ 1: ××™×¡×•×£ × ×ª×•× ×™ ×©×›×¨ ×•× ×•×›×—×•×ª</div>
            <div class="step-detail">
                <strong>×¡×•×’ ×—×™×©×•×‘:</strong> ${result.calculationType || '×œ× ×–××™×Ÿ'}<br>
                <strong>×™××™ ×¢×‘×•×“×” ×‘-3 ×—×•×“×©×™×:</strong> ${extendedDetails?.totalWorkDays || '×œ× ×–××™×Ÿ'}<br>
                <strong>×¡×”"×› ×‘×¨×•×˜×• (3 ×—×•×“×©×™×):</strong> ${extendedDetails?.totalBrutoBTL ? formatCurrency(extendedDetails.totalBrutoBTL) : '×œ× ×–××™×Ÿ'}
                ${result.calculationType === '×—×œ×•×¤×™' ? '<br><span style="color: #e74c3c; font-weight: bold;">××–×”×¨×”: ×¤×—×•×ª ×-60 ×™××™ ×¢×‘×•×“×” - ××¢×‘×¨ ×œ×—×™×©×•×‘ ×—×œ×•×¤×™</span>' : ''}
            </div>
        </div>
        
        <div class="calculation-step">
            <div class="step-title">×©×œ×‘ 2: ×—×™×©×•×‘ ×¢×¨×š ×™×•××™ ×‘×¡×™×¡×™ (Column E)</div>
            <div class="step-detail">
                ×¢×¨×š ×’×•×œ××™: ${extendedDetails?.totalBrutoBTL ? (extendedDetails.totalBrutoBTL / 90).toFixed(2) : '×œ× ×–××™×Ÿ'} â‚ª<br>
                <strong>×¢×¨×š ×œ××—×¨ ×”×’×‘×œ×•×ª:</strong> ${result.basicValue ? result.basicValue.toFixed(2) : '×œ× ×–××™×Ÿ'} â‚ª
            </div>
        </div>
        
        <div class="calculation-step">
            <div class="step-title">×©×œ×‘ 3: ×¢×¨×š ××•××œ×¥ 60 ×™××™× (Column F)</div>
            <div class="step-detail">
                ${result.startDate >= new Date('2025-05-01') ? '××™×œ×•××™× ×—×“×©×™× - ×œ× ×‘×•×“×§ ×©×™×¨×•×ª ×§×•×“×' : '×‘×“×™×§×ª ×©×™×¨×•×ª ×§×•×“× ×‘-60 ×™××™× ××—×¨×•× ×™×'}<br>
                <strong>×¢×¨×š ××•××œ×¥:</strong> ${result.recommendedValue ? result.recommendedValue.toFixed(2) : '×œ× ×–××™×Ÿ'} â‚ª
            </div>
        </div>
        
        <div class="calculation-step">
            <div class="step-title">×©×œ×‘ 4: ×¢×¨×š ×¨×¦×™×£ (Column G) ${result.isValueLocked ? 'ğŸ”’ × ×¢×•×œ' : ''}</div>
            <div class="step-detail ${result.isValueLocked ? 'locked-value' : ''}">
                ${result.isValueLocked ? '× ×¢×™×œ×ª ×¢×¨×š ×œ××™×œ×•××™× ×—×“×©×™×<br>' : ''}
                <strong>×¢×¨×š ×¨×¦×™×£ ×¡×•×¤×™:</strong> ${result.continuousValue ? result.continuousValue.toFixed(2) : '×œ× ×–××™×Ÿ'} â‚ª<br>
                ${result.startDate >= new Date('2023-10-07') ? '×—×œ ×œ×•×’×™×§×ª ××™×œ×•××™ ×—×™×¨×•×' : '××™×œ×•××™× ×¨×’×™×œ×™×'}
                ${result.isValueLocked ? '<br><span style="color: #ff9800; font-weight: bold;">×¢×¨×š ×”×•×’×‘×œ ×¢×‘×•×¨ ××™×œ×•××™× ×—×“×©×™× ×œ××§×¡×™××•× 120% ×©×œ ×ª×—×™×œ×ª ×”××©×›×•×œ</span>' : ''}
                ${result.emergencyClusterStart ? '<br><strong>×ª×—×™×œ×ª ××©×›×•×œ ×—×™×¨×•×:</strong> ' + formatDate(result.emergencyClusterStart) : ''}
                ${result.emergencyValue > 0 ? '<br><strong>×¢×¨×š ×—×™×¨×•× 90:</strong> ' + result.emergencyValue.toFixed(2) + ' â‚ª' : ''}
            </div>
        </div>
        
        <div class="calculation-step" style="background: #e8f5e8; border-right-color: #4caf50;">
            <div class="step-title">×ª×•×¦××” ×¡×•×¤×™×ª âœ…</div>
            <div class="step-detail">
                <strong>×™××™ ××™×œ×•××™×:</strong> ${result.miluimDays || '×œ× ×–××™×Ÿ'}<br>
                <strong>×¢×¨×š ×™×•××™ ×¡×•×¤×™:</strong> ${result.continuousValue ? result.continuousValue.toFixed(2) : '×œ× ×–××™×Ÿ'} â‚ª<br>
                <strong>×¡×”"×› ×ª×©×œ×•×:</strong> ${result.continuousValue && result.miluimDays ? formatCurrency(result.continuousValue * result.miluimDays) : '×œ× ×–××™×Ÿ'}
                ${result.maxEmergencyValue > 0 ? 
                    '<br><strong>×ª×©×œ×•× ×—×™×¨×•× ××§×¡×™××œ×™:</strong> ' + formatCurrency(result.maxEmergencyValue * result.miluimDays) : ''}
            </div>
        </div>
    `;
    
    document.getElementById('detailsContent').innerHTML = html;
    document.getElementById('detailsModal').style.display = 'block';
}
      // Export functionality - ××¢×•×“×›×Ÿ ×¢× ×¢×¨×š ×›×¤×™×™×” ×¨×¦×•×£
function exportToExcel() {
    // ×™×¦×™×¨×ª ×”× ×ª×•× ×™× ×”××¡×•× × ×™× ×‘×–××Ÿ ×”×™×™×¦×•×
    let dataToExport = [...calculationResults];
    
    // ×”×—×œ ××•×ª×Ÿ ×¡×™× ×•× ×™× ×©×§×™×™××™× ×‘××××©×§
    const employeeFilter = document.getElementById('employeeFilter').value.trim();
    const yearFilter = document.getElementById('yearFilter').value;
    const miluimTypeFilter = document.getElementById('miluimTypeFilter').value;
    
    // ××•×ª×” ×œ×•×’×™×§×ª ×¡×™× ×•×Ÿ ×›××• ×‘-applyFilters
    if (employeeFilter) {
        dataToExport = dataToExport.filter(result => 
            result.employeeId.toString().includes(employeeFilter)
        );
    }
    
    if (yearFilter) {
        dataToExport = dataToExport.filter(result => 
            result.startDate.getFullYear().toString() === yearFilter
        );
    }
    
    if (miluimTypeFilter) {
        dataToExport = dataToExport.filter(result => {
            switch (miluimTypeFilter) {
                case 'regular':
                    return result.startDate < EMERGENCY_START;
                case 'emergency':
                    return result.startDate >= EMERGENCY_START && result.startDate < NEW_MILUIM_START;
                case 'new':
                    return result.isNewMiluim;
                case 'locked':
                    return result.limitedByNewMiluim || result.isValueLocked;
                case 'gap':
                    const calculatedDifference = (result.paidAmount || 0) - (result.continuousValue || 0);
                    return Math.abs(calculatedDifference) > 1;
               case 'crossMonth':
               if (!result.isCrossMonth) return false;
             break;
                     default:                   
                    return true;
            }
        });
    }
    
    if (dataToExport.length === 0) {
        alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×.');
        return;
    }
    
// ×”×©×ª××© ×‘× ×ª×•× ×™× ×”×§×™×™××™× ×¢× ×”×›×¤×™×™×” ×”×¨×¦×™×¤×” ×©×›×‘×¨ ×—×•×©×‘×”
const processedData = dataToExport;
    
    const wsData = [
        ['××¡×¤×¨ ×¢×•×‘×“', '×ª××¨×™×š ×”×ª×—×œ×”', '×ª××¨×™×š ×¡×™×•×', '×™××™ ××™×œ×•××™×', 'E - ×¢×¨×š ×‘×¡×™×¡×™', 'F - ×¢×¨×š ××•××œ×¥', 'G - ×¢×¨×š ×¨×¦×™×£', 'I - ×—×™×¨×•× 90', 'J - ××§×¡×™××•× 120%', 'K - ×ª×—×™×œ×ª ××©×›×•×œ', '×¡×”×´×› ×ª×©×œ×•×', '×¡×•×’ ×—×™×©×•×‘', '××™×œ×•××™× ×—×“×©×™×', '××©×›×•×œ ×—×™×¨×•×', 'L - ×¢×¨×š ×‘×©×›×¨', 'M - ×¤×¢×¨','N-×¢×¨×š ×›×¤×™×™×”','O - ×›×¤×™×™×” ×¨×¦×™×¤×”',
'p-×›×¤×™×™×” 4405']
    ];    
   
   for (let result of processedData) {
        wsData.push([
            result.employeeId,
            result.startDate,                       
            result.endDate,                         
            parseInt(result.miluimDays),            
            parseFloat(result.basicValue.toFixed(2)),           
            parseFloat(result.recommendedValue.toFixed(2)),     
            parseFloat(result.continuousValue.toFixed(2)),      
            result.emergencyValue > 0 ? parseFloat(result.emergencyValue.toFixed(2)) : '',
            result.maxEmergencyValue > 0 ? parseFloat(result.maxEmergencyValue.toFixed(2)) : '',
            result.emergencyClusterStart || '',     
            parseFloat((result.continuousValue * result.miluimDays).toFixed(2)), 
            result.calculationType,
            result.isNewMiluim ? '×›×Ÿ' : '×œ×',
            result.isNewCluster ? '×›×Ÿ' : '×œ×',
            parseFloat(result.paidAmount || 0),     
            parseFloat(((result.paidAmount || 0) - result.continuousValue).toFixed(0)), 
            parseFloat(result.compulsion || 0),
            parseFloat(result.compulsionContinuous || 0),
            parseFloat(result.emergencyCompulsion4405 || 0)
        ]);
    }
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // ×”×’×“×¨×ª ×¤×•×¨××˜×™× ×œ×ª××™×
    const range = XLSX.utils.decode_range(ws['!ref']);

    for (let R = 1; R <= range.e.r; R++) {
        // ×ª××¨×™×›×™× (×¢××•×“×•×ª B, C, J)
        ['B', 'C', 'J'].forEach(col => {
            const cellAddress = col + (R + 1);
            if (ws[cellAddress] && ws[cellAddress].v instanceof Date) {
                ws[cellAddress].z = 'dd/mm/yyyy';
                ws[cellAddress].t = 'd';
            }
        });
        
        // ××¡×¤×¨×™× ×©×œ××™× (×¢××•×“×” D)
        const dCellAddress = 'D' + (R + 1);
        if (ws[dCellAddress] && typeof ws[dCellAddress].v === 'number') {
            ws[dCellAddress].z = '0';
            ws[dCellAddress].t = 'n';
        }
        
         // ×¡×›×•××™ ×›×¡×£ (×¢××•×“×•×ª E, F, G, H, I, K, O, Q)
        ['E', 'F', 'G', 'H', 'I', 'K', 'O', 'Q'].forEach(col => {
            const cellAddress = col + (R + 1);
            if (ws[cellAddress] && typeof ws[cellAddress].v === 'number') {
                ws[cellAddress].z = '#,##0.00"â‚ª"';
                ws[cellAddress].t = 'n';
            }
        });
    }
    
    // Auto-size columns
    const colWidths = wsData[0].map(() => ({ wch: 15 }));
    ws['!cols'] = colWidths;
    
    XLSX.utils.book_append_sheet(wb, ws, '×ª×•×¦××•×ª ××™×œ×•××™×');
    
    const fileName = `×ª×•×¦××•×ª_××™×œ×•××™×_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
}


        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            
            // ×”×•×“×¢×ª ×œ×•×’ ×¢×œ ×”×ª×™×§×•× ×™×
            console.log('ğŸ”¥ ××—×©×‘×•×Ÿ ××™×œ×•××™× - ×’×¨×¡×” ××ª×•×§× ×ª!');
            console.log('âœ… ×ª×•×§×Ÿ: parseExcelDate (value-1 ×‘××§×•× value-2)');
            console.log('âœ… ×ª×•×§×Ÿ: ApplyBrutoMinimumFromCSV ××•×’×“×¨');
            console.log('âœ… ×ª×•×§×Ÿ: ApplyFinalLimitsFromCSV ××•×’×“×¨');
            console.log('âœ… ×ª×•×§×Ÿ: GetBrutoForMonth ××—×™×œ ×‘×¨×•×˜×• ××™× ×™××œ×™');
            console.log('âœ… ×ª×•×§×Ÿ: calculateBasicDailyValue ××©×ª××© ×‘×’×‘×•×œ×•×ª ×¡×•×¤×™×™×');
            
            document.getElementById('calculateBtn').addEventListener('click', function() {
    const uniqueEmployees = [...new Set(miluimData.map(m => m.employeeId))];
    
    console.log(`××¡×¤×¨ ×¢×•×‘×“×™× ×œ×—×™×©×•×‘: ${uniqueEmployees.length}`);
    
    // ×× ×™×© ×™×•×ª×¨ ×-100 ×¢×•×‘×“×™×, ×”×©×ª××© ×‘×’×¨×¡×” ×”××§×•×˜×¢×ª
    if (uniqueEmployees.length > 100) {
        console.log('××©×ª××© ×‘×—×™×©×•×‘ ××§×•×˜×¢ (Batched)');
        calculateMiluim({
            batchSize: 20,
            showProgress: true,
            enableCancel: true
        });
    } else {
        console.log('Ã®Ã¹ÃºÃ®Ã¹ Ã¡Ã§Ã©Ã¹Ã¥Ã¡ Ã¸Ã¢Ã©Ã¬');
        calculateMiluim({
            batchSize: 0,
            showProgress: false
        });
    }
});

            // Event listeners ×œ×¢×•×‘×“ ×‘×•×“×“
if (document.getElementById('employeeInput')) {
    document.getElementById('employeeInput').addEventListener('input', validateEmployee);
    document.getElementById('employeeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !document.getElementById('calculateSingleBtn').disabled) {
           const selectedEmployee = document.getElementById('employeeInput').value.trim();
    calculateMiluim({
        employeeIds: [selectedEmployee],
        addEmployeeHeader: true,
        batchSize: 0
    });
        }
    });
}
            
            document.getElementById('clearBtn').addEventListener('click', function() {
                miluimData = [];
                salaryData = [];
                attendanceData = [];
                calculationResults = [];
                
                // Reset upload status
                document.querySelector('.upload-card').classList.remove('uploaded');
                updateUploadStatus(false);
                
                // Reset sheet status
                updateSheetStatus('sheet1Status', false, 'ğŸ“Š ×’×œ×™×•×Ÿ ××™×œ×•××™×: âŒ');
                updateSheetStatus('sheet2Status', false, 'ğŸ’° ×’×œ×™×•×Ÿ ×©×›×¨: âŒ');
                updateSheetStatus('sheet3Status', false, 'ğŸ“… ×’×œ×™×•×Ÿ × ×•×›×—×•×ª: âŒ');
                document.getElementById('sheetsStatus').style.display = 'none';
                
                // Clear file input
                document.getElementById('excelFile').value = '';
                
                // Remove messages
                document.querySelectorAll('.success, .error').forEach(msg => msg.remove());
                
                // Reset UI
                document.getElementById('calculateBtn').disabled = true;
                document.getElementById('resultsContainer').innerHTML = '';
                document.getElementById('summaryStats').style.display = 'none';
                document.getElementById('exportSection').style.display = 'none';
            });
            
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            
            // Modal close
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('detailsModal').style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('detailsModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Filters - ×¢× ×¤×•× ×§×¦×™×” ×’×œ×•×‘×œ×™×ª
            document.getElementById('employeeFilter').addEventListener('input', applyFilters);
            document.getElementById('yearFilter').addEventListener('change', applyFilters);
            document.getElementById('miluimTypeFilter').addEventListener('change', applyFilters);
            
            // ×”×•×¡×¤×ª ×¤×•× ×§×¦×™×” ×’×œ×•×‘×œ×™×ª
            window.clearFilters = clearFilters;
        });
// ××©×ª× ×” ×’×œ×•×‘×œ×™
let filterWorker = null;

// ×™×¦×™×¨×ª Inline Worker
function createInlineWorker() {
     const workerCode = `
        // ğŸ”¥ ×¤×•× ×§×¦×™×” ×¤×©×•×˜×” ×œ×—×™×©×•×‘ ×ª××¨×™×š ×-Excel
        function simpleExcelToDate(serialNumber) {
            if (typeof serialNumber !== 'number') return null;
            
            const resultDate = new Date(1900, 0, 1);
            resultDate.setDate(resultDate.getDate() + serialNumber - 2);
            return new Date(resultDate.getFullYear(), resultDate.getMonth(), resultDate.getDate());
        }

        self.onmessage = function(e) {
            const { results, filters, miluimData } = e.data;
            self.miluimData = miluimData;
                
            // ×”×¡×™× ×•×Ÿ
            let filteredResults = results.filter(result => {
                // ×¡×™× ×•×Ÿ ×¢×•×‘×“
                if (filters.employee && !result.employeeId.toString().includes(filters.employee)) {
                    return false;
                }
                
                // ×¡×™× ×•×Ÿ ×©× ×”
                if (filters.year && result.startDate.getFullYear().toString() !== filters.year) {
                    return false;
                }
                
                // ×¡×™× ×•×Ÿ ×¡×•×’ ××™×œ×•××™×
                if (filters.miluimType) {
                    switch (filters.miluimType) {
                        case 'new':
                            if (!result.isNewMiluim) return false;
                            break;
                        case 'locked':
                            if (!(result.limitedByNewMiluim || result.isValueLocked)) return false;
                            break;
                        case 'gap':
                            if (Math.abs(result.paidAmount - result.continuousValue) <= 1) return false;
                            break;
                        case 'crossMonth':
                       if (!result.isCrossMonth) return false;
                      break;
                        case 'regular':
                            // ×¦×¨×™×š ×œ×”×¢×‘×™×¨ ×§×‘×•×¢×™×
                            const EMERGENCY_START = new Date('2023-10-07');
                            if (result.startDate >= EMERGENCY_START) return false;
                            break;
                        case 'emergency':
                            const EMERGENCY_START2 = new Date('2023-10-07');
                            const NEW_MILUIM_START = new Date('2025-05-01');
                            if (!(result.startDate >= EMERGENCY_START2 && result.startDate < NEW_MILUIM_START)) return false;
                            break;
                    }
                }
                
                return true;
            });
            
            self.postMessage(filteredResults);
        };
    `;
    
    const blob = new Blob([workerCode], { type: 'application/javascript' });
    return new Worker(URL.createObjectURL(blob));
}

// ××ª×—×•×œ Worker
function initFilterWorker() {
    if (!filterWorker) {
        try {
            filterWorker = createInlineWorker();
            console.log('Inline Web Worker × ×•×¦×¨ ×‘×”×¦×œ×—×”');
        } catch (error) {
            console.error('×©×’×™××” ×‘×™×¦×™×¨×ª Worker:', error);
            return false;
        }
    }
    return true;
}

function applyFilters() {
    if (calculationResults.length === 0) return;
    
    // × ×¡×” ×œ×™×¦×•×¨ Worker
    if (!initFilterWorker()) {
        console.log('× ×—×–×•×¨ ×œ×¡×™× ×•×Ÿ ×¨×’×™×œ');
        applyFiltersRegular();
        return;
    }
    
    // ×”×›×Ÿ ×¤×™×œ×˜×¨×™×
    const filters = {
        employee: document.getElementById('employeeFilter').value.trim(),
        year: document.getElementById('yearFilter').value,
        miluimType: document.getElementById('miluimTypeFilter').value
    };
    
    // ×”×¦×’ Loading
    document.getElementById('resultsContainer').innerHTML = `
        <div class="loading" style="padding: 40px; text-align: center;">
            ğŸ”„ ××¡× ×Ÿ ${calculationResults.length} ×ª×•×¦××•×ª ×‘×¨×§×¢...
        </div>
    `;  
      
    // ×©×œ×— ×œWorker
      filterWorker.postMessage({
        results: calculationResults,
        filters: filters,
        miluimData: miluimData  // ğŸ”¥ ×”×•×¡×£ ××ª ×”× ×ª×•× ×™× ×”××§×•×¨×™×™×
    });
    
    // ×§×‘×œ ×ª×•×¦××•×ª
    filterWorker.onmessage = function(e) {
        const filteredResults = e.data;
        console.log(`×¡×™× ×•×Ÿ ×”×¡×ª×™×™×: ${filteredResults.length} ××ª×•×š ${calculationResults.length}`);
        
        // âœ… ×ª×™×§×•×Ÿ: ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×”×—×“×©×” ×‘××§×•× ×”×§×•×“ ×”××¡×•×›×Ÿ ×”×™×©×Ÿ
        if (filteredResults.length > 200) {
            // âŒ ×§×•×“ ×™×©×Ÿ ××¡×•×›×Ÿ:
            // const originalResults = calculationResults;
            // calculationResults = filteredResults;
            // displayResultsPaginated(1, 50);
            // calculationResults = originalResults;
            
            // âœ… ×§×•×“ ×—×“×© ×‘×˜×•×—:
            displayResults(filteredResults, { 
                isFiltered: true, 
                sourceData: calculationResults,
                itemsPerPage: 50,
                page: 1,
                title: 'ğŸ” ×ª×•×¦××•×ª ××¡×•× × ×•×ª (×¢× ×¢××•×“×™×)'
            });
        } else {
            // âŒ ×§×•×“ ×™×©×Ÿ:
            // displayFilteredResults(filteredResults);
            
            // âœ… ×§×•×“ ×—×“×©:
            displayResults(filteredResults, { 
                isFiltered: true, 
                sourceData: calculationResults,
                title: 'ğŸ” ×ª×•×¦××•×ª ××¡×•× × ×•×ª'
            });
        }
        
        // âŒ ×–×” ×œ× × ×“×¨×© ×™×•×ª×¨ - ×”×¤×•× ×§×¦×™×” ×”×—×“×©×” ×¢×•×©×” ×–××ª ××•×˜×•××˜×™×ª:
        // updateFilteredStats(filteredResults);
    };
    
    filterWorker.onerror = function(error) {
        console.error('×©×’×™××” ×‘-Worker:', error);
        applyFiltersRegular();
    };
}

// âœ… ×’× ×ª×§× ×™ ××ª applyFiltersRegular (×× ×™×© ×œ×š):
function applyFiltersRegular() {
    if (calculationResults.length === 0) return;
    
    // ×”×›×Ÿ ×¤×™×œ×˜×¨×™×
    const filters = {
        employee: document.getElementById('employeeFilter').value.trim(),
        year: document.getElementById('yearFilter').value,
        miluimType: document.getElementById('miluimTypeFilter').value
    };
    
    // ×¡× ×Ÿ ××ª ×”× ×ª×•× ×™×
    let filteredResults = [...calculationResults];
    
    // ×¡×™× ×•×Ÿ ×œ×¤×™ ××¡×¤×¨ ×¢×•×‘×“
    if (filters.employee) {
        filteredResults = filteredResults.filter(result => 
            result.employeeId.toString().includes(filters.employee)
        );
    }
    
    // ×¡×™× ×•×Ÿ ×œ×¤×™ ×©× ×”
    if (filters.year) {
        filteredResults = filteredResults.filter(result => 
            result.startDate.getFullYear().toString() === filters.year
        );
    }
    
    // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×•×’ ××™×œ×•××™×
    if (filters.miluimType) {
        filteredResults = filteredResults.filter(result => {
            switch (filters.miluimType) {
                case 'regular':
                    const EMERGENCY_START = new Date('2023-10-07');
                    return result.startDate < EMERGENCY_START;
                case 'emergency':
                    const EMERGENCY_START2 = new Date('2023-10-07');
                    const NEW_MILUIM_START = new Date('2025-05-01');
                    return result.startDate >= EMERGENCY_START2 && result.startDate < NEW_MILUIM_START;
                case 'new':
                    return result.isNewMiluim;
                case 'locked':
                    return result.limitedByNewMiluim || result.isValueLocked;
                case 'gap':
                    return Math.abs((result.paidAmount || 0) - result.continuousValue) > 0.01;
                case 'crossMonth':
                    const startDate = new Date(result.startDate);
                    const endDate = new Date(result.endDate);
                    return (startDate.getMonth() !== endDate.getMonth() || 
                            startDate.getFullYear() !== endDate.getFullYear());
                default:
                    return true;
            }
        });
    }
    
    // âœ… ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×”×—×“×©×”
    displayResults(filteredResults, { 
        isFiltered: true, 
        sourceData: calculationResults,
        title: filteredResults.length < calculationResults.length ? 'ğŸ” ×ª×•×¦××•×ª ××¡×•× × ×•×ª' : null
    });
}
      
        function updateFilteredStats(filteredResults) {
            const uniqueEmployees = new Set(filteredResults.map(r => r.employeeId)).size;
            const totalPeriods = filteredResults.length;
            const totalDays = filteredResults.reduce((sum, r) => sum + r.miluimDays, 0);
            const totalPayment = filteredResults.reduce((sum, r) => sum + (r.continuousValue * r.miluimDays), 0);
            
            document.getElementById('totalEmployees').textContent = uniqueEmployees;
            document.getElementById('totalPeriods').textContent = totalPeriods;
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('totalPayment').textContent = formatCurrency(totalPayment);
        }

        function clearFilters() {
            document.getElementById('employeeFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('miluimTypeFilter').value = '';
            displayResults(calculationResults, { 
            itemsPerPage: calculationResults.length > 500 ? 100 : null });
            updateSummaryStats();
        }
// ========================
// ×©×œ×‘ ×‘' - ×× ×œ×™×–×” ××ª×§×“××ª
// ========================
function analyzeGaps_basic() {
    console.log("ğŸ” ××ª×—×™×œ × ×™×ª×•×— ×¤×¢×¨×™×...");
    
    if (!calculationResults || calculationResults.length === 0) {
        alert("âŒ ×œ× × ××¦××• ×ª×•×¦××•×ª ×—×™×©×•×‘. ×”×¨×¥ ×ª×—×™×œ×” '×—×©×‘ ××™×œ×•××™×'");
        return;
    }
    
    const analysis = categorizeGaps();
    showAnalysisWindow(analysis);
}

function categorizeGaps() {
    // ×‘×“×™×§×ª Debug
    console.log("ğŸ” ×”×ª×—×œ×ª ×‘×“×™×§×ª ×¤×¢×¨×™×...");
    console.log("××¡×¤×¨ ×ª×•×¦××•×ª:", calculationResults.length);

    const categories = {
        monthlyRule: { name: "×¢×¨×š ×‘×’×™×Ÿ ×—×•×“×©×™ (×œ×¤× ×™ 1.5.2025)", status: "ok", items: [], icon: "âœ…" },
        continuousValue: { name: "×¢×¨×š ×›×¤×•×™ ××¨×¦×£", status: "ok", items: [], icon: "âœ…" },
        higherValue60DayIssue: { name: "×ª×§×œ×ª ×—×•×§×” - ×™×© ×œ×ª×ª ×¢×¨×š ×‘×’×™×Ÿ ×-60 ×™×•× (××™×œ×•××™× ×¨×’×™×œ×™×)", status: "fix", items: [], icon: "ğŸš«" },
        newMiluimHigherValueIssue: { name: "×ª×§×œ×ª ×—×•×§×” - ××™×Ÿ ×œ×ª×ª ×¢×¨×š ×‘×’×™×Ÿ ×-60 ×™×•× (××™×œ×•××™× ×—×“×©×™×)", status: "fix", items: [], icon: "âš ï¸" },
        forceValueNotApplied: { name: "××™ ×”×—×œ×ª ×¢×¨×š ×›×¤×™×™×”", status: "fix", items: [], icon: "ğŸš¨" },
        emergencyCompulsionNotApplied: { name: "×ª×§×œ×ª ×—×•×§×” - ×œ× ×”×•×—×œ ×›×¤×™×™×ª ×¢×¨×š ×—×™×¨×•×", status: "fix", items: [], icon: "âš¡" },
        minimumValueIssue: { name: "×©×•×œ× ×¢×¨×š ×§×˜×Ÿ ××©×›×¨ ××™× ×™××•×", status: "fix", items: [], icon: "ğŸ’°" },
        incorrectMinimumBruto: { name: "×ª×§×œ×” ×‘×—×•×§×” - ×‘×¨×•×˜×• ××™× ×™××œ×™ ×œ× ×ª×§×™×Ÿ", status: "fix", items: [], icon: "ğŸ“Š" },
        unknown: { name: "×œ× ××–×•×”×”", status: "check", items: [], icon: "ğŸ¤”" }
    };
    
    let totalRecords = calculationResults.length;
    let gapsFound = 0;
    let noGaps = 0;
    const analysisStartDate = new Date('2023-01-01');
    
    calculationResults.forEach(result => {
        if (result.startDate < analysisStartDate) {
            return;
        }
        
        const columnG = result.continuousValue || 0;
        const columnL = result.paidAmount || 0;
        const columnO = result.compulsionContinuous || 0;
        const columnP = result.emergencyCompulsion4405 || 0;
        let categoryFound = false;
        
        // **×©×œ×‘ 1: ×‘×“×™×§×ª ×¢×¨×›×™ ×›×¤×™×™×” - ×–×” ×—×™×™×‘ ×œ×”×ª×××” ×œ×¢×¨×š ××©×•×œ×!**
        
        // ×‘×“×™×§×” 1.1: ×¢×¨×š ×›×¤×•×™ ××¨×¦×£ (×¢××•×“×” O)
        if (columnO > 0 && Math.abs(columnL - columnO) > 1) {
            categories.forceValueNotApplied.items.push({
                employeeId: result.employeeId,
                period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                gap: (columnL - columnO).toFixed(2),
                columnG: columnG.toFixed(2),
                columnL: columnL.toFixed(2),
                columnO: columnO.toFixed(2),
                explanation: "×™×© ×¢×¨×š ×›×¤×•×™ ××¨×¦×£ - ×œ× ×”×•×ª×× ×œ×ª×©×œ×•×",
                details: `×©×•×œ× ${columnL}â‚ª ×‘××§×•× ${columnO}â‚ª - ×¤×¢×¨ ×©×œ ${(columnL - columnO).toFixed(2)}â‚ª`
            });
            categoryFound = true;
            gapsFound++;
        }
        
        // ×‘×“×™×§×” 1.2: ×¢×¨×š ×›×¤×™×™×ª ×—×™×¨×•× (×¢××•×“×” P) - ××™×œ×•××™× ×—×“×©×™×
       if (result.isNewMiluim && columnP > 0 && Math.abs(columnL - columnP) > 1) {
            categories.emergencyCompulsionNotApplied.items.push({
                employeeId: result.employeeId,
                period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                gap: (columnL - columnP).toFixed(2),
                columnG: columnG.toFixed(2),
                columnL: columnL.toFixed(2),
                columnP: columnP.toFixed(2),
                explanation: "××™×œ×•××™× ×—×“×©×™× - ×©×•×œ× ×™×•×ª×¨ ××¢×¨×š ×”×›×¤×™×™×” ×”×—×™×¨×•×",
                details: `×©×•×œ× ${columnL}â‚ª ×‘××§×•× ${columnP}â‚ª - ×™×ª×¨×ª ×ª×©×œ×•× ${(columnL - columnP).toFixed(2)}â‚ª`
            });
            categoryFound = true;
            gapsFound++;
        }
        
        // **×©×œ×‘ 2: ×‘×“×™×§×•×ª ×›×©××™×Ÿ ×¢×¨×›×™ ×›×¤×™×™×” (O=0 ×•-P=0)**
        else if (columnO === 0 && columnP === 0 && Math.abs(columnG - columnL) > 1) {
            
            // ×‘×“×™×§×” 2.1: ×¢×¨×š ×§×˜×Ÿ ××©×›×¨ ××™× ×™××•×
            if (checkMinimumValue(columnL, result.startDate)) {
                const minimumDaily = getMinimumDailyForDate(result.startDate);
                categories.minimumValueIssue.items.push({
                    employeeId: result.employeeId,
                    period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                    gap: (minimumDaily - columnL).toFixed(2),
                    columnG: columnG.toFixed(2),
                    columnL: columnL.toFixed(2),
                    explanation: "×©×•×œ× ×¢×¨×š ×§×˜×Ÿ ××©×›×¨ ××™× ×™××•×",
                    details: `×©×•×œ× ${columnL}â‚ª - ×¤×—×•×ª ××”××™× ×™××•× ${minimumDaily}â‚ª ×œ×ª××¨×™×š ×”×©×™×¨×•×ª`
                });
                categoryFound = true;
                gapsFound++;
            }
            
            // ×‘×“×™×§×” 2.2: ×‘×“×™×§×ª ×‘×¨×•×˜×• ××™× ×™××œ×™ ×œ× ×ª×§×™×Ÿ
            else {
                const alternativeValue = calculateBasicFromMinimumDaily(result.employeeId, result.startDate);
                if (Math.abs(columnL - alternativeValue) <= 1 && Math.abs(columnG - columnL) <= 1) {
                    categories.incorrectMinimumBruto.items.push({
                        employeeId: result.employeeId,
                        period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                        gap: (columnG - columnL).toFixed(2),
                        columnG: columnG.toFixed(2),
                        columnL: columnL.toFixed(2),
                        explanation: "×ª×§×œ×” ×‘×—×•×§×” - ×‘×¨×•×˜×• ××™× ×™××œ×™ ×œ× ×ª×§×™×Ÿ",
                        details: `×—×•×©×‘ ×œ×¤×™ ×‘×¨×•×˜×• ××™× ×™××œ×™ ${alternativeValue.toFixed(2)}â‚ª ×‘××§×•× ×¢×¨×š × ×›×•×Ÿ ${columnG.toFixed(2)}â‚ª`
                    });
                    categoryFound = true;
                    gapsFound++;
                }
                
                // ×‘×“×™×§×” 2.3: ×¤×•× ×§×¦×™×™×ª ××‘×—×•×Ÿ ××ª×§×“××ª - ××™×œ×•××™× ×¨×’×™×œ×™× ×©×œ× ×§×™×‘×œ×• ×¢×¨×š ×’×‘×•×” ×-60 ×™×•×
                else {
                    const diagnosis = diagnoseGapWithNewMethods(result);
                    if (diagnosis && diagnosis.issue === "60DayHigherValueNotGiven") {
                        categories.higherValue60DayIssue.items.push({
                            employeeId: result.employeeId,
                            period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                            gap: (diagnosis.columnF - diagnosis.columnL).toFixed(2),
                            columnG: diagnosis.columnG.toFixed(2),
                            columnL: diagnosis.columnL.toFixed(2),
                            explanation: diagnosis.explanation,
                            details: `×—×™×©×•×‘ ×‘×¡×™×¡×™ (E): ${diagnosis.columnE.toFixed(2)}â‚ª | ×¢×¨×š ×-60 ×™×•× (F): ${diagnosis.columnF.toFixed(2)}â‚ª | ×©×•×œ×: ${diagnosis.columnL.toFixed(2)}â‚ª`
                        });
                        categoryFound = true;
                        gapsFound++;
                    }
                    
                    // ×‘×“×™×§×” 2.4: ×¤×•× ×§×¦×™×™×ª ××‘×—×•×Ÿ ××ª×§×“××ª - ××™×œ×•××™× ×—×“×©×™× ×©×§×™×‘×œ×• ×¢×¨×š ×’×‘×•×”
                    else {
                        const newMiluimDiagnosis = diagnoseNewMiluimHigherValue(result);
                        if (newMiluimDiagnosis && newMiluimDiagnosis.issue === "NewMiluimHigherValueGiven") {
                            categories.newMiluimHigherValueIssue.items.push({
                                employeeId: result.employeeId,
                                period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                                gap: (newMiluimDiagnosis.columnL - newMiluimDiagnosis.columnE).toFixed(2),
                                columnG: columnG.toFixed(2),
                                columnL: newMiluimDiagnosis.columnL.toFixed(2),
                                columnE: newMiluimDiagnosis.columnE.toFixed(2),
                                explanation: newMiluimDiagnosis.explanation,
                                details: `×”×™×” ×¦×¨×™×š ×œ×§×‘×œ ×¢×¨×š ×‘×¡×™×¡×™ ${newMiluimDiagnosis.columnE.toFixed(2)}â‚ª ××‘×œ ×§×™×‘×œ ${newMiluimDiagnosis.columnL.toFixed(2)}â‚ª`
                            });
                            categoryFound = true;
                            gapsFound++;
                        }
                        
                        // ×‘×“×™×§×” 2.5: ×‘×“×™×§×•×ª × ×•×¡×¤×•×ª (××”×§×•×“ ×”××§×•×¨×™)
                        else {
                            const gap = Math.abs(columnG - columnL);
                            
                            // ×‘×“×™×§×ª ×›×œ×œ ×—×•×“×©×™ ××ª×§×“×
                            const monthlyCheck = checkMonthlyRuleAdvanced(result, calculationResults);
                            if (monthlyCheck) {
                                categories.monthlyRule.items.push({
                                    employeeId: result.employeeId,
                                    period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                                    gap: gap.toFixed(2),
                                    columnG: columnG.toFixed(2),
                                    columnL: columnL.toFixed(2),
                                    explanation: monthlyCheck.explanation,
                                    details: `${monthlyCheck.monthPeriods} ×ª×§×•×¤×•×ª ×‘××•×ª×• ×—×•×“×©, ×¢×¨×›×™×: ${monthlyCheck.allValues.map(v => v.toFixed(2)).join(', ')}â‚ª`
                                });
                                categoryFound = true;
                                gapsFound++;
                            }
                            
                            // ×‘×“×™×§×ª ×¢×¨×š ×›×¤×•×™ ××¨×¦×£ - ×”×ª×××”
                            else {
                                const compulsionValue = result.compulsionContinuous || 0;
                                const compulsionOriginal = result.compulsion || 0;
                                
                                const matchesN = compulsionOriginal > 0 && Math.abs(columnL - compulsionOriginal) <= 1;
                                const matchesO = compulsionValue > 0 && Math.abs(columnL - compulsionValue) <= 1;
                                
                                if (matchesN || matchesO) {
                                    categories.continuousValue.items.push({
                                        employeeId: result.employeeId,
                                        period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                                        gap: gap.toFixed(2),
                                        columnG: columnG.toFixed(2),
                                        columnL: columnL.toFixed(2),
                                        columnN: result.compulsion || 0,
                                        columnO: result.compulsionContinuous || 0,
                                        explanation: "×ª×§×•×¤×” ×¢× ×¢×¨×š ×›×¤×•×™ ×ª×§×™×Ÿ",
                                        details: matchesN ? 
                                            `×ª×•×× ×¢××•×“×” N: ${compulsionOriginal}â‚ª` : 
                                            `×ª×•×× ×¢××•×“×” O: ${compulsionValue}â‚ª`
                                    });
                                    categoryFound = true;
                                    gapsFound++;
                                }
                                
                              
                                // ×œ× ××–×•×”×”
                                else {
                                    categories.unknown.items.push({
                                        employeeId: result.employeeId,
                                        period: `${formatDate(result.startDate)} - ${formatDate(result.endDate)}`,
                                        gap: gap.toFixed(2),
                                        columnG: columnG.toFixed(2),
                                        columnL: columnL.toFixed(2),
                                        explanation: "×¡×™×‘×ª ×”×¤×¢×¨ ×œ× ×‘×¨×•×¨×”",
                                        details: "×“×•×¨×© ×‘×“×™×§×” ×™×“× ×™×ª"
                                    });
                                    categoryFound = true;
                                    gapsFound++;
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // ×× ×œ× × ××¦× ×¤×¢×¨ ××• ×”×¤×¢×¨ ×§×˜×Ÿ ×-1 ×©"×—
        if (!categoryFound) {
            noGaps++;
        }
    });
    
    return {
        totalRecords,
        gapsFound,
        noGaps,
        categories
    };
}
   
function diagnoseGapWithNewMethods(result) {
    const columnG = result.continuousValue || 0;
    const columnL = result.paidAmount || 0;
    const gap = Math.abs(columnG - columnL);
    const tolerance = 1.0;
    
    if (gap <= tolerance) {
        return null;
    }
    
    const employeeId = result.employeeId;
    const serviceStartDate = result.startDate;
    
    // ×ª×™×§×•×Ÿ - ×©×™××•×© × ×›×•×Ÿ ×‘×¤×•× ×§×¦×™×•×ª
    const basicResult = calculateBasicDailyValue(employeeId, serviceStartDate);
    const columnE = basicResult.dailyValue; // ×œ×§×—×ª ××ª dailyValue ××”××•×‘×™×™×§×˜
    
    const columnF = calculateRecommendedValue(employeeId, serviceStartDate, columnE); // ×”×¢×‘×¨×ª basicValue
    
    console.log(`Debug for employee ${employeeId}:`);
    console.log(`columnE (basic): ${columnE}`);
    console.log(`columnF (recommended): ${columnF}`);
    console.log(`columnG (continuous): ${columnG}`);
    console.log(`columnL (paid): ${columnL}`);
  
    // ×”×ª× ××™× ×œ×–×™×”×•×™ "×ª×§×œ×ª ×—×•×§×” - ×™×© ×œ×ª×ª ×¢×¨×š ×’×‘×•×” ×-60 ×™×•×":
const condition1 = Math.abs(columnL - columnE) <= tolerance; // L = E (×©×•×œ× ×œ×¤×™ ×‘×¡×™×¡×™)
const condition2 = columnF > columnE; // F ×’×‘×•×” ×-E (×™×© ×¢×¨×š ×’×‘×•×” ×™×•×ª×¨ ×-60 ×™×•×)
const condition3 = Math.abs(columnG - columnF) <= tolerance; // G = F (×”××¢×¨×›×ª ×—×™×©×‘×” × ×›×•×Ÿ)
const condition4 = !result.isNewMiluim; // ğŸ†• ×œ× ××™×œ×•××™× ×—×“×©×™×!

if (condition1 && condition2 && condition3 && condition4) {
    return {
        issue: "60DayHigherValueNotGiven",
        explanation: "×ª×§×œ×ª ×—×•×§×” - ×™×© ×œ×ª×ª ×¢×¨×š ×’×‘×•×” ×-60 ×™×•× ××—×¨×•× ×™×",
        columnE: columnE,
        columnF: columnF,
        columnG: columnG,
        columnL: columnL,
        shouldHavePaid: columnF
    };
}
    
    // ×× ×œ× - ×”××©×š ×œ×‘×“×™×§×•×ª ××—×¨×•×ª...
    return null;
}
function diagnoseNewMiluimHigherValue(result) {
    if (!result.isNewMiluim) return null;
    
    const columnG = result.continuousValue || 0;
    const columnL = result.paidAmount || 0;
    const tolerance = 1.0;
    
    // ×—×™×©×•×‘ ×¢×¨×š ×‘×¡×™×¡×™
    const basicResult = calculateBasicDailyValue(result.employeeId, result.startDate);
    const columnE = basicResult.dailyValue;
    
    // ×‘×“×™×§×”: ×”×× ×©×•×œ× ×™×•×ª×¨ ××”×¢×¨×š ×”×‘×¡×™×¡×™?
    if (Math.abs(columnL - columnE) <= tolerance) {
        return null; // ×©×•×œ× ×¢×¨×š ×‘×¡×™×¡×™ - ×ª×§×™×Ÿ
    }
    
    if (columnL > columnE + tolerance) {
        return {
            issue: "NewMiluimHigherValueGiven",
            explanation: "××™×œ×•××™× ×—×“×©×™× - ×©×•×œ× ×¢×¨×š ×’×‘×•×” ×‘××§×•× ×‘×¡×™×¡×™",
            columnE: columnE,
            columnL: columnL,
            shouldHavePaid: columnE
        };
    }
    
    return null;
}
// ========================
// ×¤×•× ×§×¦×™×™×ª ×‘×“×™×§×” ××ª×§×“××ª - ×›×œ×œ ×—×•×“×©×™
// ========================
function checkMonthlyRuleAdvanced(result, allResults) {
    // ×ª× ××™ 1: ×œ×¤× ×™ 1.5.2025
    if (result.startDate >= new Date('2025-05-01')) {
        return null; // ×œ× ×¨×œ×•×•× ×˜×™
    }
    
    // ××¦×™××ª ×—×•×“×©+×©× ×” ×©×œ ×”×ª×§×•×¤×” ×”× ×•×›×—×™×ª
    const currentMonth = result.startDate.getMonth();
    const currentYear = result.startDate.getFullYear();
    
    // ××¦×™××ª ×›×œ ×”×ª×§×•×¤×•×ª ×‘××•×ª×• ×—×•×“×© (×©×œ ××•×ª×• ×¢×•×‘×“)
    const sameMonthPeriods = allResults.filter(r => 
        r.employeeId === result.employeeId &&
        r.startDate.getMonth() === currentMonth &&
        r.startDate.getFullYear() === currentYear
    );
    
    // ×ª× ××™ 2: ×™×© ×™×•×ª×¨ ××ª×§×•×¤×” ××—×ª ×‘××•×ª×• ×—×•×“×©
    if (sameMonthPeriods.length <= 1) {
        return null; // ××™×Ÿ ××¡×¤×¨ ×ª×§×•×¤×•×ª
    }
    
    // ×ª× ××™ 3: ×™×© ×¢×¨×›×™× ×©×•× ×™× ×‘×¢××•×“×” G
    const columnGValues = sameMonthPeriods.map(r => r.continuousValue || 0);
    const uniqueValues = [...new Set(columnGValues)];
    if (uniqueValues.length <= 1) {
        return null; // ×›×œ ×”×¢×¨×›×™× ×–×”×™×
    }
    
    // ×ª× ××™ 4: ×”×¢×¨×š ×‘×¢××•×“×” L = ×”×¢×¨×š ×”×’×‘×•×” ×‘×™×•×ª×¨ ×‘×¢××•×“×” G
    const maxColumnG = Math.max(...columnGValues);
    const currentColumnL = result.paidAmount || 0;
    
    // ×‘×“×™×§×” ×× ×”×¢×¨×š ×‘×©×›×¨ ×ª×•×× ×œ×¢×¨×š ×”×’×‘×•×” (×¡×˜×™×™×” ×¢×“ 1 ×©"×—)
    if (Math.abs(currentColumnL - maxColumnG) <= 1) {
        return {
            matched: true,
            explanation: `×”×—×•×§×” ×”×—×™×œ×” ×¢×¨×š ×’×‘×•×” (${maxColumnG.toFixed(2)}â‚ª) ×-${sameMonthPeriods.length} ×ª×§×•×¤×•×ª ×‘××•×ª×• ×—×•×“×©`,
            monthPeriods: sameMonthPeriods.length,
            maxValue: maxColumnG,
            allValues: uniqueValues
        };
    }
    
    return null; // ×œ× ×ª×•×× ×œ×›×œ×œ
}

// ×—×™×©×•×‘ ×œ×¤×™ ×©×œ×•×©×” ×—×•×“×©×™× ××—×¨×•× ×™× ××•×ª×× ×œ×‘×¨×•×˜×• ××™× ××œ×™
function calculateAlwaysLast3WithMinimum(employeeId, serviceStartDate) {
    const serviceMonth = new Date(serviceStartDate.getFullYear(), serviceStartDate.getMonth(), 1);
    
    const month1 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 1, 1);
    const month2 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 2, 1);
    const month3 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 3, 1);
    
    let totalBruto = 0;
    totalBruto += GetBrutoForMonth(employeeId, month1);
    totalBruto += GetBrutoForMonth(employeeId, month2);
    totalBruto += GetBrutoForMonth(employeeId, month3);
    
    return totalBruto / 90;
}

function calculateBest3From6WithMinimum(employeeId, serviceStartDate) {
    const serviceMonth = new Date(serviceStartDate.getFullYear(), serviceStartDate.getMonth(), 1);
    
    // ×‘× ×™×™×ª ×¨×©×™××ª 6 ×”×—×•×“×©×™× ×”××—×¨×•× ×™×
    const months = [];
    for (let i = 1; i <= 6; i++) {
        const month = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - i, 1);
        months.push({
            date: month,
            bruto: GetBrutoForMonth(employeeId, month) // ×¢× ××™× ×™××•× ×‘×¨×•×˜×•
        });
    }
    
    // ××™×•×Ÿ ×œ×¤×™ ×‘×¨×•×˜×• ××”×’×‘×•×” ×œ× ××•×š ×•×œ×§×™×—×ª 3 ×”×˜×•×‘×™×
    const bestMonths = months
        .sort((a, b) => b.bruto - a.bruto)
        .slice(0, 3);
    
    // ×—×™×©×•×‘ ×¡×›×•× ×‘×¨×•×˜×• ×©×œ 3 ×”×—×•×“×©×™× ×”×˜×•×‘×™×
    const totalBruto = bestMonths.reduce((sum, month) => sum + month.bruto, 0);
    
    // ×—×–×¨×ª ×¢×¨×š ×™×•××™
    return totalBruto / 90;
}
// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×—×“×©×•×ª - ××—×•×¥ ×œ×¤×•× ×§×¦×™×” ×”×¨××©×™×ª
function checkMinimumValue(columnL, serviceStartDate) {
    // ××¦×™××ª ×”×¢×¨×š ×”××™× ×™××œ×™ ×œ×¤×™ ×ª××¨×™×š ×”×©×™×¨×•×ª
    for (let limit of DAILY_LIMITS) {
        if (serviceStartDate >= limit.start && serviceStartDate <= limit.end) {
            return columnL < limit.min;
        }
    }
    // Default to latest limits if no match found
    const latestLimit = DAILY_LIMITS[DAILY_LIMITS.length - 1];
    return columnL < latestLimit.min;
}

function getMinimumDailyForDate(serviceStartDate) {
    // ××¦×™××ª ×”×¢×¨×š ×”××™× ×™××œ×™ ×œ×¤×™ ×ª××¨×™×š ×”×©×™×¨×•×ª
    for (let limit of DAILY_LIMITS) {
        if (serviceStartDate >= limit.start && serviceStartDate <= limit.end) {
            return limit.min;
        }
    }
    // Default to latest limits if no match found
    const latestLimit = DAILY_LIMITS[DAILY_LIMITS.length - 1];
    return latestLimit.min;
}

function calculateBasicFromMinimumDaily(employeeId, serviceStartDate) {
    // ×¤×•× ×§×¦×™×” ×©××—×§×” ××ª ×ª×§×œ×ª ×”×—×•×§×”: ×©×™××•×© ×‘×‘×¨×•×˜×• ××™× ×™××œ×™ ××—×•×©×‘ (×™×•× ××™× ×™××•× * 30)
    // ×‘××§×•× ×”×‘×¨×•×˜×• ××™× ×™××œ×™ ×”×§×‘×•×¢ ××”×˜×‘×œ×”
    
    const minimumDaily = getMinimumDailyForDate(serviceStartDate);
    const calculatedMinimumMonthly = minimumDaily * 30; // ×”×ª×§×œ×” - ×—×™×©×•×‘ ×‘××§×•× ×§×‘×•×¢!
    
    // ×—×™×©×•×‘ ×–×”×” ×œ×¤×•× ×§×¦×™×” ×”××§×•×¨×™×ª
    const serviceMonth = new Date(serviceStartDate.getFullYear(), serviceStartDate.getMonth(), 1);
    
    const month1 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 1, 1);
    const month2 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 2, 1);
    const month3 = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - 3, 1);
    
    // ×‘×“×™×§×ª ×™××™ ×¢×‘×•×“×” ×‘-3 ×—×•×“×©×™× (×›××• ×‘×¤×•× ×§×¦×™×” ×”××§×•×¨×™×ª)
    const workDays1 = GetWorkDaysForMonth(employeeId, month1, serviceStartDate);
    const workDays2 = GetWorkDaysForMonth(employeeId, month2, serviceStartDate);
    const workDays3 = GetWorkDaysForMonth(employeeId, month3, serviceStartDate);
    const totalWorkDays = workDays1 + workDays2 + workDays3;
    
    let totalBruto = 0;
    
    if (totalWorkDays >= 60) {
        // ×—×™×©×•×‘ ×¨×’×™×œ - 3 ×—×•×“×©×™×, ××‘×œ ×¢× ×‘×¨×•×˜×• ××—×•×©×‘ (×”×ª×§×œ×”)
        // ×‘××§×•× GetBrutoForMonth (×©××—×™×œ ×§×‘×•×¢×™× × ×›×•× ×™×), × ×©×ª××© ×‘×‘×¨×•×˜×• ×”××—×•×©×‘ ×”×©×’×•×™
        const bruto1 = Math.max(getBestBrutoForMonth(employeeId, month1), calculatedMinimumMonthly);
        const bruto2 = Math.max(getBestBrutoForMonth(employeeId, month2), calculatedMinimumMonthly);
        const bruto3 = Math.max(getBestBrutoForMonth(employeeId, month3), calculatedMinimumMonthly);
        totalBruto = bruto1 + bruto2 + bruto3;
    } else {
        // ×—×™×©×•×‘ ×—×œ×•×¤×™ - 3 ×”×—×•×“×©×™× ×”×˜×•×‘×™× ×-6, ××‘×œ ×¢× ×‘×¨×•×˜×• ××—×•×©×‘
        const months = [];
        for (let i = 1; i <= 6; i++) {
            const month = new Date(serviceMonth.getFullYear(), serviceMonth.getMonth() - i, 1);
            const brutoBest = getBestBrutoForMonth(employeeId, month);
            const brutoWithCalculatedMin = Math.max(brutoBest, calculatedMinimumMonthly);
            months.push({ date: month, bruto: brutoWithCalculatedMin });
        }
        
        // ××™×•×Ÿ ×œ×¤×™ ×‘×¨×•×˜×• ×™×•×¨×“ ×•×œ×§×™×—×ª 3 ×”×˜×•×‘×™×
        months.sort((a, b) => b.bruto - a.bruto);
        totalBruto = months.slice(0, 3).reduce((sum, month) => sum + month.bruto, 0);
    }
    
    const dailyValue = totalBruto / 90;
    let finalValue = ApplyFinalLimitsFromCSV(dailyValue, serviceStartDate);
    
    return finalValue;
}

// ×¤×•× ×§×¦×™×” ×¢×–×¨ - ××—×–×™×¨×” ×‘×¨×•×˜×• ×’×•×œ××™ ×‘×œ×™ ×”×—×œ×ª ××™× ×™××•× (×œ×¤× ×™ ×”×ª×§×œ×”)
function getBestBrutoForMonth(employeeId, monthDate) {
    const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
    const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
    
    let bestBruto = 0;
    
    for (let salary of salaryData) {
        if (salary.employeeId == employeeId) {
            const salaryDate = parseExcelDate(salary.monthYear);
            if (salaryDate && salaryDate >= monthStart && salaryDate <= monthEnd) {
                bestBruto = Math.max(bestBruto, salary.bruto || 0);
            }
        }
    }
    
    return bestBruto; // ×œ×œ× ×”×—×œ×ª ××™× ×™××•× - ×–×” ××” ×©×”×™×” ×œ×¤× ×™ ×”×ª×§×œ×”
}
// ğŸ†• ×¤×•× ×§×¦×™×” ×œ×™×™×¦×•× × ×™×ª×•×— ×¤×¢×¨×™× ×œ××§×¡×œ
function exportGapsToExcel() {
    console.log("ğŸ”„ ××ª×—×™×œ ×™×™×¦×•× × ×™×ª×•×— ×¤×¢×¨×™× ×œ××§×¡×œ...");
    
    // ×—×™×©×•×‘ ×”× ×ª×•× ×™× ××—×“×©
    const analysis = categorizeGaps();
    
    // ×™×¦×™×¨×ª workbook ×—×“×©
    const wb = XLSX.utils.book_new();
    
    // 1. ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×¡×™×›×•×
    createSummarySheet(wb, analysis);
    
    // 2. ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×œ×›×œ ×§×˜×’×•×¨×™×” ×¢× ×¤×¨×™×˜×™×
    Object.entries(analysis.categories).forEach(([categoryKey, category]) => {
        if (category.items.length > 0) {
            createCategorySheet(wb, categoryKey, category);
        }
    });
    
    // 3. ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×›×œ ×”×¤×¢×¨×™×
    createAllGapsSheet(wb, analysis);
    
    // ×™×¦×™×¨×ª ×©× ×§×•×‘×¥ ×¢× ×ª××¨×™×š ×•×©×¢×”
    const now = new Date();
    const timestamp = now.toISOString().slice(0, 16).replace(/[:-]/g, '').replace('T', '_');
    const filename = `× ×™×ª×•×—_×¤×¢×¨×™×_${timestamp}.xlsx`;
    
    // ×”×•×¨×“×ª ×”×§×•×‘×¥
    XLSX.writeFile(wb, filename);
    
    console.log(`âœ… ×™×™×¦×•× ×”×•×©×œ×: ${filename}`);
    alert(`âœ… ×”×§×•×‘×¥ × ×•×¦×¨ ×‘×”×¦×œ×—×”!\nğŸ“ ${filename}`);
}

// ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×¡×™×›×•×
function createSummarySheet(wb, analysis) {
    const summaryData = [
        ['× ×™×ª×•×— ×¤×¢×¨×™× - ×¡×™×›×•× ×× ×”×œ×™×', '', '', ''],
        ['×ª××¨×™×š ×™×¦×™×¨×”:', new Date().toLocaleDateString('he-IL'), '', ''],
        ['', '', '', ''],
        ['ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×•×ª', '', '', ''],
        ['×¡×”"×› ×¨×©×•××•×ª:', analysis.totalRecords, '', ''],
        ['×œ×œ× ×¤×¢×¨×™×:', analysis.noGaps, `${(analysis.noGaps/analysis.totalRecords*100).toFixed(1)}%`, ''],
        ['×¤×¢×¨×™× ×–×•×”×•:', analysis.gapsFound, `${(analysis.gapsFound/analysis.totalRecords*100).toFixed(1)}%`, ''],
        ['', '', '', ''],
        ['ğŸ“‹ ×¤×™×¨×•×˜ ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª', '', '', ''],
        ['×§×˜×’×•×¨×™×”', '××¡×¤×¨ ××§×¨×™×', '××—×•×–', '×¡×˜×˜×•×¡']
    ];
    
    // ×”×•×¡×¤×ª × ×ª×•× ×™ ×§×˜×’×•×¨×™×•×ª
    Object.entries(analysis.categories).forEach(([key, category]) => {
        if (category.items.length > 0) {
            const percentage = ((category.items.length / analysis.totalRecords) * 100).toFixed(1);
            const statusText = category.status === 'ok' ? '×ª×§×™×Ÿ' : 
                              category.status === 'fix' ? '×“×•×¨×© ×ª×™×§×•×Ÿ' : '×‘×“×™×§×”';
            summaryData.push([
                category.name,
                category.items.length,
                `${percentage}%`,
                statusText
            ]);
        }
    });
    
    const ws = XLSX.utils.aoa_to_sheet(summaryData);
    
    // ×¢×™×¦×•×‘ ×”×’×œ×™×•×Ÿ
    ws['!cols'] = [
        { wch: 30 }, // ×¢××•×“×” A
        { wch: 15 }, // ×¢××•×“×” B  
        { wch: 15 }, // ×¢××•×“×” C
        { wch: 15 }  // ×¢××•×“×” D
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, '×¡×™×›×•×');
}

// ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×œ×§×˜×’×•×¨×™×” ×¡×¤×¦×™×¤×™×ª
function createCategorySheet(wb, categoryKey, category) {
    const data = [
        [`${category.icon} ${category.name}`, '', '', '', '', ''],
        ['×¢×•×‘×“', '×ª×§×•×¤×”', '×¤×¢×¨ (×©"×—)', '×¢××•×“×” G', '×¢××•×“×” L', '×”×¡×‘×¨'],
        []
    ];
    
    // ×”×•×¡×¤×ª × ×ª×•× ×™ ×”×¤×¨×™×˜×™×
    category.items.forEach(item => {
        data.push([
            item.employeeId,
            item.period,
            item.gap,
            item.columnG,
            item.columnL,
            item.explanation + (item.details ? ` | ${item.details}` : '')
        ]);
    });
    
    // ×”×•×¡×¤×ª ×¡×™×›×•× ×‘×ª×—×ª×™×ª
    const totalGap = category.items.reduce((sum, item) => sum + parseFloat(item.gap), 0);
    data.push([]);
    data.push(['×¡×™×›×•×:', '', totalGap.toFixed(2), '', '', `${category.items.length} ××§×¨×™×`]);
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    ws['!cols'] = [
        { wch: 12 }, // ×¢×•×‘×“
        { wch: 25 }, // ×ª×§×•×¤×”
        { wch: 12 }, // ×¤×¢×¨
        { wch: 12 }, // ×¢××•×“×” G
        { wch: 12 }, // ×¢××•×“×” L
        { wch: 40 }  // ×”×¡×‘×¨
    ];
    
    // ×©× ×”×’×œ×™×•×Ÿ (××§×•×¦×¨ ×œ××§×¡×™××•× 31 ×ª×•×•×™×)
    let sheetName = category.name.substring(0, 31);
    if (sheetName.endsWith('...')) {
        sheetName = sheetName.substring(0, 28) + '...';
    }
    
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
}

// ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×¢× ×›×œ ×”×¤×¢×¨×™×
function createAllGapsSheet(wb, analysis) {
    const data = [
        ['×›×œ ×”×¤×¢×¨×™× ×”××–×•×”×™×', '', '', '', '', '', ''],
        ['×¢×•×‘×“', '×ª×§×•×¤×”', '×¤×¢×¨ (×©"×—)', '×¢××•×“×” G', '×¢××•×“×” L', '×§×˜×’×•×¨×™×”', '×”×¡×‘×¨'],
        []
    ];
    
    // ××™×¡×•×£ ×›×œ ×”×¤×¨×™×˜×™× ××›×œ ×”×§×˜×’×•×¨×™×•×ª
    Object.entries(analysis.categories).forEach(([key, category]) => {
        category.items.forEach(item => {
            data.push([
                item.employeeId,
                item.period,
                item.gap,
                item.columnG,
                item.columnL,
                category.name,
                item.explanation + (item.details ? ` | ${item.details}` : '')
            ]);
        });
    });
    
    // ×”×•×¡×¤×ª ×¡×™×›×•× ×›×œ×œ×™
    const totalItems = Object.values(analysis.categories).reduce((sum, cat) => sum + cat.items.length, 0);
    const totalGapAmount = Object.values(analysis.categories)
        .flatMap(cat => cat.items)
        .reduce((sum, item) => sum + parseFloat(item.gap), 0);
    
    data.push([]);
    data.push(['×¡×”"×›:', '', totalGapAmount.toFixed(2), '', '', `${totalItems} ××§×¨×™×`, '']);
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    ws['!cols'] = [
        { wch: 12 }, // ×¢×•×‘×“
        { wch: 25 }, // ×ª×§×•×¤×”  
        { wch: 12 }, // ×¤×¢×¨
        { wch: 12 }, // ×¢××•×“×” G
        { wch: 12 }, // ×¢××•×“×” L
        { wch: 20 }, // ×§×˜×’×•×¨×™×”
        { wch: 50 }  // ×”×¡×‘×¨
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, '×›×œ ×”×¤×¢×¨×™×');
}
function showAnalysisWindow(analysis) {
    // ×”×¦×’×ª ×¡×™×›×•×
    document.getElementById('analysisSummary').innerHTML = `
        <div class="summary-stat">
            <h4>×¡×”"×› ×¨×©×•××•×ª</h4>
            <div style="font-size: 1.5em; color: #2196f3;">${analysis.totalRecords}</div>
        </div>
        <div class="summary-stat">
            <h4>×œ×œ× ×¤×¢×¨×™×</h4>
            <div style="font-size: 1.5em; color: #4caf50;">${analysis.noGaps}</div>
            <small>(${(analysis.noGaps/analysis.totalRecords*100).toFixed(1)}%)</small>
        </div>
        <div class="summary-stat">
            <h4>×¤×¢×¨×™× ×–×•×”×•</h4>
            <div style="font-size: 1.5em; color: #ff9800;">${analysis.gapsFound}</div>
            <small>(${(analysis.gapsFound/analysis.totalRecords*100).toFixed(1)}%)</small>
        </div>
        <h2>ğŸ” × ×™×ª×•×— ×¤×¢×¨×™× ××¤×•×¨×˜</h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="exportGapsToExcel()" style="background: #2e7d32; color: white;">
                ğŸ“Š ×™×™×¦× ×œ××§×¡×œ
            </button>
            <button class="btn" onclick="closeAnalysisWindow()" style="background: #d32f2f; color: white;">
                âŒ ×¡×’×•×¨
            </button>
        </div>
    `;
    
    // ×”×¦×’×ª ×§×˜×’×•×¨×™×•×ª
    let categoriesHTML = '';
    Object.entries(analysis.categories).forEach(([key, category]) => {
        if (category.items.length > 0) {
            const statusIcon = category.status === 'ok' ? 'âœ…' : category.status === 'fix' ? 'âŒ' : 'ğŸ¤”';
            const statusText = category.status === 'ok' ? '×ª×§×™×Ÿ' : category.status === 'fix' ? '×“×•×¨×© ×ª×™×§×•×Ÿ' : '×‘×“×™×§×” ×™×“× ×™×ª';
            
            categoriesHTML += `
                <div class="category-box category-${category.status}">
                    <div class="category-header" onclick="toggleCategory('${key}')">
                        <span>${statusIcon} ${category.name}</span>
                        <span>${category.items.length} ××§×¨×™× | ${statusText}</span>
                    </div>
                    <div class="category-content" id="category-${key}">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f0f0f0;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">×¢×•×‘×“</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">×ª×§×•×¤×”</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">×¢××•×“×” G</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">×¢××•×“×” L</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">×¤×¢×¨</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">×”×¡×‘×¨</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">×¤×¨×˜×™× × ×•×¡×¤×™×</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${category.items.map(item => `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>${item.employeeId}</strong></td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${item.period}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${item.columnG} â‚ª</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; background: #e8f5e8;"><strong>${item.columnL} â‚ª</strong></td>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #ff9800;">${item.gap} â‚ª</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.9em;">${item.explanation}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.8em; color: #666;">${item.details || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    });
    
    document.getElementById('analysisCategories').innerHTML = categoriesHTML;
    
    // ×”×¦×’×ª ×”×—×œ×•×Ÿ
    document.getElementById('analysisOverlay').style.display = 'block';
    document.getElementById('analysisWindow').style.display = 'block';
}

function toggleCategory(categoryId) {
    const content = document.getElementById('category-' + categoryId);
    content.style.display = content.style.display === 'block' ? 'none' : 'block';
}

function closeAnalysis() {
    document.getElementById('analysisOverlay').style.display = 'none';
    document.getElementById('analysisWindow').style.display = 'none';
}
    </script>
<!-- ×—×œ×•×Ÿ ×× ×œ×™×–×” × ×¤×¨×“ -->
<div class="overlay" id="analysisOverlay" onclick="closeAnalysis()"></div>
<div class="analysis-window" id="analysisWindow">
    <div class="analysis-header">
        <h2>ğŸ” × ×™×ª×•×— ×¤×¢×¨×™× ×‘××™×œ×•××™×</h2>
        <button class="close-btn" onclick="closeAnalysis()">Ã—</button>
    </div>
    
    <div class="analysis-content">
        <div class="analysis-summary" id="analysisSummary">
            <!-- ×¡×™×›×•× ×›×œ×œ×™ -->
        </div>
        
        <div class="analysis-categories" id="analysisCategories">
            <!-- ×§×˜×’×•×¨×™×•×ª ×¤×¢×¨×™× -->
        </div>
    </div>
</div>
</body>
</html>
