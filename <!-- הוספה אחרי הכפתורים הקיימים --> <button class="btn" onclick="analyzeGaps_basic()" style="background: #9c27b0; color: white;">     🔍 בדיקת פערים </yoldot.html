<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×ª×‘×™×¢×•×ª ×“××™ ×œ×™×“×”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .back-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* ×›×¤×ª×•×¨ ×‘×—×™×¨×ª ×ª×™×§×™×™×” */
        .folder-select-area {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border: 3px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder-select-area:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .folder-select-area.loaded {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .folder-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            margin: 5px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        /* ×¡×˜×˜×™×¡×˜×™×§×•×ª */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        /* ×¡×™× ×•× ×™× */
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .filter-item input, .filter-item select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        /* ×˜×‘×œ×” */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* ×¡×˜×˜×•×¡ dropdown */
        .status-select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            min-width: 150px;
        }

        .status-select:focus {
            outline: none;
            border-color: #3498db;
        }

        /* ×”×¢×¨×•×ª */
        .notes-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .notes-btn:hover {
            background: #8e44ad;
        }

        /* ××•×“××œ ×”×¢×¨×•×ª */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .modal-content textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            resize: vertical;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .hidden {
            display: none;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }

        .message.success {
            background: #d5f4e6;
            color: #27ae60;
            border: 2px solid #27ae60;
        }

        .message.error {
            background: #fadbd8;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        .message.info {
            background: #e3f2fd;
            color: #3498db;
            border: 2px solid #3498db;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="back-btn" onclick="window.location.href='../index.html'">ğŸ  ×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
            <h1>ğŸ‘¶ ××¢×¨×›×ª ×ª×‘×™×¢×•×ª ×“××™ ×œ×™×“×”</h1>
            <p>× ×™×”×•×œ ×§×‘×¦×™ MASHOV ×•××¢×§×‘ ×¡×˜×˜×•×¡×™×</p>
        </div>

        <!-- ×‘×—×™×¨×ª ×ª×™×§×™×™×” -->
        <div class="section">
            <h2>ğŸ“ ×‘×—×™×¨×ª ×ª×™×§×™×™×”</h2>
            <div class="folder-select-area" id="folderArea" onclick="document.getElementById('folderInput').click()">
                <div class="folder-icon">ğŸ“‚</div>
                <h3>×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª×™×§×™×™×”</h3>
                <p>×”×ª×™×§×™×™×” ×¦×¨×™×›×” ×œ×”×›×™×œ ×§×‘×¦×™ MASHOV_SCHIR01_MMDD</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none;">
            </div>
            <div id="loadMessage"></div>
            
            <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn-primary" onclick="loadFromIndexedDB()">
                    ğŸ“¥ ×˜×¢×Ÿ × ×ª×•× ×™× ×©××•×¨×™×
                </button>
                <button class="btn-primary" onclick="saveToIndexedDB()" style="background: #9b59b6;">
                    ğŸ’¾ ×©××•×¨ × ×ª×•× ×™×
                </button>
                <button class="btn-primary" onclick="clearIndexedDB()" style="background: #e74c3c;">
                    ğŸ—‘ï¸ ××—×§ × ×ª×•× ×™× ×©××•×¨×™×
                </button>
            </div>
        </div>

        <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
        <div class="section hidden" id="statsSection">
            <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">×¡×š ×”×›×œ ×¨×©×•××•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">×§×‘×¦×™× × ×˜×¢× ×•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueEmployees">0</div>
                    <div class="stat-label">×¢×•×‘×“×•×ª ×™×™×—×•×“×™×•×ª</div>
                </div>
            </div>
        </div>

        <!-- ×¡×™× ×•× ×™× -->
        <div class="section hidden" id="filtersSection">
            <h2>ğŸ” ×¡×™× ×•× ×™×</h2>
            <div class="filters-grid">
                <div class="filter-item">
                    <label>××¡×¤×¨ ×–×”×•×ª</label>
                    <input type="text" id="filterID" placeholder="×”×§×œ×“ ××¡×¤×¨ ×–×”×•×ª">
                </div>
                <div class="filter-item">
                    <label>×ª×™×§ × ×™×›×•×™×™×</label>
                    <input type="text" id="filterTik" placeholder="×—×¤×© ×ª×™×§">
                </div>
                <div class="filter-item">
                    <label>×¡×˜×˜×•×¡ × ×•×›×—×™</label>
                    <select id="filterCurrentStatus">
                        <option value="">×”×›×œ</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>×¡×˜×˜×•×¡ ×¢×“×›×•×Ÿ</label>
                    <select id="filterUserStatus">
                        <option value="">×”×›×œ</option>
                        <option value="×—×“×©">×—×“×©</option>
                        <option value="×‘×˜×™×¤×•×œ">×‘×˜×™×¤×•×œ</option>
                        <option value="×ª×•×§×Ÿ">×ª×•×§×Ÿ</option>
                        <option value="×¡×’×•×¨">×¡×’×•×¨</option>
                    </select>
                </div>
            </div>
            <button class="btn-primary" onclick="applyFilters()">ğŸ” ×¡× ×Ÿ</button>
            <button class="btn-primary" onclick="exportToExcel()" style="background: #27ae60;">ğŸ“¥ ×™×™×¦× ×œ-Excel</button>
        </div>

        <!-- ×˜×‘×œ×ª ×ª×•×¦××•×ª -->
        <div class="section hidden" id="resultsSection">
            <h2>ğŸ“‹ ×ª×•×¦××•×ª</h2>
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>××¡×¤×¨ ×–×”×•×ª</th>
                            <th>×ª×™×§ × ×™×›×•×™×™×</th>
                            <th>×¡×˜×˜×•×¡ ××¢×¨×›×ª</th>
                            <th>×¡×˜×˜×•×¡ ×¢×“×›×•×Ÿ</th>
                            <th>×ª××¨×™×š ×§×•×‘×¥</th>
                            <th>×”×¢×¨×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ××•×“××œ ×”×¢×¨×•×ª -->
    <div class="modal" id="notesModal">
        <div class="modal-content">
            <h3>ğŸ’¬ ×”×¢×¨×•×ª</h3>
            <textarea id="notesText" placeholder="×”×§×œ×“ ×”×¢×¨×•×ª ×›××Ÿ..."></textarea>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="saveNotes()">ğŸ’¾ ×©××•×¨</button>
                <button class="btn-primary" onclick="closeNotesModal()" style="background: #95a5a6;">âœ–ï¸ ×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let maternityData = [];
        let allData = []; // ×›×œ ×”×¨×©×•××•×ª ××›×œ ×”×§×‘×¦×™×
        let currentEditingKey = null;
        let uniqueStatuses = new Set();

        // IndexedDB
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('bituachLeumiDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('maternity')) {
                        db.createObjectStore('maternity', { keyPath: 'id' });
                    }
                };
            });
        }

        // ×©××™×¨×” ×œ-IndexedDB
        async function saveToIndexedDB() {
            try {
                const db = await openDatabase();
                const tx = db.transaction(['maternity'], 'readwrite');
                const store = tx.objectStore('maternity');
                
                // ××—×™×§×ª × ×ª×•× ×™× ×™×©× ×™×
                store.clear();
                
                // ×©××™×¨×ª × ×ª×•× ×™× ×—×“×©×™×
                maternityData.forEach(item => {
                    store.put(item);
                });
                
                await tx.complete;
                console.log('âœ… × ×ª×•× ×™× × ×©××¨×• ×‘-IndexedDB');
                showMessage('loadMessage', 'âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!', 'success');
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×©××™×¨×”:', error);
                showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×', 'error');
            }
        }

        // ×˜×¢×™× ×” ×-IndexedDB
        async function loadFromIndexedDB() {
            try {
                const db = await openDatabase();
                const tx = db.transaction('maternity', 'readonly');
                const store = tx.objectStore('maternity');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const data = request.result || [];
                    
                    if (data.length === 0) {
                        showMessage('loadMessage', 'âŒ ××™×Ÿ × ×ª×•× ×™× ×©××•×¨×™× ×‘-IndexedDB', 'error');
                        return;
                    }
                    
                    maternityData = data;
                    
                    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡×™× ×™×™×—×•×“×™×™×
                    uniqueStatuses.clear();
                    maternityData.forEach(item => {
                        if (item.systemStatus) uniqueStatuses.add(item.systemStatus.trim());
                    });
                    
                    // ×¢×“×›×•×Ÿ UI
                    document.getElementById('folderArea').classList.add('loaded');
                    document.getElementById('folderArea').innerHTML = `
                        <div class="folder-icon">ğŸ’¾</div>
                        <h3>× ×˜×¢× ×• × ×ª×•× ×™× ××”××—×©×‘!</h3>
                        <p>${maternityData.length} ×¨×©×•××•×ª</p>
                    `;
                    
                    showMessage('loadMessage', `âœ… × ×˜×¢× ×• ${maternityData.length} ×¨×©×•××•×ª ×-IndexedDB!`, 'success');
                    
                    populateStatusFilters();
                    updateStats();
                    displayResults();
                    
                    document.getElementById('statsSection').classList.remove('hidden');
                    document.getElementById('filtersSection').classList.remove('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                };
                
                request.onerror = () => {
                    showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
                };
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×”:', error);
                showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
            }
        }

        // ××—×™×§×” ×-IndexedDB
        async function clearIndexedDB() {
            if (!confirm('â“ ×”×× ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×©××•×¨×™×?')) {
                return;
            }
            
            try {
                const db = await openDatabase();
                const tx = db.transaction(['maternity'], 'readwrite');
                tx.objectStore('maternity').clear();
                await tx.complete;
                
                console.log('ğŸ—‘ï¸ IndexedDB × ×•×§×”');
                showMessage('loadMessage', 'âœ… ×”× ×ª×•× ×™× × ××—×§×• ×-IndexedDB', 'success');
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘××—×™×§×”:', error);
            }
        }

        // ×”×¦×’×ª ×”×•×“×¢×”
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="message ${type} fade-in">${text}</div>`;
        }

     // ×˜×¢×™× ×ª ×§×‘×¦×™× - ×’×¨×¡×” ××ª×•×§× ×ª
document.getElementById('folderInput').addEventListener('change', async function(e) {
    const files = Array.from(e.target.files);
    
    if (files.length === 0) {
        showMessage('loadMessage', '×œ× × ×‘×—×¨×• ×§×‘×¦×™×', 'error');
        return;
    }

    console.log(`ğŸ“ ×¡×”"×› ×§×‘×¦×™× ×©× ×‘×—×¨×•: ${files.length}`);

    // ×¡×™× ×•×Ÿ ×§×‘×¦×™× ×¨×œ×•×•× ×˜×™×™×
    const mashovFiles = files.filter(f => 
        f.name.toUpperCase().includes('MASHOV') || 
        f.name.toUpperCase().includes('SCHIR')
    );

    console.log('ğŸ” ×§×‘×¦×™ MASHOV ×©× ××¦××•:', mashovFiles.map(f => f.name));

    if (mashovFiles.length === 0) {
        showMessage('loadMessage', 'âŒ ×œ× × ××¦××• ×§×‘×¦×™ MASHOV', 'error');
        return;
    }

    showMessage('loadMessage', `â³ ×˜×•×¢×Ÿ ${mashovFiles.length} ×§×‘×¦×™×...`, 'info');

    allData = [];
    let processedFiles = 0;
    let totalLines = 0;
    let validRecords = 0;

    for (const file of mashovFiles) {
        try {
            console.log(`\nğŸ“„ ××¢×‘×“ ×§×•×‘×¥: ${file.name}`);
            
            // ×§×¨×™××ª ×”×§×•×‘×¥ ×›-ArrayBuffer
            const arrayBuffer = await file.arrayBuffer();
            
            // × ×™×¡×™×•×Ÿ ×¢× ×§×™×“×•×“×™× ×©×•× ×™× ×©×œ ×¢×‘×¨×™×ª
            let text = null;
            const encodings = ['windows-1255', 'iso-8859-8', 'utf-8'];
            
            for (const encoding of encodings) {
                try {
                    const decoder = new TextDecoder(encoding);
                    const decoded = decoder.decode(arrayBuffer);
                    
                    // ×‘×“×™×§×” ×× ×™×© ××•×ª×™×•×ª ×¢×‘×¨×™×•×ª ×ª×§×™× ×•×ª (×-×ª)
                    if (/[\u0590-\u05FF]/.test(decoded) || /[×-×ª]/.test(decoded)) {
                        text = decoded;
                        console.log(`âœ… ×§×™×“×•×“ ××•×¦×œ×—: ${encoding}`);
                        break;
                    }
                } catch (e) {
                    console.log(`âŒ ×§×™×“×•×“ ${encoding} × ×›×©×œ`);
                }
            }
            
            // ×× ×œ× ×”×¦×œ×—× ×•, × ×©×ª××© ×‘-UTF-8 ×›×‘×¨×™×¨×ª ××—×“×œ
            if (!text) {
                console.log('âš ï¸ ××©×ª××© ×‘-UTF-8 ×›×‘×¨×™×¨×ª ××—×“×œ');
                const decoder = new TextDecoder('utf-8');
                text = decoder.decode(arrayBuffer);
            }
            
            // ×¤×™×¦×•×œ ×œ×©×•×¨×•×ª
            const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
            const fileDate = new Date(file.lastModified);
            
            console.log(`ğŸ“Š ${file.name}:`);
            console.log(`   - ${lines.length} ×©×•×¨×•×ª (××—×¨×™ ×¡×™× ×•×Ÿ ×¨×™×§×•×ª)`);
            console.log(`   - ×ª××¨×™×š: ${fileDate.toLocaleDateString('he-IL')}`);
            console.log(`   - ×’×•×“×œ ×§×•×‘×¥: ${file.size} bytes`);
            
            let fileValidRecords = 0;
            
            lines.forEach((line, index) => {
                totalLines++;
                
                console.log(`\n   ğŸ“ ×©×•×¨×” ${index + 1}:`);
                console.log(`      ××•×¨×š: ${line.length} ×ª×•×•×™×`);
                console.log(`      ×ª×•×›×Ÿ: "${line}"`);
                
                // âš ï¸ ×”×•×¨×“× ×• ××ª ×”×“×¨×™×©×” - ×›×¢×ª ××§×‘×œ×™× ×›×œ ×©×•×¨×” ××¢×œ 60 ×ª×•×•×™×
                if (line.length < 60) {
                    console.log(`      âŒ ×©×•×¨×” ×§×¦×¨×” ××“×™ (×¦×¨×™×š ×œ×¤×—×•×ª 60)`);
                    return;
                }
                
                // ×—×™×œ×•×¥ × ×ª×•× ×™× ×œ×¤×™ ×¤×•×–×™×¦×™×•×ª
                const id = line.substring(0, 9).trim();
                const tik = line.substring(44, 55).trim();
                const status = line.substring(55).trim(); // ×›×œ ×”×©××¨
                
                console.log(`      ğŸ” ××” ×—×•×œ×¥:`);
                console.log(`         ××¡×¤×¨ ×–×”×•×ª (0-10): "${id}" (${id.length} ×ª×•×•×™×)`);
                console.log(`         ×ª×™×§ × ×™×›×•×™×™× (45-56): "${tik}" (${tik.length} ×ª×•×•×™×)`);
                console.log(`         ×¡×˜×˜×•×¡ (56-×¡×•×£): "${status}" (${status.length} ×ª×•×•×™×)`);
                
                // ×•×œ×™×“×¦×™×” - ×¨×§ ×‘×•×“×§×™× ×©×™×© ××¡×¤×¨ ×–×”×•×ª
                if (id && id.length >= 5 && /^\d+$/.test(id)) {
                    allData.push({
                        id: id,
                        tik: tik,
                        systemStatus: status,
                        fileDate: fileDate,
                        fileName: file.name,
                        userStatus: '×—×“×©',
                        notes: ''
                    });
                    fileValidRecords++;
                    validRecords++;
                    console.log(`      âœ… ×¨×©×•××” ×ª×§×™× ×”!`);
                } else {
                    console.log(`      âŒ ××¡×¤×¨ ×–×”×•×ª ×œ× ×ª×§×™×Ÿ:`, {
                        id: id,
                        length: id.length,
                        isNumeric: /^\d+$/.test(id)
                    });
                }
            });
            
            console.log(`\n   âœ… ${fileValidRecords} ×¨×©×•××•×ª ×ª×§×™× ×•×ª ××”×§×•×‘×¥ ×”×–×”`);
            processedFiles++;
            
        } catch (error) {
            console.error(`âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ${file.name}:`, error);
        }
    }

    console.log(`\nğŸ“Š ×¡×™×›×•× ×›×œ×œ×™:`);
    console.log(`   - ×§×‘×¦×™×: ${processedFiles}`);
    console.log(`   - ×©×•×¨×•×ª: ${totalLines}`);
    console.log(`   - ×¨×©×•××•×ª ×ª×§×™× ×•×ª: ${validRecords}`);

    if (validRecords === 0) {
        showMessage('loadMessage', 'âŒ ×œ× × ××¦××• ×¨×©×•××•×ª ×ª×§×™× ×•×ª! ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ ×œ×¤×¨×˜×™×', 'error');
        return;
    }

    // ×§×‘×œ×ª ×”×¨×©×•××” ×”××—×¨×•× ×” ×œ×›×œ ×¢×•×‘×“×ª
    processLatestRecords();

    // ×©××™×¨×” ××•×˜×•××˜×™×ª
    await saveToIndexedDB();

    // ×¢×“×›×•×Ÿ UI
    document.getElementById('folderArea').classList.add('loaded');
    document.getElementById('folderArea').innerHTML = `
        <div class="folder-icon">âœ…</div>
        <h3>×”×§×‘×¦×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”!</h3>
        <p>${processedFiles} ×§×‘×¦×™× | ${maternityData.length} ×¨×©×•××•×ª ×™×™×—×•×“×™×•×ª</p>
    `;

    showMessage('loadMessage', `âœ… × ×˜×¢× ×• ${processedFiles} ×§×‘×¦×™× ×‘×”×¦×œ×—×”! (${maternityData.length} ×¢×•×‘×“×•×ª)`, 'success');
    
    populateStatusFilters();
    updateStats();
    displayResults();
    
    document.getElementById('statsSection').classList.remove('hidden');
    document.getElementById('filtersSection').classList.remove('hidden');
    document.getElementById('resultsSection').classList.remove('hidden');
});
        // ×¢×™×‘×•×“ - ×œ×§×™×—×ª ×”×¨×©×•××” ×”××—×¨×•× ×” ×œ×›×œ ×¢×•×‘×“×ª
        function processLatestRecords() {
            // ×§×™×‘×•×¥ ×œ×¤×™ ××¡×¤×¨ ×–×”×•×ª
            const grouped = {};
            
            allData.forEach(record => {
                if (!grouped[record.id]) {
                    grouped[record.id] = [];
                }
                grouped[record.id].push(record);
            });
            
            // ×œ×›×œ ×¢×•×‘×“×ª - ×œ×§×™×—×ª ×”×¨×©×•××” ×¢× ×”×ª××¨×™×š ×”××—×¨×•×Ÿ
            maternityData = [];
            Object.keys(grouped).forEach(id => {
                const records = grouped[id];
                // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š ×§×•×‘×¥ - ×”××—×¨×•×Ÿ ×¨××©×•×Ÿ
                records.sort((a, b) => b.fileDate - a.fileDate);
                const latest = records[0];
                
                maternityData.push({
                    id: latest.id,
                    tik: latest.tik,
                    systemStatus: latest.systemStatus,
                    fileDate: latest.fileDate,
                    fileName: latest.fileName,
                    userStatus: '×—×“×©',
                    notes: ''
                });
                
                // ×©××™×¨×ª ×¡×˜×˜×•×¡×™× ×™×™×—×•×“×™×™×
                if (latest.systemStatus) uniqueStatuses.add(latest.systemStatus.trim());
            });
            
            console.log(`âœ… ${maternityData.length} ×¢×•×‘×“×•×ª ×™×™×—×•×“×™×•×ª`);
        }

        // ××™×œ×•×™ ×¡×™× ×•×Ÿ ×¡×˜×˜×•×¡×™×
        function populateStatusFilters() {
            const select = document.getElementById('filterCurrentStatus');
            select.innerHTML = '<option value="">×”×›×œ</option>';
            
            Array.from(uniqueStatuses).sort().forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                select.appendChild(option);
            });
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        function updateStats() {
            document.getElementById('totalRecords').textContent = maternityData.length;
            document.getElementById('totalFiles').textContent = new Set(maternityData.map(r => r.fileName)).size;
            document.getElementById('uniqueEmployees').textContent = maternityData.length;
        }

        // ×”×¦×’×ª ×ª×•×¦××•×ª
        function displayResults(filteredData = null) {
            const data = filteredData || maternityData;
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.tik}</td>
                    <td>${row.systemStatus}</td>
                    <td>
                        <select class="status-select" onchange="updateUserStatus('${row.id}', this.value)">
                            <option value="×—×“×©" ${row.userStatus === '×—×“×©' ? 'selected' : ''}>×—×“×©</option>
                            <option value="×‘×˜×™×¤×•×œ" ${row.userStatus === '×‘×˜×™×¤×•×œ' ? 'selected' : ''}>×‘×˜×™×¤×•×œ</option>
                            <option value="×ª×•×§×Ÿ" ${row.userStatus === '×ª×•×§×Ÿ' ? 'selected' : ''}>×ª×•×§×Ÿ</option>
                            <option value="×¡×’×•×¨" ${row.userStatus === '×¡×’×•×¨' ? 'selected' : ''}>×¡×’×•×¨</option>
                        </select>
                    </td>
                    <td>${row.fileDate.toLocaleDateString('he-IL')}</td>
                    <td>
                        <button class="notes-btn" onclick="openNotesModal('${row.id}')">
                            ğŸ’¬ ${row.notes ? '×¢×¨×•×š' : '×”×•×¡×£'}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××©×ª××©
        function updateUserStatus(id, status) {
            const record = maternityData.find(r => r.id === id);
            if (record) {
                record.userStatus = status;
                saveToIndexedDB();
                console.log(`âœ… ×¢×•×“×›×Ÿ ×¡×˜×˜×•×¡ ×œ-${id}: ${status}`);
            }
        }

        // ×¤×ª×™×—×ª ××•×“××œ ×”×¢×¨×•×ª
        function openNotesModal(id) {
            currentEditingKey = id;
            const record = maternityData.find(r => r.id === id);
            document.getElementById('notesText').value = record?.notes || '';
            document.getElementById('notesModal').classList.add('show');
        }

        // ×¡×’×™×¨×ª ××•×“××œ
        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('show');
            currentEditingKey = null;
        }

        // ×©××™×¨×ª ×”×¢×¨×•×ª
        function saveNotes() {
            const notes = document.getElementById('notesText').value;
            const record = maternityData.find(r => r.id === currentEditingKey);
            
            if (record) {
                record.notes = notes;
                saveToIndexedDB();
                displayResults();
                closeNotesModal();
                console.log(`âœ… ×”×¢×¨×•×ª × ×©××¨×• ×œ-${currentEditingKey}`);
            }
        }

        // ×”×—×œ×ª ×¡×™× ×•× ×™×
        function applyFilters() {
            const filterID = document.getElementById('filterID').value.trim();
            const filterTik = document.getElementById('filterTik').value.trim();
            const filterCurrentStatus = document.getElementById('filterCurrentStatus').value;
            const filterUserStatus = document.getElementById('filterUserStatus').value;

            let filtered = maternityData.filter(row => {
                if (filterID && !row.id.includes(filterID)) return false;
                if (filterTik && !row.tik.includes(filterTik)) return false;
                if (filterCurrentStatus && row.systemStatus !== filterCurrentStatus) return false;
                if (filterUserStatus && row.userStatus !== filterUserStatus) return false;
                return true;
            });

            displayResults(filtered);
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¡×•× × ×•×ª
            document.getElementById('totalRecords').textContent = filtered.length;
        }

        // ×™×™×¦×•× ×œ-Excel
        function exportToExcel() {
            // × ×•×¡×™×£ ×‘×”××©×š ×¢× ×¡×¤×¨×™×™×ª XLSX
            alert('×™×™×¦×•× ×œ-Excel ×™×ª×•×•×¡×£ ×‘×§×¨×•×‘!');
        }
    </script>
</body>
</html>