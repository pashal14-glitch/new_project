<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×”×¦×œ×‘×ª × ×ª×•× ×™ ××™×œ×•××™×</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* ×”×’×“×¨×•×ª ×¢××•×“×•×ª */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
        }

        .setting-item label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .setting-item input, .setting-item select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: #3498db;
        }

        /* ×›×¤×ª×•×¨ ×‘×—×™×¨×ª ×ª×™×§×™×™×” */
        .folder-select-area {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border: 3px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder-select-area:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .folder-select-area.loaded {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .folder-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .btn-primary {
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
}

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        /* ×¡×˜×˜×™×¡×˜×™×§×•×ª */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        /* ×¡×™× ×•× ×™× */
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .filter-item input, .filter-item select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        /* ×˜×‘×œ×” */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-balanced {
            color: #27ae60;
            font-weight: bold;
        }

        .status-unbalanced {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-partial {
            color: #f39c12;
            font-weight: bold;
        }

        /* ×›×¤×ª×•×¨ ×™×™×¦×•× */
        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .export-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }

        .message.success {
            background: #d5f4e6;
            color: #27ae60;
            border: 2px solid #27ae60;
        }

        .message.error {
            background: #fadbd8;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        .message.info {
            background: #e3f2fd;
            color: #3498db;
            border: 2px solid #3498db;
        }

        /* ×× ×™××¦×™×•×ª */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .save-settings-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .save-settings-btn:hover {
            background: #8e44ad;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¯ ××¢×¨×›×ª ×”×¦×œ×‘×ª × ×ª×•× ×™ ××™×œ×•××™×</h1>
            <p>×›×œ×™ ×¤×©×•×˜ ×œ×”×¦×œ×‘×ª ×§×‘×¦×™ ×ª×©×œ×•××™× ×•×”×—×–×¨×™×</p>
        </div>

        <!-- ×”×’×“×¨×•×ª Salary - ×§×‘×•×¢×•×ª ×‘×§×•×“ -->
        <div class="section" id="settingsSection">
            <h2>âš™ï¸ ×”×’×“×¨×•×ª ×§×•×‘×¥ Salary (×§×‘×•×¢×•×ª)</h2>
            <div class="message info">
                <strong>ğŸ“‹ ×”×’×“×¨×•×ª ×¢××•×“×•×ª ×§×‘×•×¢×•×ª:</strong><br>
                â€¢ ×¢××•×“×” G - ××¡×¤×¨ ×¢×•×‘×“<br>
                â€¢ ×¢××•×“×” L - ×ª××¨×™×š ×”×ª×—×œ×” (YYYYMMDD)<br>
                â€¢ ×¢××•×“×” M - ×ª××¨×™×š ×¡×™×•× (YYYYMMDD)<br>
                â€¢ ×¢××•×“×” Q - ×¡×›×•× ×ª×©×œ×•×<br>
                â€¢ ×©×•×¨×ª ×”×ª×—×œ×”: 1<br><br>
                <strong>ğŸ’¡ ×œ× ××©× ×” ××” ×™×© ×‘×¢××•×“×•×ª ××—×¨×•×ª - ×”××¢×¨×›×ª ×§×•×¨××ª ×¨×§ ××”×¢××•×“×•×ª ×”××œ×•!</strong>
            </div>
        </div>

        <!-- ×‘×—×™×¨×ª ×ª×™×§×™×™×” -->
       <div class="section">
    <h2>ğŸ“ ×‘×—×™×¨×ª ×ª×™×§×™×™×”</h2>
    <div class="folder-select-area" id="folderArea" onclick="document.getElementById('folderInput').click()">
        <div class="folder-icon">ğŸ“‚</div>
        <h3>×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª×™×§×™×™×”</h3>
        <p>×”×ª×™×§×™×™×” ×¦×¨×™×›×” ×œ×”×›×™×œ ×ª×ª×™-×ª×™×§×™×•×ª ×¢× ×§×‘×¦×™ Salary ×•-BTL</p>
        <input type="file" id="folderInput" webkitdirectory multiple style="display: none;">
    </div>
    <div id="loadMessage"></div>
    
    <!-- ğŸ‘‡ ×”×•×¡×¤×” ×—×“×©×” -->
    <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button class="btn-primary" onclick="loadFromIndexedDB()">
            ğŸ“¥ ×˜×¢×Ÿ × ×ª×•× ×™× ×©××•×¨×™×
        </button>
        <button class="btn-primary" onclick="saveToIndexedDB()" style="background: #9b59b6;">
            ğŸ’¾ ×©××•×¨ × ×ª×•× ×™×
        </button>
        <button class="btn-primary" onclick="clearIndexedDB()" style="background: #e74c3c;">
            ğŸ—‘ï¸ ××—×§ × ×ª×•× ×™× ×©××•×¨×™×
        </button>
    </div>
</div>

        <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
        <div class="section hidden" id="statsSection">
            <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">×¡×š ×”×›×œ ×¨×©×•××•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="balancedCount">0</div>
                    <div class="stat-label">×××•×–× ×™× âœ…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unbalancedCount">0</div>
                    <div class="stat-label">×œ× ×××•×–× ×™× âŒ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalGap">0 â‚ª</div>
                    <div class="stat-label">×¡×š ×¤×¢×¨×™×</div>
                </div>
            </div>
        </div>

        <!-- ×¡×™× ×•× ×™× -->
        <div class="section hidden" id="filtersSection">
            <h2>ğŸ” ×¡×™× ×•× ×™×</h2>
            <div class="filters-grid">
                <div class="filter-item">
                    <label>××¡×¤×¨ ×¢×•×‘×“</label>
                    <input type="text" id="filterEmployee" placeholder="×”×§×œ×“ ××¡×¤×¨ ×–×”×•×ª">
                </div>
                <div class="filter-item">
                    <label>×©× ×”</label>
                    <select id="filterYear">
                        <option value="">×›×œ ×”×©× ×™×</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>×¡×˜×˜×•×¡</label>
                    <select id="filterStatus">
                        <option value="">×”×›×œ</option>
                        <option value="balanced">×××•×–×Ÿ</option>
                        <option value="unbalanced">×œ× ×××•×–×Ÿ</option>
                        <option value="partial">×—×œ×§×™</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>×—×™×¤×•×© ×—×•×¤×©×™</label>
                    <input type="text" id="filterSearch" placeholder="×—×¤×©...">
                </div>
            </div>
            <button class="btn-primary" onclick="applyFilters()">ğŸ” ×¡× ×Ÿ</button>
            <button class="export-btn" onclick="exportToExcel()">ğŸ“¥ ×™×™×¦× ×œ-Excel</button>
            <button class="export-btn" onclick="exportDetailedExcel()">ğŸ“Š ×™×™×¦× ×“×•×— ××¤×•×¨×˜ (3 ×’×œ×™×•× ×•×ª)</button>
            <button class="export-btn" style="background: #9b59b6;" onclick="saveToIndexedDB()">ğŸ’¾ ×©××•×¨ × ×ª×•× ×™× ×œ××—×©×‘×•×Ÿ</button>
        </div>

        <!-- ×˜×‘×œ×ª ×ª×•×¦××•×ª -->
        <div class="section hidden" id="resultsSection">
            <h2>ğŸ“‹ ×ª×•×¦××•×ª ×”×¦×œ×‘×”</h2>
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>××¡×¤×¨ ×–×”×•×ª</th>
                            <th>×ª××¨×™×š ×”×ª×—×œ×”</th>
                            <th>×ª××¨×™×š ×¡×™×•×</th>
                            <th>×¡×›×•× ×©×©×•×œ× (Salary)</th>
                            <th>×¡×›×•× ×©×”×ª×§×‘×œ (BTL)</th>
                            <th>×××–×Ÿ</th>
                            <th>×¡×˜×˜×•×¡</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let salaryData = {};
        let btlData = {};
        let matchedData = [];
        let allYears = new Set();
        let detailedSalaryData = {}; // ×œ×©××™×¨×ª × ×ª×•× ×™ ×—×•×“×©×™× ××¤×•×¨×˜×™×
        let salaryFilesDates = {};   // ×œ×©××™×¨×ª ×ª××¨×™×›×™ ×§×‘×¦×™×

        // ×”×’×“×¨×•×ª ×§×‘×•×¢×•×ª ×œ×§×•×‘×¥ Salary - ×œ×¤×™ ××•×ª×™×•×ª ×¢××•×“×•×ª
        const SALARY_SETTINGS = {
            colId: 'G',        // ×¢××•×“×” G - ××¡×¤×¨ ×¢×•×‘×“
            colStart: 'L',     // ×¢××•×“×” L - ×ª××¨×™×š ×”×ª×—×œ×”
            colEnd: 'M',       // ×¢××•×“×” M - ×ª××¨×™×š ×¡×™×•×
            colAmount: 'Q',    // ×¢××•×“×” Q - ×¡×›×•×
            startRow: 1        // ×©×•×¨×” 1
        };
        // ========== IndexedDB - ×©××™×¨×” ×•×§×¨×™××” ==========

// ×¤×ª×™×—×ª/×™×¦×™×¨×ª ××¡×“ × ×ª×•× ×™×
function openDatabase() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('miluimDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // ×™×¦×™×¨×ª ×˜×‘×œ××•×ª ×× ×œ× ×§×™×™××•×ª
            if (!db.objectStoreNames.contains('matchedData')) {
                db.createObjectStore('matchedData', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('salaryData')) {
                db.createObjectStore('salaryData', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('btlData')) {
                db.createObjectStore('btlData', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('detailedSalaryData')) {
                db.createObjectStore('detailedSalaryData', { keyPath: 'key' });
            }
        };
    });
}

// ×©××™×¨×ª × ×ª×•× ×™× ×œ-IndexedDB
async function saveToIndexedDB() {
    try {
        const db = await openDatabase();
        const tx = db.transaction(['matchedData', 'salaryData', 'btlData', 'detailedSalaryData'], 'readwrite');
        
        // ×©××™×¨×ª matchedData
        const matchedStore = tx.objectStore('matchedData');
        matchedData.forEach(item => {
            matchedStore.put(item);
        });
        
        // ×©××™×¨×ª salaryData
        const salaryStore = tx.objectStore('salaryData');
        Object.keys(salaryData).forEach(key => {
            salaryStore.put({ key, ...salaryData[key] });
        });
        
        // ×©××™×¨×ª btlData
        const btlStore = tx.objectStore('btlData');
        Object.keys(btlData).forEach(key => {
            btlStore.put({ key, ...btlData[key] });
        });
        
        // ×©××™×¨×ª detailedSalaryData (×× ×§×™×™×)
        if (typeof detailedSalaryData !== 'undefined') {
            const detailedStore = tx.objectStore('detailedSalaryData');
            Object.keys(detailedSalaryData).forEach(key => {
                detailedStore.put({ key, months: detailedSalaryData[key] });
            });
        }
        
        await tx.complete;
        console.log('âœ… × ×ª×•× ×™× × ×©××¨×• ×‘-IndexedDB');
        showMessage('loadMessage', 'âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!', 'success');
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×©××™×¨×”:', error);
        showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×', 'error');
    }
}

        // ×”××¨×ª ××•×ª ×¢××•×“×” ×œ××¡×¤×¨ (A=1, B=2, ..., Z=26, AA=27, etc.)
        function columnToIndex(col) {
            let index = 0;
            for (let i = 0; i < col.length; i++) {
                index = index * 26 + (col.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
            }
            return index - 1; // ××—×–×™×¨ ××™× ×“×§×¡ ××‘×•×¡×¡-0
        }

        // ×”××¨×ª ×ª××¨×™×š ××¤×•×¨××˜ YYYYMMDD ×œ-DD/MM/YYYY
        function convertDate(dateStr) {
            if (!dateStr) return '';
            
       
             const str = dateStr.toString().replace(/\D/g, ''); 
            // ×× ×–×” ×‘×“×™×•×§ 8 ×¡×¤×¨×•×ª - ×–×” YYYYMMDD
            if (str.length === 8) {
                const year = str.substring(0, 4);
                const month = str.substring(4, 6);
                const day = str.substring(6, 8);
                
               
                // Ã—â€˜Ã—â€œÃ—â„¢Ã—Â§Ã—â€ Ã—Â©Ã—â€Ã—ÂªÃ—ÂÃ—Â¨Ã—â„¢Ã—Å¡ Ã—â€Ã—â€™Ã—â„¢Ã—â€¢Ã— Ã—â„¢
                if (parseInt(year) >= 1900 && parseInt(year) <= 2100 &&
                    parseInt(month) >= 1 && parseInt(month) <= 12 &&
                    parseInt(day) >= 1 && parseInt(day) <= 31) {
                    return `${day}/${month}/${year}`;
                }
            }
            
            // Ã—ÂÃ—Â Ã—â€“Ã—â€ Ã—ÂªÃ—ÂÃ—Â¨Ã—â„¢Ã—Å¡ Excel (Ã—Å¾Ã—Â¡Ã—Â¤Ã—Â¨ Ã—Â§Ã—ËœÃ—Å¸ Ã—â„¢Ã—â€”Ã—Â¡Ã—â„¢Ã—Âª)
            if (typeof dateStr === 'number' && dateStr > 1 && dateStr < 100000) {
                return convertExcelDate(dateStr);
            }
            
            return '';
        }

        // ×”××¨×ª ×ª××¨×™×š Excel (××¡×¤×¨ ×¡×™×“×•×¨×™) ×œ×¤×•×¨××˜ DD/MM/YYYY - ××ª×•×§×Ÿ!
function convertExcelDate(excelDate) {
    if (!excelDate || isNaN(excelDate)) return '';
    
    // ğŸ”¥ ×ª×™×§×•×Ÿ: value-1 ×‘××§×•× value-2
    const excelEpoch = new Date(1900, 0, 1);
    const days = excelDate - 1;
    const result = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
    
    // ğŸ”¥ ×ª×™×§×•×Ÿ timezone - adjustment ×œ×–××Ÿ ×™×©×¨××œ×™
    const adjusted = new Date(result.getTime() + (result.getTimezoneOffset() * 60000));
    
    const day = String(adjusted.getDate()).padStart(2, '0');
    const month = String(adjusted.getMonth() + 1).padStart(2, '0');
    const year = adjusted.getFullYear();
    
    return `${day}/${month}/${year}`;
}

// ×”××¨×ª ×ª××¨×™×š ××¤×•×¨××˜ YYYYMMDD ××• Excel number ×œ-DD/MM/YYYY - ××ª×•×§×Ÿ!
function convertDate(dateStr) {
    if (!dateStr) return '';
    
    // ğŸ”¥ ×× ×–×” Date object - ×”××¨ ×™×©×™×¨×•×ª
    if (dateStr instanceof Date) {
        const day = String(dateStr.getDate()).padStart(2, '0');
        const month = String(dateStr.getMonth() + 1).padStart(2, '0');
        const year = dateStr.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    // ğŸ”¥ ×§×•×“× ×‘×•×“×§×™× ×× ×–×” ××¡×¤×¨ Excel - ×œ×¤× ×™ ×©×”×•×¨×¡×™× ××ª ×”×˜×™×™×¤!
    if (typeof dateStr === 'number' && dateStr > 1 && dateStr < 100000) {
        return convertExcelDate(dateStr);
    }
    
    // ×¢×›×©×™×• ××¤×©×¨ ×œ×”××™×¨ ×œ××—×¨×•×–×ª
    const str = dateStr.toString().trim();
    
    // ×ª××™×›×” ×‘×¤×•×¨××˜×™× ×©×•× ×™×
    const formats = [
        { regex: /^(\d{4})-(\d{2})-(\d{2})$/, order: 'YMD' },        // YYYY-MM-DD
        { regex: /^(\d{2})\/(\d{2})\/(\d{4})$/, order: 'DMY' },      // DD/MM/YYYY
        { regex: /^(\d{2})-(\d{2})-(\d{4})$/, order: 'DMY' },        // DD-MM-YYYY
        { regex: /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, order: 'DMY' },  // D/M/YYYY
        { regex: /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/, order: 'DMY' }   // D.M.YYYY
    ];
    
    for (let format of formats) {
        const match = str.match(format.regex);
        if (match) {
            let day, month, year;
            
            if (format.order === 'YMD') {
                year = match[1];
                month = match[2];
                day = match[3];
            } else { // DMY
                day = match[1].padStart(2, '0');
                month = match[2].padStart(2, '0');
                year = match[3];
            }
            
            // ×‘×“×™×§×ª ×ª×§×™× ×•×ª
            if (parseInt(year) >= 1900 && parseInt(year) <= 2100 &&
                parseInt(month) >= 1 && parseInt(month) <= 12 &&
                parseInt(day) >= 1 && parseInt(day) <= 31) {
                return `${day}/${month}/${year}`;
            }
        }
    }
    
    // ×× ×–×” ×‘×“×™×•×§ 8 ×¡×¤×¨×•×ª - ×–×” YYYYMMDD
    const numOnly = str.replace(/\D/g, '');
    if (numOnly.length === 8) {
        const year = numOnly.substring(0, 4);
        const month = numOnly.substring(4, 6);
        const day = numOnly.substring(6, 8);
        
        if (parseInt(year) >= 1900 && parseInt(year) <= 2100 &&
            parseInt(month) >= 1 && parseInt(month) <= 12 &&
            parseInt(day) >= 1 && parseInt(day) <= 31) {
            return `${day}/${month}/${year}`;
        }
    }
    
    return '';
}

        // ×™×¦×™×¨×ª ××¤×ª×— ×™×™×—×•×“×™
        function createKey(empId, startDate, endDate) {
            return `${empId}_${startDate}_${endDate}`;
        }

        // ×”×¦×’×ª ×”×•×“×¢×”
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="message ${type} fade-in">${text}</div>`;
        }

       // ×¢×™×‘×•×“ ×§×•×‘×¥ Salary
function processSalaryFile(workbook, fileName) {
    const firstSheet = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheet];
    
    // ×•×™×“×•× ×©×™×© ×˜×•×•×— ×ª×§×™×Ÿ
    if (!worksheet['!ref'] || worksheet['!ref'] === 'A1') {
        console.warn('âš ï¸ ×§×•×‘×¥ ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ:', fileName);
        return 0;
    }
    
    const range = XLSX.utils.decode_range(worksheet['!ref']);
    const startRow = SALARY_SETTINGS.startRow - 1;
    
    // ×—×™×œ×•×¥ ×ª××¨×™×š ××”×§×•×‘×¥ (×œ××©×œ Salary_202501 -> 202501)
    const dateMatch = fileName.match(/(\d{6})/);
    const fileDate = dateMatch ? dateMatch[1] : '000000';
    
    console.log(`ğŸ“‹ ${fileName}: ×˜×•×•×—: ${worksheet['!ref']}, ×ª××¨×™×š: ${fileDate}`);

    let count = 0;
    
    for (let rowNum = startRow; rowNum <= range.e.r; rowNum++) {
        const empIdCell = worksheet[SALARY_SETTINGS.colId + (rowNum + 1)];
        const startDateCell = worksheet[SALARY_SETTINGS.colStart + (rowNum + 1)];
        const endDateCell = worksheet[SALARY_SETTINGS.colEnd + (rowNum + 1)];
        const amountCell = worksheet[SALARY_SETTINGS.colAmount + (rowNum + 1)];
        const signCell = worksheet['P' + (rowNum + 1)];
        
        const empId = empIdCell ? empIdCell.v : null;
        const startDateRaw = startDateCell ? startDateCell.v : null;
        const endDateRaw = endDateCell ? endDateCell.v : null;
        let amount = amountCell ? parseFloat(amountCell.v) : 0;

        // ×”×ª×—×©×‘×•×ª ×‘×¡×™××Ÿ
        if (signCell && signCell.v === '-') {
            amount = -amount;
        }

        const startDate = convertDate(startDateRaw);
        const endDate = convertDate(endDateRaw);

        if (empId && startDate && endDate) {
            const key = createKey(empId, startDate, endDate);
            
            // ×¢×“×›×•×Ÿ ×¡×›×•× Q
            if (!salaryData[key]) {
                salaryData[key] = {
                    empId: empId,
                    startDate: startDate,
                    endDate: endDate,
                    amount: 0
                };
            }
            salaryData[key].amount += amount;
            count++;

            // ×©××™×¨×ª × ×ª×•× ×™ ×—×•×“×©×™× ××¤×•×¨×˜×™× - ×¨×§ ××”×§×•×‘×¥ ×”××—×¨×•×Ÿ
            if (!salaryFilesDates[key] || fileDate > salaryFilesDates[key]) {
                salaryFilesDates[key] = fileDate;
                
                // ×—×™×œ×•×¥ 6 ×—×•×“×©×™× (R,T,U -> V,X,Y -> ...)
                const months = [];
                const cols = ['R','V','Z','AD','AH','AL']; // ×¢××•×“×•×ª ×—×•×“×©
                const daysCols = ['T','X','AB','AF','AJ','AN']; // ×¢××•×“×•×ª ×™××™×
                const brutoCols = ['U','Y','AC','AG','AK','AO']; // ×¢××•×“×•×ª ×‘×¨×•×˜×•
                
                for (let i = 0; i < 6; i++) {
                    const monthCell = worksheet[cols[i] + (rowNum + 1)];
                    const daysCell = worksheet[daysCols[i] + (rowNum + 1)];
                    const brutoCell = worksheet[brutoCols[i] + (rowNum + 1)];
                    
                    if (monthCell && monthCell.v) {
                        months.push({
                            month: monthCell.v,
                            days: daysCell ? daysCell.v : 0,
                            bruto: brutoCell ? parseFloat(brutoCell.v) : 0
                        });
                    }
                }
                
                detailedSalaryData[key] = months;
            }

            const year = startDate.split('/')[2];
            if (year) allYears.add(year);
        }
    }
    
    console.log(`âœ… Salary: ${fileName} - ${count} ×¨×©×•××•×ª × ×˜×¢× ×•`);
    return count;
}
        // ×¢×™×‘×•×“ ×§×•×‘×¥ BTL (×‘×“×™×•×§ ×›××• ×‘××—×©×‘×•×Ÿ)
        function processBTLFile(workbook, fileName) {
            const firstSheet = workbook.SheetNames[0];
           const worksheet = workbook.Sheets[firstSheet];

// ×•×™×“×•× ×©×™×© ×˜×•×•×— ×ª×§×™×Ÿ
if (!worksheet['!ref'] || worksheet['!ref'] === 'A1') {
    console.warn('âš ï¸ ×§×•×‘×¥ ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ:', fileName);
    return 0;
}
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

            let count = 0;
            // ××ª×—×™×œ×™× ××©×•×¨×” 8 (××™× ×“×§×¡ 7)
            for (let i = 8; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                const empId = row[2];          // ×¢××•×“×” 3
                const startDateRaw = row[3];   // ×¢××•×“×” 4
                const endDateRaw = row[4];     // ×¢××•×“×” 5
                const amount = parseFloat(row[16]) || 0;  // ×¢××•×“×” 17

                if (empId && startDateRaw && endDateRaw && !isNaN(empId)) {
                    // ×”××¨×ª ×ª××¨×™×›×™× (×ª×•××š ×’× ×‘-YYYYMMDD ×•×’× ×‘×ª××¨×™×š Excel)
                    const startDate = convertDate(startDateRaw);
                    const endDate = convertDate(endDateRaw);
                    
                    const key = createKey(empId, startDate, endDate);
                    
                    if (!btlData[key]) {
                        btlData[key] = {
                            empId: empId,
                            startDate: startDate,
                            endDate: endDate,
                            amount: 0
                        };
                    }
                    btlData[key].amount += amount;
                    count++;
                }
            }
            console.log(`âœ… BTL: ${fileName} - ${count} ×¨×©×•××•×ª × ×˜×¢× ×•`);
            return count;
        }

        // ×–×™×”×•×™ ×¡×•×’ ×§×•×‘×¥ ×œ×¤×™ × ×ª×™×‘
        function identifyFileType(filePath) {
            const lowerPath = filePath.toLowerCase();
            
            console.log(`ğŸ” ×‘×•×“×§ ×§×•×‘×¥: ${filePath}`);
            
            // ×–×™×”×•×™ Salary - ×‘×“×™×§×” ×¨×—×‘×”
            if (lowerPath.includes('salary') || 
                lowerPath.includes('×ª×©×œ×•××™×') || 
                lowerPath.includes('×©×›×¨') ||
                lowerPath.includes('××©×›×•×¨×ª') ||
                lowerPath.includes('×ª×’××•×œ')) {
                console.log(`âœ… ×–×•×”×” ×›-Salary: ${filePath}`);
                return 'salary';
            } 
            
            // ×–×™×”×•×™ BTL - ×‘×“×™×§×” ×¨×—×‘×”
            if (lowerPath.includes('btl') || 
                lowerPath.includes('×”×—×–×¨') || 
                lowerPath.includes('×‘×™×˜×•×—') ||
                lowerPath.includes('×”×—×–×¨×™×')) {
                console.log(`âœ… ×–×•×”×” ×›-BTL: ${filePath}`);
                return 'btl';
            }
            
            console.warn(`âš ï¸ ×§×•×‘×¥ ×œ× ××–×•×”×”: ${filePath}`);
            return null;
        }

        // ×˜×¢×™× ×ª ×§×‘×¦×™× ××ª×™×§×™×™×”
        document.getElementById('folderInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            
            if (files.length === 0) {
                showMessage('loadMessage', '×œ× × ×‘×—×¨×• ×§×‘×¦×™×', 'error');
                return;
            }

            console.log(`ğŸ“ ×¡×”"×› ×§×‘×¦×™× ×©× ×‘×—×¨×•: ${files.length}`);

            // ××™×¤×•×¡ × ×ª×•× ×™×
            salaryData = {};
            btlData = {};
            matchedData = [];
            allYears.clear();

            showMessage('loadMessage', `â³ ×˜×•×¢×Ÿ ${files.length} ×§×‘×¦×™×...`, 'info');

            let salaryCount = 0;
            let btlCount = 0;
            let processedFiles = 0;
            let skippedFiles = [];

            for (const file of files) {
                // ×¨×§ ×§×‘×¦×™ Excel
               if (!file.name.match(/\.(xlsx|xls|xla|csv)$/i)) {
    console.log(`â­ï¸ ××“×œ×’ ×¢×œ ×§×•×‘×¥ (×œ× Excel/CSV): ${file.name}`);
    continue;
}
                try {
                    const fileType = identifyFileType(file.webkitRelativePath || file.name);
                    
                    if (!fileType) {
                        console.log(`âŒ ××“×œ×’ ×¢×œ ×§×•×‘×¥ ×œ× ××–×•×”×”: ${file.name}`);
                        skippedFiles.push(file.name);
                        continue;
                    }

                   const data = await file.arrayBuffer();
let workbook;

// ×˜×™×¤×•×œ ××™×•×—×“ ×‘-CSV
if (file.name.match(/\.csv$/i)) {
    const text = new TextDecoder('utf-8').decode(data);
    workbook = XLSX.read(text, { type: 'string' });
} else {
    workbook = XLSX.read(data, { type: 'array' });
}
                

                    if (fileType === 'salary') {
                        const count = processSalaryFile(workbook, file.name);
                        salaryCount += count;
                        console.log(`âœ… Salary: ${file.name} - ${count} ×¨×©×•××•×ª`);
                    } else if (fileType === 'btl') {
                        const count = processBTLFile(workbook, file.name);
                        btlCount += count;
                        console.log(`âœ… BTL: ${file.name} - ${count} ×¨×©×•××•×ª`);
                    }

                    processedFiles++;
                } catch (error) {
                    console.error(`âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ${file.name}:`, error);
                    skippedFiles.push(file.name);
                }
            }

            console.log(`ğŸ“Š ×¡×™×›×•×: Salary=${Object.keys(salaryData).length} ×¨×©×•××•×ª, BTL=${Object.keys(btlData).length} ×¨×©×•××•×ª`);

            if (processedFiles === 0) {
                let errorMsg = 'âŒ ×œ× × ××¦××• ×§×‘×¦×™× ××ª××™××™×<br><br>';
                errorMsg += '<strong>×•×•×“× ×©×”×ª×™×§×™×•×ª × ×§×¨××•×ª:</strong><br>';
                errorMsg += 'â€¢ Salary / SALARY / ×ª×©×œ×•××™× / ×©×›×¨<br>';
                errorMsg += 'â€¢ BTL / ×”×—×–×¨×™× / ×‘×™×˜×•×—<br><br>';
                if (skippedFiles.length > 0) {
                    errorMsg += '<strong>×§×‘×¦×™× ×©×œ× ×–×•×”×•:</strong><br>';
                    skippedFiles.forEach(f => errorMsg += `â€¢ ${f}<br>`);
                }
                showMessage('loadMessage', errorMsg, 'error');
                return;
            }

            // ×‘×™×¦×•×¢ ×”×¦×œ×‘×”
            performMatching();

// ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ-IndexedDB
saveToIndexedDB();

            // ×¢×“×›×•×Ÿ UI
            document.getElementById('folderArea').classList.add('loaded');
            document.getElementById('folderArea').innerHTML = `
                <div class="folder-icon">âœ…</div>
                <h3>×”×§×‘×¦×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”!</h3>
                <p>Salary: ${Object.keys(salaryData).length} ×¨×©×•××•×ª | BTL: ${Object.keys(btlData).length} ×¨×©×•××•×ª</p>
            `;

            let successMsg = `âœ… × ×˜×¢× ×• ${processedFiles} ×§×‘×¦×™× ×‘×”×¦×œ×—×”!<br>`;
            successMsg += `Salary: ${Object.keys(salaryData).length} ×¨×©×•××•×ª | BTL: ${Object.keys(btlData).length} ×¨×©×•××•×ª`;
            if (skippedFiles.length > 0) {
                successMsg += `<br>âš ï¸ ${skippedFiles.length} ×§×‘×¦×™× ×œ× ×–×•×”×• (×¨××” Console)`;
            }
            showMessage('loadMessage', successMsg, 'success');
            
            // ×”×¦×’×ª ×ª×•×¦××•×ª
            populateYearFilter();
            updateStats();
            displayResults();
            
            // ×”×¦×’×ª ×—×œ×§×™× ××•×¡×ª×¨×™×
            document.getElementById('statsSection').classList.remove('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            saveToIndexedDB();
        });
        // ×˜×¢×™× ×ª × ×ª×•× ×™× ×-IndexedDB
async function loadFromIndexedDB() {
    try {
        const db = await openDatabase();
        
        // ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™×
        const matchedDataFromDB = await getAllFromStore(db, 'matchedData');
        const salaryDataFromDB = await getAllFromStore(db, 'salaryData');
        const btlDataFromDB = await getAllFromStore(db, 'btlData');
        
        console.log('ğŸ“Š × ×ª×•× ×™× × ×˜×¢× ×• ×-IndexedDB:', {
            matched: matchedDataFromDB.length,
            salary: salaryDataFromDB.length,
            btl: btlDataFromDB.length
        });
        
        // ×”××¨×” ×œ××‘× ×” ×”××§×•×¨×™
        matchedData = matchedDataFromDB;
        
        salaryData = {};
        salaryDataFromDB.forEach(item => {
            const { key, ...data } = item;
            salaryData[key] = data;
        });
        
        btlData = {};
        btlDataFromDB.forEach(item => {
            const { key, ...data } = item;
            btlData[key] = data;
        });
        
        // ×˜×¢×™× ×ª detailedSalaryData ×× ×§×™×™×
        try {
            const detailedDataFromDB = await getAllFromStore(db, 'detailedSalaryData');
            if (typeof detailedSalaryData !== 'undefined') {
                detailedSalaryData = {};
                detailedDataFromDB.forEach(item => {
                    detailedSalaryData[item.key] = item.months;
                });
            }
            console.log('âœ… × ×ª×•× ×™× ××¤×•×¨×˜×™× × ×˜×¢× ×•:', detailedDataFromDB.length);
        } catch (e) {
            console.log('â„¹ï¸ ××™×Ÿ × ×ª×•× ×™× ××¤×•×¨×˜×™×');
        }
        
        // ×¢×“×›×•×Ÿ ×©× ×™×
        allYears.clear();
        matchedData.forEach(row => {
            const year = row.startDate.split('/')[2];
            if (year) allYears.add(year);
        });
        
        // ×¢×“×›×•×Ÿ UI
        document.getElementById('folderArea').classList.add('loaded');
        document.getElementById('folderArea').innerHTML = `
            <div class="folder-icon">ğŸ’¾</div>
            <h3>× ×ª×•× ×™× × ×˜×¢× ×• ×-IndexedDB!</h3>
            <p>Matched: ${matchedData.length} | Salary: ${Object.keys(salaryData).length} | BTL: ${Object.keys(btlData).length}</p>
        `;
        
        showMessage('loadMessage', `âœ… × ×˜×¢× ×• ${matchedData.length} ×¨×©×•××•×ª ×-IndexedDB!`, 'success');
        
        // ×”×¦×’×ª ×ª×•×¦××•×ª
        populateYearFilter();
        updateStats();
        displayResults();
        
        document.getElementById('statsSection').classList.remove('hidden');
        document.getElementById('filtersSection').classList.remove('hidden');
        document.getElementById('resultsSection').classList.remove('hidden');
        
        return true;
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×”:', error);
        showMessage('loadMessage', 'âŒ ××™×Ÿ × ×ª×•× ×™× ×©××•×¨×™× ×‘-IndexedDB', 'error');
        return false;
    }
}

// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ - ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××˜×‘×œ×”
function getAllFromStore(db, storeName) {
    return new Promise((resolve, reject) => {
        try {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const request = store.getAll();
            
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
        } catch (error) {
            // ×× ×”×˜×‘×œ×” ×œ× ×§×™×™××ª, ××—×–×™×¨×™× ××¢×¨×š ×¨×™×§
            resolve([]);
        }
    });
}

// ××—×™×§×ª ×›×œ ×”× ×ª×•× ×™× ×-IndexedDB
async function clearIndexedDB() {
    if (!confirm('â“ ×”×× ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×©××•×¨×™×?')) {
        return;
    }
    
    try {
        const db = await openDatabase();
        const tx = db.transaction(['matchedData', 'salaryData', 'btlData', 'detailedSalaryData'], 'readwrite');
        
        tx.objectStore('matchedData').clear();
        tx.objectStore('salaryData').clear();
        tx.objectStore('btlData').clear();
        try {
            tx.objectStore('detailedSalaryData').clear();
        } catch (e) {}
        
        await tx.complete;
        
        console.log('ğŸ—‘ï¸ IndexedDB × ×•×§×”');
        showMessage('loadMessage', 'âœ… ×”× ×ª×•× ×™× × ××—×§×• ×-IndexedDB', 'success');
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘××—×™×§×”:', error);
    }
}

        // ×‘×™×¦×•×¢ ×”×¦×œ×‘×”
        function performMatching() {
            matchedData = [];
            const allKeys = new Set([...Object.keys(salaryData), ...Object.keys(btlData)]);

            allKeys.forEach(key => {
                const salary = salaryData[key] || { empId: '', startDate: '', endDate: '', amount: 0 };
                const btl = btlData[key] || { empId: '', startDate: '', endDate: '', amount: 0 };

                // ×× ××™×Ÿ × ×ª×•× ×™× ×‘×©× ×™ ×”×¦×“×“×™×, ×§×— ××”×¦×“ ×©×™×© ×‘×• × ×ª×•× ×™×
                const empId = salary.empId || btl.empId;
                const startDate = salary.startDate || btl.startDate;
                const endDate = salary.endDate || btl.endDate;

                const salaryAmount = salary.amount || 0;
                const btlAmount = btl.amount || 0;
                const balance = btlAmount - salaryAmount;

                let status = 'unbalanced';
                if (Math.abs(balance) < 0.01) {
                    status = 'balanced';
                } else if (btlAmount > 0 && btlAmount < salaryAmount) {
                    status = 'partial';
                }

                matchedData.push({
                    key: key,
                    empId: empId,
                    startDate: startDate,
                    endDate: endDate,
                    salaryAmount: salaryAmount,
                    btlAmount: btlAmount,
                    balance: balance,
                    status: status
                });
            });

            console.log(`âœ… ×”×¦×œ×‘×” ×”×•×©×œ××”: ${matchedData.length} ×¨×©×•××•×ª`);
        }

        // ××™×œ×•×™ ×¡×™× ×•×Ÿ ×©× ×™×
        function populateYearFilter() {
            const yearSelect = document.getElementById('filterYear');
            yearSelect.innerHTML = '<option value="">×›×œ ×”×©× ×™×</option>';
            
            const sortedYears = Array.from(allYears).sort((a, b) => b - a);
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        function updateStats() {
            const total = matchedData.length;
            const balanced = matchedData.filter(r => r.status === 'balanced').length;
            const unbalanced = matchedData.filter(r => r.status !== 'balanced').length;
            const totalGap = matchedData.reduce((sum, r) => sum + Math.abs(r.balance), 0);

            document.getElementById('totalRecords').textContent = total;
            document.getElementById('balancedCount').textContent = balanced;
            document.getElementById('unbalancedCount').textContent = unbalanced;
            document.getElementById('totalGap').textContent = totalGap.toLocaleString('he-IL', { minimumFractionDigits: 2 }) + ' â‚ª';
        }

        // ×”×¦×’×ª ×ª×•×¦××•×ª
        function displayResults(filteredData = null) {
            const data = filteredData || matchedData;
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                
                const statusText = row.status === 'balanced' ? 'âœ… ×××•×–×Ÿ' : 
                                 row.status === 'partial' ? 'âš ï¸ ×—×œ×§×™' : 
                                 'âŒ ×œ× ×××•×–×Ÿ';
                
                const statusClass = row.status === 'balanced' ? 'status-balanced' : 
                                   row.status === 'partial' ? 'status-partial' : 
                                   'status-unbalanced';

                tr.innerHTML = `
                    <td>${row.empId}</td>
                    <td>${row.startDate}</td>
                    <td>${row.endDate}</td>
                    <td>${row.salaryAmount.toLocaleString('he-IL', { minimumFractionDigits: 2 })} â‚ª</td>
                    <td>${row.btlAmount.toLocaleString('he-IL', { minimumFractionDigits: 2 })} â‚ª</td>
                    <td class="${statusClass}">${row.balance.toLocaleString('he-IL', { minimumFractionDigits: 2 })} â‚ª</td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ×”×—×œ×ª ×¡×™× ×•× ×™×
        function applyFilters() {
            const filterEmployee = document.getElementById('filterEmployee').value.trim();
            const filterYear = document.getElementById('filterYear').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterSearch = document.getElementById('filterSearch').value.trim().toLowerCase();

            let filtered = matchedData.filter(row => {
                // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¢×•×‘×“
                if (filterEmployee && !row.empId.toString().includes(filterEmployee)) {
                    return false;
                }

                // ×¡×™× ×•×Ÿ ×œ×¤×™ ×©× ×”
                if (filterYear) {
                    const year = row.startDate.split('/')[2];
                    if (year !== filterYear) return false;
                }

                // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡
                if (filterStatus && row.status !== filterStatus) {
                    return false;
                }

                // ×—×™×¤×•×© ×—×•×¤×©×™
                if (filterSearch) {
                    const searchStr = `${row.empId} ${row.startDate} ${row.endDate}`.toLowerCase();
                    if (!searchStr.includes(filterSearch)) return false;
                }

                return true;
            });

            displayResults(filtered);
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¡×•× × ×•×ª
            const balanced = filtered.filter(r => r.status === 'balanced').length;
            const unbalanced = filtered.filter(r => r.status !== 'balanced').length;
            const totalGap = filtered.reduce((sum, r) => sum + Math.abs(r.balance), 0);

            document.getElementById('totalRecords').textContent = filtered.length;
            document.getElementById('balancedCount').textContent = balanced;
            document.getElementById('unbalancedCount').textContent = unbalanced;
            document.getElementById('totalGap').textContent = totalGap.toLocaleString('he-IL', { minimumFractionDigits: 2 }) + ' â‚ª';
        }

        // ×™×™×¦×•× ×œ-Excel
        function exportToExcel() {
            const data = [];
            const tbody = document.getElementById('resultsBody');
            const rows = tbody.getElementsByTagName('tr');

            // ×›×•×ª×¨×•×ª
            data.push(['××¡×¤×¨ ×–×”×•×ª', '×ª××¨×™×š ×”×ª×—×œ×”', '×ª××¨×™×š ×¡×™×•×', '×¡×›×•× ×©×©×•×œ×', '×¡×›×•× ×©×”×ª×§×‘×œ', '×××–×Ÿ', '×¡×˜×˜×•×¡']);

            // × ×ª×•× ×™×
            Array.from(rows).forEach(row => {
                const cells = row.getElementsByTagName('td');
                const rowData = Array.from(cells).map(cell => cell.textContent.replace(' â‚ª', ''));
                data.push(rowData);
            });

            // ×™×¦×™×¨×ª workbook
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '×ª×•×¦××•×ª ×”×¦×œ×‘×”');

            // ×”×•×¨×“×”
            const fileName = `miluim_report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
// ×™×™×¦×•× ×“×•×— ××¤×•×¨×˜ ×œ-3 ×’×œ×™×•× ×•×ª
function exportDetailedExcel() {
    const wb = XLSX.utils.book_new();
    
    // ×’×™×œ×™×•×Ÿ 90291 - ××¡×¤×¨ ×¢×•×‘×“, ×ª××¨×™×š ×, ×ª××¨×™×š ×¢×“
    const sheet1Data = [['××¡×¤×¨ ×¢×•×‘×“', '×ª××¨×™×š ×”×ª×—×œ×”', '×ª××¨×™×š ×¡×™×•×']];
    Object.keys(salaryData).forEach(key => {
        const rec = salaryData[key];
        sheet1Data.push([rec.empId, rec.startDate, rec.endDate]);
    });
    const ws1 = XLSX.utils.aoa_to_sheet(sheet1Data);
    XLSX.utils.book_append_sheet(wb, ws1, '90291');
    
    // ×’×™×œ×™×•×Ÿ 94010 - ××¡×¤×¨ ×¢×•×‘×“, ×—×•×“×© ×¢×¨×š, ×‘×¨×•×˜×• ×‘×™×˜×•×— ×œ××•××™
    const sheet2Data = [['××¡×¤×¨ ×¢×•×‘×“', '×—×•×“×© ×¢×¨×š', '×‘×¨×•×˜×• ×‘×™×˜×•×— ×œ××•××™']];
    Object.keys(detailedSalaryData).forEach(key => {
        const rec = salaryData[key];
        const months = detailedSalaryData[key];
        months.forEach(m => {
            sheet2Data.push([rec.empId, m.month, m.bruto]);
        });
    });
    const ws2 = XLSX.utils.aoa_to_sheet(sheet2Data);
    XLSX.utils.book_append_sheet(wb, ws2, '94010');
    
    // ×’×™×œ×™×•×Ÿ 1857 - ××¡×¤×¨ ×¢×•×‘×“, ×—×•×“×© ×¢×¨×š, ××¡×¤×¨ ×™××™×
    const sheet3Data = [['××¡×¤×¨ ×¢×•×‘×“', '×—×•×“×© ×¢×¨×š', '××¡×¤×¨ ×™××™×']];
    Object.keys(detailedSalaryData).forEach(key => {
        const rec = salaryData[key];
        const months = detailedSalaryData[key];
        months.forEach(m => {
            sheet3Data.push([rec.empId, m.month, m.days]);
        });
    });
    const ws3 = XLSX.utils.aoa_to_sheet(sheet3Data);
    XLSX.utils.book_append_sheet(wb, ws3, '1857');
    
    // ×”×•×¨×“×”
    const fileName = `miluim_detailed_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    console.log('âœ… ×™×™×¦×•× ××¤×•×¨×˜ ×”×•×©×œ×!');
}
        // ××™×Ÿ ×¦×•×¨×š ×‘×˜×¢×™× ×ª ×”×’×“×¨×•×ª - ×”×Ÿ ×§×‘×•×¢×•×ª ×‘×§×•×“
    </script>
</body>
</html>
