<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×¡×‘×¨ ×‘×§×œ×™×§</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 { font-size: 1.8em; margin-bottom: 5px; }
        .header p { opacity: 0.85; font-size: 0.95em; }

        .content { padding: 30px; }

        .upload-area {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border: 3px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
        }
        .upload-area:hover { border-color: #3498db; background: #e3f2fd; }
        .upload-area.loaded { border-color: #27ae60; background: #d5f4e6; }
        .upload-icon { font-size: 3em; margin-bottom: 10px; }
        .upload-area p { color: #666; font-size: 1.1em; }
        #fileInput { display: none; }
        .file-name { margin-top: 10px; font-weight: bold; color: #27ae60; }

        .check-selection { margin-bottom: 25px; }
        .check-selection label { display: block; font-weight: bold; color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
        .check-selection select {
            width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 10px;
            font-size: 1em; font-family: inherit; background: white; cursor: pointer;
        }
        .check-selection select:focus { outline: none; border-color: #3498db; }

        .btn-run {
            display: block; width: 100%; padding: 14px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white; border: none; border-radius: 10px;
            font-size: 1.15em; font-weight: bold; cursor: pointer;
            transition: all 0.3s; margin-bottom: 25px;
        }
        .btn-run:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(39,174,96,0.4); }
        .btn-run:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }

        .results-area { display: none; }

        .result-card {
            background: #f8f9fa; border-radius: 12px; border: 2px solid #e9ecef;
            padding: 25px; margin-bottom: 20px;
        }
        .result-card h3 {
            color: #2c3e50; font-size: 1.3em; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 2px solid #3498db;
        }

        .explanation-text { line-height: 1.9; color: #333; font-size: 1.05em; white-space: pre-wrap; }
        .explanation-text .highlight { background: #fff3cd; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .explanation-text .total { background: #d4edda; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .explanation-text .note { color: #856404; font-style: italic; }

        .employee-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 15px 20px; border-radius: 10px;
            margin-bottom: 20px; font-size: 1.05em;
        }
        .employee-info span { margin-left: 25px; }

        .message { padding: 12px 18px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .message.error { background: #fadbd8; color: #c0392b; border: 1px solid #e74c3c; display: block; }
        .message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffc107; display: block; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #17a2b8; display: block; }
        .tlush-category {
    margin-bottom: 20px;
}
.tlush-category-title {
    background: linear-gradient(45deg, #2c3e50, #3498db);
    color: white;
    padding: 10px 15px;
    border-radius: 8px 8px 0 0;
    font-weight: bold;
    font-size: 1.1em;
}
.tlush-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 5px;
}
.tlush-table th {
    background: #f0f0f0;
    padding: 8px;
    border: 1px solid #ddd;
    font-size: 0.85em;
    color: #555;
}
.tlush-table td {
    padding: 8px;
    border: 1px solid #ddd;
    font-size: 0.9em;
}
.tlush-table tr:hover {
    background: #e3f2fd;
    cursor: pointer;
}
.tlush-table tr.has-explanation {
    background: #fffde7;
}
.tlush-table tr.has-explanation:hover {
    background: #fff9c4;
}
.tlush-explain-icon {
    cursor: pointer;
    font-size: 1.2em;
}
.tlush-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}
.tlush-row .tlush-category {
    flex: 1;
}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ“‹ ×”×¡×‘×¨ ×‘×§×œ×™×§</h1>
        <p>×”×¢×œ×• ×§×•×‘×¥ × ×ª×•× ×™ ×©×›×¨ ×•×‘×—×¨×• ×¡×•×’ ×‘×“×™×§×” ×œ×§×‘×œ×ª ×”×¡×‘×¨ ××¤×•×¨×˜</p>
    </div>

    <div class="content">
        <!-- ×”×¢×œ××ª ×§×•×‘×¥ - ×ª××™×“ ××•×¦×’ -->
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">ğŸ“</div>
            <p>×œ×—×¦×• ×›××Ÿ ×œ×”×¢×œ××ª ×§×•×‘×¥ ××§×¡×œ ×©×œ ×¢×•×‘×“</p>
            <div class="file-name" id="fileName"></div>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">

        <!-- ×˜××‘×™× - ××•×¦×’×™× ××—×¨×™ ×˜×¢×™× ×ª ×§×•×‘×¥ -->
        <div class="tabs" id="tabsArea" style="display:none; flex-direction:row; margin-bottom:20px; border-bottom:3px solid #3498db;">
            <button class="tab-btn active" id="tabTlush" onclick="switchTab('tlush')" style="flex:1; padding:12px; border:none; background:#3498db; color:white; font-size:1.1em; font-weight:bold; cursor:pointer; border-radius:8px 8px 0 0;">×ª×¦×•×’×ª ×ª×œ×•×©</button>
            <button class="tab-btn" id="tabChecks" onclick="switchTab('checks')" style="flex:1; padding:12px; border:none; background:#e9ecef; color:#333; font-size:1.1em; font-weight:bold; cursor:pointer; border-radius:8px 8px 0 0;">×‘×“×™×§×•×ª ××•×¨×›×‘×•×ª</button>
        </div>

        <!-- ×¤×× ×œ ×ª×œ×•×© -->
        <div id="tlushPanel" style="display:none;">
            <div class="employee-info" id="tlushEmployeeInfo"></div>
            <div id="tlushCategories"></div>
        </div>

        <!-- ×¤×× ×œ ×”×¡×‘×¨ ×œ×ª×œ×•×© -->
        <div id="tlushExplanation" style="display:none; position:fixed; top:0; left:0; width:400px; height:100vh; background:white; box-shadow:5px 0 20px rgba(0,0,0,0.3); z-index:200; overflow-y:auto; padding:20px;">
            <button onclick="closeTlushExplanation()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; margin-bottom:15px;">âœ• ×¡×’×•×¨</button>
            <h3 id="tlushExpTitle" style="color:#2c3e50; margin-bottom:15px;"></h3>
            <div id="tlushExpContent" class="explanation-text"></div>
        </div>

        <!-- ×¤×× ×œ ×‘×“×™×§×•×ª ××•×¨×›×‘×•×ª -->
        <div id="checksPanel" style="display:none;">
            <div class="check-selection">
                <label>×‘×—×¨×• ×¡×•×’ ×‘×“×™×§×”:</label>
                <select id="checkType">
                    <option value="">-- ×‘×—×¨×• ×‘×“×™×§×” --</option>
                    <option value="vatik">×ª×•×¡×¤×ª ×•×ª×§</option>
                    <option value="nihul4517">××¢× ×§ ×ª×•×¡×¤×ª × ×™×”×•×œ (4517)</option>
                    <option value="check161">×‘×“×™×§×ª ×¡×›×•××™× ×‘×˜×•×¤×¡ 161</option>
                  <option value="bruto91025">×”×¨×›×‘×ª ×‘×¨×•×˜×• ×¤× ×¡×™×” (91025)</option>
                  <option value="checkTax">×‘×“×™×§×ª ××¡ ×”×›× ×¡×”</option>
                  <option value="checkBituachLeumi">×‘×“×™×§×ª ×‘×™×˜×•×— ×œ××•××™ ×•××¡ ×‘×¨×™××•×ª</option>
                </select>
            </div>

            <div class="message info" id="instructionsArea" style="display:none;"></div>

            <button class="btn-run" id="btnRun" disabled onclick="runCheck()">â–¶ ×”×¦×’ ×”×¡×‘×¨</button>

            <div class="message" id="messageArea"></div>

            <div class="results-area" id="resultsArea">
                <div class="employee-info" id="employeeInfo"></div>
                <div class="result-card">
                    <h3 id="resultTitle"></h3>
                    <div class="explanation-text" id="explanationText"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// ============================================
// ××™×¤×•×™ ×¢××•×“×•×ª ×§×‘×•×¢ (×¢×‘×¨×™×ª)
// ============================================
const COL = {
    MISRAD:        '××©×¨×“',
    ZEHUT:         '×–×”×•×ª',
    MN:            '×.× ',
    MISPAR_OVED:   '××¡×¤×§ ×¢×•×‘×“',
    SEMEL:         '×¡××œ',
    SHEM_SEMEL:    '×©× ×¡××œ',
    TAARICH_SACHAR:'×ª××¨×™×š ×©×›×¨',
    TAARICH_ERECH: '×ª××¨×™×š ×¢×¨×š',
    SCHUM:         '×¡×›×•×',           // ×©×“×” 1
    KAMUT:         '×›××•×ª',           // ×©×“×” 2
    ACHUZ:         '××—×•×–',           // ×©×“×” 3
    TAARIF:        '×ª×¢×¨×™×£',          // ×©×“×” 4
    PRATIM:        '×¤×¨×˜×™×',          // ×©×“×” 5
    SEIF_TAKTZIV:  '×¡×¢×™×£ ×ª×§×¦×™×‘×™',    // ×©×“×” 6
    TAARICH_M:     '×ª××¨×™×š ×',        // ×©×“×” 7
    TAARICH_AD:    '×ª××¨×™×š ×¢×“',       // ×©×“×” 8
    VALUE_5:       'value_5',        // ×©×“×” 9
    VALUE_6:       'value_6',        // ×©×“×” 10
    VALUE_7:       'value_7',        // ×©×“×” 11
    VALUE_8:       'value_8',        // ×©×“×” 12
    VALUE_9:       'value_9',        // ×©×“×” 13
    VALUE_10:      'value_10',       // ×©×“×” 14
    VALUE_11:      'value_11',       // ×©×“×” 15
    VALUE_12:      'value_12',       // ×©×“×” 16
    VALUE_13:      'value_13',       // ×©×“×” 17
    VALUE_14:      'value_14',       // ×©×“×” 18
    VALUE_15:      'value_15',       // ×©×“×” 19
    VALUE_16:      'value_16',       // ×©×“×” 20
    VALUE_17:      'value_17',       // ×©×“×” 21
    VALUE_18:      'value_18',       // ×©×“×” 22
    VALUE_19:      'value_19',       // ×©×“×” 23
    VALUE_20:      'value_20',       // ×©×“×” 24
    VALUE_21:      'value_21',       // ×©×“×” 25
    VALUE_22:      'value_22',       // ×©×“×” 26
    VALUE_23:      'value_23',       // ×©×“×” 27
    VALUE_24:      'value_24',       // ×©×“×” 28
    SCHUM_SHIKLI:  '×¡×›×•× ×©×§×œ×™',      // ×©×“×” 29
};

let rawData = [];
let employeeData = {};
let lastFileData = null;
const checkInstructions = {
    vatik: {
        title: '×ª×•×¡×¤×ª ×•×ª×§',
        instructions: '×™×© ×œ×”×›×™×Ÿ ×§×•×‘×¥ × ×ª×•× ×™× ×›×¡×¤×™×™× ×œ×¢×•×‘×“ ×¢×‘×•×¨ <strong>×—×•×“×© ××—×“</strong>.'
    },
    // ×“×•×’××” ×œ×‘×“×™×§×” ×¢×ª×™×“×™×ª ×©×¦×¨×™×›×” 3 ×—×•×“×©×™×
    // example: {
    //     title: '×‘×“×™×§×” ×œ×“×•×’××”',
    //     instructions: '×™×© ×œ×”×›×™×Ÿ ×§×•×‘×¥ × ×ª×•× ×™× ×›×¡×¤×™×™× ×œ×¢×•×‘×“ ×¢×‘×•×¨ <strong>3 ×—×•×“×©×™× ××—×¨×•× ×™×</strong>.'
    // },
  nihul4517: {
    title: '××¢× ×§ ×ª×•×¡×¤×ª × ×™×”×•×œ (4517)',
    instructions: '××“×•×‘×¨ ×‘×ª×•×¡×¤×ª ×¨×‘×¢×•× ×™×ª. ×™×© ×œ×©×œ×•×£ × ×ª×•× ×™× ×›×¡×¤×™×™× ×‘×’×™×Ÿ <strong>3 ×—×•×“×©×™ ×¢×¨×š</strong> ×©×§×“××• ×œ×ª×©×œ×•× ×”× ×‘×“×§.<br>×œ×“×•×’××”: ×× ×‘×•×“×§×™× 01.01.2026, ×™×© ×œ×”×•×¦×™× × ×ª×•× ×™× ×-01.10.2025 ×¢×“ 31.12.2025.'
},
check161: {
    title: '×‘×“×™×§×ª ×¡×›×•××™× ×‘×˜×•×¤×¡ 161',
    instructions: '×™×© ×œ×”×•×¦×™× × ×ª×•× ×™× ×›×¡×¤×™×™× ×©×œ <strong>×—×•×“×© ×¢×‘×•×“×” ××—×¨×•×Ÿ</strong>. ×”××¢×¨×›×ª ×ª×‘×“×•×§ ×©×œ×•×©×” ×¡×›×•××™×: ××©×›×•×¨×ª ××‘×•×˜×—×ª, ××©×›×•×¨×ª ×œ×¤×™×¦×•×™×™× ×•××©×›×•×¨×ª ×œ×¤×˜×•×¨.'
},
};
// ============================================
// ×œ×•×— × ×™×›×•×™×™× 2026 - ×¨×©×•×ª ×”××¡×™×
// ============================================
const TAX_TABLES = {
    meta: { year: 2026 },
    
    incomeTax: {
        monthly: [
            { from: 0, to: 7010, rate: 0.10 },
            { from: 7011, to: 10060, rate: 0.14 },
            { from: 10061, to: 16150, rate: 0.20 },
            { from: 16151, to: 22440, rate: 0.31 },
            { from: 22441, to: 46690, rate: 0.35 },
            { from: 46691, to: null, rate: 0.47 }
        ]
    },
    
    creditPoint: { monthly: 242 },
    
    additionalTax: {
        threshold: 60130,
        rate: 0.03
    }
};
const SIMPLE_RULES = {
    '×”×‘×¨××”': {
        name: ' ×”×‘×¨××”',
        explanation: '×ª×©×œ×•× ×©× ×ª×™ ×¢×‘×•×¨ ×“××™ ×”×‘×¨××”. ××—×•×©×‘ ×œ×¤×™ ××¡×¤×¨ ×™××™ ×”×–×›××•×ª ×›×¤×•×œ ×ª×¢×¨×™×£ ×™×•× ×”×‘×¨××”.',
        fields: {
            kamut: '××¡×¤×¨ ×™××™ ×–×›××•×ª',
            taarif: '×ª×¢×¨×™×£ ×œ×™×•×',
            schum: '×¡×”"×› ×ª×©×œ×•×'
        }
    },
    '×‘×™×’×•×“': {
        name: '×‘×™×’×•×“',
        explanation: '×ª×©×œ×•× ×©× ×ª×™ ×œ×¨×›×™×©×ª ×‘×™×’×•×“.',
        fields: {
            schum: '×¡×”"×› ×ª×©×œ×•×'
        }
    },
   '××¢× ×§ ×™×•×‘×œ': {
    name: '××¢× ×§ ×™×•×‘×œ',
    explanation: '××¢× ×§ ×©× ×ª×™ ×œ×‘×¢×œ×™ ×•×ª×§ ×©×œ 25 ×©× ×” ×•××¢×œ×”. ××©×•×œ× ×‘×©×™×¢×•×¨ 60% ××”×©×›×¨ ×”×§×•×‘×¢ (×¡××œ 91025).',
    relatedSemel: 91025,
    checkPercent: 0.60,
    fields: {
        schum: '×¡×”"×› ×ª×©×œ×•×'
    }
},
 '×©×›×¨ ×™×¡×•×“': {
        name: '×©×›×¨ ×™×¡×•×“',
        explanation: '×ª×•×¡×¤×ª ××©×•×œ××ª ×¢×œ ×¤×™ ×“×™×¨×•×’ ×•×“×¨×’×”',
        fields: {
            schum: '×¡×”"×› ×ª×©×œ×•×'
        }
    },
};
const COMPLEX_RULES_MAP = {
    90146: 'vatik',
    4517: 'nihul4517',
    9517: 'nihul4517',
    91025: 'bruto91025',
    91003: 'checkTax',
    91001: 'checkBituachLeumi',
92041: 'checkBituachLeumi'
};
const NON_PENSION_KEYWORDS = [
    '×”×—×–×¨', '×©"× ', '×©×¢×•×ª × ×•×¡×¤×•×ª', '×©.× ', '×©× ', '×©×´× ',
    '×˜×œ×¤×•×Ÿ', '×›×œ×›×œ×”', '× ×¡×™×¢×•×ª', '××©"×œ', '××©×œ', '××©×´×œ',
    '×”×•×¦××•×ª', '× ×¡×™×¢×”', '×¨×›×‘', '×“×œ×§', '×—× ×™×”'
];
// ============================================
// ×˜×¢×™× ×ª ×§×•×‘×¥
// ============================================
document.getElementById('fileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    document.getElementById('fileName').textContent = 'âœ… ' + file.name;
    document.getElementById('uploadArea').classList.add('loaded');

    try {
        const data = await file.arrayBuffer();
        lastFileData = data;
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        
        // ×§×¨×™××” ×›××¢×¨×š ×©×•×¨×•×ª
        const allRows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        // ××¦×™××ª ×©×•×¨×ª ×”×›×•×ª×¨×•×ª - ××—×¤×©×™× ××ª ×”×©×•×¨×” ×©××›×™×œ×” "×¡××œ"
        let headerRowIndex = -1;
        for (let i = 0; i < Math.min(allRows.length, 5); i++) {
            const row = allRows[i];
            if (row && row.some(cell => String(cell || '').trim() === '×¡××œ')) {
                headerRowIndex = i;
                break;
            }
        }

        if (headerRowIndex === -1) {
            showMessage('âŒ ×œ× × ××¦××” ×©×•×¨×ª ×›×•×ª×¨×•×ª ×¢× ×”×©×“×” "×¡××œ"', 'error');
            return;
        }

        const headers = allRows[headerRowIndex].map(h => String(h || '').trim());
        console.log('×›×•×ª×¨×•×ª:', headers);

        // ×”××¨×” ×œ××•×‘×™×™×§×˜×™×
        const dataRows = [];
        for (let i = headerRowIndex + 1; i < allRows.length; i++) {
            const row = allRows[i];
            if (!row || row.length === 0) continue;
            
            const obj = {};
            headers.forEach((header, idx) => {
                if (header) obj[header] = row[idx];
            });
            
            if (obj[COL.SEMEL]) {
                dataRows.push(obj);
            }
        }

        rawData = dataRows;
        console.log(`âœ… × ×˜×¢× ×• ${rawData.length} ×¨×©×•××•×ª`);

    
parseEmployeeData();
    lastFileData = data;
    buildTlush();
    document.getElementById('tabsArea').style.display = 'flex';
    switchTab('tlush');
    updateRunButton();
    showMessage('');

    } catch (error) {
        console.error('×©×’×™××”:', error);
        showMessage('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ' + error.message, 'error');
    }
});

// ============================================
// ×¤×¨×¡×•×¨ × ×ª×•× ×™ ×¢×•×‘×“
// ============================================
function parseEmployeeData() {
    employeeData = {
        zehut: null,
        misparOved: null,
        misrad: null,
        rows: rawData,
        elements: {}
    };

    rawData.forEach(row => {
        if (!employeeData.zehut) {
            employeeData.zehut = row[COL.ZEHUT] || '';
            employeeData.misparOved = row[COL.MISPAR_OVED] || '';
            employeeData.misrad = row[COL.MISRAD] || '';
        }

        const semel = Number(row[COL.SEMEL] || 0);
        if (!employeeData.elements[semel]) {
            employeeData.elements[semel] = [];
        }

      employeeData.elements[semel].push({
            semel: semel,
            shemSemel: row[COL.SHEM_SEMEL] || '',
            taarichSachar: row[COL.TAARICH_SACHAR] || '',
            taarichErech: row[COL.TAARICH_ERECH] || '',
            // ×©×“×•×ª 1-4 (×¢××•×“×•×ª I-L)
            schum: Number(row[COL.SCHUM] || 0),       // ×©×“×” 1
            kamut: Number(row[COL.KAMUT] || 0),       // ×©×“×” 2
            achuz: Number(row[COL.ACHUZ] || 0),       // ×©×“×” 3
            taarif: Number(row[COL.TAARIF] || 0),     // ×©×“×” 4
            // ×©×“×•×ª 5-8 (×¢××•×“×•×ª M-P)
            pratim: row[COL.PRATIM] || '',            // ×©×“×” 5
            seifTaktziv: row[COL.SEIF_TAKTZIV] || '', // ×©×“×” 6
            taarichM: row[COL.TAARICH_M] || '',       // ×©×“×” 7
            taarichAd: row[COL.TAARICH_AD] || '',     // ×©×“×” 8
            // ×©×“×•×ª 9-16 (×¢××•×“×•×ª Q-X = VALUE_5 ×¢×“ VALUE_12)
            field9: Number(row[COL.VALUE_5] || 0),
            field10: Number(row[COL.VALUE_6] || 0),
            field11: Number(row[COL.VALUE_7] || 0),
            field12: Number(row[COL.VALUE_8] || 0),
            field13: Number(row[COL.VALUE_9] || 0),
            field14: Number(row[COL.VALUE_10] || 0),
            field15: Number(row[COL.VALUE_11] || 0),
            field16: Number(row[COL.VALUE_12] || 0),
            // ×©×“×•×ª 17-24 (×¢××•×“×•×ª Y-AF = VALUE_13 ×¢×“ VALUE_20)
            field17: Number(row[COL.VALUE_13] || 0),
            field18: Number(row[COL.VALUE_14] || 0),
            field19: Number(row[COL.VALUE_15] || 0),
            field20: Number(row[COL.VALUE_16] || 0),
            field21: Number(row[COL.VALUE_17] || 0),
            field22: Number(row[COL.VALUE_18] || 0),
            field23: Number(row[COL.VALUE_19] || 0),
            field24: Number(row[COL.VALUE_20] || 0),
            // ×©×“×•×ª 25-29 (×¢××•×“×•×ª AG-AK = VALUE_21 ×¢×“ VALUE_24 + ×¡×›×•× ×©×§×œ×™)
            field25: Number(row[COL.VALUE_21] || 0),
            field26: Number(row[COL.VALUE_22] || 0),
            field27: Number(row[COL.VALUE_23] || 0),
            field28: Number(row[COL.VALUE_24] || 0),
            schumShikli: Number(row[COL.SCHUM_SHIKLI] || 0),  // ×©×“×” 29
        });
    });

    console.log('×–×”×•×ª:', employeeData.zehut);
    console.log('××¡×¤×¨ ×¢×•×‘×“:', employeeData.misparOved);
    console.log('×¡××œ×™× ×©× ××¦××•:', Object.keys(employeeData.elements).join(', '));
}

// ============================================
// × ×™×”×•×œ ×××©×§
// ============================================
function updateRunButton() {
    const hasFile = rawData.length > 0;
    const hasCheck = document.getElementById('checkType').value !== '';
    document.getElementById('btnRun').disabled = !(hasFile && hasCheck);
}

document.getElementById('checkType').addEventListener('change', function() {
    updateRunButton();
    const type = this.value;
    const instrEl = document.getElementById('instructionsArea');
    if (type && checkInstructions[type]) {
        instrEl.innerHTML = 'ğŸ“‹ ' + checkInstructions[type].instructions;
        instrEl.style.display = 'block';
    } else {
        instrEl.style.display = 'none';
    }
});

function showMessage(text, type) {
    const el = document.getElementById('messageArea');
    if (!text) { el.style.display = 'none'; el.className = 'message'; return; }
    el.textContent = text;
    el.className = 'message ' + (type || 'info');
    el.style.display = 'block';
}

// ============================================
// ×”×¨×¦×ª ×‘×“×™×§×”
// ============================================
function runCheck() {
    const checkType = document.getElementById('checkType').value;
    if (!checkType || rawData.length === 0) return;

    showMessage('');
    document.getElementById('resultsArea').style.display = 'none';

    document.getElementById('employeeInfo').innerHTML =
        `<span>ğŸ‘¤ ×–×”×•×ª: <strong>${employeeData.zehut}</strong></span>` +
        `<span>××¡×¤×¨ ×¢×•×‘×“: <strong>${employeeData.misparOved}</strong></span>` +
        `<span>××©×¨×“: <strong>${employeeData.misrad}</strong></span>`;

    let result = null;
switch (checkType) {
    case 'vatik':
        result = checkVatik();
        break;
    case 'nihul4517':
        result = checkNihul4517();
        break;
case 'check161':
    result = check161();
    break;
    case 'bruto91025':
     result = check91025();
     break;
     case 'checkTax':
    result = checkTax();
    break;
    case 'checkBituachLeumi':
    result = checkBituachLeumi();
    break;
    default:
        if (SIMPLE_RULES[checkType]) {
            result = checkSimpleRule(checkType);
        } else {
            showMessage('×¡×•×’ ×‘×“×™×§×” ×œ× ××•×›×¨', 'error');
        }
        break;
}

    if (result) {
        document.getElementById('resultTitle').textContent = result.title;
        document.getElementById('explanationText').innerHTML = result.explanation;
        document.getElementById('resultsArea').style.display = 'block';
    }
}

// ============================================
// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×§×¨×™××ª ×•×ª×§
// ============================================

/** ×¤×•×¨××˜ ×' (998, 55, 999) - ×©× ×™× ×•×—×•×“×©×™× ×‘×©×“×” ×¡×›×•×. ×œ××©×œ 38.25 = 38 ×©× ×™× + 3 ×—×•×“×©×™× */
function parseVatikFormatA(schum) {
    const years = Math.floor(schum);
    const months = Math.round((schum - years) * 12);
    return { years, months };
}

/** ×¤×•×¨××˜ ×‘' (1, 2, 794, 20) - ×©× ×™× ×‘×¡×›×•×, ×—×•×“×©×™× ×‘××—×•×– */
function parseVatikFormatB(schum, achuz) {
    const years = Math.floor(schum);
    const months = Math.round(achuz);
    return { years, months };
}

/** ×¤×•×¨××˜ ×•×ª×§ ×œ×˜×§×¡×˜ ×§×¨×™× */
function formatVatik(vatik) {
    if (vatik.years === 0 && vatik.months === 0) return '0';
    let parts = [];
    if (vatik.years > 0) parts.push(`${vatik.years} ×©× ×™×`);
    if (vatik.months > 0) parts.push(`${vatik.months} ×—×•×“×©×™×`);
    return parts.join(' ×•-');
}

// ============================================
// ×‘×“×™×§×”: ×ª×•×¡×¤×ª ×•×ª×§
// ============================================
function checkVatik() {
    const VATIK_ELEMENT = 90146;

    const vatikRows = employeeData.elements[VATIK_ELEMENT];

    if (!vatikRows || vatikRows.length === 0) {
        showMessage('×œ× × ××¦××• × ×ª×•× ×™ ×•×ª×§ (×¡××œ 90146) ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”.', 'warning');
        return null;
    }

    console.log('×©×•×¨×•×ª ×•×ª×§:', vatikRows.length);
    console.table(vatikRows.map(r => ({ ×›××•×ª: r.kamut, ×¡×›×•×: r.schum, ××—×•×–: r.achuz, ×ª×¢×¨×™×£: r.taarif })));

    // ××™×¤×•×™ ×¡×•×’×™ ×•×ª×§
    const vatikTypes = {
        1:   { name: '×•×ª×§ ×”×ª×—×œ×ª×™ ××“×•×•×—', format: 'B', note: '×¢×•×‘×“ ×©×”×ª×—×™×œ ×œ×¤× ×™ 1.1.2012 ×¦×¤×•×™ ×©×™×”×™×” ×œ×• ×•×ª×§ ××¡×•×’ ×–×”.' },
        2:   { name: '×•×ª×§ ×©×™×¨×•×ª ×—×•×‘×”', format: 'B', note: '' },
        24:   { name: '×•×ª×§ ××§×¦×•×¢×™', format: 'B', note: '' },
        20:  { name: '×•×ª×§ ×¦×™×‘×•×¨×™', format: 'B', note: '×•×ª×§ ×©× ×¦×‘×¨ ×‘×©×™×¨×•×ª ×¦×™×‘×•×¨×™ ×§×•×“×.' },
        55:  { name: '×•×ª×§ ×‘×©× ×ª ×¤×¨×™×©×”', format: 'A', note: '' },
        794: { name: '××—×¦×™×ª ×•×ª×§ ×ª×•××¨ ×©× ×™', format: 'B', note: '××—×¦×™×ª ××ª×§×•×¤×ª ×”×œ×™××•×“×™× ×œ×ª×•××¨ ×©× ×™.' },
        999: { name: '×•×ª×§ ××—×•×©×‘', format: 'A', note: '×•×ª×§ ×©× ×¦×‘×¨ ××ª×—×™×œ×ª ×”×”×¢×¡×§×” ××• ××ª×—×™×œ×ª ×“×™×•×•×— ××—×¨×•×Ÿ ×©×œ ×•×ª×§ ×”×ª×—×œ×ª×™.' },
        998: { name: '×¡×”"×› ×•×ª×§ ×œ××©×¨×“', format: 'A', note: '' }
    };

    let components = [];
    let totalVatik = null;

    vatikRows.forEach(row => {
     const typeKey = Math.floor(row.schum);
        const typeDef = vatikTypes[typeKey];
if (!typeDef) return;

let vatik;
if (typeDef.format === 'A') {
    vatik = parseVatikFormatA(row.kamut);
} else {
    vatik = parseVatikFormatB(row.kamut, row.achuz);
}
        const entry = {
            type: typeKey,
            typeName: typeDef ? typeDef.name : `×•×ª×§ ××¡×•×’ ${typeKey}`,
            vatik: vatik,
            note: typeDef ? typeDef.note : '',
            raw: row
        };

        if (typeKey === 998) {
            totalVatik = entry;
        } else {
            components.push(entry);
        }
    });

    components.sort((a, b) => a.type - b.type);

    // ×‘× ×™×™×ª ×”×¡×‘×¨ ××™×œ×•×œ×™
    let explanation = '';

    if (totalVatik) {
        explanation += `<span class="total">×¡×”"×› ×”×•×•×ª×§ ×”××•×›×¨ ×œ××©×¨×“ ×”×•× ${formatVatik(totalVatik.vatik)}.</span>\n\n`;
        explanation += `×”×•×•×ª×§ ××•×–×Ÿ ×‘××™×¨×•×¢ 90146  :\n\n`;
        explanation += `×‘× ×ª×•× ×™× ×”×›×¡×¤×™×™× ×©×œ ×”×¢×•×‘×“ ×¨××” × ×ª×•×Ÿ ×¢×–×¨ 90146:\n\n`;
        explanation += `×”×•×•×ª×§ ××•×¨×›×‘ ××”×¨×›×™×‘×™× ×”×‘××™×:\n\n`;
    } else {
        explanation += `×œ×”×œ×Ÿ ×¤×™×¨×•×˜ ×¨×›×™×‘×™ ×”×•×•×ª×§ ×©× ××¦××•:\n\n`;
    }

    if (components.length === 0) {
        explanation += `×œ× × ××¦××• ×¨×›×™×‘×™ ×•×ª×§ ×¤×¨×˜× ×™×™×.`;
    }

    components.forEach(comp => {
        explanation += `<span class="highlight">${comp.typeName}</span> (×¡×•×’ ${comp.type}): ${formatVatik(comp.vatik)}`;
        if (comp.note) {
            explanation += `\n<span class="note">ğŸ“Œ ${comp.note}</span>`;
        }
        explanation += `\n\n`;
    });

    // ×¡×™×›×•×
    if (totalVatik && components.length > 0) {
        let sumYears = 0, sumMonths = 0;
        components.forEach(comp => {
            sumYears += comp.vatik.years;
            sumMonths += comp.vatik.months;
        });
        sumYears += Math.floor(sumMonths / 12);
        sumMonths = sumMonths % 12;

        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        explanation += `×¡×›×•× ×”×¨×›×™×‘×™×: ${formatVatik({ years: sumYears, months: sumMonths })}\n`;
        explanation += `×¡×”"×› ×•×ª×§ ×œ××©×¨×“ (998): ${formatVatik(totalVatik.vatik)}\n`;

        const totalMonths = totalVatik.vatik.years * 12 + totalVatik.vatik.months;
        const sumTotalMonths = sumYears * 12 + sumMonths;

        if (totalMonths === sumTotalMonths) {
            explanation += `\nâœ… ×¡×›×•× ×”×¨×›×™×‘×™× ×ª×•×× ××ª ×”×¡×”"×›.`;
        } else {
            const diff = Math.abs(totalMonths - sumTotalMonths);
            const diffVatik = { years: Math.floor(diff / 12), months: diff % 12 };
            explanation += `\nâš ï¸ ×§×™×™× ×¤×¢×¨ ×©×œ ${formatVatik(diffVatik)} ×‘×™×Ÿ ×¡×›×•× ×”×¨×›×™×‘×™× ×œ×¡×”"×›.`;
        }
    }

    return {
        title: 'ğŸ“Š ×”×¡×‘×¨ ×ª×•×¡×¤×ª ×•×ª×§',
        explanation: explanation
    };
}
function excelDateToDate(serial) {
    if (!serial || isNaN(serial)) return null;
    const date = new Date((serial - 25569) * 86400 * 1000);
    return date;
}

function formatMonthYear(serial) {
    const date = excelDateToDate(serial);
    if (!date) return String(serial);
    const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
    return months[date.getMonth()] + '.' + date.getFullYear();
}
function checkNihul4517() {
    const SEMEL_9517 = 9517;
    const SEMEL_4517 = 4517;
    const SEMEL_684 = 684;

    const rows9517 = employeeData.elements[SEMEL_9517];
    const rows4517 = employeeData.elements[SEMEL_4517];
    const rows684 = employeeData.elements[SEMEL_684];

    if (!rows9517 || rows9517.length === 0) {
        showMessage('×œ× × ××¦××• × ×ª×•× ×™ ×¡××œ 9517 ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”.', 'warning');
        return null;
    }

    // ×–×™×”×•×™ ×—×•×“×© ×ª×©×œ×•× × ×•×›×—×™ (×ª××¨×™×š ×©×›×¨ - ×¢××•×“×” G)
    const allSalaryDates = rawData.map(r => Number(r[COL.TAARICH_SACHAR])).filter(d => d > 0);
    const currentSalaryDate = Math.max(...allSalaryDates);
    const currentDate = excelDateToDate(currentSalaryDate);
    
    // 3 ×—×•×“×©×™ ×¢×¨×š ×©×§×“××• ×œ×—×•×“×© ×”×ª×©×œ×•×
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    const validMonths = [];
    for (let i = 1; i <= 3; i++) {
        let m = currentMonth - i;
        let y = currentYear;
        while (m < 0) { m += 12; y--; }
        validMonths.push({ month: m, year: y });
    }

    function isValidMonth(serial) {
        const d = excelDateToDate(serial);
        if (!d) return false;
        return validMonths.some(vm => vm.month === d.getMonth() && vm.year === d.getFullYear());
    }

    // ×¡×™× ×•×Ÿ ×¨×§ 9517 ×¢× ×ª××¨×™×š ×¢×¨×š ×‘-3 ×”×—×•×“×©×™× ×”×¨×œ×•×•× ×˜×™×™×
    const monthlyTotals = {};
    rows9517.forEach(row => {
        if (!isValidMonth(row.taarichErech)) return;
        const key = formatMonthYear(row.taarichErech);
        if (!monthlyTotals[key]) {
            monthlyTotals[key] = { schum: 0, rows: 0 };
        }
        monthlyTotals[key].schum += row.schum;
        monthlyTotals[key].rows++;
    });

    const months = Object.keys(monthlyTotals).sort();

    // ××—×•×–×™×
    const achuz4517 = rows4517 && rows4517.length > 0 ? rows4517[0].achuz : null;
    const achuz684 = rows684 && rows684.length > 0 ? rows684[0].kamut : null;

    // ×¡×›×•× 4517 ×‘×¤×•×¢×œ
   let schum4517 = 0;
if (rows4517) {
    rows4517.forEach(row => {
        if (Number(row.taarichSachar) === currentSalaryDate && Number(row.taarichErech) === currentSalaryDate) {
            schum4517 += row.schum;
        }
    });
}

    // ×—×™×©×•×‘ ×××•×¦×¢
    let totalSchum = 0;
    months.forEach(m => { totalSchum += monthlyTotals[m].schum; });
    const total3Months = totalSchum;

    // ×‘× ×™×™×ª ×”×¡×‘×¨
    let explanation = '';
    explanation += `××¢× ×§ × ×™×”×•×œ ×™×™×¦×•×¨ (4517) ×”×•× ××¢× ×§ ×¨×‘×¢×•× ×™ ×”××—×•×©×‘ ×›×××•×¦×¢ ×©×œ ×©×œ×•×©×ª ×”×—×•×“×©×™× ×”××—×¨×•× ×™×.\n\n`;
    explanation += `×—×•×“×© ×ª×©×œ×•× × ×•×›×—×™: <span class="highlight">${formatMonthYear(currentSalaryDate)}</span>\n\n`;

    if (achuz684 !== null && achuz4517 !== null) {
        const achuz9517 = (achuz684 / 100 + 1) * achuz4517;
        explanation += `×”×‘×¨×•×˜×• ×”×—×•×“×©×™ × ×©××¨ ×‘×¡××œ 9517 ×•××—×•×©×‘ ×›×š:\n`;
        explanation += `<span class="highlight">××—×•×– 9517</span> = (××—×•×– 684 [${achuz684}] / 100 + 1) Ã— ××—×•×– 4517 [${achuz4517}] = ${achuz9517.toFixed(2)}\n`;
        explanation += `<span class="highlight">×¡×›×•× 9517</span> = ×ª×¢×¨×™×£ Ã— ××—×•×– / 3\n\n`;
    }

    explanation += `×¤×™×¨×•×˜ ×œ×¤×™ ×—×•×“×© ×¢×¨×š:\n`;
    if (months.length !== 3) {
        explanation += `<span class="note">âš ï¸ × ××¦××• ${months.length} ×—×•×“×©×™ ×¢×¨×š ×‘××§×•× 3!</span>\n`;
    }

    months.forEach(m => {
        const data = monthlyTotals[m];
        explanation += `<span class="highlight">${m}</span>: ×¡×”"×› 9517 = ${data.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—`;
        if (data.rows > 1) {
            explanation += ` (${data.rows} ×©×•×¨×•×ª)`;
        }
        explanation += `\n`;
    });

    explanation += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  explanation += `×¡×”"×› 9517 ×œ-${months.length} ×—×•×“×©×™×: ${total3Months.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
    explanation += `×¡×›×•× 4517 ×‘×¤×•×¢×œ: ${schum4517.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;

    const diff = Math.abs(schum4517 - total3Months);
    if (diff < 1) {
        explanation += `\nâœ… ×¡×›×•× 4517 ×ª×•×× ××ª ×××•×¦×¢ 3 ×”×—×•×“×©×™×.`;
    } else {
        explanation += `\nâš ï¸ ×§×™×™× ×¤×¢×¨ ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×— ×‘×™×Ÿ ×”×¡×›×•× ×‘×¤×•×¢×œ ×œ×××•×¦×¢.`;
    }

    return {
        title: 'ğŸ“Š ×”×¡×‘×¨ ××¢× ×§ ×ª×•×¡×¤×ª × ×™×”×•×œ (4517)',
        explanation: explanation
    };
}
function check91025() {
    const SEMEL_91025 = 91025;
    const SEMEL_BASIC = 1;  // ×©×›×¨ ×™×¡×•×“
    const TOLERANCE = 0.5;
    
    // ×©×œ×™×¤×ª 91025
    const rows91025 = employeeData.elements[SEMEL_91025];
    if (!rows91025 || rows91025.length === 0) {
        showMessage('×œ× × ××¦× ×¡××œ 91025 (×‘×¨×•×˜×• ×¤× ×¡×™×”) ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”.', 'warning');
        return null;
    }
    
    // ×–×™×”×•×™ ×—×•×“×© × ×•×›×—×™
    const allSalaryDates = rawData.map(r => Number(r[COL.TAARICH_SACHAR])).filter(d => d > 0);
    const currentSalaryDate = Math.max(...allSalaryDates);
    
    // ××¦×™××ª ×¢×¨×š 91025 ×”×©×•×˜×£ (×œ× ×¨×˜×¨×•××§×˜×™×‘×™)
    const current91025 = rows91025.find(r => 
        Number(r.taarichSachar) === currentSalaryDate && 
        Number(r.taarichErech) === currentSalaryDate
    );
    
    const targetBruto = current91025 ? current91025.schum : 0;
    
    if (targetBruto === 0) {
        showMessage('×œ× × ××¦× ×‘×¨×•×˜×• ×¤× ×¡×™×” ×©×•×˜×£ (91025) ×œ×—×•×“×© ×”× ×•×›×—×™.', 'warning');
        return null;
    }
    
    // ××™×¡×•×£ ×›×œ ×”×ª×•×¡×¤×•×ª ×”×©×•×˜×¤×•×ª
    const additions = [];
    for (const [semel, rows] of Object.entries(employeeData.elements)) {
        const semelNum = Number(semel);
        if (semelNum >= 90000) continue;  // ×œ× ×¡××œ×™ ×¡×™×›×•×
        
        rows.forEach(row => {
            if (Number(row.taarichSachar) === currentSalaryDate && 
                Number(row.taarichErech) === currentSalaryDate &&
                row.schum > 0) {
                additions.push({
                    code: semelNum,
                    name: row.shemSemel || `×¡××œ ${semelNum}`,
                    amount: row.schum,
                    tariff: row.taarif || 0
                });
            }
        });
    }
    
    // ×©×œ×‘ 1: ××¦×™××ª ×©×›×¨ ×™×¡×•×“
    const basicSalary = additions.find(a => a.code === SEMEL_BASIC);
    if (!basicSalary) {
        showMessage('×œ× × ××¦× ×©×›×¨ ×™×¡×•×“ (×¡××œ 1) - ×œ× × ×™×ª×Ÿ ×œ× ×ª×— ×”×¨×›×‘×”.', 'warning');
        return null;
    }
    
    // ×‘× ×™×™×ª ×©×¨×©×¨×ª
    let chain = [{
        code: basicSalary.code,
        name: basicSalary.name,
        amount: basicSalary.amount,
        tariff: basicSalary.tariff,
        type: 'base',
        runningTotal: basicSalary.amount
    }];
    
    let runningTotal = basicSalary.amount;
    let usedCodes = new Set([SEMEL_BASIC]);
    
    // ×©×œ×‘ 2: ×‘× ×™×™×ª ×©×¨×©×¨×ª ×”×™×¨×¨×›×™×ª
    let foundNew = true;
    while (foundNew) {
        foundNew = false;
        
        for (const addition of additions) {
            if (usedCodes.has(addition.code)) continue;
            
            // ×‘×“×™×§×”: ×”×× ×”×ª×¢×¨×™×£ ×©×•×•×” ×œ×¡×›×•× ××¦×˜×‘×¨?
            const matchesRunningTotal = Math.abs(addition.tariff - runningTotal) < TOLERANCE;
            const matchesAnyTotal = chain.some(step => 
                Math.abs(addition.tariff - step.runningTotal) < TOLERANCE
            );
            
            if (matchesRunningTotal || matchesAnyTotal) {
                runningTotal += addition.amount;
                chain.push({
                    code: addition.code,
                    name: addition.name,
                    amount: addition.amount,
                    tariff: addition.tariff,
                    type: 'hierarchical',
                    runningTotal: runningTotal
                });
                usedCodes.add(addition.code);
                foundNew = true;
            }
        }
    }
    
    // ×©×œ×‘ 3: PLUG - ×¡×’×™×¨×ª ×¤×¢×¨
    let gap = targetBruto - runningTotal;
    
    if (Math.abs(gap) > TOLERANCE) {
        for (const addition of additions) {
            if (usedCodes.has(addition.code)) continue;
            
            if (Math.abs(addition.amount - gap) < TOLERANCE) {
                // ×‘×“×™×§×” ×©×–×• ×ª×•×¡×¤×ª ×¤× ×¡×™×•× ×™×ª
                const isPension = !NON_PENSION_KEYWORDS.some(kw => 
                    addition.name.includes(kw)
                );
                
                if (isPension) {
                    runningTotal += addition.amount;
                    chain.push({
                        code: addition.code,
                        name: addition.name,
                        amount: addition.amount,
                        tariff: addition.tariff,
                        type: 'plug',
                        runningTotal: runningTotal
                    });
                    usedCodes.add(addition.code);
                    gap = targetBruto - runningTotal;
                    break;
                }
            }
        }
    }
    
    // ×‘× ×™×™×ª ×¨×©×™××ª ×ª×•×¡×¤×•×ª ×©×œ× × ×›×œ×œ×•
    const excluded = additions.filter(a => !usedCodes.has(a.code)).map(a => {
        const isNonPension = NON_PENSION_KEYWORDS.some(kw => a.name.includes(kw));
        return {
            ...a,
            reason: isNonPension ? '×¨×›×™×‘ ×œ×-×¤× ×¡×™×•× ×™' : '×œ× ×”×ª××™× ×œ×©×¨×©×¨×ª'
        };
    });
    
    // ×‘× ×™×™×ª ×”×¡×‘×¨
    let explanation = '';
    explanation += `×‘×¨×•×˜×• ×¤× ×¡×™×” (91025) ××•×¨×›×‘ ××ª×•×¡×¤×•×ª ×¤× ×¡×™×•× ×™×•×ª ×”× ×‘× ×•×ª ×‘×”×™×¨×¨×›×™×”.\n`;
    explanation += `×›×œ ×ª×•×¡×¤×ª ××—×•×©×‘×ª ×¢×œ ×‘×¡×™×¡ ×¡×›×•× ×”×ª×•×¡×¤×•×ª ×©×§×“××• ×œ×” (×©×“×” ×ª×¢×¨×™×£).\n\n`;
    explanation += `×—×•×“×©: <span class="highlight">${formatMonthYear(currentSalaryDate)}</span>\n`;
    explanation += `×‘×¨×•×˜×• ×¤× ×¡×™×” ×‘×¤×•×¢×œ: <span class="highlight">${targetBruto.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
    
    explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    explanation += `ğŸ“Š ×©×¨×©×¨×ª ×”×¨×›×‘×ª ×”×‘×¨×•×˜×• ×”×¤× ×¡×™×•× ×™:\n`;
    explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    const typeLabels = {
        'base': 'ğŸ”µ ×‘×¡×™×¡',
        'hierarchical': 'ğŸŸ¢ ×”×™×¨×¨×›×™',
        'plug': 'ğŸŸ¡ PLUG'
    };
    
    chain.forEach((step, index) => {
        const typeLabel = typeLabels[step.type];
        const tariffInfo = step.type === 'base' ? '' : 
                          step.type === 'plug' ? '(×ª×•×¡×¤×ª ×¡×›×•××™×ª)' : 
                          `â† ×ª×¢×¨×™×£: ${step.tariff.toLocaleString('he-IL')}`;
        
        explanation += `${typeLabel} <span class="highlight">${step.code}</span> ${step.name}\n`;
        explanation += `   ×¡×›×•×: +${step.amount.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª ${tariffInfo}\n`;
        explanation += `   <span class="total">×¡×”"×› ××¦×˜×‘×¨: ${step.runningTotal.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
    });
    
    explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    explanation += `×¡×”"×› ××—×•×©×‘: <span class="highlight">${runningTotal.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n`;
    explanation += `×‘×¨×•×˜×• ×¤× ×¡×™×” ×‘×¤×•×¢×œ: <span class="highlight">${targetBruto.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n`;
    
    const finalGap = Math.abs(targetBruto - runningTotal);
    if (finalGap < TOLERANCE) {
        explanation += `\n<span class="total">âœ… ×”×”×¨×›×‘×” ×ª×•×××ª ××ª ×”×‘×¨×•×˜×• ×”×¤× ×¡×™×•× ×™!</span>`;
    } else {
        explanation += `\n<span class="note">âš ï¸ ×¤×¢×¨ ×©×œ ${finalGap.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>`;
    }
    
   
    return {
        title: 'ğŸ“Š ×”×¨×›×‘×ª ×‘×¨×•×˜×• ×¤× ×¡×™×” (91025)',
        explanation: explanation
    };
}
// ============================================
// ×‘×“×™×§×”: ××¡ ×”×›× ×¡×”
// ============================================
// ============================================
// ×‘×“×™×§×”: ××¡ ×”×›× ×¡×” ×•× ×§×•×“×•×ª ×–×™×›×•×™
// ============================================
function checkTax() {
    // ×¡××œ × ×™×›×•×™ ××¡ ×”×›× ×¡×”
    const rows91003 = employeeData.elements[91003];
    
    // ×¡××œ×™ × ×§×•×“×•×ª ×–×™×›×•×™
    const rows91430 = employeeData.elements[91430];
    const rows91434 = employeeData.elements[91434];
    const rows91435 = employeeData.elements[91435];
    const rows91436 = employeeData.elements[91436];
    
    if (!rows91003 || rows91003.length === 0) {
        showMessage('×œ× × ××¦× ×¡××œ 91003 (× ×™×›×•×™ ××¡ ×”×›× ×¡×”) ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”.', 'warning');
        return null;
    }
    
    const taxActual = rows91003[0].schum;
    
    // ×‘× ×™×™×ª ×”×¡×‘×¨
    let explanation = '';
    explanation += `×‘×“×™×§×ª × ×™×›×•×™ ××¡ ×”×›× ×¡×” - ×œ×•×— × ×™×›×•×™×™× ${TAX_TABLES.meta.year}\n\n`;
    
    // × ×™×›×•×™ ××¡ ×‘×¤×•×¢×œ
    explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    explanation += `ğŸ’° × ×™×›×•×™ ××¡ ×”×›× ×¡×” (×¡××œ 91003)\n`;
    explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    explanation += `×¡×›×•× ×©× ×•×›×”: <span class="highlight">${taxActual.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
    
  // × ×ª×•× ×™ ××¡ ××¡××œ 91430
    if (rows91430 && rows91430.length > 0) {
        const r = rows91430[0];
        
        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        explanation += `ğŸ¯ × ×ª×•× ×™ ××¡ ×›×œ×œ×™×™× (×¡××œ 91430)\n`;
        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        
        // ×©×“×” 1 = schum = × ×§×•×“×•×ª ×‘×—×•×“×©
        if (r.schum > 0) explanation += `× ×§×•×“×•×ª ×–×™×›×•×™ ×‘×—×•×“×©: <span class="highlight">${r.schum}</span>\n`;
        // ×©×“×” 9 = field13 (value_9) = ××—×•×– ×©×•×œ×™ ××“×¨×’×•×ª
        if (r.field13 > 0) explanation += `××—×•×– ××¡ ×©×•×œ×™ (××“×¨×’×•×ª): <span class="highlight">${(r.field13 * 100).toFixed(0)}%</span>\n`;
        // ×©×“×” 12 = field16 (value_12) = ××—×•×– ×©×•×œ×™ ×‘×—×•×“×©
        if (r.field16 > 0) explanation += `××—×•×– ××¡ ×©×•×œ×™ ×‘×—×•×“×©: <span class="highlight">${(r.field16 * 100).toFixed(0)}%</span>\n`;
        // ×©×“×” 13 = field17 (value_13) = ××—×•×– ×–×™×›×•×™ ×™×™×©×•×‘
        if (r.field17 > 0) explanation += `×”×˜×‘×ª ×™×™×©×•×‘ ××•×˜×‘: <span class="highlight">${(r.field17 * 100).toFixed(0)}%</span> ×”× ×—×” ×××¡\n`;
        // ×©×“×” 14 = field18 (value_14) = × ×§×•×“×•×ª ×–×™×›×•×™ ××¦×˜×‘×¨×•×ª
        if (r.field18 > 0) explanation += `× ×§×•×“×•×ª ×–×™×›×•×™ ××¦×˜×‘×¨×•×ª: <span class="highlight">${r.field18}</span>\n`;
        
        explanation += `\n`;
    }
    
    // ×¤×™×¨×•×˜ × ×§×•×“×•×ª ×–×™×›×•×™ ×—×•×“×©×™×•×ª ××¡××œ 91434
    if (rows91434 && rows91434.length > 0) {
        const r = rows91434[0];
        
        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        explanation += `ğŸ“‹ ×¤×™×¨×•×˜ × ×§×•×“×•×ª ×–×™×›×•×™ ×—×•×“×©×™×•×ª (×¡××œ 91434)\n`;
        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        
        let totalPoints = 0;
        let hasPoints = false;
        
        // ×©×“×” 1 = schum = × ×§×³ ×ª×•×©×‘ ×‘×—×•×“×©
        if (r.schum > 0) {
            explanation += `â€¢ × ×§×³ ×ª×•×©×‘: <span class="highlight">${r.schum}</span> (×ª×•×©×‘ ×™×©×¨××œ)\n`;
            totalPoints += r.schum;
            hasPoints = true;
        }
        // ×©×“×” 2 = kamut = × ×§×³ ×¦×¢×™×¨ ×‘×—×•×“×©
        if (r.kamut > 0) {
            explanation += `â€¢ × ×§×³ ×¦×¢×™×¨: <span class="highlight">${r.kamut}</span> (×’×™×œ 16-18)\n`;
            totalPoints += r.kamut;
            hasPoints = true;
        }
        // ×©×“×” 3 = achuz = × ×§×³ ×™×œ×“ 0+18 ×‘×“×—×™×”
        if (r.achuz > 0) {
            explanation += `â€¢ × ×§×³ ×™×œ×“ 0/18: <span class="highlight">${r.achuz}</span> (×™×œ×“ ×’×™×œ 0 ××• 18 ×‘×“×—×™×”)\n`;
            totalPoints += r.achuz;
            hasPoints = true;
        }
        // ×©×“×” 4 = taarif = × ×§×³ ×™×œ×“ 6-17
        if (r.taarif > 0) {
            explanation += `â€¢ × ×§×³ ×™×œ×“ 6-17: <span class="highlight">${r.taarif}</span>\n`;
            totalPoints += r.taarif;
            hasPoints = true;
        }
        // ×©×“×” 5 = field9 = × ×§×³ ×—×“ ×”×•×¨×™
        if (r.field9 > 0) {
            explanation += `â€¢ × ×§×³ ×—×“ ×”×•×¨×™: <span class="highlight">${r.field9}</span> (××©×¤×—×” ×—×“ ×”×•×¨×™×ª)\n`;
            totalPoints += r.field9;
            hasPoints = true;
        }
        // ×©×“×” 6 = field10 = × ×§×³ ×‘×Ÿ/×‘×ª ×–×•×’
        if (r.field10 > 0) {
            explanation += `â€¢ × ×§×³ ×‘×Ÿ/×‘×ª ×–×•×’: <span class="highlight">${r.field10}</span> (×‘×Ÿ ×–×•×’ ×œ×œ× ×”×›× ×¡×”)\n`;
            totalPoints += r.field10;
            hasPoints = true;
        }
        // ×©×“×” 7 = field11 = × ×§×³ ×—×™×™×œ
        if (r.field11 > 0) {
            explanation += `â€¢ × ×§×³ ×—×™×™×œ ××©×•×—×¨×¨: <span class="highlight">${r.field11}</span>\n`;
            totalPoints += r.field11;
            hasPoints = true;
        }
        // ×©×“×” 8 = field12 = × ×§×³ ×¢×•×œ×”
        if (r.field12 > 0) {
            explanation += `â€¢ × ×§×³ ×¢×•×œ×” ×—×“×©: <span class="highlight">${r.field12}</span>\n`;
            totalPoints += r.field12;
            hasPoints = true;
        }
        // ×©×“×” 9 = field13 = × ×§×³ ××§×“××™
        if (r.field13 > 0) {
            explanation += `â€¢ × ×§×³ ×œ×™××•×“×™× ×œ×ª×•××¨: <span class="highlight">${r.field13}</span>\n`;
            totalPoints += r.field13;
            hasPoints = true;
        }
        
        if (!hasPoints) {
            explanation += `<span class="note">×œ× × ××¦××• × ×§×•×“×•×ª ×–×™×›×•×™ ××¤×•×¨×˜×•×ª</span>\n`;
        } else {
            explanation += `\n`;
            explanation += `×¡×”"×› × ×§×•×“×•×ª ×‘×—×•×“×©: <span class="total">${totalPoints.toFixed(2)}</span>\n`;
            explanation += `×©×•×•×™ ×–×™×›×•×™: <span class="total">${(totalPoints * TAX_TABLES.creditPoint.monthly).toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n`;
        }
        
        explanation += `\n`;
    }
    
    // × ×§×•×“×•×ª ××¦×˜×‘×¨×•×ª ××¡××œ 91435
    if (rows91435 && rows91435.length > 0) {
        const r = rows91435[0];
        
        let hasCumulative = false;
        let cumulativeText = '';
        
        // ×©×“×” 1 = schum = × ×§×³ ×¤×¢×•×˜ 1-5 ××¦×˜×‘×¨
        if (r.schum > 0) {
            cumulativeText += `â€¢ × ×§×³ ×¤×¢×•×˜ 1-5 ××¦×˜×‘×¨: <span class="highlight">${r.schum}</span>\n`;
            hasCumulative = true;
        }
        // ×©×“×” 2 = kamut = × ×§×³ ×—×“ ×”×•×¨×™ ××¦×˜×‘×¨
        if (r.kamut > 0) {
            cumulativeText += `â€¢ × ×§×³ ×—×“ ×”×•×¨×™ ××¦×˜×‘×¨: <span class="highlight">${r.kamut}</span>\n`;
            hasCumulative = true;
        }
        // ×©×“×” 3 = achuz = × ×§×³ ×‘×Ÿ ×–×•×’ ××¦×˜×‘×¨
        if (r.achuz > 0) {
            cumulativeText += `â€¢ × ×§×³ ×‘×Ÿ ×–×•×’ ××¦×˜×‘×¨: <span class="highlight">${r.achuz}</span>\n`;
            hasCumulative = true;
        }
        
        if (hasCumulative) {
            explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            explanation += `ğŸ“Š × ×§×•×“×•×ª ×–×™×›×•×™ ××¦×˜×‘×¨×•×ª (×¡××œ 91435)\n`;
            explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            explanation += cumulativeText;
            explanation += `\n`;
        }
    }
    
    // ××™×“×¢ × ×•×¡×£
    explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    explanation += `â„¹ï¸ ××™×“×¢ ×›×œ×œ×™\n`;
    explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    explanation += `×¢×¨×š × ×§×•×“×ª ×–×™×›×•×™ ×—×•×“×©×™×ª: <span class="highlight">${TAX_TABLES.creditPoint.monthly} â‚ª</span>\n`;
    explanation += `×¡×£ ××¡ ×™×¡×£: <span class="highlight">${TAX_TABLES.additionalTax.threshold.toLocaleString('he-IL')} â‚ª</span> (${TAX_TABLES.additionalTax.rate * 100}% × ×•×¡×£)\n`;
    
    return {
        title: 'ğŸ“Š ×‘×“×™×§×ª × ×™×›×•×™ ××¡ ×”×›× ×¡×” ×•× ×§×•×“×•×ª ×–×™×›×•×™',
        explanation: explanation
    };
}
// ============================================
// ×‘×“×™×§×”: ×‘×™×˜×•×— ×œ××•××™ ×•××¡ ×‘×¨×™××•×ª
// ============================================
function checkBituachLeumi() {
    const rows91001 = employeeData.elements[91001];
    const rows92041 = employeeData.elements[92041];
    
    let explanation = '';
    explanation += `×‘×“×™×§×ª × ×™×›×•×™×™ ×‘×™×˜×•×— ×œ××•××™ ×•××¡ ×‘×¨×™××•×ª\n\n`;
    
    // ×‘×™×˜×•×— ×œ××•××™ - ×¡××œ 91001
    if (rows91001 && rows91001.length > 0) {
        const r = rows91001[0];
        
        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        explanation += `ğŸ›ï¸ ×‘×™×˜×•×— ×œ××•××™ (×¡××œ 91001)\n`;
        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
        
        explanation += `×¡×›×•× × ×™×›×•×™ ×‘×¤×•×¢×œ: <span class="highlight">${r.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
        
        explanation += `<strong>×—×™×©×•×‘ ×‘×©×™×¢×•×¨ ××•×¤×—×ª:</strong>\n`;
        explanation += `â€¢ ×¡×›×•× ×—×™×™×‘: ${r.field9.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª\n`;
        explanation += `â€¢ ×©×™×¢×•×¨: ${(r.achuz ).toFixed(2)}%\n`;
        explanation += `â€¢ ×ª×•×¦××”: <span class="highlight">${r.field13.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
        
        explanation += `<strong>×—×™×©×•×‘ ×‘×©×™×¢×•×¨ ××œ×:</strong>\n`;
        explanation += `â€¢ ×¡×›×•× ×—×™×™×‘: ${r.field10.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª\n`;
        explanation += `â€¢ ×©×™×¢×•×¨: ${(r.taarif ).toFixed(2)}%\n`;
        explanation += `â€¢ ×ª×•×¦××”: <span class="highlight">${r.field14.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
        
        const total = r.field13 + r.field14;
        explanation += `×¡×”"×› ××—×•×©×‘: <span class="total">${total.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n`;
        
        const diff = Math.abs(r.schum - total);
        if (diff < 1) {
            explanation += `<span class="total">âœ… ×ª×•×× ×œ× ×™×›×•×™ ×‘×¤×•×¢×œ</span>\n`;
        } else {
            explanation += `<span class="note">âš ï¸ ×”×¤×¨×© ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n`;
        }
        
        explanation += `\n`;
    } else {
        explanation += `<span class="note">×œ× × ××¦× ×¡××œ 91001 (×‘×™×˜×•×— ×œ××•××™)</span>\n\n`;
    }
    
    // ××¡ ×‘×¨×™××•×ª - ×¡××œ 92041
    if (rows92041 && rows92041.length > 0) {
        const r = rows92041[0];
        
        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        explanation += `ğŸ¥ ××¡ ×‘×¨×™××•×ª (×¡××œ 92041)\n`;
        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
        
        explanation += `×¡×›×•× × ×™×›×•×™ ×‘×¤×•×¢×œ: <span class="highlight">${r.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
        
        explanation += `<strong>×—×™×©×•×‘ ×‘×©×™×¢×•×¨ ××•×¤×—×ª:</strong>\n`;
        explanation += `â€¢ ×¡×›×•× ×—×™×™×‘: ${r.field9.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª\n`;
        explanation += `â€¢ ×©×™×¢×•×¨: ${(r.achuz ).toFixed(2)}%\n`;
        explanation += `â€¢ ×ª×•×¦××”: <span class="highlight">${r.field13.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
        
        explanation += `<strong>×—×™×©×•×‘ ×‘×©×™×¢×•×¨ ××œ×:</strong>\n`;
        explanation += `â€¢ ×¡×›×•× ×—×™×™×‘: ${r.field10.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª\n`;
        explanation += `â€¢ ×©×™×¢×•×¨: ${(r.taarif ).toFixed(2)}%\n`;
        explanation += `â€¢ ×ª×•×¦××”: <span class="highlight">${r.field14.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n\n`;
        
        const total = r.field13 + r.field14;
        explanation += `×¡×”"×› ××—×•×©×‘: <span class="total">${total.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n`;
        
        const diff = Math.abs(r.schum - total);
        if (diff < 1) {
            explanation += `<span class="total">âœ… ×ª×•×× ×œ× ×™×›×•×™ ×‘×¤×•×¢×œ</span>\n`;
        } else {
            explanation += `<span class="note">âš ï¸ ×”×¤×¨×© ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} â‚ª</span>\n`;
        }
    } else {
        explanation += `<span class="note">×œ× × ××¦× ×¡××œ 92041 (××¡ ×‘×¨×™××•×ª)</span>\n`;
    }
    
    return {
        title: 'ğŸ“Š ×‘×“×™×§×ª ×‘×™×˜×•×— ×œ××•××™ ×•××¡ ×‘×¨×™××•×ª',
        explanation: explanation
    };
}
function checkSimpleRule(ruleName) {
    const rule = SIMPLE_RULES[ruleName];
    if (!rule) return null;

    // ×—×™×¤×•×© ×œ×¤×™ ×©× ×¡××œ (×¢××•×“×” F)
    let matchedRows = null;
    for (const rows of Object.values(employeeData.elements)) {
const found = rows.filter(r => r.shemSemel.includes(ruleName) || ruleName.includes(r.shemSemel));
        if (found.length > 0) {
            matchedRows = found;
            break;
        }
    }

    if (!matchedRows || matchedRows.length === 0) {
        showMessage(`×œ× × ××¦× ×¨×›×™×‘ "${ruleName}" ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”.`, 'warning');
        return null;
    }

    const row = matchedRows[0];
    let explanation = `${rule.explanation}\n\n`;

    for (const [field, label] of Object.entries(rule.fields)) {
        const value = row[field] || 0;
        explanation += `<span class="highlight">${label}</span>: ${value.toLocaleString('he-IL', {minimumFractionDigits: 2})}\n`;
    }

    if (rule.relatedSemel && rule.checkPercent) {
    const relatedRows = employeeData.elements[rule.relatedSemel];
    if (relatedRows && relatedRows.length > 0) {
        const base = relatedRows[0].schum;
        const expected = base * rule.checkPercent;
        explanation += `\n×©×›×¨ ×§×•×‘×¢ (${rule.relatedSemel}): ${base.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        explanation += `×¦×¤×•×™ (${rule.checkPercent * 100}%): ${expected.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        
        const diff = Math.abs(row.schum - expected);
        if (diff < 1) {
            explanation += `\nâœ… ×”×¡×›×•× ×ª×•×× ××ª ×”×—×™×©×•×‘.`;
        } else {
            explanation += `\nâš ï¸ ×¤×¢×¨ ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×— ××”×—×™×©×•×‘ ×”×¦×¤×•×™.`;
        }
    }
}

    return {
        title: `ğŸ“Š ×”×¡×‘×¨ ${rule.name} (×¡××œ ${row.semel})`,
        explanation: explanation
    };
}
function populateCheckTypes() {
    const select = document.getElementById('checkType');
    for (const [semel, rule] of Object.entries(SIMPLE_RULES)) {
        const option = document.createElement('option');
        option.value = semel;
        option.textContent = `${rule.name} (${semel})`;
        select.appendChild(option);
    }
}
populateCheckTypes();
function check161() {
    const rows91200 = employeeData.elements[91200];
    const rows91301 = employeeData.elements[91301];
    const rows91025 = employeeData.elements[91025];
    const rows92199 = employeeData.elements[92199];
    const rows90120 = employeeData.elements[90120];
    const rows90148 = employeeData.elements[90148];
    const rows4630 = employeeData.elements[4630];
    const rows4631 = employeeData.elements[4631];

    // ×‘×“×™×§×ª ×¤× ×¡×™×” ×ª×§×¦×™×‘×™×ª
    let pensiaT = false;
    if (rows90120) {
        rows90120.forEach(row => {
            if (row.kamut === 200 && row.value6 === 1) {
                pensiaT = true;
            }
        });
    }

    // ×‘×“×™×§×ª ××©×¨×“
    const misrad = Number(employeeData.misrad) || 0;
    const isMisrad418to422 = misrad >= 418 && misrad <= 422;

    // ×”×™×§×£ ××©×¨×” ××¡××œ 90148
    let heikefMisra = 1;
    let needsInflation = false;
    if (rows90148 && rows90148.length > 0) {
        heikefMisra = rows90148[0].schum;
        if (heikefMisra !== 1 && heikefMisra > 0) {
            needsInflation = true;
        }
    }

    let explanation = '';

   // =============================
    // ×—×œ×§ ×' - ××©×›×•×¨×ª ××‘×•×˜×—×ª
    // =============================
    explanation += `<span class="total">â•â• ×—×œ×§ ×\': ××©×›×•×¨×ª ××‘×•×˜×—×ª â•â•</span>\n\n`;
    explanation += `×××•×¦×¢ ×©×œ 12 ×”×—×•×“×©×™× ×”××œ××™× ×”××—×¨×•× ×™× ×©×œ ×¡×”"×› ×”×©×›×¨ ×”××‘×•×˜×— ×œ×§×•×¤×•×ª.\n`;
    explanation += `×›×•×œ×œ ×¨×§ ×¡××œ×™× ×©×”×™×•×• ×‘×¤×•×¢×œ ×‘×¡×™×¡ ×œ×”×¤×¨×©×” ×œ×§×•×¤×•×ª ×’××œ.\n\n`;

    if (pensiaT) {
        explanation += `<span class="note">ğŸ“Œ ×”×¢×•×‘×“ ×‘×¤× ×¡×™×” ×ª×§×¦×™×‘×™×ª (×¡××œ 90120 ×§×•×“ 200). ×‘×¨×•×˜×• ×¤× ×¡×™×” ×ª×§×¦×™×‘×™×ª ×œ× × ×›×œ×œ ×‘×—×™×©×•×‘ ×”×××•×¦×¢.</span>\n\n`;
    }

    // ×¢×¨×š ××©×›×•×¨×ª ××‘×•×˜×—×ª
    let mevutachat = null;
    let mekorMevutachat = '';

    if (rows91200) {
        rows91200.forEach(row => {
            if (row.value13) {
                mevutachat = row.value13;
                mekorMevutachat = '×¡××œ 91200 ×©×“×” 13';
            }
        });
    }
    if (mevutachat === null && rows91301) {
        rows91301.forEach(row => {
            if (row.achuz) {
                mevutachat = row.achuz;
                mekorMevutachat = '×¡××œ 91301 ×©×“×” ××—×•×–';
            }
        });
    }

    if (mevutachat !== null) {
        explanation += `<span class="highlight">××©×›×•×¨×ª ××‘×•×˜×—×ª: ${mevutachat.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—</span>\n`;
        explanation += `××§×•×¨: ${mekorMevutachat}\n\n`;
    } else {
        explanation += `<span class="note">âš ï¸ ×œ× × ××¦× ×¢×¨×š ××©×›×•×¨×ª ××‘×•×˜×—×ª.</span>\n\n`;
    }

    // ×¤×™×¨×•×˜ ×—×•×“×©×™ 92199
    let monthlyDetails = [];
    if (rows92199) {
        rows92199.forEach(row => {
            const monthFrom = row.taarichM ? formatMonthYear(row.taarichM) : '';
            const monthTo = row.taarichAd ? formatMonthYear(row.taarichAd) : '';
            monthlyDetails.push({
                month: monthFrom || monthTo,
                schum: row.schum
            });
        });
        monthlyDetails.sort((a, b) => a.month > b.month ? 1 : -1);
    }

    if (monthlyDetails.length > 0) {
        explanation += `×¤×™×¨×•×˜ ×—×•×“×©×™ (×¡××œ 92199):\n`;
        let totalMonthly = 0;
        let countMonths = 0;
        monthlyDetails.forEach(m => {
            explanation += `<span class="highlight">${m.month}</span>: ${m.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
            if (m.schum > 0) {
                totalMonthly += m.schum;
                countMonths++;
            }
        });
        const calculatedAvg = countMonths > 0 ? totalMonthly / countMonths : 0;
        explanation += `\n×¡×”"×› ${countMonths} ×—×•×“×©×™×: ${totalMonthly.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        explanation += `×××•×¦×¢ ××—×•×©×‘: ${calculatedAvg.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;

        if (mevutachat !== null) {
            const diff = Math.abs(mevutachat - calculatedAvg);
            if (diff < 1) {
                explanation += `âœ… ×”×××•×¦×¢ ×ª×•×× ××ª ×”××©×›×•×¨×ª ×”××‘×•×˜×—×ª.\n`;
            } else {
                explanation += `âš ï¸ ×¤×¢×¨ ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×— ×‘×™×Ÿ ×”×××•×¦×¢ ×œ××©×›×•×¨×ª ×”××‘×•×˜×—×ª.\n`;
            }
        }
    } else {
        explanation += `<span class="note">âš ï¸ ×œ× × ××¦× ×¤×™×¨×•×˜ ×—×•×“×©×™ (×¡××œ 92199).</span>\n`;
    }

    // ×–×™×”×•×™ ×—×•×“×© ×©×›×¨ × ×•×›×—×™
    const allSalaryDates = rawData.map(r => Number(r[COL.TAARICH_SACHAR])).filter(d => d > 0);
    const currentSalaryDate = Math.max(...allSalaryDates);
    const currentMonthStr = formatMonthYear(currentSalaryDate);

    // ×”×¡×‘×¨ ××¤×•×¨×˜ ×œ×—×•×“×© × ×•×›×—×™ - ×××” ××•×¨×›×‘ 92199
    const rows4720 = employeeData.elements[4720];
    const rows4717 = employeeData.elements[4717];

    explanation += `\n×¤×™×¨×•×˜ ×—×™×©×•×‘ ×—×•×“×© × ×•×›×—×™ (${currentMonthStr}):\n`;
    explanation += `×¡××œ 92199 ××•×¨×›×‘ ××”×¨×›×™×‘×™× ×”×‘××™×:\n\n`;

    let totalBreakdown = 0;

    // 91025 - ×‘×¨×•×˜×• ×¤× ×¡×™×” (×¨×§ ×× ×œ× ×¤× ×¡×™×” ×ª×§×¦×™×‘×™×ª)
    if (!pensiaT) {
        let val91025 = 0;
        if (rows91025) {
            const matched = rows91025.find(row => row.taarichSachar === row.taarichErech);
            if (matched) val91025 = matched.schum;
        }
        explanation += `<span class="highlight">×‘×¨×•×˜×• ×¤× ×¡×™×” (91025)</span>: ${val91025.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        totalBreakdown += val91025;
    } else {
        explanation += `<span class="note">ğŸ“Œ ×‘×¨×•×˜×• ×¤× ×¡×™×” (91025) ×œ× × ×›×œ×œ - ×¤× ×¡×™×” ×ª×§×¦×™×‘×™×ª.</span>\n`;
    }

    // 4720
    let val4720 = 0;
    if (rows4720) {
        const matched = rows4720.find(row => row.taarichSachar === row.taarichErech);
        if (matched) val4720 = matched.schum;
    }
    explanation += `<span class="highlight">${rows4720 && rows4720[0] ? rows4720[0].shemSemel : '×¡××œ 4720'}</span>: ${val4720.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
    totalBreakdown += val4720;

    // 4717
    let val4717 = 0;
    if (rows4717) {
        const matched = rows4717.find(row => row.taarichSachar === row.taarichErech);
        if (matched) val4717 = matched.schum;
    }
    explanation += `<span class="highlight">${rows4717 && rows4717[0] ? rows4717[0].shemSemel : '×¡××œ 4717'}</span>: ${val4717.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
    totalBreakdown += val4717;

    explanation += `\n×¡×”"×› ×¨×›×™×‘×™×: ${totalBreakdown.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;

    // ×”×©×•×•××” ×œ×—×•×“×© ×”× ×•×›×—×™ ×‘-92199
    if (monthlyDetails.length > 0) {
        const lastMonth = monthlyDetails.find(m => m.month === currentMonthStr) || monthlyDetails[monthlyDetails.length - 1];
        explanation += `×¢×¨×š ×—×•×“×© × ×•×›×—×™ ×‘-92199 (${lastMonth.month}): ${lastMonth.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        const diffBreakdown = Math.abs(lastMonth.schum - totalBreakdown);
        if (diffBreakdown < 1) {
            explanation += `âœ… ×¡×›×•× ×”×¨×›×™×‘×™× ×ª×•××.\n`;
        } else {
            explanation += `âš ï¸ ×¤×¢×¨ ×©×œ ${diffBreakdown.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×— ×‘×™×Ÿ ×¡×›×•× ×”×¨×›×™×‘×™× ×œ×¢×¨×š ×‘-92199.\n`;
        }
    }

    // =============================
    // ×—×œ×§ ×‘' - ××©×›×•×¨×ª ×œ×¤×™×¦×•×™×™×
    // =============================
    explanation += `\n\n<span class="total">â•â• ×—×œ×§ ×‘\': ××©×›×•×¨×ª ×œ×¤×™×¦×•×™×™× â•â•</span>\n\n`;
    explanation += `×‘×¨×•×˜×• ×¤× ×¡×™×” (×¡××œ 91025) ×©×œ ×—×•×“×© ×”×¢×¨×š ×”× ×‘×“×§ (×ª××¨×™×š ×©×›×¨ = ×ª××¨×™×š ×¢×¨×š)`;
    if (!isMisrad418to422) {
        explanation += `, ×‘×ª×•×¡×¤×ª 1/12 ×”×‘×¨××” (4630)`;
        if (!pensiaT) {
            explanation += ` ×•-1/12 ×‘×™×’×•×“ (4631)`;
        }
    }
    if (needsInflation) {
        explanation += `, ×× ×•×¤×— ×œ-100% (×”×™×§×£ ××©×¨×”: ${heikefMisra})`;
    }
    explanation += `.\n\n`;

    // ×‘×¨×•×˜×• ×¤× ×¡×™×” - ×¨×§ ×©×•×¨×” ×©×ª××¨×™×š ×©×›×¨ = ×ª××¨×™×š ×¢×¨×š
    let brutoPensia = 0;
    if (rows91025) {
        const matched = rows91025.find(row => row.taarichSachar === row.taarichErech);
        if (matched) {
            brutoPensia = matched.schum;
            explanation += `<span class="highlight">×‘×¨×•×˜×• ×¤× ×¡×™×” (91025)</span>: ${brutoPensia.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×— (×—×•×“×© ×¢×¨×š: ${formatMonthYear(matched.taarichErech)})\n`;
        } else {
            explanation += `<span class="note">âš ï¸ ×œ× × ××¦× ×‘×¨×•×˜×• ×¤× ×¡×™×” (91025) ×¢× ×ª××¨×™×š ×©×›×¨ = ×ª××¨×™×š ×¢×¨×š.</span>\n`;
        }
    }

    // 4630 - 1/12 ×”×‘×¨××” - ××•×¡×™×¤×™× ×ª××™×“ ×—×•×¥ ×××©×¨×“×•×ª 418-422
    let havra12 = 0;
    let bigud12 = 0;

    if (!isMisrad418to422) {
        if (rows4630 && rows4630.length > 0) {
            havra12 = rows4630[0].schum;
            explanation += `<span class="highlight">1/12 ×”×‘×¨××” (4630)</span>: ${havra12.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        }
    } else {
        explanation += `<span class="note">ğŸ“Œ ×œ× ××•×¡×™×¤×™× 4630 (××©×¨×“ ${misrad}).</span>\n`;
    }

    // 4631 - 1/12 ×‘×™×’×•×“ - ×œ× ××•×¡×™×¤×™× ×‘×¤× ×¡×™×” ×ª×§×¦×™×‘×™×ª ××• ××©×¨×“×•×ª 418-422
    if (!pensiaT && !isMisrad418to422) {
        if (rows4631 && rows4631.length > 0) {
            bigud12 = rows4631[0].schum;
            explanation += `<span class="highlight">1/12 ×‘×™×’×•×“ (4631)</span>: ${bigud12.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        }
    } else {
        let reason = pensiaT ? '×¤× ×¡×™×” ×ª×§×¦×™×‘×™×ª' : `××©×¨×“ ${misrad}`;
        explanation += `<span class="note">ğŸ“Œ ×œ× ××•×¡×™×¤×™× 4631 (${reason}).</span>\n`;
    }

    let totalPitzuim = brutoPensia + havra12 + bigud12;

    if (needsInflation) {
        explanation += `\n×œ×¤× ×™ × ×™×¤×•×—: ${totalPitzuim.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        totalPitzuim = totalPitzuim / heikefMisra;
        explanation += `×”×™×§×£ ××©×¨×” (90148): ${heikefMisra}\n`;
        explanation += `××—×¨×™ × ×™×¤×•×— ×œ-100%: ${totalPitzuim.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
    }

    // ×”×©×•×•××” ×œ×¢×¨×š ×‘××¢×¨×›×ª
    let pitzuimMaarechet = null;
    if (rows91200) {
        rows91200.forEach(row => {
            if (row.taarif) pitzuimMaarechet = row.taarif;
        });
    }
    if (pitzuimMaarechet === null && rows91301) {
        rows91301.forEach(row => {
            if (row.schum) pitzuimMaarechet = row.schum;
        });
    }

    explanation += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    explanation += `××©×›×•×¨×ª ×œ×¤×™×¦×•×™×™× ××—×•×©×‘×ª: ${totalPitzuim.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;

    if (pitzuimMaarechet !== null) {
        explanation += `××©×›×•×¨×ª ×œ×¤×™×¦×•×™×™× ×‘××¢×¨×›×ª: ${pitzuimMaarechet.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        const diff = Math.abs(pitzuimMaarechet - totalPitzuim);
        if (diff < 1) {
            explanation += `âœ… ×”×¡×›×•× ×”××—×•×©×‘ ×ª×•×× ××ª ×”××¢×¨×›×ª.`;
        } else {
            explanation += `âš ï¸ ×¤×¢×¨ ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—.`;
        }
    }
    // =============================
    // ×—×œ×§ ×’' - ××©×›×•×¨×ª ×œ×¤×˜×•×¨ (×ª×§× ×” 1)
    // =============================
    explanation += `\n\n<span class="total">â•â• ×—×œ×§ ×’\': ××©×›×•×¨×ª ××—×¨×•× ×” ×œ×¤×˜×•×¨ (×ª×§× ×” 1) â•â•</span>\n\n`;
    explanation += `×××•×¦×¢ ×©×œ 12 ×”×—×•×“×©×™× ×”××œ××™× ×”××—×¨×•× ×™× ×©×œ ×¡×”"×› ×ª×•×¡×¤×•×ª ×œ×œ× ×”×—×–×¨ ×”×•×¦××•×ª ×•×©×•×•×™ ×¨×›×‘.\n\n`;

    const rows92300 = employeeData.elements[92300];

    // ×¢×¨×š ××©×›×•×¨×ª ×œ×¤×˜×•×¨
    let patur = null;
    let mekorPatur = '';

    if (rows91200) {
        rows91200.forEach(row => {
            if (row.value12) {
                patur = row.value12;
                mekorPatur = '×¡××œ 91200 ×©×“×” 12';
            }
        });
    }
    if (patur === null && rows91301) {
        rows91301.forEach(row => {
            if (row.kamut) {
                patur = row.kamut;
                mekorPatur = '×¡××œ 91301 ×©×“×” ×›××•×ª';
            }
        });
    }

    if (patur !== null) {
        explanation += `<span class="highlight">××©×›×•×¨×ª ×œ×¤×˜×•×¨: ${patur.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—</span>\n`;
        explanation += `××§×•×¨: ${mekorPatur}\n\n`;
    } else {
        explanation += `<span class="note">âš ï¸ ×œ× × ××¦× ×¢×¨×š ××©×›×•×¨×ª ×œ×¤×˜×•×¨.</span>\n\n`;
    }

    // ×¤×™×¨×•×˜ ×—×•×“×©×™ 92300
    let monthlyPatur = [];
    if (rows92300) {
        rows92300.forEach(row => {
            const monthFrom = row.taarichM ? formatMonthYear(row.taarichM) : '';
            const monthTo = row.taarichAd ? formatMonthYear(row.taarichAd) : '';
            monthlyPatur.push({
                month: monthFrom || monthTo,
                schum: row.schum
            });
        });
        monthlyPatur.sort((a, b) => a.month > b.month ? 1 : -1);
    }

    if (monthlyPatur.length > 0) {
        explanation += `×¤×™×¨×•×˜ ×—×•×“×©×™ (×¡××œ 92300):\n`;
        let totalPatur = 0;
        let countPatur = 0;
        monthlyPatur.forEach(m => {
            explanation += `<span class="highlight">${m.month}</span>: ${m.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
            if (m.schum > 0) {
                totalPatur += m.schum;
                countPatur++;
            }
        });
        const calculatedPatur = countPatur > 0 ? totalPatur / countPatur : 0;
        explanation += `\n×¡×”"×› ${countPatur} ×—×•×“×©×™×: ${totalPatur.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        explanation += `×××•×¦×¢ ××—×•×©×‘: ${calculatedPatur.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;

        if (patur !== null) {
            const diff = Math.abs(patur - calculatedPatur);
            if (diff < 1) {
                explanation += `âœ… ×”×××•×¦×¢ ×ª×•×× ××ª ××©×›×•×¨×ª ×”×¤×˜×•×¨.\n`;
            } else {
                explanation += `âš ï¸ ×¤×¢×¨ ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×— ×‘×™×Ÿ ×”×××•×¦×¢ ×œ××©×›×•×¨×ª ×”×¤×˜×•×¨.\n`;
            }
        }
    } else {
        explanation += `<span class="note">âš ï¸ ×œ× × ××¦× ×¤×™×¨×•×˜ ×—×•×“×©×™ (×¡××œ 92300).</span>\n`;
    }

    return {
        title: 'ğŸ“Š ×‘×“×™×§×ª ×¡×›×•××™× ×‘×˜×•×¤×¡ 161',
        explanation: explanation
    };
}
const CATEGORIES = ['×ª×©×œ×•××™×', '× ×™×›×•×™×™×', '×”×¤×¨×©×•×ª', '×–×§×™×¤×•×ª', '× ×ª×•× ×™ ×¢×–×¨'];

function switchTab(tab) {
    document.getElementById('tlushPanel').style.display = tab === 'tlush' ? 'block' : 'none';
    document.getElementById('checksPanel').style.display = tab === 'checks' ? 'block' : 'none';
    document.getElementById('tabTlush').style.background = tab === 'tlush' ? '#3498db' : '#e9ecef';
    document.getElementById('tabTlush').style.color = tab === 'tlush' ? 'white' : '#333';
    document.getElementById('tabChecks').style.background = tab === 'checks' ? '#3498db' : '#e9ecef';
    document.getElementById('tabChecks').style.color = tab === 'checks' ? 'white' : '#333';
}

function buildTlush() {
    const container = document.getElementById('tlushCategories');
    container.innerHTML = '';

    // ×¤×¨×˜×™ ×¢×•×‘×“
    document.getElementById('tlushEmployeeInfo').innerHTML =
        `<span>ğŸ‘¤ ×–×”×•×ª: <strong>${employeeData.zehut}</strong></span>` +
        `<span>××¡×¤×¨ ×¢×•×‘×“: <strong>${employeeData.misparOved}</strong></span>` +
        `<span>××©×¨×“: <strong>${employeeData.misrad}</strong></span>`;

    // ×—×œ×•×§×” ×œ×§×˜×’×•×¨×™×•×ª ×œ×¤×™ ×©×•×¨×•×ª ×›×•×ª×¨×ª ×—×•×–×¨×•×ª
    const allRows = XLSX.utils.sheet_to_json(
        XLSX.read(lastFileData, { type: 'array' }).Sheets[
            XLSX.read(lastFileData, { type: 'array' }).SheetNames[0]
        ], { header: 1 }
    );

    let categories = [];
    let currentCat = { name: CATEGORIES[0], rows: [] };
    let catIndex = 0;
    let headersFound = 0;

    // ××¦×™××ª ×©×•×¨×ª ×›×•×ª×¨×•×ª ×¨××©×•× ×”
    let headerRowIndex = -1;
    for (let i = 0; i < Math.min(allRows.length, 5); i++) {
        if (allRows[i] && allRows[i].some(cell => String(cell || '').trim() === '×¡××œ')) {
            headerRowIndex = i;
            break;
        }
    }

    const headers = allRows[headerRowIndex];

    for (let i = headerRowIndex + 1; i < allRows.length; i++) {
        const row = allRows[i];
        if (!row || row.length === 0) continue;

        // ×‘×“×™×§×” ×× ×–×• ×©×•×¨×ª ×›×•×ª×¨×•×ª ×—×•×–×¨×ª
        if (row.some(cell => String(cell || '').trim() === '×¡××œ')) {
            // ×©××™×¨×ª ×§×˜×’×•×¨×™×” ×§×•×“××ª
            if (currentCat.rows.length > 0) {
                categories.push(currentCat);
            }
            catIndex++;
            currentCat = { name: CATEGORIES[catIndex] || `×§×˜×’×•×¨×™×” ${catIndex + 1}`, rows: [] };
            continue;
        }

        // ×©×•×¨×ª × ×ª×•× ×™× ×¨×’×™×œ×”
        const obj = {};
        headers.forEach((header, idx) => {
            if (header) obj[String(header).trim()] = row[idx];
        });

        if (obj[COL.SEMEL]) {
            currentCat.rows.push(obj);
        }
    }
    // ×©××™×¨×ª ×§×˜×’×•×¨×™×” ××—×¨×•× ×”
    if (currentCat.rows.length > 0) {
        categories.push(currentCat);
    }
// ×¡×™× ×•×Ÿ × ×ª×•× ×™ ×¢×–×¨ - ×¨×§ ×¡××œ×™× ×¡×¤×¦×™×¤×™×™×
    const allowedEzer = [91025, 4717, 4720,90146];

    // ×‘× ×™×™×ª HTML ×œ×›×œ ×§×˜×’×•×¨×™×”
  function buildCatHtml(cat) {
        const grouped = {};
        cat.rows.forEach(row => {
            const semel = row[COL.SEMEL] || '';
            const shemSemel = row[COL.SHEM_SEMEL] || '';
            const originalSchum = Number(row[COL.SCHUM] || 0); // ×”×¡×›×•× ×”××§×•×¨×™ ×œ×‘×“×™×§×•×ª
            const kamut = Number(row[COL.KAMUT] || 0); // ×”×›××•×ª ×”××§×•×¨×™×ª
            const tSachar = row[COL.TAARICH_SACHAR];
            const tErech = row[COL.TAARICH_ERECH];
            const isShotef = (tSachar === tErech);

            // ×¡×™× ×•×Ÿ × ×ª×•× ×™ ×¢×–×¨
            if (cat.name === '× ×ª×•× ×™ ×¢×–×¨') {
                if (!allowedEzer.includes(Number(semel))) return;
                
                // ×¡×™× ×•×Ÿ ×¡×¤×¦×™×¤×™ ×œ×¡××œ 90146 - ×¨×§ ×©×•×¨×•×ª ×©×”×¡×›×•× ×©×œ×”×Ÿ ×”×•× 998
                if (Number(semel) === 90146 && Math.floor(originalSchum) !== 998) {
                    return; // ××“×œ×’×™× ×¢×œ ×›×œ ×©×•×¨×” ×©××™× ×” 998
                }
            }

            // ×§×‘×™×¢×ª ×”×¢×¨×š ×©×™×•×¦×’ ×‘×˜×‘×œ×”: ×× ×–×” ×¡××œ 90146 × ×™×§×— ××ª ×”"×›××•×ª", ××—×¨×ª × ×™×§×— ××ª ×”"×¡×›×•×"
            const displayValue = (Number(semel) === 90146) ? kamut : originalSchum;

            if (!grouped[semel]) {
                grouped[semel] = {
                    semel: semel,
                    shemSemel: shemSemel,
                    shotef: null,
                    hefarshim: { schum: 0, count: 0 }
                };
            }

            if (isShotef && !grouped[semel].shotef) {
                // ×©×•××¨×™× ××ª ×”×¢×¨×š ×©×‘×—×¨× ×• ×œ×”×¦×™×’
                grouped[semel].shotef = { schum: displayValue };
            } else {
                grouped[semel].hefarshim.schum += displayValue;
                grouped[semel].hefarshim.count++;
            }
        });

        let html = `<div class="tlush-category-title">${cat.name}</div>`;
        html += `<table class="tlush-table">`;
        html += `<tr><th>×¡××œ</th><th>×©×</th><th>×©×•×˜×£</th><th>×”×¤×¨×©×™×</th><th></th></tr>`;

        for (const semel in grouped) {
            const g = grouped[semel];
            const hasExplanation = hasExplanationRule(g.shemSemel, semel);
            const rowClass = hasExplanation ? 'has-explanation' : '';
            const shotef = g.shotef || { schum: 0 };
            const hefStr = g.hefarshim.count > 0
                ? `${g.hefarshim.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})}`
                : '';

            html += `<tr class="${rowClass}" onclick="showTlushExplanation('${g.shemSemel.replace(/'/g, "\\'")}', ${semel})">`;
            html += `<td>${semel}</td>`;
            html += `<td>${g.shemSemel}</td>`;
            html += `<td>${shotef.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})}</td>`; // ××“×¤×™×¡ ××ª ×”×›××•×ª ×‘××§×¨×” ×©×œ 90146
            html += `<td>${hefStr}</td>`;
            html += `<td>${hasExplanation ? '<span class="tlush-explain-icon">ğŸ’¡</span>' : ''}</td>`;
            html += `</tr>`;
        }

        html += `</table>`;
        return html;
    }
          
      

    // ×ª×©×œ×•××™× ×•× ×™×›×•×™×™× ×–×” ×œ×™×“ ×–×”
    const tashlumim = categories.find(c => c.name === '×ª×©×œ×•××™×');
    const nikuyim = categories.find(c => c.name === '× ×™×›×•×™×™×');

    if (tashlumim || nikuyim) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'tlush-row';
        if (tashlumim) {
            const div = document.createElement('div');
            div.className = 'tlush-category';
            div.innerHTML = buildCatHtml(tashlumim);
            rowDiv.appendChild(div);
        }
        if (nikuyim) {
            const div = document.createElement('div');
            div.className = 'tlush-category';
            div.innerHTML = buildCatHtml(nikuyim);
            rowDiv.appendChild(div);
        }
        container.appendChild(rowDiv);
    }

    // ×”×¤×¨×©×•×ª ×•×–×§×™×¤×•×ª ×–×” ×œ×™×“ ×–×”
    const hafrashot = categories.find(c => c.name === '×”×¤×¨×©×•×ª');
    const zkifot = categories.find(c => c.name === '×–×§×™×¤×•×ª');

    if (hafrashot || zkifot) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'tlush-row';
        if (hafrashot) {
            const div = document.createElement('div');
            div.className = 'tlush-category';
            div.innerHTML = buildCatHtml(hafrashot);
            rowDiv.appendChild(div);
        }
        if (zkifot) {
            const div = document.createElement('div');
            div.className = 'tlush-category';
            div.innerHTML = buildCatHtml(zkifot);
            rowDiv.appendChild(div);
        }
        container.appendChild(rowDiv);
    }

    // × ×ª×•× ×™ ×¢×–×¨ - ×©×•×¨×” ×‘×•×“×“×ª
    const ezer = categories.find(c => c.name === '× ×ª×•× ×™ ×¢×–×¨');
    if (ezer) {
        const div = document.createElement('div');
        div.className = 'tlush-category';
        div.innerHTML = buildCatHtml(ezer);
        container.appendChild(div);
    }


 document.getElementById('tlushPanel').style.display = 'block';
}

function hasExplanationRule(shemSemel, semelNum) {
    if (COMPLEX_RULES_MAP[Number(semelNum)]) return true;
    for (const key in SIMPLE_RULES) {
        if (shemSemel.includes(key) || key.includes(shemSemel)) {
            return true;
        }
    }
    return false;
}
function showTlushExplanation(shemSemel, semelNum) {
    const num = Number(semelNum);
    let result = null;

    // ×§×•×“× × ×‘×“×•×§ ×× ×–×” ×¡××œ ×©×œ ×‘×“×™×§×” ××•×¨×›×‘×ª ×œ×¤×™ ×”××¡×¤×¨
    if (COMPLEX_RULES_MAP[num]) {
        const checkType = COMPLEX_RULES_MAP[num];
        if (checkType === 'vatik') {
            result = checkVatik();
        } else if (checkType === 'nihul4517') {
            result = checkNihul4517();
        } else if (checkType === 'bruto91025') {
    result = check91025();
} else if (checkType === 'checkTax') {
    result = checkTax();

} else if (checkType === 'checkBituachLeumi') {
    result = checkBituachLeumi();
}
      
    } else {
        // ×× ×œ×, × ×—×¤×© ×‘×—×•×§×™× ×”×¤×©×•×˜×™× ×œ×¤×™ ×©×
        let ruleName = '';
        for (const key in SIMPLE_RULES) {
            if (shemSemel.includes(key) || key.includes(shemSemel)) {
                ruleName = key;
                break;
            }
        }

        if (ruleName) {
            result = checkSimpleRule(ruleName);
            // ×’×™×‘×•×™ ×‘××§×¨×” ×©×”×¤×•× ×§×¦×™×” ×œ× ×”×—×–×™×¨×” ×ª×•×¦××” ××—×•×©×‘×ª
            if (!result && SIMPLE_RULES[ruleName]) {
                result = {
                    title: SIMPLE_RULES[ruleName].name,
                    explanation: SIMPLE_RULES[ruleName].explanation
                };
            }
        }
    }

    // ×”×“×¤×¡×ª ×”×ª×•×¦××” ×œ×¤×× ×œ
    if (result) {
        document.getElementById('tlushExpTitle').textContent = result.title;
        document.getElementById('tlushExpContent').innerHTML = result.explanation;
    } else {
        document.getElementById('tlushExpTitle').textContent = `${shemSemel} (${semelNum})`;
        document.getElementById('tlushExpContent').innerHTML = '××™×Ÿ ×”×¡×‘×¨ ×–××™×Ÿ ×œ×¨×›×™×‘ ×–×”.';
    }
    
    document.getElementById('tlushExplanation').style.display = 'block';
}

function closeTlushExplanation() {
    document.getElementById('tlushExplanation').style.display = 'none';
}
</script>

</body>
</html>
