<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×¡×‘×¨ ×‘×§×œ×™×§</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 { font-size: 1.8em; margin-bottom: 5px; }
        .header p { opacity: 0.85; font-size: 0.95em; }

        .content { padding: 30px; }

        .upload-area {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border: 3px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
        }
        .upload-area:hover { border-color: #3498db; background: #e3f2fd; }
        .upload-area.loaded { border-color: #27ae60; background: #d5f4e6; }
        .upload-icon { font-size: 3em; margin-bottom: 10px; }
        .upload-area p { color: #666; font-size: 1.1em; }
        #fileInput { display: none; }
        .file-name { margin-top: 10px; font-weight: bold; color: #27ae60; }

        .check-selection { margin-bottom: 25px; }
        .check-selection label { display: block; font-weight: bold; color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
        .check-selection select {
            width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 10px;
            font-size: 1em; font-family: inherit; background: white; cursor: pointer;
        }
        .check-selection select:focus { outline: none; border-color: #3498db; }

        .btn-run {
            display: block; width: 100%; padding: 14px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white; border: none; border-radius: 10px;
            font-size: 1.15em; font-weight: bold; cursor: pointer;
            transition: all 0.3s; margin-bottom: 25px;
        }
        .btn-run:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(39,174,96,0.4); }
        .btn-run:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }

        .results-area { display: none; }

        .result-card {
            background: #f8f9fa; border-radius: 12px; border: 2px solid #e9ecef;
            padding: 25px; margin-bottom: 20px;
        }
        .result-card h3 {
            color: #2c3e50; font-size: 1.3em; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 2px solid #3498db;
        }

        .explanation-text { line-height: 1.9; color: #333; font-size: 1.05em; white-space: pre-wrap; }
        .explanation-text .highlight { background: #fff3cd; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .explanation-text .total { background: #d4edda; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .explanation-text .note { color: #856404; font-style: italic; }

        .employee-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 15px 20px; border-radius: 10px;
            margin-bottom: 20px; font-size: 1.05em;
        }
        .employee-info span { margin-left: 25px; }

        .message { padding: 12px 18px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .message.error { background: #fadbd8; color: #c0392b; border: 1px solid #e74c3c; display: block; }
        .message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffc107; display: block; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #17a2b8; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“‹ ×”×¡×‘×¨ ×‘×§×œ×™×§</h1>
        <p>×”×¢×œ×• ×§×•×‘×¥ × ×ª×•× ×™ ×©×›×¨ ×•×‘×—×¨×• ×¡×•×’ ×‘×“×™×§×” ×œ×§×‘×œ×ª ×”×¡×‘×¨ ××¤×•×¨×˜</p>
    </div>
      

    <div class="content">
        <div class="check-selection">
            <label>×‘×—×¨×• ×¡×•×’ ×‘×“×™×§×”:</label>
            <select id="checkType">
                <option value="">-- ×‘×—×¨×• ×‘×“×™×§×” --</option>
                <option value="vatik">×ª×•×¡×¤×ª ×•×ª×§</option>
                <option value="nihul4517">××¢× ×§ ×ª×•×¡×¤×ª × ×™×”×•×œ (4517)</option>
            </select>
        </div>
        <div class="message info" id="instructionsArea" style="display:none;"></div>
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">ğŸ“</div>
            <p>×œ×—×¦×• ×›××Ÿ ×œ×”×¢×œ××ª ×§×•×‘×¥ ××§×¡×œ ×©×œ ×¢×•×‘×“</p>
            <div class="file-name" id="fileName"></div>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">

       
        <button class="btn-run" id="btnRun" disabled onclick="runCheck()">â–¶ ×”×¦×’ ×”×¡×‘×¨</button>

        <div class="message" id="messageArea"></div>

        <div class="results-area" id="resultsArea">
            <div class="employee-info" id="employeeInfo"></div>
            <div class="result-card">
                <h3 id="resultTitle"></h3>
                <div class="explanation-text" id="explanationText"></div>
            </div>
        </div>
    </div>
</div>


<script>
// ============================================
// ××™×¤×•×™ ×¢××•×“×•×ª ×§×‘×•×¢ (×¢×‘×¨×™×ª)
// ============================================
const COL = {
    MISRAD:        '××©×¨×“',
    ZEHUT:         '×–×”×•×ª',
    MN:            '×.× ',
    MISPAR_OVED:   '××¡×¤×¨ ×¢×•×‘×“',
    SEMEL:         '×¡××œ',
    SHEM_SEMEL:    '×©× ×¡××œ',
    TAARICH_SACHAR:'×ª××¨×™×š ×©×›×¨',
    TAARICH_ERECH: '×ª××¨×™×š ×¢×¨×š',
    SCHUM:         '×¡×›×•×',
    KAMUT:         '×›××•×ª',
    ACHUZ:         '××—×•×–',
    TAARIF:        '×ª×¢×¨×™×£',
    PRATIM:        '×¤×¨×˜×™×',
    SEIF_TAKTZIV:  '×¡×¢×™×£ ×ª×§×¦×™×‘',
    TAARICH_M:     '×ª××¨×™×š ×',
    TAARICH_AD:    '×ª××¨×™×š ×¢×“',
};

let rawData = [];
let employeeData = {};
const checkInstructions = {
    vatik: {
        title: '×ª×•×¡×¤×ª ×•×ª×§',
        instructions: '×™×© ×œ×”×›×™×Ÿ ×§×•×‘×¥ × ×ª×•× ×™× ×›×¡×¤×™×™× ×œ×¢×•×‘×“ ×¢×‘×•×¨ <strong>×—×•×“×© ××—×“</strong>.'
    },
    // ×“×•×’××” ×œ×‘×“×™×§×” ×¢×ª×™×“×™×ª ×©×¦×¨×™×›×” 3 ×—×•×“×©×™×
    // example: {
    //     title: '×‘×“×™×§×” ×œ×“×•×’××”',
    //     instructions: '×™×© ×œ×”×›×™×Ÿ ×§×•×‘×¥ × ×ª×•× ×™× ×›×¡×¤×™×™× ×œ×¢×•×‘×“ ×¢×‘×•×¨ <strong>3 ×—×•×“×©×™× ××—×¨×•× ×™×</strong>.'
    // },
  nihul4517: {
    title: '××¢× ×§ ×ª×•×¡×¤×ª × ×™×”×•×œ (4517)',
    instructions: '××“×•×‘×¨ ×‘×ª×•×¡×¤×ª ×¨×‘×¢×•× ×™×ª. ×™×© ×œ×©×œ×•×£ × ×ª×•× ×™× ×›×¡×¤×™×™× ×‘×’×™×Ÿ <strong>3 ×—×•×“×©×™ ×¢×¨×š</strong> ×©×§×“××• ×œ×ª×©×œ×•× ×”× ×‘×“×§.<br>×œ×“×•×’××”: ×× ×‘×•×“×§×™× 01.01.2026, ×™×© ×œ×”×•×¦×™× × ×ª×•× ×™× ×-01.10.2025 ×¢×“ 31.12.2025.'
},
};
const SIMPLE_RULES = {
    '×”×‘×¨××”': {
        name: ' ×”×‘×¨××”',
        explanation: '×ª×©×œ×•× ×©× ×ª×™ ×¢×‘×•×¨ ×“××™ ×”×‘×¨××”. ××—×•×©×‘ ×œ×¤×™ ××¡×¤×¨ ×™××™ ×”×–×›××•×ª ×›×¤×•×œ ×ª×¢×¨×™×£ ×™×•× ×”×‘×¨××”.',
        fields: {
            kamut: '××¡×¤×¨ ×™××™ ×–×›××•×ª',
            taarif: '×ª×¢×¨×™×£ ×œ×™×•×',
            schum: '×¡×”"×› ×ª×©×œ×•×'
        }
    },
    '×‘×™×’×•×“': {
        name: '×‘×™×’×•×“',
        explanation: '×ª×©×œ×•× ×©× ×ª×™ ×œ×¨×›×™×©×ª ×‘×™×’×•×“.',
        fields: {
            schum: '×¡×”"×› ×ª×©×œ×•×'
        }
    },
   '××¢× ×§ ×™×•×‘×œ': {
    name: '××¢× ×§ ×™×•×‘×œ',
    explanation: '××¢× ×§ ×©× ×ª×™ ×œ×‘×¢×œ×™ ×•×ª×§ ×©×œ 25 ×©× ×” ×•××¢×œ×”. ××©×•×œ× ×‘×©×™×¢×•×¨ 60% ××”×©×›×¨ ×”×§×•×‘×¢ (×¡××œ 91025).',
    relatedSemel: 91025,
    checkPercent: 0.60,
    fields: {
        schum: '×¡×”"×› ×ª×©×œ×•×'
    }
},
};
// ============================================
// ×˜×¢×™× ×ª ×§×•×‘×¥
// ============================================
document.getElementById('fileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    document.getElementById('fileName').textContent = 'âœ… ' + file.name;
    document.getElementById('uploadArea').classList.add('loaded');

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        
        // ×§×¨×™××” ×›××¢×¨×š ×©×•×¨×•×ª
        const allRows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        // ××¦×™××ª ×©×•×¨×ª ×”×›×•×ª×¨×•×ª - ××—×¤×©×™× ××ª ×”×©×•×¨×” ×©××›×™×œ×” "×¡××œ"
        let headerRowIndex = -1;
        for (let i = 0; i < Math.min(allRows.length, 5); i++) {
            const row = allRows[i];
            if (row && row.some(cell => String(cell || '').trim() === '×¡××œ')) {
                headerRowIndex = i;
                break;
            }
        }

        if (headerRowIndex === -1) {
            showMessage('âŒ ×œ× × ××¦××” ×©×•×¨×ª ×›×•×ª×¨×•×ª ×¢× ×”×©×“×” "×¡××œ"', 'error');
            return;
        }

        const headers = allRows[headerRowIndex].map(h => String(h || '').trim());
        console.log('×›×•×ª×¨×•×ª:', headers);

        // ×”××¨×” ×œ××•×‘×™×™×§×˜×™×
        const dataRows = [];
        for (let i = headerRowIndex + 1; i < allRows.length; i++) {
            const row = allRows[i];
            if (!row || row.length === 0) continue;
            
            const obj = {};
            headers.forEach((header, idx) => {
                if (header) obj[header] = row[idx];
            });
            
            if (obj[COL.SEMEL]) {
                dataRows.push(obj);
            }
        }

        rawData = dataRows;
        console.log(`âœ… × ×˜×¢× ×• ${rawData.length} ×¨×©×•××•×ª`);

        parseEmployeeData();
        updateRunButton();
        showMessage('');

    } catch (error) {
        console.error('×©×’×™××”:', error);
        showMessage('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ' + error.message, 'error');
    }
});

// ============================================
// ×¤×¨×¡×•×¨ × ×ª×•× ×™ ×¢×•×‘×“
// ============================================
function parseEmployeeData() {
    employeeData = {
        zehut: null,
        misparOved: null,
        misrad: null,
        rows: rawData,
        elements: {}
    };

    rawData.forEach(row => {
        if (!employeeData.zehut) {
            employeeData.zehut = row[COL.ZEHUT] || '';
            employeeData.misparOved = row[COL.MISPAR_OVED] || '';
            employeeData.misrad = row[COL.MISRAD] || '';
        }

        const semel = Number(row[COL.SEMEL] || 0);
        if (!employeeData.elements[semel]) {
            employeeData.elements[semel] = [];
        }

        employeeData.elements[semel].push({
            semel: semel,
            shemSemel: row[COL.SHEM_SEMEL] || '',
            schum: Number(row[COL.SCHUM] || 0),
            kamut: Number(row[COL.KAMUT] || 0),
            achuz: Number(row[COL.ACHUZ] || 0),
            taarif: Number(row[COL.TAARIF] || 0),
            pratim: row[COL.PRATIM] || '',
            taarichSachar: row[COL.TAARICH_SACHAR] || '',
            taarichErech: row[COL.TAARICH_ERECH] || '',
            taarichM: row[COL.TAARICH_M] || '',
            taarichAd: row[COL.TAARICH_AD] || '',
        });
    });

    console.log('×–×”×•×ª:', employeeData.zehut);
    console.log('××¡×¤×¨ ×¢×•×‘×“:', employeeData.misparOved);
    console.log('×¡××œ×™× ×©× ××¦××•:', Object.keys(employeeData.elements).join(', '));
}

// ============================================
// × ×™×”×•×œ ×××©×§
// ============================================
function updateRunButton() {
    const hasFile = rawData.length > 0;
    const hasCheck = document.getElementById('checkType').value !== '';
    document.getElementById('btnRun').disabled = !(hasFile && hasCheck);
}

document.getElementById('checkType').addEventListener('change', function() {
    updateRunButton();
    const type = this.value;
    const instrEl = document.getElementById('instructionsArea');
    if (type && checkInstructions[type]) {
        instrEl.innerHTML = 'ğŸ“‹ ' + checkInstructions[type].instructions;
        instrEl.style.display = 'block';
    } else {
        instrEl.style.display = 'none';
    }
});

function showMessage(text, type) {
    const el = document.getElementById('messageArea');
    if (!text) { el.style.display = 'none'; el.className = 'message'; return; }
    el.textContent = text;
    el.className = 'message ' + (type || 'info');
    el.style.display = 'block';
}

// ============================================
// ×”×¨×¦×ª ×‘×“×™×§×”
// ============================================
function runCheck() {
    const checkType = document.getElementById('checkType').value;
    if (!checkType || rawData.length === 0) return;

    showMessage('');
    document.getElementById('resultsArea').style.display = 'none';

    document.getElementById('employeeInfo').innerHTML =
        `<span>ğŸ‘¤ ×–×”×•×ª: <strong>${employeeData.zehut}</strong></span>` +
        `<span>××¡×¤×¨ ×¢×•×‘×“: <strong>${employeeData.misparOved}</strong></span>` +
        `<span>××©×¨×“: <strong>${employeeData.misrad}</strong></span>`;

    let result = null;
switch (checkType) {
    case 'vatik':
        result = checkVatik();
        break;
    case 'nihul4517':
        result = checkNihul4517();
        break;
    default:
        if (SIMPLE_RULES[checkType]) {
            result = checkSimpleRule(checkType);
        } else {
            showMessage('×¡×•×’ ×‘×“×™×§×” ×œ× ××•×›×¨', 'error');
        }
        break;
}

    if (result) {
        document.getElementById('resultTitle').textContent = result.title;
        document.getElementById('explanationText').innerHTML = result.explanation;
        document.getElementById('resultsArea').style.display = 'block';
    }
}

// ============================================
// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×§×¨×™××ª ×•×ª×§
// ============================================

/** ×¤×•×¨××˜ ×' (998, 55, 999) - ×©× ×™× ×•×—×•×“×©×™× ×‘×©×“×” ×¡×›×•×. ×œ××©×œ 38.25 = 38 ×©× ×™× + 3 ×—×•×“×©×™× */
function parseVatikFormatA(schum) {
    const years = Math.floor(schum);
    const months = Math.round((schum - years) * 12);
    return { years, months };
}

/** ×¤×•×¨××˜ ×‘' (1, 2, 794, 20) - ×©× ×™× ×‘×¡×›×•×, ×—×•×“×©×™× ×‘××—×•×– */
function parseVatikFormatB(schum, achuz) {
    const years = Math.floor(schum);
    const months = Math.round(achuz);
    return { years, months };
}

/** ×¤×•×¨××˜ ×•×ª×§ ×œ×˜×§×¡×˜ ×§×¨×™× */
function formatVatik(vatik) {
    if (vatik.years === 0 && vatik.months === 0) return '0';
    let parts = [];
    if (vatik.years > 0) parts.push(`${vatik.years} ×©× ×™×`);
    if (vatik.months > 0) parts.push(`${vatik.months} ×—×•×“×©×™×`);
    return parts.join(' ×•-');
}

// ============================================
// ×‘×“×™×§×”: ×ª×•×¡×¤×ª ×•×ª×§
// ============================================
function checkVatik() {
    const VATIK_ELEMENT = 90146;

    const vatikRows = employeeData.elements[VATIK_ELEMENT];

    if (!vatikRows || vatikRows.length === 0) {
        showMessage('×œ× × ××¦××• × ×ª×•× ×™ ×•×ª×§ (×¡××œ 90146) ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”.', 'warning');
        return null;
    }

    console.log('×©×•×¨×•×ª ×•×ª×§:', vatikRows.length);
    console.table(vatikRows.map(r => ({ ×›××•×ª: r.kamut, ×¡×›×•×: r.schum, ××—×•×–: r.achuz, ×ª×¢×¨×™×£: r.taarif })));

    // ××™×¤×•×™ ×¡×•×’×™ ×•×ª×§
    const vatikTypes = {
        1:   { name: '×•×ª×§ ×”×ª×—×œ×ª×™ ××“×•×•×—', format: 'B', note: '×¢×•×‘×“ ×©×”×ª×—×™×œ ×œ×¤× ×™ 1.1.2012 ×¦×¤×•×™ ×©×™×”×™×” ×œ×• ×•×ª×§ ××¡×•×’ ×–×”.' },
        2:   { name: '×•×ª×§ ×©×™×¨×•×ª ×—×•×‘×”', format: 'B', note: '' },
        24:   { name: '×•×ª×§ ××§×¦×•×¢×™', format: 'B', note: '' },
        20:  { name: '×•×ª×§ ×¦×™×‘×•×¨×™', format: 'B', note: '×•×ª×§ ×©× ×¦×‘×¨ ×‘×©×™×¨×•×ª ×¦×™×‘×•×¨×™ ×§×•×“×.' },
        55:  { name: '×•×ª×§ ×‘×©× ×ª ×¤×¨×™×©×”', format: 'A', note: '' },
        794: { name: '××—×¦×™×ª ×•×ª×§ ×ª×•××¨ ×©× ×™', format: 'B', note: '××—×¦×™×ª ××ª×§×•×¤×ª ×”×œ×™××•×“×™× ×œ×ª×•××¨ ×©× ×™.' },
        999: { name: '×•×ª×§ ××—×•×©×‘', format: 'A', note: '×•×ª×§ ×©× ×¦×‘×¨ ××ª×—×™×œ×ª ×”×”×¢×¡×§×” ××• ××ª×—×™×œ×ª ×“×™×•×•×— ××—×¨×•×Ÿ ×©×œ ×•×ª×§ ×”×ª×—×œ×ª×™.' },
        998: { name: '×¡×”"×› ×•×ª×§ ×œ××©×¨×“', format: 'A', note: '' }
    };

    let components = [];
    let totalVatik = null;

    vatikRows.forEach(row => {
     const typeKey = Math.floor(row.schum);
        const typeDef = vatikTypes[typeKey];
if (!typeDef) return;

let vatik;
if (typeDef.format === 'A') {
    vatik = parseVatikFormatA(row.kamut);
} else {
    vatik = parseVatikFormatB(row.kamut, row.achuz);
}
        const entry = {
            type: typeKey,
            typeName: typeDef ? typeDef.name : `×•×ª×§ ××¡×•×’ ${typeKey}`,
            vatik: vatik,
            note: typeDef ? typeDef.note : '',
            raw: row
        };

        if (typeKey === 998) {
            totalVatik = entry;
        } else {
            components.push(entry);
        }
    });

    components.sort((a, b) => a.type - b.type);

    // ×‘× ×™×™×ª ×”×¡×‘×¨ ××™×œ×•×œ×™
    let explanation = '';

    if (totalVatik) {
        explanation += `<span class="total">×¡×”"×› ×”×•×•×ª×§ ×”××•×›×¨ ×œ××©×¨×“ ×”×•× ${formatVatik(totalVatik.vatik)}.</span>\n\n`;
        explanation += `×”×•×•×ª×§ ××•×–×Ÿ ×‘××™×¨×•×¢ 90146  :\n\n`;
        explanation += `×‘× ×ª×•× ×™× ×”×›×¡×¤×™×™× ×©×œ ×”×¢×•×‘×“ ×¨××” × ×ª×•×Ÿ ×¢×–×¨ 90146:\n\n`;
        explanation += `×”×•×•×ª×§ ××•×¨×›×‘ ××”×¨×›×™×‘×™× ×”×‘××™×:\n\n`;
    } else {
        explanation += `×œ×”×œ×Ÿ ×¤×™×¨×•×˜ ×¨×›×™×‘×™ ×”×•×•×ª×§ ×©× ××¦××•:\n\n`;
    }

    if (components.length === 0) {
        explanation += `×œ× × ××¦××• ×¨×›×™×‘×™ ×•×ª×§ ×¤×¨×˜× ×™×™×.`;
    }

    components.forEach(comp => {
        explanation += `<span class="highlight">${comp.typeName}</span> (×¡×•×’ ${comp.type}): ${formatVatik(comp.vatik)}`;
        if (comp.note) {
            explanation += `\n<span class="note">ğŸ“Œ ${comp.note}</span>`;
        }
        explanation += `\n\n`;
    });

    // ×¡×™×›×•×
    if (totalVatik && components.length > 0) {
        let sumYears = 0, sumMonths = 0;
        components.forEach(comp => {
            sumYears += comp.vatik.years;
            sumMonths += comp.vatik.months;
        });
        sumYears += Math.floor(sumMonths / 12);
        sumMonths = sumMonths % 12;

        explanation += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        explanation += `×¡×›×•× ×”×¨×›×™×‘×™×: ${formatVatik({ years: sumYears, months: sumMonths })}\n`;
        explanation += `×¡×”"×› ×•×ª×§ ×œ××©×¨×“ (998): ${formatVatik(totalVatik.vatik)}\n`;

        const totalMonths = totalVatik.vatik.years * 12 + totalVatik.vatik.months;
        const sumTotalMonths = sumYears * 12 + sumMonths;

        if (totalMonths === sumTotalMonths) {
            explanation += `\nâœ… ×¡×›×•× ×”×¨×›×™×‘×™× ×ª×•×× ××ª ×”×¡×”"×›.`;
        } else {
            const diff = Math.abs(totalMonths - sumTotalMonths);
            const diffVatik = { years: Math.floor(diff / 12), months: diff % 12 };
            explanation += `\nâš ï¸ ×§×™×™× ×¤×¢×¨ ×©×œ ${formatVatik(diffVatik)} ×‘×™×Ÿ ×¡×›×•× ×”×¨×›×™×‘×™× ×œ×¡×”"×›.`;
        }
    }

    return {
        title: 'ğŸ“Š ×”×¡×‘×¨ ×ª×•×¡×¤×ª ×•×ª×§',
        explanation: explanation
    };
}
function excelDateToDate(serial) {
    if (!serial || isNaN(serial)) return null;
    const date = new Date((serial - 25569) * 86400 * 1000);
    return date;
}

function formatMonthYear(serial) {
    const date = excelDateToDate(serial);
    if (!date) return String(serial);
    const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
    return months[date.getMonth()] + '.' + date.getFullYear();
}
function checkNihul4517() {
    const SEMEL_9517 = 9517;
    const SEMEL_4517 = 4517;
    const SEMEL_684 = 684;

    const rows9517 = employeeData.elements[SEMEL_9517];
    const rows4517 = employeeData.elements[SEMEL_4517];
    const rows684 = employeeData.elements[SEMEL_684];

    if (!rows9517 || rows9517.length === 0) {
        showMessage('×œ× × ××¦××• × ×ª×•× ×™ ×¡××œ 9517 ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”.', 'warning');
        return null;
    }

    // ×–×™×”×•×™ ×—×•×“×© ×ª×©×œ×•× × ×•×›×—×™ (×ª××¨×™×š ×©×›×¨ - ×¢××•×“×” G)
    const allSalaryDates = rawData.map(r => Number(r[COL.TAARICH_SACHAR])).filter(d => d > 0);
    const currentSalaryDate = Math.max(...allSalaryDates);
    const currentDate = excelDateToDate(currentSalaryDate);
    
    // 3 ×—×•×“×©×™ ×¢×¨×š ×©×§×“××• ×œ×—×•×“×© ×”×ª×©×œ×•×
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    const validMonths = [];
    for (let i = 1; i <= 3; i++) {
        let m = currentMonth - i;
        let y = currentYear;
        while (m < 0) { m += 12; y--; }
        validMonths.push({ month: m, year: y });
    }

    function isValidMonth(serial) {
        const d = excelDateToDate(serial);
        if (!d) return false;
        return validMonths.some(vm => vm.month === d.getMonth() && vm.year === d.getFullYear());
    }

    // ×¡×™× ×•×Ÿ ×¨×§ 9517 ×¢× ×ª××¨×™×š ×¢×¨×š ×‘-3 ×”×—×•×“×©×™× ×”×¨×œ×•×•× ×˜×™×™×
    const monthlyTotals = {};
    rows9517.forEach(row => {
        if (!isValidMonth(row.taarichErech)) return;
        const key = formatMonthYear(row.taarichErech);
        if (!monthlyTotals[key]) {
            monthlyTotals[key] = { schum: 0, rows: 0 };
        }
        monthlyTotals[key].schum += row.schum;
        monthlyTotals[key].rows++;
    });

    const months = Object.keys(monthlyTotals).sort();

    // ××—×•×–×™×
    const achuz4517 = rows4517 && rows4517.length > 0 ? rows4517[0].achuz : null;
    const achuz684 = rows684 && rows684.length > 0 ? rows684[0].kamut : null;

    // ×¡×›×•× 4517 ×‘×¤×•×¢×œ
   let schum4517 = 0;
if (rows4517) {
    rows4517.forEach(row => {
        if (Number(row.taarichSachar) === currentSalaryDate && Number(row.taarichErech) === currentSalaryDate) {
            schum4517 += row.schum;
        }
    });
}

    // ×—×™×©×•×‘ ×××•×¦×¢
    let totalSchum = 0;
    months.forEach(m => { totalSchum += monthlyTotals[m].schum; });
    const total3Months = totalSchum;

    // ×‘× ×™×™×ª ×”×¡×‘×¨
    let explanation = '';
    explanation += `××¢× ×§ × ×™×”×•×œ ×™×™×¦×•×¨ (4517) ×”×•× ××¢× ×§ ×¨×‘×¢×•× ×™ ×”××—×•×©×‘ ×›×××•×¦×¢ ×©×œ ×©×œ×•×©×ª ×”×—×•×“×©×™× ×”××—×¨×•× ×™×.\n\n`;
    explanation += `×—×•×“×© ×ª×©×œ×•× × ×•×›×—×™: <span class="highlight">${formatMonthYear(currentSalaryDate)}</span>\n\n`;

    if (achuz684 !== null && achuz4517 !== null) {
        const achuz9517 = (achuz684 / 100 + 1) * achuz4517;
        explanation += `×”×‘×¨×•×˜×• ×”×—×•×“×©×™ × ×©××¨ ×‘×¡××œ 9517 ×•××—×•×©×‘ ×›×š:\n`;
        explanation += `<span class="highlight">××—×•×– 9517</span> = (××—×•×– 684 [${achuz684}] / 100 + 1) Ã— ××—×•×– 4517 [${achuz4517}] = ${achuz9517.toFixed(2)}\n`;
        explanation += `<span class="highlight">×¡×›×•× 9517</span> = ×ª×¢×¨×™×£ Ã— ××—×•×– / 3\n\n`;
    }

    explanation += `×¤×™×¨×•×˜ ×œ×¤×™ ×—×•×“×© ×¢×¨×š:\n`;
    if (months.length !== 3) {
        explanation += `<span class="note">âš ï¸ × ××¦××• ${months.length} ×—×•×“×©×™ ×¢×¨×š ×‘××§×•× 3!</span>\n`;
    }

    months.forEach(m => {
        const data = monthlyTotals[m];
        explanation += `<span class="highlight">${m}</span>: ×¡×”"×› 9517 = ${data.schum.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—`;
        if (data.rows > 1) {
            explanation += ` (${data.rows} ×©×•×¨×•×ª)`;
        }
        explanation += `\n`;
    });

    explanation += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  explanation += `×¡×”"×› 9517 ×œ-${months.length} ×—×•×“×©×™×: ${total3Months.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
    explanation += `×¡×›×•× 4517 ×‘×¤×•×¢×œ: ${schum4517.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;

    const diff = Math.abs(schum4517 - total3Months);
    if (diff < 1) {
        explanation += `\nâœ… ×¡×›×•× 4517 ×ª×•×× ××ª ×××•×¦×¢ 3 ×”×—×•×“×©×™×.`;
    } else {
        explanation += `\nâš ï¸ ×§×™×™× ×¤×¢×¨ ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×— ×‘×™×Ÿ ×”×¡×›×•× ×‘×¤×•×¢×œ ×œ×××•×¦×¢.`;
    }

    return {
        title: 'ğŸ“Š ×”×¡×‘×¨ ××¢× ×§ ×ª×•×¡×¤×ª × ×™×”×•×œ (4517)',
        explanation: explanation
    };
}
function checkSimpleRule(ruleName) {
    const rule = SIMPLE_RULES[ruleName];
    if (!rule) return null;

    // ×—×™×¤×•×© ×œ×¤×™ ×©× ×¡××œ (×¢××•×“×” F)
    let matchedRows = null;
    for (const rows of Object.values(employeeData.elements)) {
const found = rows.filter(r => r.shemSemel.includes(ruleName) || ruleName.includes(r.shemSemel));
        if (found.length > 0) {
            matchedRows = found;
            break;
        }
    }

    if (!matchedRows || matchedRows.length === 0) {
        showMessage(`×œ× × ××¦× ×¨×›×™×‘ "${ruleName}" ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”.`, 'warning');
        return null;
    }

    const row = matchedRows[0];
    let explanation = `${rule.explanation}\n\n`;

    for (const [field, label] of Object.entries(rule.fields)) {
        const value = row[field] || 0;
        explanation += `<span class="highlight">${label}</span>: ${value.toLocaleString('he-IL', {minimumFractionDigits: 2})}\n`;
    }

    if (rule.relatedSemel && rule.checkPercent) {
    const relatedRows = employeeData.elements[rule.relatedSemel];
    if (relatedRows && relatedRows.length > 0) {
        const base = relatedRows[0].schum;
        const expected = base * rule.checkPercent;
        explanation += `\n×©×›×¨ ×§×•×‘×¢ (${rule.relatedSemel}): ${base.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        explanation += `×¦×¤×•×™ (${rule.checkPercent * 100}%): ${expected.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×—\n`;
        
        const diff = Math.abs(row.schum - expected);
        if (diff < 1) {
            explanation += `\nâœ… ×”×¡×›×•× ×ª×•×× ××ª ×”×—×™×©×•×‘.`;
        } else {
            explanation += `\nâš ï¸ ×¤×¢×¨ ×©×œ ${diff.toLocaleString('he-IL', {minimumFractionDigits: 2})} ×©"×— ××”×—×™×©×•×‘ ×”×¦×¤×•×™.`;
        }
    }
}

    return {
        title: `ğŸ“Š ×”×¡×‘×¨ ${rule.name} (×¡××œ ${row.semel})`,
        explanation: explanation
    };
}
function populateCheckTypes() {
    const select = document.getElementById('checkType');
    for (const [semel, rule] of Object.entries(SIMPLE_RULES)) {
        const option = document.createElement('option');
        option.value = semel;
        option.textContent = `${rule.name} (${semel})`;
        select.appendChild(option);
    }
}
populateCheckTypes();
</script>

</body>
</html>
