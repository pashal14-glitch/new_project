<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×©×’×•×™×™ 102</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #e74c3c);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .back-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .folder-select-area {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border: 3px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder-select-area:hover {
            border-color: #e74c3c;
            background: #ffe8e8;
        }

        .folder-select-area.loaded {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .folder-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            margin: 5px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .filter-item input, .filter-item select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 8px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.85em;
        }

        td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.8em;
        }

        tr:hover {
            background: #fff5f5;
        }

        .tik-badge {
            background: #fadbd8;
            color: #c0392b;
            padding: 4px 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.85em;
            min-width: 110px;
        }

        .status-select:focus {
            outline: none;
            border-color: #e74c3c;
        }

        .notes-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .notes-btn:hover {
            background: #8e44ad;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .modal-content textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            resize: vertical;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .hidden {
            display: none;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }

        .message.success {
            background: #d5f4e6;
            color: #27ae60;
            border: 2px solid #27ae60;
        }

        .message.error {
            background: #fadbd8;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        .message.info {
            background: #e3f2fd;
            color: #3498db;
            border: 2px solid #3498db;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="back-btn" onclick="window.location.href='../index.html'">ğŸ  ×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
            <h1>ğŸ“Š ××¢×¨×›×ª ×©×’×•×™×™ 102</h1>
            <p>× ×™×”×•×œ ×•× ×™×ª×•×— ×˜×¤×¡×™ 102 ×©×’×•×™×™×</p>
        </div>

        <!-- ×‘×—×™×¨×ª ×ª×™×§×™×™×” -->
        <div class="section">
            <h2>ğŸ“ ×‘×—×™×¨×ª ×ª×™×§×™×™×”</h2>
            <div class="folder-select-area" id="folderArea" onclick="document.getElementById('folderInput').click()">
                <div class="folder-icon">ğŸ“‚</div>
                <h3>×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª×™×§×™×™×”</h3>
                <p>×”×ª×™×§×™×™×” ×¦×¨×™×›×” ×œ×”×›×™×œ ×§×‘×¦×™ Excel ×©×œ ×˜×¤×¡×™ 102 ×©×’×•×™×™×</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none;">
            </div>
            <div id="loadMessage"></div>
            
            <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn-primary" onclick="loadFromIndexedDB()">
                    ğŸ“¥ ×˜×¢×Ÿ × ×ª×•× ×™× ×©××•×¨×™×
                </button>
                <button class="btn-primary" onclick="saveToIndexedDB()" style="background: #9b59b6;">
                    ğŸ’¾ ×©××•×¨ × ×ª×•× ×™×
                </button>
                <button class="btn-primary" onclick="clearIndexedDB()" style="background: #95a5a6;">
                    ğŸ—‘ï¸ ××—×§ × ×ª×•× ×™× ×©××•×¨×™×
                </button>
            </div>
        </div>

        <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
        <div class="section hidden" id="statsSection">
            <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">×¡×š ×”×›×œ ×¨×©×•××•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">×§×‘×¦×™× × ×˜×¢× ×•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueEmployees">0</div>
                    <div class="stat-label">×¢×•×‘×“×™× ×™×™×—×•×“×™×™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueTiks">0</div>
                    <div class="stat-label">×ª×™×§×™× ×©×•× ×™×</div>
                </div>
            </div>
        </div>

        <!-- ×¡×™× ×•× ×™× -->
        <div class="section hidden" id="filtersSection">
            <h2>ğŸ” ×¡×™× ×•× ×™×</h2>
            <div class="filters-grid">
                <div class="filter-item">
                    <label>××¡×¤×¨ ×–×”×•×ª</label>
                    <input type="text" id="filterID" placeholder="×”×§×œ×“ ××¡×¤×¨ ×–×”×•×ª">
                </div>
                <div class="filter-item">
                    <label>×ª××¨×™×š ×”×¤×§×ª ××©×•×‘</label>
                    <select id="filterDate">
                        <option value="">×›×œ ×”×ª××¨×™×›×™×</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>×ª×™×§</label>
                    <select id="filterTik">
                        <option value="">×›×œ ×”×ª×™×§×™×</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>×¡×•×’ ×“×™×•×•×—</label>
                    <select id="filterReportType">
                        <option value="">×”×›×œ</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>×¡×˜×˜×•×¡ ×¢×“×›×•×Ÿ</label>
                    <select id="filterUserStatus">
                        <option value="">×”×›×œ</option>
                        <option value="×—×“×©">×—×“×©</option>
                        <option value="×‘×˜×™×¤×•×œ">×‘×˜×™×¤×•×œ</option>
                        <option value="×ª×•×§×Ÿ">×ª×•×§×Ÿ</option>
                        <option value="×¡×’×•×¨">×¡×’×•×¨</option>
                    </select>
                </div>
            </div>
            <button class="btn-primary" onclick="applyFilters()">ğŸ” ×¡× ×Ÿ</button>
            <button class="btn-primary" onclick="exportToExcel()" style="background: #27ae60;">ğŸ“¥ ×™×™×¦× ×œ-Excel</button>
        </div>

        <!-- ×˜×‘×œ×ª ×ª×•×¦××•×ª -->
        <div class="section hidden" id="resultsSection">
            <h2>ğŸ“‹ ×ª×•×¦××•×ª</h2>
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>××¡×¤×¨ ×–×”×•×ª</th>
                            <th> ××¡×¤×¨ ×¢×•×‘×“ </th>
                            <th>×ª×™×§</th>
                            <th>×¡×•×’ ×“×™×•×•×—</th>
                            <th>×ª×§×•×¤×ª ×“×™×•×•×—</th>
                            <th>×©× ××©×¤×—×”</th>
                            <th>×©× ×¤×¨×˜×™</th>
                            <th>×©× ×©×“×”</th>
                            <th>×”× ×ª×•×Ÿ ×©×“×•×•×—</th>
                            <th>×ª×™××•×¨</th>
                            <th>×ª××¨×™×š ×”×¤×§×ª ××©×•×‘</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×”×¢×¨×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ××•×“××œ ×”×¢×¨×•×ª -->
    <div class="modal" id="notesModal">
        <div class="modal-content">
            <h3>ğŸ’¬ ×”×¢×¨×•×ª</h3>
            <textarea id="notesText" placeholder="×”×§×œ×“ ×”×¢×¨×•×ª ×›××Ÿ..."></textarea>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="saveNotes()">ğŸ’¾ ×©××•×¨</button>
                <button class="btn-primary" onclick="closeNotesModal()" style="background: #95a5a6;">âœ–ï¸ ×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let form102Data = [];
        let allDates = new Set();
        let allTiks = new Set();
        let allReportTypes = new Set();
        let currentEditingKey = null;

        // IndexedDB
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('bituachLeumiDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('form102')) {
                        db.createObjectStore('form102', { keyPath: 'key' });
                    }
                };
            });
        }

        // ×©××™×¨×” ×œ-IndexedDB
        async function saveToIndexedDB() {
            try {
                const db = await openDatabase();
                const tx = db.transaction(['form102'], 'readwrite');
                const store = tx.objectStore('form102');
                
                store.clear();
                
                form102Data.forEach(item => {
                    store.put(item);
                });
                
                await tx.complete;
                console.log('âœ… × ×ª×•× ×™× × ×©××¨×• ×‘-IndexedDB');
                showMessage('loadMessage', 'âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!', 'success');
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×©××™×¨×”:', error);
                showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×', 'error');
            }
        }

        // ×˜×¢×™× ×” ×-IndexedDB
        async function loadFromIndexedDB() {
            try {
                const db = await openDatabase();
                const tx = db.transaction('form102', 'readonly');
                const store = tx.objectStore('form102');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const data = request.result || [];
                    
                    if (data.length === 0) {
                        showMessage('loadMessage', 'âŒ ××™×Ÿ × ×ª×•× ×™× ×©××•×¨×™× ×‘-IndexedDB', 'error');
                        return;
                    }
                    
                    form102Data = data;
                    
                    // ×¢×“×›×•×Ÿ ×¡×˜×™×
                    allDates.clear();
                    allTiks.clear();
                    allReportTypes.clear();
                    form102Data.forEach(item => {
                        if (item.feedbackDate) allDates.add(item.feedbackDate);
                        if (item.tik) allTiks.add(item.tik);
                        if (item.reportType) allReportTypes.add(item.reportType);
                    });
                    
                    document.getElementById('folderArea').classList.add('loaded');
                    document.getElementById('folderArea').innerHTML = `
                        <div class="folder-icon">ğŸ’¾</div>
                        <h3>× ×˜×¢× ×• × ×ª×•× ×™× ××”××—×©×‘!</h3>
                        <p>${form102Data.length} ×¨×©×•××•×ª</p>
                    `;
                    
                    showMessage('loadMessage', `âœ… × ×˜×¢× ×• ${form102Data.length} ×¨×©×•××•×ª ×-IndexedDB!`, 'success');
                    
                    populateFilters();
                    updateStats();
                    displayResults();
                    
                    document.getElementById('statsSection').classList.remove('hidden');
                    document.getElementById('filtersSection').classList.remove('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                };
                
                request.onerror = () => {
                    showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
                };
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×”:', error);
                showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
            }
        }

        // ××—×™×§×” ×-IndexedDB
        async function clearIndexedDB() {
            if (!confirm('â“ ×”×× ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×©××•×¨×™×?')) {
                return;
            }
            
            try {
                const db = await openDatabase();
                const tx = db.transaction(['form102'], 'readwrite');
                tx.objectStore('form102').clear();
                await tx.complete;
                
                console.log('ğŸ—‘ï¸ IndexedDB × ×•×§×”');
                showMessage('loadMessage', 'âœ… ×”× ×ª×•× ×™× × ××—×§×• ×-IndexedDB', 'success');
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘××—×™×§×”:', error);
            }
        }

        // ×”×¦×’×ª ×”×•×“×¢×”
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="message ${type} fade-in">${text}</div>`;
        }

        // ×”××¨×ª ×ª××¨×™×š Excel
        function excelDateToJSDate(excelDate) {
            if (!excelDate) return '';
            
            if (typeof excelDate === 'string' && excelDate.includes('/')) {
                return excelDate;
            }
            
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            
            return excelDate.toString();
        }

        // ×˜×¢×™× ×ª ×§×‘×¦×™×
        document.getElementById('folderInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            
            if (files.length === 0) {
                showMessage('loadMessage', '×œ× × ×‘×—×¨×• ×§×‘×¦×™×', 'error');
                return;
            }

            console.log(`ğŸ“ ×¡×”"×› ×§×‘×¦×™× ×©× ×‘×—×¨×•: ${files.length}`);

            const excelFiles = files.filter(f => 
                f.name.match(/\.(xlsx|xls)$/i)
            );

            console.log('ğŸ“Š ×§×‘×¦×™ Excel ×©× ××¦××•:', excelFiles.map(f => f.name));

            if (excelFiles.length === 0) {
                showMessage('loadMessage', 'âŒ ×œ× × ××¦××• ×§×‘×¦×™ Excel', 'error');
                return;
            }

            showMessage('loadMessage', `â³ ×˜×•×¢×Ÿ ${excelFiles.length} ×§×‘×¦×™×...`, 'info');

            form102Data = [];
            let processedFiles = 0;
            let totalRecords = 0;

            for (const file of excelFiles) {
                try {
                    console.log(`\nğŸ“„ ××¢×‘×“ ×§×•×‘×¥: ${file.name}`);
                    
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        raw: false,
                        defval: ''
                    });
                    
                    console.log(`   ${jsonData.length} ×©×•×¨×•×ª ×‘×§×•×‘×¥`);
                    
                    // ×©×•×¨×” 0 ×”×™× ×›×•×ª×¨×•×ª, ××ª×—×™×œ×™× ×-1
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        // ×“×™×œ×•×’ ×¢×œ ×©×•×¨×•×ª ×¨×™×§×•×ª - ×‘×•×“×§×™× ××¡×¤×¨ ×–×”×•×ª (H = row[7])
                        if (!row || row.length === 0 || !row[7]) continue;
                        
                        // â­ ××™×¤×•×™ ××“×•×™×§ ×œ×¤×™ ×˜×•×¤×¡ 102 â­
                        const tik = (row[0] || '').toString().trim();              // A - ×ª×™×§
                        const contractType = (row[1] || '').toString().trim();     // B - ×—×•×–×” ×“×™×•×•×—
                        const reportType = (row[2] || '').toString().trim();       // C - ×¡×•×’ ×“×™×•×•×—
                        const reportPeriod = (row[3] || '').toString().trim();     // D - ×ª×§×•×¤×ª ×”×“×™×•×•×—
                        const recordNumber = (row[4] || '').toString().trim();     // E - ××¡×¤×¨ ×¨×©×•××”
                        const factoryNumber = (row[5] || '').toString().trim();    // F - ××¡×¤×¨ ××¤×¢×œ
                        const employeeNumber = (row[6] || '').toString().trim();   // G - ××¡×¤×¨ ×¢×•×‘×“
                        const id = (row[7] || '').toString().trim();               // H - ××¡×¤×¨ ×–×”×•×ª â­
                        const lastName = (row[8] || '').toString().trim();         // I - ×©× ××©×¤×—×”
                        const firstName = (row[9] || '').toString().trim();        // J - ×©××• ×¤×¨×˜×™
                        const fieldName = (row[10] || '').toString().trim();       // K - ×©× ×©×“×”
                        const reportedData = (row[11] || '').toString().trim();    // L - ×”× ×ª×•×Ÿ ×©×“×•×•×—
                        const description = (row[12] || '').toString().trim();     // M - ×ª×™××•×¨
                        const feedbackDate = excelDateToJSDate(row[13]);           // N - ×ª××¨×™×š ×”×¤×§×ª ××©×•×‘ â­
                        
                        // ×‘× ×™×™×ª ×©× ××œ×
                        const fullName = `${lastName} ${firstName}`.trim();
                        
                        // ×•×œ×™×“×¦×™×” - ××¡×¤×¨ ×–×”×•×ª ×¦×¨×™×š ×œ×”×™×•×ª ×œ×¤×—×•×ª 5 ×ª×•×•×™×
                        if (!id || id.length < 5) {
                            console.log(`   âš ï¸ ×©×•×¨×” ${i}: ××¡×¤×¨ ×–×”×•×ª ×œ× ×ª×§×™×Ÿ - "${id}"`);
                            continue;
                        }
                        
                        // ×™×¦×™×¨×ª ××¤×ª×— ×™×™×—×•×“×™
                        const key = `${id}_${tik}_${feedbackDate}_${i}`;
                        
                        form102Data.push({
                            key: key,
                            tik: tik,
                            contractType: contractType,
                            reportType: reportType,
                            reportPeriod: reportPeriod,
                            recordNumber: recordNumber,
                            factoryNumber: factoryNumber,
                            employeeNumber: employeeNumber,
                            id: id,
                            lastName: lastName,
                            firstName: firstName,
                            fullName: fullName,
                            fieldName: fieldName,
                            reportedData: reportedData,
                            description: description,
                            feedbackDate: feedbackDate,
                            fileName: file.name,
                            userStatus: '×—×“×©',
                            notes: ''
                        });
                        
                        // ×¢×“×›×•×Ÿ ×¡×˜×™× ×œ×¡×™× ×•× ×™×
                        if (feedbackDate) allDates.add(feedbackDate);
                        if (tik) allTiks.add(tik);
                        if (reportType) allReportTypes.add(reportType);
                        
                        totalRecords++;
                    }
                    
                    console.log(`   âœ… ${totalRecords} ×¨×©×•××•×ª × ×˜×¢× ×• ××”×§×•×‘×¥`);
                    processedFiles++;
                    
                } catch (error) {
                    console.error(`âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ${file.name}:`, error);
                }
            }

            console.log(`\nğŸ“Š ×¡×™×›×•×: ${processedFiles} ×§×‘×¦×™×, ${totalRecords} ×¨×©×•××•×ª`);

            if (totalRecords === 0) {
                showMessage('loadMessage', 'âŒ ×œ× × ××¦××• ×¨×©×•××•×ª ×ª×§×™× ×•×ª', 'error');
                return;
            }

            await saveToIndexedDB();

            document.getElementById('folderArea').classList.add('loaded');
            document.getElementById('folderArea').innerHTML = `
                <div class="folder-icon">âœ…</div>
                <h3>×”×§×‘×¦×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”!</h3>
                <p>${processedFiles} ×§×‘×¦×™× | ${totalRecords} ×¨×©×•××•×ª</p>
            `;

            showMessage('loadMessage', `âœ… × ×˜×¢× ×• ${processedFiles} ×§×‘×¦×™× ×‘×”×¦×œ×—×”! (${totalRecords} ×¨×©×•××•×ª)`, 'success');
            
            populateFilters();
            updateStats();
            displayResults();
            
            document.getElementById('statsSection').classList.remove('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
        });

        // ××™×œ×•×™ ×¡×™× ×•× ×™×
        function populateFilters() {
            // ×ª××¨×™×›×™× - ×××•×™×Ÿ ××”×—×“×© ×œ×™×©×Ÿ
            const dateSelect = document.getElementById('filterDate');
            dateSelect.innerHTML = '<option value="">×›×œ ×”×ª××¨×™×›×™×</option>';
            
            const sortedDates = Array.from(allDates).sort((a, b) => {
                const [dayA, monthA, yearA] = a.split('/');
                const [dayB, monthB, yearB] = b.split('/');
                const dateA = new Date(yearA, monthA - 1, dayA);
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateB - dateA;
            });
            
            sortedDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateSelect.appendChild(option);
            });
            
            // ×ª×™×§×™×
            const tikSelect = document.getElementById('filterTik');
            tikSelect.innerHTML = '<option value="">×›×œ ×”×ª×™×§×™×</option>';
            
            Array.from(allTiks).sort().forEach(tik => {
                if (tik) {
                    const option = document.createElement('option');
                    option.value = tik;
                    option.textContent = tik;
                    tikSelect.appendChild(option);
                }
            });
            
            // ×¡×•×’×™ ×“×™×•×•×—
            const typeSelect = document.getElementById('filterReportType');
            typeSelect.innerHTML = '<option value="">×”×›×œ</option>';
            
            Array.from(allReportTypes).sort().forEach(type => {
                if (type) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                }
            });
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        function updateStats() {
            document.getElementById('totalRecords').textContent = form102Data.length;
            document.getElementById('totalFiles').textContent = new Set(form102Data.map(r => r.fileName)).size;
            document.getElementById('uniqueEmployees').textContent = new Set(form102Data.map(r => r.id)).size;
            document.getElementById('uniqueTiks').textContent = allTiks.size;
        }

        // ×”×¦×’×ª ×ª×•×¦××•×ª
        function displayResults(filteredData = null) {
            const data = filteredData || form102Data;
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                
               tr.innerHTML = `
    <td>${row.id}</td>
    <td>${row.employeeNumber}</td>
    <td><span class="tik-badge">${row.tik}</span></td>
    <td>${row.reportType}</td>
    <td>${row.reportPeriod}</td>
    <td>${row.lastName}</td>
    <td>${row.firstName}</td>
    <td>${row.fieldName}</td>
    <td>${row.reportedData}</td>
    <td>${row.description}</td>
    <td><strong>${row.feedbackDate}</strong></td>
    <td>
        <select class="status-select" onchange="updateUserStatus('${row.key}', this.value)">
            <option value="×—×“×©" ${row.userStatus === '×—×“×©' ? 'selected' : ''}>×—×“×©</option>
            <option value="×‘×˜×™×¤×•×œ" ${row.userStatus === '×‘×˜×™×¤×•×œ' ? 'selected' : ''}>×‘×˜×™×¤×•×œ</option>
            <option value="×ª×•×§×Ÿ" ${row.userStatus === '×ª×•×§×Ÿ' ? 'selected' : ''}>×ª×•×§×Ÿ</option>
            <option value="×¡×’×•×¨" ${row.userStatus === '×¡×’×•×¨' ? 'selected' : ''}>×¡×’×•×¨</option>
        </select>
    </td>
    <td>
        <button class="notes-btn" onclick="openNotesModal('${row.key}')">
            ğŸ’¬ ${row.notes ? '×¢×¨×•×š' : '×”×•×¡×£'}
        </button>
    </td>
`;
                tbody.appendChild(tr);
            });
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
        function updateUserStatus(key, status) {
            const record = form102Data.find(r => r.key === key);
            if (record) {
                record.userStatus = status;
                saveToIndexedDB();
                console.log(`âœ… ×¢×•×“×›×Ÿ ×¡×˜×˜×•×¡ ×œ-${key}: ${status}`);
            }
        }

        // ××•×“××œ ×”×¢×¨×•×ª
        function openNotesModal(key) {
            currentEditingKey = key;
            const record = form102Data.find(r => r.key === key);
            document.getElementById('notesText').value = record?.notes || '';
            document.getElementById('notesModal').classList.add('show');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('show');
            currentEditingKey = null;
        }

        function saveNotes() {
            const notes = document.getElementById('notesText').value;
            const record = form102Data.find(r => r.key === currentEditingKey);
            
            if (record) {
                record.notes = notes;
                saveToIndexedDB();
                displayResults();
                closeNotesModal();
                console.log(`âœ… ×”×¢×¨×•×ª × ×©××¨×• ×œ-${currentEditingKey}`);
            }
        }

        // ×¡×™× ×•× ×™×
        function applyFilters() {
            const filterID = document.getElementById('filterID').value.trim();
            const filterDate = document.getElementById('filterDate').value;
            const filterTik = document.getElementById('filterTik').value;
            const filterReportType = document.getElementById('filterReportType').value;
            const filterUserStatus = document.getElementById('filterUserStatus').value;

            let filtered = form102Data.filter(row => {
                if (filterID && !row.id.includes(filterID)) return false;
                if (filterDate && row.feedbackDate !== filterDate) return false;
                if (filterTik && row.tik !== filterTik) return false;
                if (filterReportType && row.reportType !== filterReportType) return false;
                if (filterUserStatus && row.userStatus !== filterUserStatus) return false;
                return true;
            });

            displayResults(filtered);
            document.getElementById('totalRecords').textContent = filtered.length;
        }

        function exportToExcel() {
    const data = [['××¡×¤×¨ ×–×”×•×ª', '××¡×¤×¨ ×¢×•×‘×“', '×ª×™×§', '×¡×•×’ ×“×™×•×•×—', '×ª×§×•×¤×ª ×“×™×•×•×—', '×©× ××©×¤×—×”', '×©× ×¤×¨×˜×™', '×©× ×©×“×”', '×”× ×ª×•×Ÿ ×©×“×•×•×—', '×ª×™××•×¨', '×ª××¨×™×š ×”×¤×§×ª ××©×•×‘', '×¡×˜×˜×•×¡', '×”×¢×¨×•×ª']];
    
    const tbody = document.getElementById('resultsBody');
    const rows = tbody.getElementsByTagName('tr');
    
    Array.from(rows).forEach(row => {
        const cells = row.getElementsByTagName('td');
        const id = cells[0].textContent;
        const record = form102Data.find(r => r.id === id);
        
        const rowData = [
            cells[0].textContent,  // ××¡×¤×¨ ×–×”×•×ª
            cells[1].textContent,  // ××¡×¤×¨ ×¢×•×‘×“
            cells[2].textContent,  // ×ª×™×§
            cells[3].textContent,  // ×¡×•×’ ×“×™×•×•×—
            cells[4].textContent,  // ×ª×§×•×¤×ª ×“×™×•×•×—
            cells[5].textContent,  // ×©× ××©×¤×—×”
            cells[6].textContent,  // ×©× ×¤×¨×˜×™
            cells[7].textContent,  // ×©× ×©×“×”
            cells[8].textContent,  // ×”× ×ª×•×Ÿ ×©×“×•×•×—
            cells[9].textContent,  // ×ª×™××•×¨
            cells[10].textContent, // ×ª××¨×™×š
            cells[11].querySelector('select').value, // ×¡×˜×˜×•×¡
            record?.notes || ''    // ×”×¢×¨×•×ª
        ];
        data.push(rowData);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '×©×’×•×™×™ 102');
    
    const fileName = `form102_export_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
}
    </script>
</body>
</html>
