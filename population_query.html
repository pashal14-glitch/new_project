<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ××•×“×•×œ ×©×œ×™×¤×ª ××•×›×œ×•×¡×™×•×ª - ×¢×‘×•×“×” ×¢× ×¡××œ×™ ×©×›×¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-right: 270px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        /* ×¡×¨×’×œ ×¦×“ ×™×× ×™ */
        .stats-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 250px;
            height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }
        
        .stats-sidebar h2 {
            color: white;
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .symbol-category {
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
        }
        
        .symbol-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .symbol-item:hover {
            background: rgba(52, 152, 219, 0.3);
            transform: translateX(-5px);
        }
        
        .symbol-number {
            font-weight: bold;
            color: #3498db;
        }
        
        .symbol-count {
            background: #3498db;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        /* ×× ×’× ×•×Ÿ ××§×•×¨×“×™×•×Ÿ ×œ×§×˜×’×•×¨×™×•×ª */
        .category-header {
            cursor: pointer;
            user-select: none;
            padding: 8px;
            background: rgba(255,255,255,0.15);
            border-radius: 5px;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-header:hover {
            background: rgba(255,255,255,0.25);
        }

        .category-toggle {
            font-size: 1.2em;
            font-weight: bold;
            color: #3498db;
            min-width: 20px;
            text-align: center;
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0;
        }

        .category-content.open {
            max-height: 500px;
            padding-top: 10px;
        }

        /* ×¡×¢×™×¤×™× ×¨××©×™×™× */
        .section {
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        /* ××–×•×¨ ×”×—×™×¤×•×© */
        .search-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .search-field {
            margin-bottom: 15px;
        }
        
        .search-field label {
            display: block;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }
        
        .search-field input,
        .search-field select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .search-field input:focus,
        .search-field select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        /* ×›×¤×ª×•×¨×™× */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        /* ×˜×‘×œ×ª ×ª×•×¦××•×ª */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* ×”×•×“×¢×•×ª */
        .data-status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .data-status.success {
            background: #d5f4e6;
            border: 2px solid #27ae60;
            color: #27ae60;
        }
        
        .data-status.error {
            background: #fadbd8;
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }
        
        .data-status.info {
            background: #e3f2fd;
            border: 2px solid #3498db;
            color: #3498db;
        }
        
        /* ×”×¡×ª×¨×” */
        .hidden {
            display: none !important;
        }
        
        /* ×¡×˜×˜×™×¡×˜×™×§×•×ª */
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
    </style>
</head>
<body>


    <!-- ×¡×¨×’×œ ×¦×“ ×™×× ×™ -->
    <div class="stats-sidebar">
        <h2>ğŸ“Š × ×™×ª×•×— ×¡××œ×™ ×©×›×¨</h2>
        
  <div id="categoriesContainer">
            <!-- ×™×ª××œ× ×“×™× ××™×ª ×¢× ×›×œ ×”×§×˜×’×•×¨×™×•×ª -->
        </div>



        <div class="symbol-category">
            <h3>ğŸ“ˆ ×¡×˜×˜×™×¡×˜×™×§×•×ª</h3>
            <div id="statsInfo">
                <div class="symbol-item">
                    <span>×¡×”"×› ×©×•×¨×•×ª:</span>
                    <span id="totalRows">0</span>
                </div>
                <div class="symbol-item">
                    <span>×¡×”"×› ×¢×•×‘×“×™×:</span>
                    <span id="totalEmployees">0</span>
                </div>
                <div class="symbol-item">
                    <span>×¡××œ×™× ×©×•× ×™×:</span>
                    <span id="totalSymbols">0</span>
                </div>
            </div>
        </div>
        
        <button class="btn btn-warning" style="width: 100%; margin-top: 20px;" onclick="loadRawData()">
            ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×
        </button>
    </div>

    <!-- ×”××™×›×œ ×”×¨××©×™ -->
    <div class="container">
        <div class="header">
            <h1>ğŸ” ××•×“×•×œ ×©×œ×™×¤×ª ××•×›×œ×•×¡×™×•×ª - ×¡××œ×™ ×©×›×¨</h1>
            <div id="dataStatus"></div>
        </div>

        <!-- ×¡×¢×™×£ ×—×™×¤×•×© ×œ×¤×™ ×¡××œ×™× -->
        <div class="section">
            <h2>ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×¡××œ×™ ×©×›×¨</h2>
            
            <div class="search-area">
                <div class="search-grid">
                    <div class="search-field">
                        <label>××¡×¤×¨ ×¡××œ:</label>
                        <input type="number" id="symbolSearch" placeholder="×œ××©×œ: 91090">
                        <small style="color: #666;">91090=×©×•×˜×£, 91091=×”×¤×¨×©×™×, 91092=×ª×©×œ×•××™×</small>
                    </div>
                    

   <div class="search-field">
                        <label>×©× ×”×¡××œ :</label>
                        <input type="text" id="symbolNameSearch" placeholder="×œ××©×œ: ×“×¨×•×’">
                    </div>


                    <div class="search-field">
                        <label>×¢×¨×š ××™× ×™××œ×™:</label>
                        <input type="number" id="amountMin" placeholder="×œ××©×œ: 1000">
                    </div>
                    
                    <div class="search-field">
                        <label>×¢×¨×š ××§×¡×™××œ×™:</label>
                        <input type="number" id="amountMax" placeholder="×œ××©×œ: 50000">
                    </div>
                    
                    <div class="search-field">
                        <label>×—×•×“×©:</label>
                        <select id="monthFilter">
                            <option value="">×›×œ ×”×—×•×“×©×™×</option>
                            <option value="current">×—×•×“×© × ×•×›×—×™</option>
                            <option value="previous">×—×•×“×© ×§×•×“×</option>
                        </select>
                    </div>
                </div>
                
                <!-- ×¡××œ×™× × ×¤×•×¦×™× ×œ×‘×—×™×¨×” ××”×™×¨×” -->
                <div style="margin-top: 20px;">
                    <strong>×¡××œ×™× ××”×™×¨×™×:</strong>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="quickSearch(91090)">91090 - ×©×›×¨ ×©×•×˜×£</button>
                        <button class="btn btn-primary" onclick="quickSearch(91091)">91091 - ×”×¤×¨×©×™×</button>
                        <button class="btn btn-primary" onclick="quickSearch(91092)">91092 - ×¡×”"×› ×ª×©×œ×•××™×</button>
                        <button class="btn btn-primary" onclick="quickSearch(91095)">91095 - ×¡×”"×› × ×™×›×•×™×™×</button>
                        <button class="btn btn-primary" onclick="quickSearch(91096)">91096 - ×¡×”"×› × ×˜×• ×œ×ª×©×œ×•×</button>

                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="searchBySymbol()" style="font-size: 1.2em;">
                        ğŸ” ×‘×¦×¢ ×—×™×¤×•×©
                    </button>
                    <button class="btn btn-warning" onclick="clearSearch()">
                        ğŸ”„ × ×§×” ×—×™×¤×•×©
                    </button>
                    <button class="btn btn-success" id="exportBtn" onclick="exportToExcel()" style="display:none;">
                        ğŸ“¥ ×™×™×¦×•× ×œ××§×¡×œ
                    </button>
                </div>
            </div>
        </div>

        <!-- ×¡×¢×™×£ ×ª×•×¦××•×ª -->
        <div class="section" id="resultsSection" style="display:none;">
            <h2>ğŸ“‹ ×ª×•×¦××•×ª ×”×—×™×¤×•×©</h2>
            <div id="resultsSummary" style="margin-bottom: 20px;"></div>
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>×ª.×–</th>
                            <th>××©×¨×“</th>
                            <th>×¡××œ</th>
                            <th>×©× ×¡××œ</th>
                            <th>×¡×›×•×</th>
                            <th>×›××•×ª</th>
                            <th>××—×•×–</th>
                            <th>×ª×¢×¨×™×£</th>
                            <th>×ª××¨×™×š ×©×›×¨</th>
                            <th>×ª××¨×™×š ×™×™×—×•×¡</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let rawData = [];
        let currentResults = [];
        let currentMonth = null;
        let previousMonth = null;
        let dbConnection = null;

        // ============================================
        // ×¤×•× ×§×¦×™×•×ª IndexedDB
        // ============================================

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SharedSalaryDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    dbConnection = request.result;
                    resolve(dbConnection);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('sharedData')) {
                        db.createObjectStore('sharedData');
                    }
                };
            });
        }

        async function loadRawData() {
            try {
                console.log('ğŸ”„ ×˜×•×¢×Ÿ × ×ª×•× ×™× ×’×•×œ××™×™× ×-IndexedDB...');
                
                const db = await initDB();
                const transaction = db.transaction(['sharedData'], 'readonly');
                const store = transaction.objectStore('sharedData');
                const request = store.get('currentData');
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        if (request.result && request.result.rawData) {
                            const data = request.result;
                            rawData = data.rawData;
                            currentMonth = data.currentMonth;
                            previousMonth = data.previousMonth;
                            
                            console.log(`âœ… × ×˜×¢× ×• ${rawData.length} ×©×•×¨×•×ª × ×ª×•× ×™×`);
                            
                            showStatus('success', 
                                `âœ… × ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” | 
                                 ğŸ“Š ${data.totalRows} ×©×•×¨×•×ª | 
                                 ğŸ‘¥ ${data.uniqueEmployees} ×¢×•×‘×“×™× | 
                                 ğŸ• ${new Date(data.timestamp).toLocaleString('he-IL')}`
                            );
                            
                            updateSidebarStats();
                            resolve(true);
                        } else {
                            console.log('âš ï¸ ×œ× × ××¦××• × ×ª×•× ×™× ×‘-DB');
                            showStatus('error', 'âŒ ×œ× × ××¦××• × ×ª×•× ×™×. ×™×© ×œ×˜×¢×•×Ÿ ×§×‘×¦×™× ×‘××•×“×•×œ ×”×”×©×•×•××” ×ª×—×™×œ×”.');
                            resolve(false);
                        }
                    };
                    
                    request.onerror = () => {
                        console.error('âŒ ×©×’×™××” ×‘×§×¨×™××”:', request.error);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('âŒ Error loading raw data:', error);
                showStatus('error', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error);
                return false;
            }
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.className = `data-status ${type}`;
            statusDiv.innerHTML = message;
        }

        // ============================================
        // ×¤×•× ×§×¦×™×•×ª × ×™×ª×•×— ×•×¡×˜×˜×™×¡×˜×™×§×” - ××¢×¨×›×ª ×’× ×¨×™×ª
        // ============================================

        // ×”×’×“×¨×ª ×›×œ ×”×§×˜×’×•×¨×™×•×ª ×‘××§×•× ××—×“
        const CATEGORIES = [
            {
                id: 'grade',
                name: '×“×™×¨×•×’×™×',
                icon: 'ğŸ“Š',
                symbol: 90144,
                field: 'AMOUNT',
                sortOrder: 'desc'
            },
            {
                id: 'employeeStatus',
                name: '××¢××“ ×¢×•×‘×“',
                icon: 'ğŸ‘¤',
                symbol: 90150,
                field: 'QUANTITY',
                sortOrder: 'asc'
            },
            {
                id: 'jobScope',
                name: '×—×œ×§×™×•×ª ××©×¨×”',
                icon: 'â°',
                symbol: 90148,
                field: 'PERCENTAGE',
                sortOrder: 'desc'
            }
        ];

        // ×™×¦×™×¨×ª HTML ×“×™× ××™×ª ×œ×›×œ ×”×§×˜×’×•×¨×™×•×ª
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            CATEGORIES.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'symbol-category';
                categoryDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('${category.id}')">
                        <span>${category.icon} ${category.name}</span>
                        <span class="category-toggle" id="${category.id}Toggle">+</span>
                    </div>
                    <div class="category-content" id="${category.id}Content">
                        <div id="${category.id}Items">
                            <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                        </div>
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        // ×¢×“×›×•×Ÿ ×§×˜×’×•×¨×™×” ×¡×¤×¦×™×¤×™×ª
        function updateCategory(category) {
            const itemsDiv = document.getElementById(`${category.id}Items`);
            if (!itemsDiv) return; // ×× ×”×§×˜×’×•×¨×™×” ×¢×•×“ ×œ× × ×•×¦×¨×”

            itemsDiv.innerHTML = '';

            // ×¡×™× ×•×Ÿ ×©×•×¨×•×ª ×œ×¤×™ ×”×¡××œ ×•×”×—×•×“×©
            const categoryRows = rawData.filter(row =>
                row.SALARY_ELEMENT_NUM == category.symbol &&
                row.SALARY_DATE == currentMonth
            );

            if (categoryRows.length === 0) {
                itemsDiv.innerHTML = `<div style="padding:10px;opacity:0.7;">××™×Ÿ × ×ª×•× ×™ ${category.name}</div>`;
                return;
            }

            // ×§×™×‘×•×¥ ×œ×¤×™ ×¢×¨×š ×•×¡×¤×™×¨×ª ×¢×•×‘×“×™×
            const valueGroups = {};
            categoryRows.forEach(row => {
                const value = row[category.field];
                if (value === null || value === undefined) return;

                if (!valueGroups[value]) {
                    valueGroups[value] = new Set();
                }
                valueGroups[value].add(row.id_num);
            });

            // ××™×•×Ÿ
            const sortedValues = Object.entries(valueGroups).sort((a, b) => {
                const numA = parseFloat(a[0]);
                const numB = parseFloat(b[0]);
                return category.sortOrder === 'desc' ? numB - numA : numA - numB;
            });

            // ×”×¦×’×ª ×”×¢×¨×›×™×
            sortedValues.forEach(([value, employeeSet]) => {
                const item = document.createElement('div');
                item.className = 'symbol-item';
                item.onclick = () => searchByCategory(category, value);
                item.innerHTML = `
                    <span>
                        <span class="symbol-number">${category.name} ${value}</span>
                    </span>
                    <span class="symbol-count">${employeeSet.size}</span>
                `;
                itemsDiv.appendChild(item);
            });
        }

        // ×¢×“×›×•×Ÿ ×›×œ ×”×§×˜×’×•×¨×™×•×ª
        function updateAllCategories() {
            CATEGORIES.forEach(category => {
                updateCategory(category);
            });
        }

        // ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×§×˜×’×•×¨×™×”
        function toggleCategory(categoryId) {
            const content = document.getElementById(`${categoryId}Content`);
            const toggle = document.getElementById(`${categoryId}Toggle`);

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                toggle.textContent = '+';
            } else {
                content.classList.add('open');
                toggle.textContent = '-';
            }
        }
function searchByCategory(category, value) {
    console.log('ğŸ” DEBUG searchByCategory:', {
        categoryName: category.name,
        symbol: category.symbol,
        field: category.field,
        value: value
    });

    document.getElementById('symbolSearch').value = category.symbol;
    
    // â† ×ª××™×“ ×¢×“×›×Ÿ! ×œ× ××©× ×” ××™×–×” field!
    document.getElementById('amountMin').value = value;
    document.getElementById('amountMax').value = value;

    document.getElementById('monthFilter').value = 'current';
    console.log('ğŸ“¤ Calling searchBySymbol with field:', category.field);
    console.log('âœ… Set amountMin and amountMax to:', value);
    
    searchBySymbol(category.field);
}
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×ª
        function updateSidebarStats() {
            if (!rawData || rawData.length === 0) return;

            // ×¡×¤×™×¨×•×ª ×‘×¡×™×¡×™×•×ª
            const uniqueEmployees = [...new Set(rawData.map(row => row.id_num))];
            const symbolCounts = {};

            rawData.forEach(row => {
                const symbol = row.SALARY_ELEMENT_NUM;
                if (!symbolCounts[symbol]) {
                    symbolCounts[symbol] = { count: 0 };
                }
                symbolCounts[symbol].count++;
            });

            // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×•×ª
            document.getElementById('totalRows').textContent = rawData.length;
            document.getElementById('totalEmployees').textContent = uniqueEmployees.length;
            document.getElementById('totalSymbols').textContent = Object.keys(symbolCounts).length;

            // ×¢×“×›×•×Ÿ ×›×œ ×”×§×˜×’×•×¨×™×•×ª
            updateAllCategories();
        }
     // ============================================
        // ×¤×•× ×§×¦×™×•×ª ×—×™×¤×•×©
        // ============================================

   function searchBySymbol(selectedField = 'AMOUNT') {
    if (!rawData || rawData.length === 0) {
        alert('×™×© ×œ×˜×¢×•×Ÿ × ×ª×•× ×™× ×ª×—×™×œ×”');
        return;
    }
    
    const symbolNum = document.getElementById('symbolSearch').value;
    const amountMin = parseFloat(document.getElementById('amountMin').value) || -Infinity;
    const amountMax = parseFloat(document.getElementById('amountMax').value) || Infinity;
    const monthFilter = document.getElementById('monthFilter').value;
    
    console.log('ğŸ”¥ searchBySymbol called');
    console.log('ğŸ“Š Parameters:', { 
        symbolNum, 
        selectedField, 
        amountMin, 
        amountMax, 
        monthFilter, 
        currentMonth 
    });
    
    // ×¡×™× ×•×Ÿ ×”× ×ª×•× ×™×
    currentResults = rawData.filter(row => {
        // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡××œ (×× ×”×•×–×Ÿ)
        if (symbolNum && row.SALARY_ELEMENT_NUM != symbolNum) {
            return false;
        }
        
        // ×¡×™× ×•×Ÿ ×œ×¤×™ ×”×©×“×” ×”× ×‘×—×¨ (AMOUNT / QUANTITY / PERCENTAGE)
        const fieldValue = row[selectedField] || 0;
        console.log('ğŸ” Checking row:', { 
            SALARY_ELEMENT_NUM: row.SALARY_ELEMENT_NUM, 
            [selectedField]: fieldValue,
            min: amountMin,
            max: amountMax,
            pass: fieldValue >= amountMin && fieldValue <= amountMax
        });
        
        if (fieldValue < amountMin || fieldValue > amountMax) {
            return false;
        }
        
        // ×¡×™× ×•×Ÿ ×œ×¤×™ ×—×•×“×©
        if (monthFilter === 'current' && row.SALARY_DATE !== currentMonth) {
            return false;
        }
        if (monthFilter === 'previous' && row.SALARY_DATE !== previousMonth) {
            return false;
        }
        
        return true;
    });
    
    console.log(`âœ… Found ${currentResults.length} matching rows`);
    if (currentResults.length > 0) {
        console.log('ğŸ“‹ First result:', currentResults[0]);
    }
    
    displayResults();
}
        function quickSearch(symbolNum) {
            document.getElementById('symbolSearch').value = symbolNum;
            searchBySymbol();
        }

        function clearSearch() {
            document.getElementById('symbolSearch').value = '';
            document.getElementById('amountMin').value = '';
            document.getElementById('amountMax').value = '';
            document.getElementById('monthFilter').value = '';
            
            currentResults = [];
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
        }

        // ============================================
        // ×¤×•× ×§×¦×™×•×ª ×ª×¦×•×’×”
        // ============================================

        function displayResults() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            if (currentResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="padding:30px;color:#999;">×œ× × ××¦××• ×ª×•×¦××•×ª</td></tr>';
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'none';
                updateResultsSummary(0, 0, 0);
                return;
            }
            
            // ×§×™×‘×•×¥ ×œ×¤×™ ×¢×•×‘×“×™×
            const employeeGroups = {};
            let totalAmount = 0;
            
            currentResults.forEach(row => {
                const empId = row.id_num;
                if (!employeeGroups[empId]) {
                    employeeGroups[empId] = [];
                }
                employeeGroups[empId].push(row);
                totalAmount += (row.AMOUNT || 0);
            });
            
            // ×”×¦×’×ª ×”×ª×•×¦××•×ª
            currentResults.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // ×¦×‘×™×¢×ª ×©×•×¨×•×ª ×œ×¤×™ ×¢×•×‘×“
                if (index > 0 && currentResults[index - 1].id_num !== row.id_num) {
                    tr.style.borderTop = '3px solid #3498db';
                }
                
                tr.innerHTML = `
                    <td><strong>${row.id_num}</strong></td>
                    <td>${row.OFFICE_NUM || '-'}</td>
                    <td><span class="symbol-number">${row.SALARY_ELEMENT_NUM}</span></td>
                    <td>${row.ELEMENT_NAME || '-'}</td>
                    <td style="font-weight:bold;">${formatNumber(row.AMOUNT)}</td>
                    <td>${formatNumber(row.QUANTITY)}</td>
                    <td>${formatNumber(row.PERCENTAGE)}%</td>
                    <td>${formatNumber(row.TARIFF)}</td>
                    <td>${formatDate(row.SALARY_DATE)}</td>
                    <td>${formatDate(row.REFERENCE_DATE)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            updateResultsSummary(currentResults.length, Object.keys(employeeGroups).length, totalAmount);
            
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('exportBtn').style.display = 'inline-block';
        }

        function updateResultsSummary(rows, employees, totalAmount) {
            const summaryDiv = document.getElementById('resultsSummary');
            summaryDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; display: flex; justify-content: space-around;">
                    <div>
                        <strong>×©×•×¨×•×ª:</strong> ${rows}
                    </div>
                    <div>
                        <strong>×¢×•×‘×“×™×:</strong> ${employees}
                    </div>
                    <div>
                        <strong>×¡×›×•× ×›×•×œ×œ:</strong> ${formatCurrency(totalAmount)}
                    </div>
                </div>
            `;
        }

        // ============================================
        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
        // ============================================

        function formatNumber(num) {
            if (num === null || num === undefined || num === 0) return '-';
            return num.toLocaleString('he-IL', { maximumFractionDigits: 2 });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('he-IL', {
                style: 'currency',
                currency: 'ILS',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        function formatDate(date) {
            if (!date) return '-';
            try {
                return new Date(date).toLocaleDateString('he-IL');
            } catch {
                return date;
            }
        }

        // ============================================
        // ×™×™×¦×•× ×œ××§×¡×œ
        // ============================================

        function exportToExcel() {
            if (currentResults.length === 0) {
                alert('××™×Ÿ ×ª×•×¦××•×ª ×œ×™×™×¦×•×');
                return;
            }
            
            // ×”×›× ×ª ×”× ×ª×•× ×™× ×œ×™×™×¦×•×
            const exportData = currentResults.map(row => ({
                '×ª.×–': row.id_num,
                '××©×¨×“': row.OFFICE_NUM || '',
                '××¡×¤×¨ ×¡××œ': row.SALARY_ELEMENT_NUM,
                '×©× ×¡××œ': row.ELEMENT_NAME || '',
                '×¡×›×•×': row.AMOUNT || 0,
                '×›××•×ª': row.QUANTITY || 0,
                '××—×•×–': row.PERCENTAGE || 0,
                '×ª×¢×¨×™×£': row.TARIFF || 0,
                '×ª××¨×™×š ×©×›×¨': row.SALARY_DATE || '',
                '×ª××¨×™×š ×™×™×—×•×¡': row.REFERENCE_DATE || '',
                'DATE_FROM': row.DATE_FROM || ''
            }));
            
            // ×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '×©×œ×™×¤×ª ×¡××œ×™×');
            
            // ×©××™×¨×ª ×”×§×•×‘×¥
            const fileName = `×©×œ×™×¤×ª_×¡××œ×™×_${new Date().toLocaleDateString('he-IL').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ============================================
        // ××ª×—×•×œ
        // ============================================

        window.onload = async function() {
            console.log('ğŸš€ ×××ª×—×œ ××•×“×•×œ ×©×œ×™×¤×ª ×¡××œ×™ ×©×›×¨...');

            // ×™×¦×™×¨×ª ×”×§×˜×’×•×¨×™×•×ª ×“×™× ××™×ª
            renderCategories();

            // ×˜×¢×™× ×ª × ×ª×•× ×™× ×-IndexedDB
            const dataLoaded = await loadRawData();
            
            if (!dataLoaded) {
                showStatus('error', 
                    `âŒ ×œ× × ××¦××• × ×ª×•× ×™× ×‘××¢×¨×›×ª. 
                    <br><br>
                    <button class="btn btn-primary" onclick="window.open('salary_check_new_version.html', '_blank')">
                        ğŸ“Š ×¢×‘×•×¨ ×œ××•×“×•×œ ×”×”×©×•×•××” ×œ×˜×¢×™× ×ª × ×ª×•× ×™×
                    </button>`
                );
            }
        };

        // ×”××–× ×” ×œ×©×™× ×•×™×™× ×‘-storage
        window.addEventListener('storage', function(e) {
            if (e.key === 'sharedDataUpdated') {
                console.log('ğŸ”„ ×–×•×”×• × ×ª×•× ×™× ×—×“×©×™×, ×˜×•×¢×Ÿ ××—×“×©...');
                loadRawData();
            }
        });
    </script>
</body>
</html>
