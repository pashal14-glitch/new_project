<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×‘×§×¨×ª ×©×›×¨ - ×’×¨×¡×” ××œ××”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
    background: linear-gradient(45deg, #2c3e50, #3498db);
    color: white;
    padding: 15px 20px;  /* â† ×”×™×” 30px */
    text-align: center;
}
        .header h1 {
    font-size: 1.8em;  /* â† ×”×™×” 2.5em */
    margin-bottom: 5px;  /* â† ×”×™×” 10px */
}
        .section { padding: 30px; border-bottom: 1px solid #e9ecef; }
        .section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5em; }
        .folder-select-area {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border: 3px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .folder-select-area:hover { border-color: #3498db; background: #e3f2fd; }
        .folder-select-area.loaded { border-color: #27ae60; background: #d5f4e6; }
        .folder-icon { font-size: 4em; margin-bottom: 10px; }
        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-success { background: #27ae60; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 1em; opacity: 0.9; }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .filter-item { display: flex; flex-direction: column; }
        .filter-item label { font-weight: bold; color: #555; margin-bottom: 5px; }
        .filter-item input, .filter-item select { padding: 10px; border: 2px solid #ddd; border-radius: 5px; }
        .table-container { overflow-x: auto; margin-top: 20px; max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; }
        tr:hover { background: #f8f9fa; }
        .status-green { background: #d5f4e6; color: #27ae60; font-weight: bold; }
        .status-red { background: #fadbd8; color: #e74c3c; font-weight: bold; }
        .hidden { display: none; }
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; }
        .message.success { background: #d5f4e6; color: #27ae60; border: 2px solid #27ae60; }
        .message.error { background: #fadbd8; color: #e74c3c; border: 2px solid #e74c3c; }
        .message.info { background: #e3f2fd; color: #3498db; border: 2px solid #3498db; }
       /* ×¡×¨×’×œ ×—×¨×™×’×™× ×§×‘×•×¢ */
        .exceptions-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 250px;
            height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }

        .exceptions-sidebar h2 {
            color: white;
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .exception-stat {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .exception-stat:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(-5px);
        }

        .exception-stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .exception-stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .exception-new { border-left: 4px solid #e74c3c; }
        .exception-existing { border-left: 4px solid #f39c12; }
        .exception-resolved { border-left: 4px solid #27ae60; }

        .snapshots-list {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .snapshot-item {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .snapshot-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .snapshot-item.active {
            background: #3498db;
        }

        .btn-sidebar {
            width: 100%;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        .btn-sidebar:hover {
            background: #2980b9;
        }

       /* ×”×ª×××ª ×”×ª×•×›×Ÿ ×”×¨××©×™ */
        .container {
            margin-right: 250px;
        }

        /* ×¤×× ×œ ××¤×•×¨×˜ */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -700px;
            width: 700px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            transition: right 0.3s;
            z-index: 200;
            overflow-y: auto;
        }

        .detail-panel.open {
            right: 250px;
        }

        .detail-panel-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
        }

        .detail-panel-content {
            padding: 20px;
        }

        .exception-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .exception-card.new {
            border-color: #e74c3c;
            background: #fadbd8;
        }

        .exception-card.existing {
            border-color: #f39c12;
            background: #fff3cd;
        }

        .exception-card.resolved {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .exception-card.approved {
            opacity: 0.6;
        }

        .exception-notes {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            min-height: 60px;
            font-family: inherit;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-approve:hover {
            background: #229954;
        }
        .delete-snapshot-btn {
    position: absolute;
    top: 5px;
    left: 5px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 0.8em;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s, transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.snapshot-item:hover .delete-snapshot-btn {
    opacity: 1;
}

.delete-snapshot-btn:hover {
    transform: scale(1.1);
    background: #c0392b;
}

.delete-snapshot-btn:active {
    transform: scale(0.95);
}


.stats-sidebar h2 {
    color: white;
    font-size: 1.3em;
    margin-bottom: 15px;
    border-bottom: 2px solid rgba(255,255,255,0.3);
    padding-bottom: 10px;
}

.stats-sidebar-card {
    background: rgba(255,255,255,0.15);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    text-align: center;
    transition: all 0.3s;
    border: 2px solid rgba(255,255,255,0.2);
}

.stats-sidebar-card:hover {
    background: rgba(255,255,255,0.25);
    transform: scale(1.05);
}

.stats-sidebar-number {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 5px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.stats-sidebar-label {
    font-size: 0.95em;
    opacity: 0.95;
    font-weight: 500;
}

/* ×”×ª×××ª container ×œ×©× ×™ ×¡×¨×’×œ×™× */
.container {
    margin-right: 250px;  /* ×¡×¨×’×œ ×—×¨×™×’×™× */
    margin-left: 280px;   /* ×¡×¨×’×œ ×¡×˜×˜×™×¡×˜×™×§×•×ª */
}
/* ========================================
   ×˜××‘×™× inline - ×¢×™×¦×•×‘ ×—×“×©
======================================== */

.tabs-container-inline {
    display: flex;
    gap: 10px;
    background: rgba(255,255,255,0.1);
    padding: 5px;
    border-radius: 10px;
}

.tab-btn {
    background: white;
    color: #2c3e50;
    border: 2px solid transparent;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.tab-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.tab-btn.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.tab-badge {
    background: rgba(0,0,0,0.2);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    min-width: 25px;
    text-align: center;
}

.tab-btn.active .tab-badge {
    background: rgba(255,255,255,0.3);
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ×”×ª×××” ×œ××¡×›×™× ×§×˜× ×™× */
@media (max-width: 768px) {
    .section > div:first-child {
        flex-direction: column;
        align-items: stretch !important;
    }
    
    .tabs-container-inline {
        width: 100%;
        justify-content: center;
        margin-top: 15px;
    }
    
    .tab-btn {
        flex: 1;
        padding: 10px 15px;
        font-size: 0.9em;
    }
}
/* ×¡×¨×’×œ ×¡×˜×˜×™×¡×˜×™×§×•×ª - ×¢×™×¦×•×‘ ×—×“×© */
.stats-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 260px;
    height: 100vh;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);  /* â† ×¡×’×•×œ */
    color: white;
    padding: 20px 10px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 5px 0 15px rgba(0,0,0,0.2);
}

.stats-sidebar h2 {
    color: white;
    font-size: 1.2em;
    margin-bottom: 15px;
    text-align: center;
    border-bottom: 2px solid rgba(255,255,255,0.3);
    padding-bottom: 10px;
}

/* ×˜××‘ ×¨××©×™ */
.stats-tab-section {
    margin-bottom: 8px;
}

.stats-tab-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.2);
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.stats-tab-header:hover {
    background: rgba(255,255,255,0.3);
    transform: translateX(-3px);
}

.stats-tab-header.active {
    background: rgba(52, 152, 219, 0.5);
    border-color: rgba(255,255,255,0.5);
}

.stats-tab-title {
    font-weight: bold;
    font-size: 0.95em;
    flex: 1;
}

.stats-tab-count {
    font-size: 1.3em;
    font-weight: bold;
    margin: 0 8px;
}

.stats-tab-arrow {
    font-size: 0.8em;
    transition: transform 0.3s;
}

.stats-tab-arrow.open {
    transform: rotate(180deg);
}

/* ×ª×•×›×Ÿ ×˜××‘ */
.stats-tab-content {
    padding: 5px 0 5px 10px;
    display: none;
}

.stats-tab-content.open {
    display: block;
}

/* ×¤×¨×™×˜ ×‘×˜××‘ */
.stats-category-item {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    margin: 3px 0;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
    border-right: 3px solid transparent;
}

.stats-category-item:hover {
    background: rgba(255,255,255,0.2);
    transform: translateX(-3px);
}

.stats-category-item.active {
    background: rgba(52, 152, 219, 0.5);
    border-right-color: white;
}

.stats-category-item.stats-item-warning {
    background: rgba(231, 76, 60, 0.3);
}

.stats-category-item.stats-item-warning:hover {
    background: rgba(231, 76, 60, 0.4);
}

.stats-item-icon {
    font-size: 1.1em;
    margin-left: 8px;
}

.stats-item-label {
    flex: 1;
    font-size: 0.9em;
}

.stats-item-count {
    font-weight: bold;
    font-size: 1.1em;
    margin-left: 8px;
}

.stats-sub-arrow {
    font-size: 0.8em;
    margin-right: 5px;
    transition: transform 0.3s;
}

.stats-sub-arrow.open {
    transform: rotate(90deg);
}

/* ×ª×ª-×¤×™×¨×•×˜ */
.stats-sub-content {
    display: none;
    padding-right: 15px;
    margin-top: 5px;
}

.stats-sub-content.open {
    display: block;
}

.stats-sub-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 10px;
    margin: 2px 0;
    background: rgba(255,255,255,0.05);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.2s;
}

.stats-sub-item:hover {
    background: rgba(255,255,255,0.15);
}

.stats-sub-item.active {
    background: rgba(52, 152, 219, 0.4);
}

.stats-sub-label {
    flex: 1;
}

.stats-sub-count {
    font-weight: bold;
}

/* ×˜××‘ ×¤×©×•×˜ */
.stats-tab-simple {
    background: rgba(255,255,255,0.15);
}

/* ×¡×™×›×•× */
.stats-summary {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid rgba(255,255,255,0.3);
}

.stats-summary-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.stats-summary-item strong {
    font-size: 1.2em;
}
/* ×©×•×¨×” ××ª×¨×—×‘×ª */
.expandable-row {
    cursor: pointer;
    transition: background 0.2s;
}

.expandable-row:hover {
    background: #e8f4f8 !important;
}

.detail-row {
    display: none;
    background: #f8f9fa;
    border-top: 2px solid #3498db;
}

.detail-row.open {
    display: table-row;
}

.detail-content {
    padding: 20px;
    line-height: 1.8;
}

.detail-section {
    margin-bottom: 15px;
}

.detail-section strong {
    color: #2c3e50;
    display: block;
    margin-bottom: 5px;
    font-size: 1.1em;
}

.detail-item {
    padding: 5px 0;
    padding-right: 20px;
}

.detail-item.success {
    color: #27ae60;
}

.detail-item.error {
    color: #e74c3c;
}

.expand-icon {
    display: inline-block;
    margin-left: 10px;
    transition: transform 0.3s;
    font-size: 0.8em;
}

.expand-icon.open {
    transform: rotate(180deg);
}
    </style>
</head>

<body>
  
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ××¢×¨×›×ª ×‘×§×¨×ª ×©×›×¨ - ×’×¨×¡×” ××œ××”</h1>
            <p>× ×™×ª×•×— ××¤×•×¨×˜ ×©×œ ×©×™× ×•×™×™× ×‘×ª×©×œ×•××™× ×©×•×˜×¤×™× ×¢× ×”×¡×‘×¨×™× ××•×˜×•××˜×™×™×</p>
        </div>

       <div class="section" style="padding: 15px 30px;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <button class="btn-primary" onclick="document.getElementById('fileInput').click()" style="font-size: 1.1em; padding: 15px 30px;">
            ğŸ“‚ ×˜×¢×™× ×ª × ×ª×•× ×™×
        </button>
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        
        <div id="fileNameDisplay" style="color: #7f8c8d; font-size: 0.95em;">
            ×œ× × ×‘×—×¨ ×§×•×‘×¥
        </div>
    </div>
    <div id="loadMessage" style="margin-top: 10px;"></div>
</div>

<div style="text-align: center; margin-top: 15px;">
        <button id="populationBtn" class="btn-primary" onclick="openPopulationQuery()" 
                style="background: #9b59b6;">
            ğŸ” ×¤×ª×— ××•×“×•×œ ×©×œ×™×¤×ª ××•×›×œ×•×¡×™×•×ª
        </button>
      
</div>

<div class="section hidden" id="statsSection" style="display: none !important;">
            <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalEmployees">0</div>
                    <div class="stat-label">×¡×š ×”×›×œ ×¢×•×‘×“×™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="employeesWithChange">0</div>
                    <div class="stat-label">×¢×•×‘×“×™× ×¢× ×©×™× ×•×™ ×‘×©×•×˜×£</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="explained">0</div>
                    <div class="stat-label">× ××¦× ×”×¡×‘×¨ âœ…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unexplained">0</div>
                    <div class="stat-label">×œ×œ× ×”×¡×‘×¨ âš ï¸</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
    <div class="stat-number" id="employeesWithDifferences">0</div>
    <div class="stat-label">×§×™×‘×œ×• ×”×¤×¨×©×™× ğŸ’°</div>
</div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
    <div class="stat-number" id="newEmployees">0</div>
    <div class="stat-label">×¢×•×‘×“×™× ×—×“×©×™× ğŸ†•</div>
</div>
<div class="stat-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
    <div class="stat-number" id="terminatedEmployees">0</div>
    <div class="stat-label">×¢×•×‘×“×™× ××•×¤×¡×§×™× â›”</div>
</div>
            </div>
        </div>

     <div class="section hidden" id="filtersSection" style="padding: 15px 30px;">
    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <strong style="font-size: 1.1em;">ğŸ” ×¡×™× ×•×Ÿ:</strong>
        
        <input type="text" id="filterEmployee" placeholder="××¡×¤×¨ ×¢×•×‘×“" 
               style="width: 120px; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.9em;">
        
        <select id="filterOffice" style="width: 100px; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.9em;">
            <option value="">×›×œ ×”××©×¨×“×™×</option>
        </select>

            <input type="text" id="filterGrade" placeholder="×“×™×¨×•×’" 
               style="width: 120px; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.9em;">
                <input type="text" id="filterMaamad" placeholder="××¢××“" 
               style="width: 120px; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.9em;">

        <select id="filterStatus" style="width: 120px; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.9em;">
            <option value="">×”×›×œ</option>
            <option value="GREEN">× ××¦× ×”×¡×‘×¨ âœ…</option>
            <option value="RED">×œ×œ× ×”×¡×‘×¨ âŒ</option>
        </select>
        
        <select id="filterReason" style="width: 180px; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.9em;">
            <option value="">×›×œ ×”×¡×™×‘×•×ª</option>
            <option value="NEW">×¢×•×‘×“ ×—×“×© ğŸ†•</option>
            <option value="TERMINATED">×¢×•×‘×“ ××•×¤×¡×§ â›”</option>
            <option value="PENSION">×©×™× ×•×™ ×¤× ×¡×™×•× ×™ (×›×•×œ×œ)</option>
            <option value="PENSION_RESEARCH">â”œâ”€ ×¢×“×›×•×Ÿ ×•×ª×§ - ×¢×•×‘×“×™ ××—×§×¨</option>
            <option value="PENSION_GRADE">â”œâ”€ ×©×™× ×•×™ ×“×¨×’×”/×“×™×¨×•×’</option>
            <option value="PENSION_SENIORITY">â”œâ”€ ×©×™× ×•×™ ×•×ª×§</option>
            <option value="PENSION_POSITION">â”œâ”€ ×©×™× ×•×™ ×ª×¤×§×™×“</option>
            <option value="PENSION_UNEXPLAINED">â””â”€ ×œ×œ× ×”×¡×‘×¨ × ×•×¡×£</option>
            <option value="OVERTIME">×©×¢×•×ª × ×•×¡×¤×•×ª</option>
            <option value="EXPENSES">×”×—×–×¨×™ ×”×•×¦××•×ª</option>
            <option value="ONE_TIME">×ª×©×œ×•× ×—×“ ×¤×¢××™</option>
            <option value="UNKNOWN">×œ×œ× ×”×¡×‘×¨</option>
        </select>
        
        <button class="btn-primary" onclick="applyFilters()" style="padding: 8px 20px; font-size: 0.9em;">
            ğŸ” ×¡× ×Ÿ
        </button>
        
        <button class="export-btn" onclick="exportToExcel()" style="padding: 8px 20px; font-size: 0.9em;">
            ğŸ“¥ ×™×™×¦× ×œExcel
        </button>
    </div>
</div>
       <div class="section hidden" id="resultsSection">
    <!-- ×›×•×ª×¨×ª ×¨××©×™×ª -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">ğŸ“‹ ×ª×•×¦××•×ª × ×™×ª×•×—</h2>
             <!-- ×˜××‘×™× -->
        <div class="tabs-container-inline">
            <button class="tab-btn active" onclick="switchTab('tab91090')">
                ğŸ“Š ×©×•×˜×£ (91090)
                <span class="tab-badge" id="badge91090">0</span>
            </button>          
        </div>
          <div class="tabs-container-inline">
            <button class="tab-btn active" onclick="switchTab('tab91091')">
                ğŸ“Š ×”×¤×¨×©×™× 91091 
                <span class="tab-badge" id="badge91091">0</span>
            </button>          
        </div>
    <div class="tabs-container-inline">
    <button class="tab-btn" onclick="switchTab('tabZikufim')">
        ğŸš— ×–×§×™×¤×•×ª
        <span class="tab-badge" id="badgeZikufim">0</span>
    </button>
</div>
   
    </div>

    <!-- ×ª×•×›×Ÿ ×˜××‘ 91090 -->
    <div id="tab91090" class="tab-content active">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>××¡×¤×¨ ×–×”×•×ª</th>
                         <th>××©×¨×“</th>
                        <th>×“×™×¨×•×’</th>
                        <th>××¢××“</th>
                        <th>×©×•×˜×£ × ×•×›×—×™</th>
                        <th>×©×•×˜×£ ×§×•×“×</th>
                        <th>×©×™× ×•×™</th>
                        <th>×¡×™×‘×ª ×©×™× ×•×™</th>
                  
                        <th>×¡×˜×˜×•×¡</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- ×ª×•×›×Ÿ ×˜××‘ 91091 -->
    <div id="tab91091" class="tab-content">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>××¡×¤×¨ ×–×”×•×ª</th>
                        <th>××©×¨×“</th>
                        <th>×“×™×¨×•×’</th>
                        <th>××¢××“</th>
                        <th>×¡×”"×› ×”×¤×¨×©×™×</th>

                        <th>×©×™× ×•×™</th>
                        <th>×¡×™×‘×ª ×©×™× ×•×™</th>
                        <th>×”×¡×‘×¨ ××¤×•×¨×˜</th>
                        <th>×¡×˜×˜×•×¡</th>
                    </tr>
                </thead>
                <tbody id="resultsBody91091">
                </tbody>
            </table>
        </div>
    </div>
    <!-- ×ª×•×›×Ÿ ×˜××‘ ×–×§×™×¤×•×ª -->
<div id="tabZikufim" class="tab-content">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>××¡×¤×¨ ×–×”×•×ª</th>
                    <th>××©×¨×“</th>
                    <th>×“×™×¨×•×’</th>
                    <th>××¢××“</th>
                    <th>×¡×›×•×</th>
                    <th>×¡×™×‘×ª ×©×™× ×•×™</th>
                    <th>×”×¡×‘×¨ ××¤×•×¨×˜</th>
                    <th>×¡×˜×˜×•×¡</th>
                </tr>
            </thead>
            <tbody id="resultsBodyZikufim">
            </tbody>
        </table>
    </div>
</div>
</div>
    <script>
        // ============================================
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        // ============================================
        let rawData = [];              // ×›×œ ×”× ×ª×•× ×™× ×”×’×•×œ××™×™× ××”×§×•×‘×¥
        let employeesData = {};        // × ×ª×•× ×™× ×××•×¨×’× ×™× ×œ×¤×™ ×¢×•×‘×“
        let analysisResults = [];      // ×ª×•×¦××•×ª ×”× ×™×ª×•×—
        let analysisResults91091 = [];  // ×ª×•×¦××•×ª 91091 - ×—×“×©!
        let analysisResultsZikufim = [];  // ×ª×•×¦××•×ª ×–×§×™×¤×•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª
        let currentMonth = null;
        let previousMonth = null;
        let currentSnapshotId = null;
        let previousSnapshotData = null;
        let comparisonResult = null;
        // ==================== ×”×’×“×¨×•×ª ×—×¨×™×’×™× ====================
const exceptionTypes = [
    { type: 'no_explanation', label: '×œ×œ× ×”×¡×‘×¨', icon: 'ğŸ”´' },
    { type: 'pension_unexplained', label: '×¤× ×¡×™×•× ×™ ×œ×œ× ×”×¡×‘×¨', icon: 'âš ï¸' },
    { type: 'grade_decrease', label: '×“×¨×’×”/×“×™×¨×•×’ + ×™×¨×™×“×”', icon: 'ğŸ”´' },
    { type: 'seniority_decrease', label: '×•×ª×§ + ×™×¨×™×“×”', icon: 'ğŸ”´' },
    { type: 'position_decrease', label: '×ª×¤×§×™×“ + ×™×¨×™×“×”', icon: 'âš ï¸' },
    { type: 'large_change', label: '×©×™× ×•×™ ×’×“×•×œ', icon: 'âš ï¸' },
    { type: 'payment_without_deduction', label: '×ª×©×œ×•××™× ×œ×œ× × ×™×›×•×™×™×', icon: 'âš ï¸' }
    
];

        // ============================================
        // IndexedDB - ×¤×ª×™×—×ª ××¡×“ × ×ª×•× ×™×
        // ============================================
        
      function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SalaryControlDB', 2);  // â† ×©×™× ×•×™ ×œ-2!
                
                request.onerror = () => {
                    console.error('âŒ ×©×’×™××” ×‘×¤×ª×™×—×ª DB:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    console.log('âœ… DB × ×¤×ª×— ×‘×”×¦×œ×—×”');
                    resolve(request.result);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    console.log('ğŸ”§ ×™×•×¦×¨ ×˜×‘×œ××•×ª...');
                    
                    // ×˜×‘×œ×ª Snapshots
                    if (!db.objectStoreNames.contains('snapshots')) {
                        const snapshotsStore = db.createObjectStore('snapshots', { keyPath: 'id' });
                        snapshotsStore.createIndex('salaryMonth', 'salaryMonth', { unique: false });
                        snapshotsStore.createIndex('runDate', 'runDate', { unique: false });
                        console.log('âœ… ×˜×‘×œ×ª snapshots × ×•×¦×¨×”');
                    }
                    
                    // ×˜×‘×œ×ª ×”×¢×¨×•×ª ××©×ª××©
                    if (!db.objectStoreNames.contains('userNotes')) {
                        db.createObjectStore('userNotes', { keyPath: 'key' });
                        console.log('âœ… ×˜×‘×œ×ª userNotes × ×•×¦×¨×”');
                    }
                    
                    // ×˜×‘×œ×ª ××™×©×•×¨×™×
                    if (!db.objectStoreNames.contains('approvals')) {
                        db.createObjectStore('approvals', { keyPath: 'key' });
                        console.log('âœ… ×˜×‘×œ×ª approvals × ×•×¦×¨×”');
                    }
                };
            });
        }
        
        // ============================================
        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
        // ============================================

        function showMessage(elementId, text, type) {
            document.getElementById(elementId).innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function formatCurrency(number) {
            return number.toLocaleString('he-IL', { minimumFractionDigits: 2 }) + ' â‚ª';
        }

        function formatChange(number) {
            return number.toLocaleString('he-IL', { minimumFractionDigits: 2, signDisplay: 'always' }) + ' â‚ª';
        }

        // ============================================
        // ×˜×¢×™× ×ª ×§×•×‘×¥
 document.getElementById('fileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    
    if (file) {
        document.getElementById('fileNameDisplay').innerHTML = `
            <strong style="color: #27ae60;">âœ… ${file.name}</strong>
        `;
    }
    
    if (!file) {
        showMessage('loadMessage', '×œ× × ×‘×—×¨ ×§×•×‘×¥', 'error');
        return;
    }

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        rawData = XLSX.utils.sheet_to_json(firstSheet);

        console.log(`âœ… × ×˜×¢× ×• ${rawData.length} ×¨×©×•××•×ª ×’×•×œ××™×•×ª`);

        identifyMonths();
        organizeDataByEmployee();
        analyzeData();
        updateUIAfterLoad();
        
        // ğŸ†• ×©××™×¨×” ××•×˜×•××˜×™×ª ×©×œ ×”× ×ª×•× ×™× ×”×’×•×œ××™×™×
        saveRawDataToDB();

    } catch (error) {
        console.error('âŒ ×©×’×™××”:', error);
        showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ' + error.message, 'error');
    }
});

function formatChange(number) {
            return number.toLocaleString('he-IL', { minimumFractionDigits: 2, signDisplay: 'always' }) + ' â‚ª';
        }

        // ============================================
        // IndexedDB - × ×™×”×•×œ ××¡×“ × ×ª×•× ×™×
        // ============================================
        // ============================================
        // ×–×™×”×•×™ ×—×•×“×©×™× (× ×•×›×—×™/×§×•×“×)
        // ============================================

        function identifyMonths() {
            const uniqueDates = [...new Set(rawData.map(row => row.SALARY_DATE))].sort();
            
            if (uniqueDates.length >= 2) {
                previousMonth = uniqueDates[0];
                currentMonth = uniqueDates[uniqueDates.length - 1];
            } else if (uniqueDates.length === 1) {
                currentMonth = uniqueDates[0];
                previousMonth = null;
                showMessage('loadMessage', 'âš ï¸ × ××¦× ×¨×§ ×—×•×“×© ××—×“ - ×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ×”×©×•×•××”', 'error');
            } else {
                showMessage('loadMessage', 'âŒ ×œ× × ××¦××• ×ª××¨×™×›×™× ×ª×§×™× ×™× ×‘×§×•×‘×¥', 'error');
                return;
            }

            console.log(`ğŸ“… ×—×•×“×© × ×•×›×—×™: ${currentMonth}, ×—×•×“×© ×§×•×“×: ${previousMonth}`);
        }

        // ============================================
        // ××¨×’×•×Ÿ × ×ª×•× ×™× ×œ×¤×™ ×¢×•×‘×“ - ×©××™×¨×ª ×›×œ ×”×©×“×•×ª!
        // ============================================
function organizeDataByEmployee() {
    employeesData = {};

    rawData.forEach(row => {
        const empId = row.id_num;

        // ×™×¦×™×¨×ª ×¨×©×•××ª ×¢×•×‘×“ ×× ×œ× ×§×™×™××ª
        if (!employeesData[empId]) {
            employeesData[empId] = {
                id_num: empId,
                office_num: row.OFFICE_NUM || '',
                grade: null,
                maamad: null,
                current: {
                    elements: {},
                    quantities: {},
                    percentages: {},
                    tariffs: {},
                    elementNames: {},
                    salaryDates: {},
                    referenceDates: {},
                    dateFroms: {}
                },
                previous: {
                    elements: {},
                    quantities: {},
                    percentages: {},
                    tariffs: {},
                    elementNames: {},
                    salaryDates: {},
                    referenceDates: {},
                    dateFroms: {}
                }
            };
        }

        // ×§×‘×™×¢×ª ×¡×•×’ ×—×•×“×©
        const monthType = row.SALARY_DATE === currentMonth ? 'current' : 'previous';

        // ğŸ”’ × ×¨××•×œ ××œ×× ×˜ ×œ××¡×¤×¨
        const elementNum = Number(row.SALARY_ELEMENT_NUM);

        // ×©××™×¨×ª × ×ª×•× ×™ ××œ×× ×˜×™×
        employeesData[empId][monthType].elements[elementNum] = Number(row.AMOUNT) || 0;
        employeesData[empId][monthType].quantities[elementNum] = Number(row.QUANTITY) || 0;
        employeesData[empId][monthType].percentages[elementNum] = Number(row.PERCENTAGE) || 0;
        employeesData[empId][monthType].tariffs[elementNum] = Number(row.TARIFF) || 0;
        employeesData[empId][monthType].elementNames[elementNum] = row.ELEMENT_NAME || '';
        employeesData[empId][monthType].salaryDates[elementNum] = row.SALARY_DATE || '';
        employeesData[empId][monthType].referenceDates[elementNum] = row.REFERENCE_DATE || '';
        employeesData[empId][monthType].dateFroms[elementNum] = row.DATE_FROM || '';



        // ===============================
        // ×—×™×œ×•×¥ GRADE ××ª×•×š ××œ×× ×˜ 90144
        // ===============================
        if (elementNum === 90144) {
            // × ×•×›×—×™ ×§×•×“×
          if (monthType === 'current') {
                employeesData[empId].grade = row.AMOUNT;
            }
            // fallback â€“ ×× ××™×Ÿ × ×•×›×—×™
            else if (employeesData[empId].grade == null) {
                employeesData[empId].grade = row.AMOUNT;
            }
        }
        
        // ===============================
        // ×—×™×œ×•×¥ maamad ××ª×•×š ××œ×× ×˜ 90150
        // ===============================
        if (elementNum === 90150) {
            // × ×•×›×—×™ ×§×•×“×
          if (monthType === 'current') {
                employeesData[empId].maamad = row.QUANTITY;
            }
            // fallback â€“ ×× ××™×Ÿ × ×•×›×—×™
            else if (employeesData[empId].maamad == null) {
                employeesData[empId].maamad = row.QUANTITY;
            }
        }


      });
   
    console.log(`ğŸ‘¥ ×××•×¨×’× ×™× ${Object.keys(employeesData).length} ×¢×•×‘×“×™×`);
}


        // ============================================
        // × ×™×ª×•×— × ×ª×•× ×™×
        // ============================================

    function identifyExceptions(row) {
         console.log('ğŸ” identifyExceptions ×¨×¥ ×œ×¢×•×‘×“:', row.id_num);
        const exceptions = [];
         
          // ×—×¨×™×’: ×©×™× ×•×™ ×œ× ××•×¡×‘×¨ (gap > 500)
if (row.totalChange !== undefined && row.totalExplained !== undefined) {
    const gap = Math.abs(row.totalChange - row.totalExplained);
    
    if (gap > 500) {  // â† ××•×ª×• ×”×¡×£ ×›××• ×‘×¦×“ ×©×××œ!
        exceptions.push({
            severity: 'error',
            type: 'no_explanation',
            reason: `×©×™× ×•×™ ×œ× ××•×¡×‘×¨: ×¤×¢×¨ ×©×œ ${gap.toFixed(2)} â‚ª`,
            gap: gap
        });
    }
}
        // ======================================
        // ×—×¨×™×’ 1: ×©×™× ×•×™ ×“×¨×’×”/×“×™×¨×•×’ + ×™×¨×™×“×” ×‘×©×›×¨
        // ======================================
        if (row.reason_code === 'PENSION' && 
            (row.explanation_detail.includes('×“×¨×’×”') || row.explanation_detail.includes('×“×™×¨×•×’'))) {
            if (row.change < 0) {
                exceptions.push({
                    severity: 'error',
                    type: 'grade_decrease',
                    reason: `×©×™× ×•×™ ×“×¨×’×”/×“×™×¨×•×’ ××š ×”×©×›×¨ ×™×¨×“ ×‘-${Math.abs(row.change).toFixed(2)} â‚ª`,
                    expectedIncrease: true,
                    actualDecrease: true
                });
            }
        }
        
        // ======================================
        // ×—×¨×™×’ 2: ×©×™× ×•×™ ×•×ª×§ + ×™×¨×™×“×” ×‘×©×›×¨
        // ======================================
        if (row.reason_code === 'PENSION' && row.explanation_detail.includes('×•×ª×§')) {
            if (row.change < 0) {
                exceptions.push({
                    severity: 'error',
                    type: 'seniority_decrease',
                    reason: `×©×™× ×•×™ ×•×ª×§ ××š ×”×©×›×¨ ×™×¨×“ ×‘-${Math.abs(row.change).toFixed(2)} â‚ª`,
                    expectedIncrease: true,
                    actualDecrease: true
                });
            }
        }
        
        // ======================================
        // ×—×¨×™×’ 3: ×©×™× ×•×™ ×ª×¤×§×™×“ + ×™×¨×™×“×” ×‘×©×›×¨
        // ======================================
        if (row.reason_code === 'PENSION' && row.explanation_detail.includes('×ª×¤×§×™×“')) {
            if (row.change < 0) {
                exceptions.push({
                    severity: 'warning',
                    type: 'position_decrease',
                    reason: `×©×™× ×•×™ ×ª×¤×§×™×“ ××š ×”×©×›×¨ ×™×¨×“ ×‘-${Math.abs(row.change).toFixed(2)} â‚ª`,
                    expectedIncrease: false,  // ×ª×¤×§×™×“ ×™×›×•×œ ×’× ×œ×¨×“×ª
                    actualDecrease: true
                });
            }
        }
        
               
        // ======================================
        // ×—×¨×™×’ 6: ×©×™× ×•×™ ×’×“×•×œ ×××•×“ (××¢×œ 5000 â‚ª)
        // ======================================
        if (Math.abs(row.change) > 20000) {
             console.log('ğŸ”” ×–×•×”×” ×—×¨×™×’ ×©×™× ×•×™ ×’×“×•×œ ×œ×¢×•×‘×“:', row.id_num);
            exceptions.push({
                severity: 'warning',
                type: 'large_change',
                reason: `×©×™× ×•×™ ×’×“×•×œ ×××•×“: ${row.change > 0 ? '+' : ''}${row.change.toFixed(2)} â‚ª`,
                needsVerification: true
            });
        }
        
        return exceptions;
    }

        function analyzeData() {
            analysisResults = [];

  Object.values(employeesData).forEach(employee => {
        // ×©×œ×™×¤×ª ×¡×›×•××™ ×©×•×˜×£ (91090)
        const current_91090 = employee.current.elements[91090] || 0;
        const previous_91090 = employee.previous.elements[91090] || 0;
        const change = current_91090 - previous_91090;
       const grade = employee.grade || '';
      const maamad = employee.maamad || '';

        // ======================================
        // ×–×™×”×•×™ ×¢×•×‘×“ ×—×“×© / ××•×¤×¡×§
        // ======================================
        
       // ×¢×•×‘×“ ××•×¤×¡×§: ×—×•×“×© × ×•×›×—×™ = 0
        if (current_91090 === 0 && previous_91090 > 0) {
            const result = {
                id_num: employee.id_num,
                office_num: employee.office_num,
                grade,
                 maamad,
                current_regular: 0,
                previous_regular: previous_91090,
                change: -previous_91090,
                reason_code: 'TERMINATED',
                reason_text: '×¢×•×‘×“ ××•×¤×¡×§',
                explanation_detail: '×¢×•×‘×“ ×”×•×¤×¡×§ - ××™×Ÿ ×ª×©×œ×•× ×‘×—×•×“×© × ×•×›×—×™',
                status: 'TERMINATED'
            };
            result.exceptions = [];  // ××™×Ÿ ×—×¨×™×’×™× ×œ×¢×•×‘×“ ××•×¤×¡×§
            result.hasExceptions = false;
            // ×–×™×”×•×™ ×—×¨×™×’×™×
            analysisResults.push(result);
            return;
        }

        // ×¢×•×‘×“ ×—×“×©: ×—×•×“×© ×§×•×“× = 0
        if (previous_91090 === 0 && current_91090 > 0) {
            const result = {
                id_num: employee.id_num,
                office_num: employee.office_num,
                grade,
    maamad,
                current_regular: current_91090,
                previous_regular: 0,
                change: current_91090,
                reason_code: 'NEW',
                reason_text: '×¢×•×‘×“ ×—×“×©',
                explanation_detail: '×¢×•×‘×“ ×—×“×© - ×œ× ×”×™×” ×ª×©×œ×•× ×‘×—×•×“×© ×§×•×“×',
                status: 'NEW'
            };
            result.exceptions = [];  // ××™×Ÿ ×—×¨×™×’×™× ×œ×¢×•×‘×“ ×—×“×©
            result.hasExceptions = false;
            analysisResults.push(result);
            return;
        }
                // × ×™×ª×•×— ×¨×§ ×× ×™×© ×©×™× ×•×™
                if (Math.abs(change) > 500) {
                    // ××¦×™××ª ×”×¡×‘×¨ ×œ×©×™× ×•×™ - ×¤×•× ×§×¦×™×” × ×¤×¨×“×ª!
                    const explanation = findExplanation(employee);
             
                    const result = {
                        id_num: employee.id_num,
                        office_num: employee.office_num,
                         grade: employee.grade,
                         maamad: employee.maamad,
                        current_regular: current_91090,
                        previous_regular: previous_91090,
                        change: change,
                        reason_code: explanation.code,
                        reason_text: explanation.text,
                        explanation_detail: explanation.detail,
                        status: explanation.status,
                       categories: explanation.categories || [],
    explanations: explanation.explanations || [],      // â† ğŸ¯ ×”×•×¡×™×¤×™!
    totalExplained: explanation.totalExplained || 0,   // â† ğŸ¯ ×”×•×¡×™×¤×™!
    totalChange: explanation.totalChange || 0,
   subCategory_oneTime: getOneTimePaymentSubCategory(employee) 
 
                    };
                    
                    // ×–×™×”×•×™ ×—×¨×™×’×™× - ×›××Ÿ!
                    result.exceptions = identifyExceptions(result);
                    result.hasExceptions = result.exceptions.length > 0;
                    
                    analysisResults.push(result);
                }
            });

       
        console.log(`ğŸ” × ××¦××• ${analysisResults.length} ×¢×•×‘×“×™× ×¢× ×©×™× ×•×™ ×‘×©×•×˜×£`);
        const withExceptions = analysisResults.filter(r => r.hasExceptions).length;
        console.log(`âš ï¸ ××ª×•×›× ${withExceptions} ×¢× ×—×¨×™×’×™×`);
    } 

function analyzeData91091() {
    analysisResults91091 = [];

    Object.values(employeesData).forEach(employee => {
        const empId = employee.id_num;
        
        // ×—×¤×© ×¨×©×•××•×ª 91091 ×‘×—×•×“×© ×”× ×•×›×—×™
        const retro91091Records = rawData.filter(row => 
            row.id_num === empId && 
            row.SALARY_ELEMENT_NUM === 91091 &&
            row.SALARY_DATE === currentMonth
        );
        
        // ×¡×›×•× ×›×œ ×”×¨×©×•××•×ª
        const current_91091 = retro91091Records.reduce((sum, r) => sum + (r.AMOUNT || 0), 0);
        
        console.log(`ğŸ’° ×¢×•×‘×“ ${empId}: ${retro91091Records.length} ×¨×©×•××•×ª 91091, ×¡×”"×›: ${current_91091}`);
        
        // âœ… ×¨×§ ×¢×•×‘×“×™× ×¢× ×”×¤×¨×©×™× > 300
        if (Math.abs(current_91091) > 300) {
            
            // × ×™×ª×•×— ×œ××” ×§×™×‘×œ ×”×¤×¨×©×™×
            const explanation = findExplanation91091(employee);
            
            const result = {
                id_num: employee.id_num,
                office_num: employee.office_num,
                 grade: employee.current?.grade || employee.grade || '-',
                 maamad: employee.current?.maamad || employee.maamad || '-',
                current_regular: current_91091,
                previous_regular: 0,
                change: current_91091,
                reason_code: explanation.code,
                reason_text: explanation.text,
                explanation_detail: explanation.detail,
                status: explanation.status
            };
            
            result.exceptions = identifyExceptions(result);
            result.hasExceptions = result.exceptions.length > 0;
            
            analysisResults91091.push(result);
        }
    });

    console.log(`ğŸ’° × ××¦××• ${analysisResults91091.length} ×¢×•×‘×“×™× ×¢× ×”×¤×¨×©×™×`);
    const withExceptions = analysisResults91091.filter(r => r.hasExceptions).length;
    console.log(`âš ï¸ ××ª×•×›× ${withExceptions} ×¢× ×—×¨×™×’×™×`);
}

function analyzeDataZikufim() {
    analysisResultsZikufim = [];
    
    Object.values(employeesData).forEach(employee => {
        const empId = employee.id_num;
        
        // ×—×¤×© ×¨×©×•××•×ª 91403 (×©×•×•×™ ×¨×›×‘) ×¨×˜×¨×•××§×˜×™×‘×™×•×ª
        const vehicleRetroRecords = rawData.filter(row => 
            row.id_num === empId && 
            row.SALARY_ELEMENT_NUM === 91403 &&
            row.SALARY_DATE === currentMonth &&
            row.REFERENCE_DATE !== currentMonth &&
            row.REFERENCE_DATE !== '' &&
            row.REFERENCE_DATE !== null
        );
        
        if (vehicleRetroRecords.length > 0) {
            const totalAmount = vehicleRetroRecords.reduce((sum, r) => sum + (r.QUANTITY || 0), 0);
            const months = [...new Set(vehicleRetroRecords.map(r => r.REFERENCE_DATE))].length;
            
            if (Math.abs(totalAmount) > 300) {
                analysisResultsZikufim.push({
                    id_num: empId,
                    office_num: employee.office_num,
                    grade: employee.current?.grade || employee.grade || '-',
                    maamad: employee.current?.maamad || employee.maamad || '-',
                    current_regular: totalAmount,
                    previous_regular: 0,
                    change: totalAmount,
                    reason_code: 'ZIKUF_VEHICLE',
                    reason_text: '×”×¤×¨×©×™ ×–×§×™×¤×” - ×©×•×•×™ ×¨×›×‘',
                    explanation_detail: `×”×¤×¨×©×™ ×©×•×•×™ ×¨×›×‘ ×œ-${months} ×—×•×“×©×™× (×¡××œ 91403) ğŸš—`,
                    status: 'GREEN',
                    exceptions: [],
                    hasExceptions: false
                });
            }
        }
    });
    
    console.log(`ğŸš— × ××¦××• ${analysisResultsZikufim.length} ×¢×•×‘×“×™× ×¢× ×”×¤×¨×©×™ ×–×§×™×¤×•×ª`);
}
// ============================================
// × ×™×ª×•×— ×ª×©×œ×•××™× ×—×“ ×¤×¢××™×™× ×©× ×›×œ×œ×™× ×‘×¤× ×¡×™×”
// ============================================

function analyzePensionOneTime(employee) {
    const empId = employee.id_num;
    
    // ğŸ¯ ×¨×©×™××” ×©×œ QUANTITY ×©× ×›×œ×œ×™× ×‘×‘×¨×•×˜×• ×¤× ×¡×™×”
    const PENSION_ONE_TIME_SYMBOLS = [
        1360,  // ××¢× ×§ ×™×•×‘×œ (×¤× ×¡×™×•× ×™)
        1342   // ×”×‘×¨××” (×¤× ×¡×™×•× ×™)
        // ×ª×•×›×œ×™ ×œ×”×•×¡×™×£ ×¢×•×“ ×¡××œ×™× ×›××Ÿ
    ];
    
    console.log(`ğŸ” ×‘×•×“×§ ×ª×©×œ×•××™× ×—×“ ×¤×¢××™×™× ×¤× ×¡×™×•× ×™×™× ×œ×¢×•×‘×“ ${empId}...`);
    
    // =========================================
    // ×‘×“×™×§×ª ×—×•×“×© × ×•×›×—×™
    // =========================================
    const currentRecords = rawData.filter(row => 
        row.id_num === empId && 
        row.SALARY_ELEMENT_NUM === 91013 &&
        row.SALARY_DATE === currentMonth &&
        row.REFERENCE_DATE === currentMonth
    );
    
    let currentTotal = 0;
    const currentDetails = [];
    
    currentRecords.forEach(record => {
        const quantity = record.QUANTITY || 0;
        const amount = record.AMOUNT || 0;
        
        if (PENSION_ONE_TIME_SYMBOLS.includes(quantity)) {
            currentTotal += amount;
            
            let symbolName = '';
            if (quantity === 1360) symbolName = ' ××¢× ×§ ×™×•×‘×œ';
            else if (quantity === 1342) symbolName = '×”×‘×¨××”';
            else symbolName = `×¡××œ ${quantity}`;
            
            currentDetails.push(`${symbolName}: ${amount.toFixed(2)} â‚ª`);
            console.log(`  âœ“ ×—×•×“×© × ×•×›×—×™ - ${symbolName} (${quantity}): ${amount.toFixed(2)} â‚ª`);
        }
    });
    
    // =========================================
    // ×‘×“×™×§×ª ×—×•×“×© ×§×•×“×
    // =========================================
    const previousRecords = rawData.filter(row => 
        row.id_num === empId && 
        row.SALARY_ELEMENT_NUM === 91013 &&
        row.SALARY_DATE === previousMonth &&
        row.REFERENCE_DATE === previousMonth
    );
    
    let previousTotal = 0;
    const previousDetails = [];
    
    previousRecords.forEach(record => {
        const quantity = record.QUANTITY || 0;
        const amount = record.AMOUNT || 0;
        
        if (PENSION_ONE_TIME_SYMBOLS.includes(quantity)) {
            previousTotal += amount;
            
            let symbolName = '';
            if (quantity === 1360) symbolName = ' ××¢× ×§ ×™×•×‘×œ';
            else if (quantity === 1342) symbolName = '×”×‘×¨××”';
            else symbolName = `×¡××œ ${quantity}`;
            
            previousDetails.push(`${symbolName}: ${amount.toFixed(2)} â‚ª`);
            console.log(`  âœ“ ×—×•×“×© ×§×•×“× - ${symbolName} (${quantity}): ${amount.toFixed(2)} â‚ª`);
        }
    });
    
    // =========================================
    // ×—×™×©×•×‘ ×”×©×™× ×•×™ ×‘×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™
    // =========================================
    const diff = currentTotal - previousTotal;
    
    console.log(`  ğŸ“Š ×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™ × ×•×›×—×™: ${currentTotal.toFixed(2)} â‚ª`);
    console.log(`  ğŸ“Š ×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™ ×§×•×“×: ${previousTotal.toFixed(2)} â‚ª`);
    console.log(`  ğŸ’° ×©×™× ×•×™ ×‘×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™: ${diff.toFixed(2)} â‚ª`);
    
    return {
        current: currentTotal,
        previous: previousTotal,
        diff: diff,  // â† ×–×” ××” ×©×¦×¨×™×š ×œ×”×¤×—×™×ª!
        currentDetails: currentDetails,
        previousDetails: previousDetails
    };
}
// ============================================
// × ×™×ª×•×— ×ª×©×œ×•××™× ×—×“ ×¤×¢××™×™× ×©× ×›×œ×œ×™× ×‘×”×•×¦××•×ª
// ============================================

function analyzeExpensesOneTime(employee) {
    const empId = employee.id_num;
    
    // ğŸ¯ ×¨×©×™××” ×©×œ QUANTITY ×©× ×›×œ×œ×™× ×‘×”×—×–×¨×™ ×”×•×¦××•×ª (4717)
    const EXPENSES_ONE_TIME_SYMBOLS = [
        1491,  // ×‘×™×˜×•×— ×¨×›×‘ (×”×•×¦××•×ª)
        1492,  // ×‘×™×˜×•×— ×¨×›×‘ (×”×•×¦××•×ª)
        1493   // ×‘×™×˜×•×— ×¨×›×‘ (×”×•×¦××•×ª)
    ];
    
    console.log(`ğŸ” ×‘×•×“×§ ×ª×©×œ×•××™× ×—×“ ×¤×¢××™×™× ×‘×”×•×¦××•×ª ×œ×¢×•×‘×“ ${empId}...`);
    
    // =========================================
    // ×‘×“×™×§×ª ×—×•×“×© × ×•×›×—×™
    // =========================================
    const currentRecords = rawData.filter(row => 
        row.id_num === empId && 
        row.SALARY_ELEMENT_NUM === 91013 &&
        row.SALARY_DATE === currentMonth &&
        row.REFERENCE_DATE === currentMonth
    );
    
    let currentTotal = 0;
    const currentDetails = [];
    
    currentRecords.forEach(record => {
        const quantity = record.QUANTITY || 0;
        const amount = record.AMOUNT || 0;
        
        if (EXPENSES_ONE_TIME_SYMBOLS.includes(quantity)) {
            currentTotal += amount;
            
            let symbolName = `×‘×™×˜×•×— ×¨×›×‘ (${quantity})`;
            
            currentDetails.push(`${symbolName}: ${amount.toFixed(2)} â‚ª`);
            console.log(`  âœ“ ×—×•×“×© × ×•×›×—×™ - ${symbolName}: ${amount.toFixed(2)} â‚ª`);
        }
    });
    
    // =========================================
    // ×‘×“×™×§×ª ×—×•×“×© ×§×•×“×
    // =========================================
    let previousTotal = 0;
    const previousDetails = [];
    
    if (previousMonth && previousMonth !== null) {
        const previousRecords = rawData.filter(row => 
            row.id_num === empId && 
            row.SALARY_ELEMENT_NUM === 91013 &&
            row.SALARY_DATE === previousMonth &&
            row.REFERENCE_DATE === previousMonth
        );
        
        previousRecords.forEach(record => {
            const quantity = record.QUANTITY || 0;
            const amount = record.AMOUNT || 0;
            
            if (EXPENSES_ONE_TIME_SYMBOLS.includes(quantity)) {
                previousTotal += amount;
                
                let symbolName = `×‘×™×˜×•×— ×¨×›×‘ (${quantity})`;
                
                previousDetails.push(`${symbolName}: ${amount.toFixed(2)} â‚ª`);
                console.log(`  âœ“ ×—×•×“×© ×§×•×“× - ${symbolName}: ${amount.toFixed(2)} â‚ª`);
            }
        });
    } else {
        console.log(`  â„¹ï¸ ××™×Ÿ ×—×•×“×© ×§×•×“× - ××“×œ×’×™× ×¢×œ ×‘×“×™×§×”`);
    }
    
    // =========================================
    // ×—×™×©×•×‘ ×”×©×™× ×•×™ ×‘×—×“ ×¤×¢××™ ×”×•×¦××•×ª
    // =========================================
    const diff = currentTotal - previousTotal;
    
    console.log(`  ğŸ“Š ×—×“ ×¤×¢××™ ×”×•×¦××•×ª × ×•×›×—×™: ${currentTotal.toFixed(2)} â‚ª`);
    console.log(`  ğŸ“Š ×—×“ ×¤×¢××™ ×”×•×¦××•×ª ×§×•×“×: ${previousTotal.toFixed(2)} â‚ª`);
    console.log(`  ğŸ’° ×©×™× ×•×™ ×‘×—×“ ×¤×¢××™ ×”×•×¦××•×ª: ${diff.toFixed(2)} â‚ª`);
    
    return {
        current: currentTotal,
        previous: previousTotal,
        diff: diff,
        currentDetails: currentDetails,
        previousDetails: previousDetails
    };
}
function analyzeOneTimePayments(employee) {
    const empId = employee.id_num;
    
    // ××¦×™××ª ×›×œ ×”×¨×©×•××•×ª ×©×œ 91013 ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”
    // ×¨×§ ×ª×©×œ×•××™× ×©×•×˜×¤×™×: SALARY_DATE = REFERENCE_DATE
    const emp91013Records = rawData.filter(row => 
        row.id_num === empId && 
        row.SALARY_ELEMENT_NUM === 91013 &&
        row.SALARY_DATE === row.REFERENCE_DATE
    );
    
    console.log(`ğŸ” ×¢×•×‘×“ ${empId}: × ××¦××• ${emp91013Records.length} ×¨×©×•××•×ª 91013 ×©×•×˜×¤×•×ª`);
    
    if (emp91013Records.length === 0) {
        return '×ª×©×œ×•× ×—×“ ×¤×¢××™ - ×œ× × ××¦××• ×ª×©×œ×•××™× ×©×•×˜×¤×™×';
    }
    
    // ×§×™×‘×•×¥ ×œ×¤×™ ×—×•×“×© ×¢×¨×š (REFERENCE_DATE)
    const byReferenceDate = {};
    
    emp91013Records.forEach(record => {
        const refDate = record.REFERENCE_DATE || '';
        const quantity = record.QUANTITY || 0;
        const amount = record.AMOUNT || 0;
        
        console.log(`  ğŸ“Œ QUANTITY=${quantity}, AMOUNT=${amount}, REF_DATE=${refDate}`);
        
        // ×”×ª×¢×œ× ××¡××œ×™× 8000-9000
       // if (quantity >= 8000 && quantity <= 9000) {
            //console.log(`  â­ï¸  ××ª×¢×œ× ××¡××œ ${quantity} (×˜×•×•×— 8000-9000)`);
           // return;
      //  }
        
        if (!byReferenceDate[refDate]) {
            byReferenceDate[refDate] = {
                carInsurance: { symbols: [], total: 0 },
                health: { symbols: [], total: 0 },
                clothing: { symbols: [], total: 0 },
                other: { symbols: [], total: 0 }
            };
        }
        
        // ×¡×™×•×•×’ ×œ×¤×™ QUANTITY
        if ([1491, 1492, 1493, 8007].includes(quantity)) {
            byReferenceDate[refDate].carInsurance.symbols.push(quantity);
            byReferenceDate[refDate].carInsurance.total += amount;
            console.log(`  ğŸš— ×‘×™×˜×•×— ×¨×›×‘: +${amount}`);
        } else if (quantity === 1342) {
            byReferenceDate[refDate].health.symbols.push(quantity);
            byReferenceDate[refDate].health.total += amount;
            console.log(`  ğŸ’Š ×”×‘×¨××”: +${amount}`);
        } else if (quantity === 1320) {
            byReferenceDate[refDate].clothing.symbols.push(quantity);
            byReferenceDate[refDate].clothing.total += amount;
            console.log(`  ğŸ‘” ×‘×™×’×•×“: +${amount}`);
             } else if (quantity === 1360) {
            byReferenceDate[refDate].clothing.symbols.push(quantity);
            byReferenceDate[refDate].clothing.total += amount;
            console.log(`  ğŸ‘” ××¢× ×§ ×™×•×‘×œ: +${amount}`);
        } else {
            byReferenceDate[refDate].other.symbols.push(quantity);
            byReferenceDate[refDate].other.total += amount;
            console.log(`  â“ ××—×¨ (${quantity}): +${amount}`);
        }
    });
    
    // ×‘× ×™×™×ª ×”×¡×‘×¨
    const explanations = [];
    
    Object.keys(byReferenceDate).sort().forEach(refDate => {
        const data = byReferenceDate[refDate];
        
        // ×‘×™×˜×•×— ×¨×›×‘
        if (data.carInsurance.total > 0) {
            explanations.push(
                `×‘×™×˜×•×— ×¨×›×‘ - ${data.carInsurance.total.toFixed(2)} â‚ª (×¡××œ×™×: ${data.carInsurance.symbols.join(', ')})`
            );
        }
        
        // ×”×‘×¨××”
        if (data.health.total > 0) {
            explanations.push(
                `×”×‘×¨××” - ${data.health.total.toFixed(2)} â‚ª`
            );
        }
        
        // ×‘×™×’×•×“
        if (data.clothing.total > 0) {
            explanations.push(
                `×‘×™×’×•×“ - ${data.clothing.total.toFixed(2)} â‚ª`
            );
        }
        // ××¢× ×§ ×™×•×‘×œ
        if (data.clothing.total > 0) {
            explanations.push(
                `××¢× ×§ ×™×•×‘×œ - ${data.clothing.total.toFixed(2)} â‚ª`
            );
        }
        
        // ××—×¨
        if (data.other.symbols.length > 0) {
            const uniqueSymbols = [...new Set(data.other.symbols)];
            uniqueSymbols.forEach(sym => {
                explanations.push(`×ª×©×œ×•× ×—×“ ×¤×¢××™ - ×¡××œ ${sym}`);
            });
        }
    });
    
    const result = explanations.length > 0 ? explanations.join(' | ') : '×ª×©×œ×•× ×—×“ ×¤×¢××™ - ×œ× ×–×•×”×”';
    console.log(`  âœ… ×”×¡×‘×¨ ×¡×•×¤×™: ${result}`);
    
    return result;
}

// ============================================
// ×¤×•× ×§×¦×™×” ×—×“×©×”: ×—×œ×•×§×” ×œ×ª×ª-×§×˜×’×•×¨×™×•×ª ×©×œ ×ª×©×œ×•××™× ×—×“-×¤×¢××™×™×
// ============================================

function getOneTimePaymentSubCategory(employee) {
    const empId = employee.id_num;
    
    // ××¦×™××ª ×›×œ ×”×¨×©×•××•×ª ×©×œ 91013 ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”
    const emp91013Records = rawData.filter(row => 
        row.id_num === empId && 
        row.SALARY_ELEMENT_NUM === 91013 &&
        row.SALARY_DATE === row.REFERENCE_DATE
    );
    
    if (emp91013Records.length === 0) {
        return null;  // ××™×Ÿ ×ª×©×œ×•××™× ×—×“-×¤×¢××™×™×
    }
    
    // ×¡×™×•×•×’ ×œ×¤×™ QUANTITY - ××¦× ××ª ×”×ª×ª-×§×˜×’×•×¨×™×” ×”×¨××©×•× ×™×ª
    let primarySubCategory = null;
    
    for (let record of emp91013Records) {
        const quantity = record.QUANTITY || 0;
        
        // ×¡×“×¨ ×¢×“×™×¤×•×™×•×ª:
        if ([1491, 1492, 1493, 8007].includes(quantity)) {
            primarySubCategory = 'VEHICLE';
            break;  // â† ×¢×¦×•×¨ ×‘×¨××©×•×Ÿ ×©××•×¦×
        } else if (quantity === 1342) {
            primarySubCategory = 'HEALTH';
            break;
        } else if (quantity === 1360) {
            primarySubCategory = 'JUBILEE';
            break;
        } else if (quantity === 1320) {
            primarySubCategory = 'CLOTHING';
            break;
        }
    }
    
    // ×× ×œ× × ××¦×, ×”×—×–×¨ OTHER
    return primarySubCategory || 'OTHER';
}
function findExplanation(employee) {
    const current = employee.current.elements;
    const previous = employee.previous.elements;
    const currentQty = employee.current.quantities;
    const previousQty = employee.previous.quantities;
    
    const totalChange = (current[91090] || 0) - (previous[91090] || 0);
    
    console.log(`ğŸ” ×¢×•×‘×“ ${employee.id_num}: ×©×™× ×•×™ ×›×•×œ×œ = ${totalChange.toFixed(2)}`);
         // ğŸ¯ ×—×©×‘ ××ª ×”×ª×©×œ×•××™× ×”×—×“ ×¤×¢××™×™× ×¤×¢× ××—×ª ×‘×”×ª×—×œ×”!
const pensionOneTime = analyzePensionOneTime(employee);
const expensesOneTime = analyzeExpensesOneTime(employee);
// ğŸ¯ ×”×’×“×¨×ª ×‘×¨×•×˜×• ×¤× ×¡×™×” - ×™×™×¢×©×” ×—×™×©×•×‘ ×××™×ª×™ ×¨×§ ×× ×™×© ×©×™× ×•×™ ×ª×¢×¨×™×£
let adjustedBrutoDiff = 0;  // â† ×”×•×¡×£ ××ª ×–×”! âœ…
// ğŸ¯ ×—×™×©×•×‘ 91013 - ×›×œ ×”×ª×©×œ×•××™× ×”×©×•×˜×¤×™× (×œ× ×¨×˜×¨×•)!
const current_91013_all = rawData
    .filter(r => 
        r.id_num === employee.id_num && 
        r.SALARY_ELEMENT_NUM === 91013 && 
        r.SALARY_DATE === currentMonth &&
        r.REFERENCE_DATE === currentMonth  // â† ×©×•×˜×£ ×‘×œ×‘×“!
    )
    .reduce((sum, r) => sum + (r.AMOUNT || 0), 0);

const previous_91013_all = rawData
    .filter(r => 
        r.id_num === employee.id_num && 
        r.SALARY_ELEMENT_NUM === 91013 && 
        r.SALARY_DATE === previousMonth &&
        r.REFERENCE_DATE === previousMonth  // â† ×©×•×˜×£ ×‘×œ×‘×“!
    )
    .reduce((sum, r) => sum + (r.AMOUNT || 0), 0);

console.log(`ğŸ“Š 91013 × ×•×›×—×™ (×›×•×œ×œ): ${current_91013_all.toFixed(2)} â‚ª`);
console.log(`ğŸ“Š 91013 ×§×•×“× (×›×•×œ×œ): ${previous_91013_all.toFixed(2)} â‚ª`);
    
    // ğŸ¯ ××¢×¨×š ×œ××™×¡×•×£ ×›×œ ×”×”×¡×‘×¨×™×
    let foundExplanations = [];
    let totalExplained = 0;
 
    
    // ======================================
    // ×‘×“×™×§×” 1: ×©×™× ×•×™ ×‘×ª×¢×¨×™×£ ××¡×œ (91203)
    // ======================================
    
    const current_91203_salaryDate = employee.current.salaryDates[91203] || '';
    const current_91203_refDate = employee.current.referenceDates[91203] || '';
    const isCurrentRegular = current_91203_salaryDate === current_91203_refDate && current_91203_salaryDate !== '';
    
    const previous_91203_salaryDate = employee.previous.salaryDates[91203] || '';
    const previous_91203_refDate = employee.previous.referenceDates[91203] || '';
    const isPreviousRegular = previous_91203_salaryDate === previous_91203_refDate && previous_91203_salaryDate !== '';
    
    const current_91203 = isCurrentRegular ? (employee.current.tariffs[91203] || 0) : 0;
    const previous_91203 = isPreviousRegular ? (employee.previous.tariffs[91203] || 0) : 0;
    
    if (isCurrentRegular && isPreviousRegular && Math.abs(current_91203 - previous_91203) > 0.01) {
        
        // ×©×œ×™×¤×ª ×‘×¨×•×˜×• ×¤× ×¡×™×” (91025)
        const current_91025_salaryDate = employee.current.salaryDates[91025] || '';
        const current_91025_refDate = employee.current.referenceDates[91025] || '';
        const isCurrent91025Regular = current_91025_salaryDate === current_91025_refDate && current_91025_salaryDate !== '';
        
        const previous_91025_salaryDate = employee.previous.salaryDates[91025] || '';
        const previous_91025_refDate = employee.previous.referenceDates[91025] || '';
        const isPrevious91025Regular = previous_91025_salaryDate === previous_91025_refDate && previous_91025_salaryDate !== '';
        
        const current_91025 = isCurrent91025Regular ? (current[91025] || 0) : 0;
        const previous_91025 = isPrevious91025Regular ? (previous[91025] || 0) : 0;
        const bruto_diff = current_91025 - previous_91025;
        
// ğŸ¯ ×‘×“×™×§×ª ×ª×©×œ×•××™× ×—×“ ×¤×¢××™×™× ×©× ×›×œ×œ×™× ×‘×¤× ×¡×™×”
adjustedBrutoDiff = bruto_diff - pensionOneTime.diff;  // â† ×”×•×¡×£ ××ª ×–×”!

console.log(`  ğŸ“Š ×‘×¨×•×˜×• ×¤× ×¡×™×” ×’×•×œ××™: ${bruto_diff.toFixed(2)} â‚ª`);
if (pensionOneTime.diff !== 0) {
    console.log(`  â– ×©×™× ×•×™ ×‘×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™: ${pensionOneTime.diff.toFixed(2)} â‚ª`);
    if (pensionOneTime.current > 0) {
        console.log(`     â€¢ × ×•×›×—×™: ${pensionOneTime.current.toFixed(2)} â‚ª (${pensionOneTime.currentDetails.join(', ')})`);
    }
    if (pensionOneTime.previous > 0) {
        console.log(`     â€¢ ×§×•×“×: ${pensionOneTime.previous.toFixed(2)} â‚ª (${pensionOneTime.previousDetails.join(', ')})`);
    }
    console.log(`  âœ… ×‘×¨×•×˜×• ×¤× ×¡×™×” ××ª×•×§×Ÿ: ${adjustedBrutoDiff.toFixed(2)} â‚ª`);
}
        // ğŸ¯ ××¢×¨×š ×œ××™×¡×•×£ ×¡×•×’×™ ×”×©×™× ×•×™×™× ×”×¤× ×¡×™×•× ×™×™×
        let pensionTypes = [];
        
        // ×‘×“×™×§×ª 90144 - ×“×¨×’×”/×”×™×¨×•×’
        const current_90144_amt = current[90144] || 0;
        const previous_90144_amt = previous[90144] || 0;
        const current_90144_qty = currentQty[90144] || 0;
        const previous_90144_qty = previousQty[90144] || 0;
        
        if (Math.abs(current_90144_amt - previous_90144_amt) > 0.01 || current_90144_qty !== previous_90144_qty) {
            pensionTypes.push({
                code: 'PENSION_GRADE',
                text: '×“×¨×’×”/×”×™×¨×•×’',
                detail: `×-${previous_90144_qty} ×œ-${current_90144_qty}`
            });
        }
        
        // ×‘×“×™×§×ª 90146 - ×•×ª×§
        const current_90146_amt = current[90146] || 0;
        const previous_90146_amt = previous[90146] || 0;
        const current_90146_qty = currentQty[90146] || 0;
        const previous_90146_qty = previousQty[90146] || 0;

        if (current_90146_qty !== previous_90146_qty && (current_90146_amt > 0 || previous_90146_amt > 0)) {
            pensionTypes.push({
                code: 'PENSION_SENIORITY',
                text: '×•×ª×§',
                detail: `×-${previous_90146_qty} ×œ-${current_90146_qty}`
            });
        }
        
        // ×‘×“×™×§×ª 1507 - ×ª×¤×§×™×“
        const current_1507_salaryDate = employee.current.salaryDates[1507] || '';
        const current_1507_refDate = employee.current.referenceDates[1507] || '';
        const isCurrent1507Regular = current_1507_salaryDate === current_1507_refDate && current_1507_salaryDate !== '';
        
        const previous_1507_salaryDate = employee.previous.salaryDates[1507] || '';
        const previous_1507_refDate = employee.previous.referenceDates[1507] || '';
        const isPrevious1507Regular = previous_1507_salaryDate === previous_1507_refDate && previous_1507_salaryDate !== '';
        
        const current_1507_qty = isCurrent1507Regular ? (currentQty[1507] || 0) : 0;
        const previous_1507_qty = isPrevious1507Regular ? (previousQty[1507] || 0) : 0;
        
        if ((isCurrent1507Regular || isPrevious1507Regular) && current_1507_qty !== previous_1507_qty) {
            pensionTypes.push({
                code: 'PENSION_POSITION',
                text: '×ª×¤×§×™×“',
                detail: `×-${previous_1507_qty} ×œ-${current_1507_qty}`
            });
        }
  // ======================================
// ×‘×“×™×§×ª 90150 - ××¢××“ ×ª×¢×¡×•×§×ª×™  â† ×”×•×¡×™×¤×™ ××ª ×–×”!
// ======================================

const current_90150_salaryDate = employee.current.salaryDates[90150] || '';
const current_90150_refDate = employee.current.referenceDates[90150] || '';
const isCurrent90150Regular = current_90150_salaryDate === current_90150_refDate && current_90150_salaryDate !== '';

const previous_90150_salaryDate = employee.previous.salaryDates[90150] || '';
const previous_90150_refDate = employee.previous.referenceDates[90150] || '';
const isPrevious90150Regular = previous_90150_salaryDate === previous_90150_refDate && previous_90150_salaryDate !== '';

const current_90150_qty = isCurrent90150Regular ? (currentQty[90150] || 0) : 0;
const previous_90150_qty = isPrevious90150Regular ? (previousQty[90150] || 0) : 0;

if ((isCurrent90150Regular || isPrevious90150Regular) && current_90150_qty !== previous_90150_qty) {
    pensionTypes.push({
        code: 'PENSION_STATUS',  // â† ×”×§×•×“ ×”×—×“×©!
        text: '××¢××“ ×ª×¢×¡×•×§×ª×™',
        detail: `×-${previous_90150_qty} ×œ-${current_90150_qty}`
    });
}
        
        // ×‘×“×™×§×” ××™×•×—×“×ª: ×¢×•×‘×“×™ ××—×§×¨
        const current_research_90144 = rawData.find(r => 
            r.id_num === employee.id_num &&
            r.SALARY_ELEMENT_NUM === 90144 && 
            r.AMOUNT === 43 &&
            r.SALARY_DATE === currentMonth &&
            r.REFERENCE_DATE === currentMonth
        );

        const previous_research_90144 = rawData.find(r => 
            r.id_num === employee.id_num &&
            r.SALARY_ELEMENT_NUM === 90144 && 
            r.AMOUNT === 43 &&
            r.SALARY_DATE === previousMonth &&
            r.REFERENCE_DATE === previousMonth
        );

        if (current_research_90144 && previous_research_90144) {
            const currentGrade = current_research_90144.QUANTITY;
            const previousGrade = previous_research_90144.QUANTITY;
            
            if (currentGrade === previousGrade) {
                const dateFrom = employee.current.dateFroms[90144];
                
                if (dateFrom) {
                    const dateFromObj = new Date((dateFrom - 25569) * 86400 * 1000);
                    const currentMonthObj = new Date((currentMonth - 25569) * 86400 * 1000);
                    
                    if (dateFromObj.getMonth() === currentMonthObj.getMonth()) {
                        pensionTypes.push({
                            code: 'PENSION_RESEARCH',
                            text: '×¢×•×‘×“×™ ××—×§×¨',
                            detail: `×‘×“×¨×’×” ${currentGrade}`
                        });
                    }
                }
            }
        }
        
        // ğŸ¯ ×× × ××¦××• ×©×™× ×•×™×™× ×¤× ×¡×™×•× ×™×™× - ×”×•×¡×£ ×¤×¢× ××—×ª ×‘×œ×‘×“!
        if (pensionTypes.length > 0) {
            let pensionDetail = pensionTypes.map(p => p.text + ': ' + p.detail).join(', ');
            
            // â† ×”×•×¡×¤×ª ×¤×™×¨×•×˜ ×× ×™×© ×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™
            if (pensionOneTime.current > 0 || pensionOneTime.previous > 0) {  // â† ×”×–×—×” ×ª×•×§× ×”!
                let details = [];
                if (pensionOneTime.current > 0) {
                    details.push(`× ×•×›×—×™: ${pensionOneTime.currentDetails.join(', ')}`);
                }
                if (pensionOneTime.previous > 0) {
                    details.push(`×§×•×“×: ${pensionOneTime.previousDetails.join(', ')}`);
                }
                pensionDetail += ` | ×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™: ${details.join(' | ')}`;
            }
            
            foundExplanations.push({
                code: 'PENSION',
                text: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™',
                detail: pensionDetail,
                amount: adjustedBrutoDiff,  // â† ××©×ª××©×™× ×‘××ª×•×§×Ÿ!
                subCategories: pensionTypes.map(p => p.code)
            });
            
            totalExplained += adjustedBrutoDiff;  // â† ×’× ×›××Ÿ ××ª×•×§×Ÿ!
            console.log(`   âœ“ ×¤× ×¡×™×•× ×™: ${pensionDetail} (${adjustedBrutoDiff.toFixed(2)} â‚ª)`);  // â† ×ª×•×§×Ÿ!
        }
    }
    
    // ======================================
    // ×‘×“×™×§×” 2: ×©×¢×•×ª × ×•×¡×¤×•×ª (4720)
    // ======================================
    
    const current_4720_salaryDate = employee.current.salaryDates[4720] || '';
    const current_4720_refDate = employee.current.referenceDates[4720] || '';
    const isCurrent4720Regular = current_4720_salaryDate === current_4720_refDate && current_4720_salaryDate !== '';
    
    const previous_4720_salaryDate = employee.previous.salaryDates[4720] || '';
    const previous_4720_refDate = employee.previous.referenceDates[4720] || '';
    const isPrevious4720Regular = previous_4720_salaryDate === previous_4720_refDate && previous_4720_salaryDate !== '';
    
    const current_4720 = isCurrent4720Regular ? (current[4720] || 0) : 0;
    const previous_4720 = isPrevious4720Regular ? (previous[4720] || 0) : 0;
    
    if ((isCurrent4720Regular || isPrevious4720Regular) && Math.abs(current_4720 - previous_4720) > 0.01) {
        const diff = current_4720 - previous_4720;
        foundExplanations.push({
            code: 'OVERTIME',
            text: '×©×¢×•×ª × ×•×¡×¤×•×ª',
            detail: `×-${previous_4720.toFixed(2)} ×œ-${current_4720.toFixed(2)}`,
            amount: diff
        });
        totalExplained += diff;
        
        console.log(`   âœ“ ×©×¢×•×ª × ×•×¡×¤×•×ª: ${diff.toFixed(2)} â‚ª`);
    }
    // ======================================
// ×‘×“×™×§×” 3: ×”×—×–×¨×™ ×”×•×¦××•×ª (4717)
// ======================================

const current_4717_salaryDate = employee.current.salaryDates[4717] || '';
const current_4717_refDate = employee.current.referenceDates[4717] || '';
const isCurrent4717Regular = current_4717_salaryDate === current_4717_refDate && current_4717_salaryDate !== '';

const previous_4717_salaryDate = employee.previous.salaryDates[4717] || '';
const previous_4717_refDate = employee.previous.referenceDates[4717] || '';
const isPrevious4717Regular = previous_4717_salaryDate === previous_4717_refDate && previous_4717_salaryDate !== '';

const current_4717 = isCurrent4717Regular ? (current[4717] || 0) : 0;
const previous_4717 = isPrevious4717Regular ? (previous[4717] || 0) : 0;

if ((isCurrent4717Regular || isPrevious4717Regular) && Math.abs(current_4717 - previous_4717) > 0.01) {
    const diff_4717_total = current_4717 - previous_4717;
    
    // ğŸ¯ ×”×¤×—×ª ××ª ×”×—×“ ×¤×¢××™ ×©×›×‘×¨ × ×›×œ×œ ×‘×”×•×¦××•×ª
    const adjustedExpensesDiff = diff_4717_total - expensesOneTime.diff;
    
    console.log(`   ğŸ“Š ×”×—×–×¨×™ ×”×•×¦××•×ª ×’×•×œ××™: ${diff_4717_total.toFixed(2)} â‚ª`);
    if (expensesOneTime.diff !== 0) {
        console.log(`   â– ×©×™× ×•×™ ×‘×—×“ ×¤×¢××™ ×”×•×¦××•×ª: ${expensesOneTime.diff.toFixed(2)} â‚ª`);
        if (expensesOneTime.current > 0) {
            console.log(`      â€¢ × ×•×›×—×™: ${expensesOneTime.current.toFixed(2)} â‚ª (${expensesOneTime.currentDetails.join(', ')})`);
        }
        if (expensesOneTime.previous > 0) {
            console.log(`      â€¢ ×§×•×“×: ${expensesOneTime.previous.toFixed(2)} â‚ª (${expensesOneTime.previousDetails.join(', ')})`);
        }
        console.log(`   âœ… ×”×—×–×¨×™ ×”×•×¦××•×ª ××ª×•×§×Ÿ: ${adjustedExpensesDiff.toFixed(2)} â‚ª`);
    }
    
    let expensesDetail = `×-${previous_4717.toFixed(2)} ×œ-${current_4717.toFixed(2)}`;
    
    // ×”×•×¡×£ ×¤×™×¨×•×˜ ×× ×™×© ×—×“ ×¤×¢××™ ×”×•×¦××•×ª
    if (expensesOneTime.current > 0 || expensesOneTime.previous > 0) {
        let details = [];
        if (expensesOneTime.current > 0) {
            details.push(`× ×•×›×—×™: ${expensesOneTime.currentDetails.join(', ')}`);
        }
        if (expensesOneTime.previous > 0) {
            details.push(`×§×•×“×: ${expensesOneTime.previousDetails.join(', ')}`);
        }
        expensesDetail += ` | ×—×“ ×¤×¢××™ ×”×•×¦××•×ª: ${details.join(' | ')}`;
    }
    
    foundExplanations.push({
        code: 'EXPENSES',
        text: '×”×—×–×¨×™ ×”×•×¦××•×ª',
        detail: expensesDetail,
        amount: adjustedExpensesDiff  // â† ××ª×•×§×Ÿ!
    });
    totalExplained += adjustedExpensesDiff;
    
    console.log(`   âœ“ ×”×•×¦××•×ª: ${expensesDetail} (${adjustedExpensesDiff.toFixed(2)} â‚ª)`);
}// ======================================
// ======================================
// ×‘×“×™×§×” 4: ×ª×©×œ×•× ×—×“ ×¤×¢××™ (91013)
// ======================================

const current_91013 = current_91013_all;
const previous_91013 = previous_91013_all;

if (current_91013 !== 0 || previous_91013 !== 0) {
    const diff_91013_total = current_91013 - previous_91013;
    
    console.log(`   ğŸ’³ ×ª×©×œ×•× ×—×“ ×¤×¢××™ (91013):`);
    console.log(`      â€¢ ×¡×”"×› ×©×™× ×•×™: ${diff_91013_total.toFixed(2)} â‚ª`);
    
    // ğŸ¯ ×ª××™×“ × ×¡×¤×¨ ××ª ×”××œ×!
    if (Math.abs(diff_91013_total) > 0.01) {
        const oneTimeAnalysis = analyzeOneTimePayments(employee);
        const oneTimeSubCategory = getOneTimePaymentSubCategory(employee);
        
        foundExplanations.push({
            code: 'ONE_TIME',
            text: '×ª×©×œ×•× ×—×“ ×¤×¢××™',
            detail: oneTimeAnalysis,
             subCategory: oneTimeSubCategory,  // â† ×”×•×¡×£ ××ª ×–×”!
            amount: diff_91013_total  // â† ×”×¡×›×•× ×”××œ×! âœ…
        });
        totalExplained += diff_91013_total;
        
        console.log(`   âœ“ ×—×“ ×¤×¢××™: ${oneTimeAnalysis} (${diff_91013_total.toFixed(2)} â‚ª)`);
    }
}
// ======================================
// ×‘×“×™×§×” 5: ××¦×‘ ××©×¤×—×ª×™/×™×œ×“×™× (1420)  â† ×”×•×¡×™×¤×™!
// ======================================

const current_1420_salaryDate = employee.current.salaryDates[1420] || '';
const current_1420_refDate = employee.current.referenceDates[1420] || '';
const isCurrent1420Regular = current_1420_salaryDate === current_1420_refDate && current_1420_salaryDate !== '';

const previous_1420_salaryDate = employee.previous.salaryDates[1420] || '';
const previous_1420_refDate = employee.previous.referenceDates[1420] || '';
const isPrevious1420Regular = previous_1420_salaryDate === previous_1420_refDate && previous_1420_salaryDate !== '';

const current_1420_pct = isCurrent1420Regular ? (employee.current.percentages[1420] || 0) : 0;
const previous_1420_pct = isPrevious1420Regular ? (employee.previous.percentages[1420] || 0) : 0;

if ((isCurrent1420Regular || isPrevious1420Regular) && Math.abs(current_1420_pct - previous_1420_pct) > 0.01) {
    const current_1420_amt = isCurrent1420Regular ? (current[1420] || 0) : 0;
    const previous_1420_amt = isPrevious1420Regular ? (previous[1420] || 0) : 0;
    const diff = current_1420_amt - previous_1420_amt;
    
    foundExplanations.push({
        code: 'FAMILY_STATUS',  // â† ×”×§×•×“ ×”×—×“×©!
        text: '××¦×‘ ××©×¤×—×ª×™/×™×œ×“×™×',
        detail: `×-${previous_1420_pct.toFixed(2)}% ×œ-${current_1420_pct.toFixed(2)}%`,
        amount: diff
    });
    totalExplained += diff;
    
    console.log(`   âœ“ ××¦×‘ ××©×¤×—×ª×™: ${diff.toFixed(2)} â‚ª`);
}

        // ======================================
    // ğŸ¯ ×—×™×©×•×‘ ×”×¤×¨×© ×•×”×—×œ×˜×” ×¡×•×¤×™×ª
    // ======================================
    
    const gap = Math.abs(totalChange - totalExplained);
    
    console.log(`   ğŸ“Š ×¡×”"×› ×©×™× ×•×™: ${totalChange.toFixed(2)}`);
    console.log(`   âœ… ×¡×”"×› ×”×•×¡×‘×¨: ${totalExplained.toFixed(2)}`);
    console.log(`   ğŸ“ ×”×¤×¨×©: ${gap.toFixed(2)}`);
    
    if (foundExplanations.length === 0) {
        // ×œ× × ××¦× ×©×•× ×”×¡×‘×¨
        return {
            code: 'UNKNOWN',
            text: '×œ×œ× ×”×¡×‘×¨',
            explanation_detail: '×œ× × ××¦× ×”×¡×‘×¨ ×œ×©×™× ×•×™ - ×“×•×¨×© ×‘×“×™×§×” ×™×“× ×™×ª',
            status: 'RED',
            categories: ['UNKNOWN']
        };
    }
    
    // ×‘× ×™×™×ª ×”×¡×‘×¨ ××¤×•×¨×˜
    const detailParts = foundExplanations.map(exp => 
        `${exp.text}: ${exp.detail} (${exp.amount > 0 ? '+' : ''}${exp.amount.toFixed(2)} â‚ª)`
    );
    
    let explanation_detail = detailParts.join(' | ');
    
    // ×”×•×¡×¤×ª ×”×¤×¨×© ×× ×§×™×™×
    if (gap > 500) {
        explanation_detail += ` | ğŸ”´ × ×•×ª×¨×• ${gap.toFixed(2)} â‚ª ×œ×œ× ×”×¡×‘×¨`;
    } else if (gap > 0.01) {
        explanation_detail += ` | âœ“ ×”×¤×¨×© ×§×˜×Ÿ: ${gap.toFixed(2)} â‚ª`;
    }
    
    // ×”×—×œ×˜×”: GREEN ×× ×”×”×¤×¨×© ×§×˜×Ÿ ×-300
    const status = gap <= 500 ? 'GREEN' : 'RED';
    
    // ×§×•×“ ×¨××©×™
    const code = foundExplanations.length === 1 ? foundExplanations[0].code : 'MULTIPLE';
    const text = foundExplanations.length === 1 ? foundExplanations[0].text : '××¡×¤×¨ ×¡×™×‘×•×ª';
    
    // ğŸ¯ ×‘× ×™×™×ª ×¨×©×™××ª categories - ×›×•×œ×œ ×ª×ª-×§×˜×’×•×¨×™×•×ª ×¤× ×¡×™×•× ×™×•×ª
    let allCategories = [];
    foundExplanations.forEach(exp => {
        if (exp.subCategories) {
            // ×× ×™×© ×ª×ª-×§×˜×’×•×¨×™×•×ª (×¤× ×¡×™×•× ×™) - ×”×•×¡×£ ××•×ª×Ÿ
            allCategories.push(...exp.subCategories);
        } else {
            // ××—×¨×ª ×”×•×¡×£ ××ª ×”×§×•×“ ×”×¨×’×™×œ
            allCategories.push(exp.code);
        }
    });
    
    // ×× ×™×© ×¤×¢×¨ > 500, ×”×•×¡×£ UNKNOWN
    if (gap > 500) {
        allCategories.push('UNKNOWN');
    }
    
    console.log(`   ğŸ ×¡×˜×˜×•×¡: ${status}, ×§×˜×’×•×¨×™×•×ª: ${allCategories.join(', ')}`);
    
    return {
        code: code,
        text: text,
        explanation_detail: explanation_detail,
        status: status,
        categories: allCategories,
        explanations: foundExplanations,
        totalExplained: totalExplained,
        totalChange: totalChange
    };
}
// ============================================
// ×¤×•× ×§×¦×™×” × ×¤×¨×“×ª ×œ××¦×™××ª ×”×¡×‘×¨ - 91091 (×”×¤×¨×©×™×)
// ×œ××” ×”×¢×•×‘×“ ×§×™×‘×œ ×”×¤×¨×©×™×?
// ============================================

function findExplanation91091(employee) {
    const empId = employee.id_num;
    
    // ğŸ” ××¦×™××ª ×›×œ ×”×¨×©×•××•×ª ×”×¨×˜×¨×•××§×˜×™×‘×™×•×ª
    const retroRecords = rawData.filter(row => 
        row.id_num === empId &&
        row.SALARY_DATE === currentMonth &&
        row.REFERENCE_DATE !== currentMonth &&
        row.REFERENCE_DATE !== '' &&
        row.REFERENCE_DATE !== null
    );
    
    console.log(`ğŸ“Š ×¢×•×‘×“ ${empId}: ${retroRecords.length} ×¨×©×•××•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª`);
    
    if (retroRecords.length === 0) {
        return {
            code: 'UNKNOWN',
            text: '×œ×œ× ×”×¡×‘×¨',
            detail: '×§×™×‘×œ ×”×¤×¨×©×™× ××‘×œ ×œ× × ××¦××• ×¨×©×•××•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª',
            status: 'RED'
        };
    }
    
    // âœ… × ×™×ª×•×— ×”×¨×©×•××•×ª ×”×¨×˜×¨×•××§×˜×™×‘×™×•×ª
    const retroByType = {
        grade: [],      // 90144 - ×“×¨×’×”
        seniority: [],  // 90146 - ×•×ª×§
        position: [],   // 1507 - ×ª×¤×§×™×“
        tariff: [],     // 91203 - ×ª×¢×¨×™×£
        overtime: [],   // 4720 - ×©×¢×•×ª × ×•×¡×¤×•×ª
        expenses: [],   // 4717 - ×”×•×¦××•×ª
        oneTime: []     // 91013 - ×—×“ ×¤×¢××™
    };
    
    retroRecords.forEach(rec => {
        const element = rec.SALARY_ELEMENT_NUM;
        const refDate = rec.REFERENCE_DATE;
        const amount = rec.AMOUNT || 0;
        const qty = rec.QUANTITY || 0;
        
        console.log(`  ğŸ“Œ ×¡××œ ${element}, ×ª××¨×™×š ×¢×¨×š: ${refDate}, ×¡×›×•×: ${amount}`);
        
        if (element === 90144) {
            retroByType.grade.push({ refDate, amount, qty });
        } else if (element === 90146) {
            retroByType.seniority.push({ refDate, amount, qty });
        } else if (element === 1507) {
            retroByType.position.push({ refDate, amount, qty });
        } else if (element === 91203) {
            retroByType.tariff.push({ refDate, amount, qty });
        } else if (element === 4720) {
            retroByType.overtime.push({ refDate, amount });
        } else if (element === 4717) {
            retroByType.expenses.push({ refDate, amount });
        } else if (element === 91013) {
            retroByType.oneTime.push({ refDate, amount, qty });
         }
    });
    
    // âœ… ×‘× ×™×™×ª ×”×¡×‘×¨ ×œ×¤×™ ×¡×“×¨ ×¢×“×™×¤×•×ª
    
    // 1. ×©×™× ×•×™ ×“×¨×’×” ×¨×˜×¨×•××§×˜×™×‘×™
    if (retroByType.grade.length > 0) {
        const months = [...new Set(retroByType.grade.map(r => r.refDate))].length;
        const totalAmount = retroByType.grade.reduce((sum, r) => sum + r.amount, 0);
        
        return {
            code: 'RETRO_GRADE',
            text: '×¨×˜×¨×•××§×˜×™×‘×™ - ×©×™× ×•×™ ×“×¨×’×”',
            detail: `×©×™× ×•×™ ×“×¨×’×” ×¨×˜×¨×•××§×˜×™×‘×™ ×œ-${months} ×—×•×“×©×™× (×¡×”"×› ${totalAmount.toFixed(2)} â‚ª) ğŸ”™`,
            status: 'GREEN'
        };
    }
    
    // 2. ×©×™× ×•×™ ×•×ª×§ ×¨×˜×¨×•××§×˜×™×‘×™
    if (retroByType.seniority.length > 0) {
        const months = [...new Set(retroByType.seniority.map(r => r.refDate))].length;
        const totalAmount = retroByType.seniority.reduce((sum, r) => sum + r.amount, 0);
        
        return {
            code: 'RETRO_SENIORITY',
            text: '×¨×˜×¨×•××§×˜×™×‘×™ - ×©×™× ×•×™ ×•×ª×§',
            detail: `×©×™× ×•×™ ×•×ª×§ ×¨×˜×¨×•××§×˜×™×‘×™ ×œ-${months} ×—×•×“×©×™× (×¡×”"×› ${totalAmount.toFixed(2)} â‚ª) ğŸ”™`,
            status: 'GREEN'
        };
    }
    
    // 3. ×©×™× ×•×™ ×ª×¤×§×™×“ ×¨×˜×¨×•××§×˜×™×‘×™
    if (retroByType.position.length > 0) {
        const months = [...new Set(retroByType.position.map(r => r.refDate))].length;
        
        return {
            code: 'RETRO_POSITION',
            text: '×¨×˜×¨×•××§×˜×™×‘×™ - ×©×™× ×•×™ ×ª×¤×§×™×“',
            detail: `×©×™× ×•×™ ×ª×¤×§×™×“ ×¨×˜×¨×•××§×˜×™×‘×™ ×œ-${months} ×—×•×“×©×™× ğŸ”™`,
            status: 'GREEN'
        };
    }
    
    // 4. ×©×™× ×•×™ ×ª×¢×¨×™×£ ×¨×˜×¨×•××§×˜×™×‘×™
    if (retroByType.tariff.length > 0) {
        const months = [...new Set(retroByType.tariff.map(r => r.refDate))].length;
        
        return {
            code: 'RETRO_TARIFF',
            text: '×¨×˜×¨×•××§×˜×™×‘×™ - ×©×™× ×•×™ ×ª×¢×¨×™×£',
            detail: `×©×™× ×•×™ ×ª×¢×¨×™×£ ×¨×˜×¨×•××§×˜×™×‘×™ ×œ-${months} ×—×•×“×©×™× ğŸ”™`,
            status: 'GREEN'
        };
    }
    
    // 5. ×©×¢×•×ª × ×•×¡×¤×•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª
    if (retroByType.overtime.length > 0) {
        const months = [...new Set(retroByType.overtime.map(r => r.refDate))].length;
        const totalAmount = retroByType.overtime.reduce((sum, r) => sum + r.amount, 0);
        
        return {
            code: 'RETRO_OVERTIME',
            text: '×¨×˜×¨×•××§×˜×™×‘×™ - ×©×¢×•×ª × ×•×¡×¤×•×ª',
            detail: `×©×¢×•×ª × ×•×¡×¤×•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª ×œ-${months} ×—×•×“×©×™× (×¡×”"×› ${totalAmount.toFixed(2)} â‚ª) ğŸ”™`,
            status: 'GREEN'
        };
    }
    
    // 6. ×”×•×¦××•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª
    if (retroByType.expenses.length > 0) {
        const months = [...new Set(retroByType.expenses.map(r => r.refDate))].length;
        const totalAmount = retroByType.expenses.reduce((sum, r) => sum + r.amount, 0);
        
        return {
            code: 'RETRO_EXPENSES',
            text: '×¨×˜×¨×•××§×˜×™×‘×™ - ×”×•×¦××•×ª',
            detail: `×”×—×–×¨×™ ×”×•×¦××•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª ×œ-${months} ×—×•×“×©×™× (×¡×”"×› ${totalAmount.toFixed(2)} â‚ª) ğŸ”™`,
            status: 'GREEN'
        };
    }
   
    
    // 7. ×ª×©×œ×•× ×—×“ ×¤×¢××™ ×¨×˜×¨×•××§×˜×™×‘×™
    if (retroByType.oneTime.length > 0) {
        const months = [...new Set(retroByType.oneTime.map(r => r.refDate))].length;
        
        return {
            code: 'RETRO_ONE_TIME',
            text: '×¨×˜×¨×•××§×˜×™×‘×™ - ×—×“ ×¤×¢××™',
            detail: `×ª×©×œ×•× ×—×“ ×¤×¢××™ ×¨×˜×¨×•××§×˜×™×‘×™ ×œ-${months} ×—×•×“×©×™× ğŸ”™`,
            status: 'GREEN'
        };
    }
    
    // ×œ× ×¦×¨×™×š ×œ×”×’×™×¢ ×œ×›××Ÿ
    return {
        code: 'RETRO',
        text: '×ª×©×œ×•× ×¨×˜×¨×•××§×˜×™×‘×™',
        detail: `×ª×©×œ×•× ×¨×˜×¨×•××§×˜×™×‘×™ - ${retroRecords.length} ×¨×©×•××•×ª ğŸ”™`,
        status: 'GREEN'
    };
}
function analyzeAdditionalExceptions() {
    console.log('ğŸ” ×‘×•×“×§ ×—×¨×™×’×™× × ×•×¡×¤×™× (×œ× ×§×©×•×¨×™× ×œ×©×•×˜×£)...');
    
    let addedCount = 0;
    
    // âœ… ××©×ª××© ×‘-employeesData (×›××• analyzeData ×©×œ×š!)
    Object.values(employeesData).forEach(employee => {
        
        // ========== ×—×¨×™×’: ×’×™×“×•×œ ×ª×©×œ×•××™× ×œ×œ× × ×™×›×•×™×™× ==========
        
        const current_91092 = employee.current.elements[91092] || 0;
        const previous_91092 = employee.previous.elements[91092] || 0;
        const current_91095 = employee.current.elements[91095] || 0;
        const previous_91095 = employee.previous.elements[91095] || 0;
        
        const paymentsChange = current_91092 - previous_91092;
        const deductionsChange = current_91095 - previous_91095;
        
        // ğŸš¨ ×ª× ××™: ×’×™×“×•×œ ×ª×©×œ×•××™× > 1000 ××‘×œ × ×™×›×•×™×™× < 100
        if (paymentsChange > 100 && Math.abs(deductionsChange) < 5) {
            
            console.log(`ğŸ”´ ×—×¨×™×’: ×¢×•×‘×“ ${employee.id_num}, ×ª×©×œ×•××™×: +${paymentsChange.toFixed(2)}, × ×™×›×•×™×™×: ${deductionsChange.toFixed(2)}`);
            
            const newException = {
                severity: 'warning',
                type: 'payment_without_deduction',
                reason: `×ª×©×œ×•××™× ×¢×œ×• ×‘-${paymentsChange.toFixed(2)} â‚ª ××š × ×™×›×•×™×™× ${deductionsChange >= 0 ? '×¢×œ×• ×¨×§' : '×™×¨×“×•'} ×‘-${Math.abs(deductionsChange).toFixed(2)} â‚ª`
            };
            
            const existingIndex = analysisResults.findIndex(r => r.id_num === employee.id_num);
            
            if (existingIndex >= 0) {
                // ×”×•×¡×£ ×œ×©×•×¨×” ×§×™×™××ª
                analysisResults[existingIndex].exceptions.push(newException);
                analysisResults[existingIndex].hasExceptions = true;
                analysisResults[existingIndex].explanation_detail += ` | ×’×™×“×•×œ ×ª×©×œ×•××™× ×œ×œ× × ×™×›×•×™×™×`;
            } else {
                // ×¦×•×¨ ×©×•×¨×” ×—×“×©×”
                analysisResults.push({
                    id_num: employee.id_num,
                    office_num: employee.office_num,
                    current_regular: current_91092,
                    previous_regular: previous_91092,
                    change: paymentsChange,
                    reason_code: 'PAYMENT_DEDUCTION_MISMATCH',
                    reason_text: '×’×™×“×•×œ ×ª×©×œ×•××™× ×œ×œ× × ×™×›×•×™×™×',
                    explanation_detail: `×ª×©×œ×•××™× (91092): +${paymentsChange.toFixed(2)} â‚ª | × ×™×›×•×™×™× (91095): ${deductionsChange >= 0 ? '+' : ''}${deductionsChange.toFixed(2)} â‚ª`,
                    status: 'warning',
                    exceptions: [newException],
                    hasExceptions: true
                });
                addedCount++;
            }
        }
    });
    
    console.log(`âœ… × ×•×¡×¤×• ${addedCount} ×—×¨×™×’×™× ×—×“×©×™×`);
}
       // ============================================
        // ×¢×“×›×•×Ÿ UI ××—×¨×™ ×˜×¢×™× ×”
        // ============================================

         function updateUIAfterLoad() {
    console.log('ğŸ“Š ××ª×—×™×œ × ×™×ª×•×—...');
    
    // 1ï¸âƒ£ × ×™×ª×•×— ×©×™× ×•×™×™× ×‘×©×•×˜×£ (91090)
    analyzeData();
     analyzeData91091();  
     analyzeDataZikufim();
    
    // 2ï¸âƒ£ ×—×¨×™×’×™× × ×•×¡×¤×™× (91092, 91095, ×•×›×•')
    analyzeAdditionalExceptions();
    
    // 3ï¸âƒ£ ×¢×“×›×•×Ÿ UI
    populateOfficeFilter();
    updateStats();
    updateStatsSidebar(); // â† ×”×•×¡×™×¤×™ ××ª ×–×”!
    displayResults();
    displayResults91091();
    displayResultsZikufim();
    // ğŸ†• ×¢×“×›×•×Ÿ ×ª×’×™×•×ª ×”×˜××‘×™×
    updateTabBadges();
    
    document.getElementById('statsSection').classList.remove('hidden');
    document.getElementById('filtersSection').classList.remove('hidden');
    document.getElementById('resultsSection').classList.remove('hidden');
    
    loadSnapshotsList();
    updateExceptionsSidebar();
    saveSnapshot();
    // ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ-IndexedDB
     saveSharedData();
    
    // ×”×¦×’×ª ×›×¤×ª×•×¨ ×œ××•×“×•×œ ×”×©×œ×™×¤×•×ª
    //showPopulationButton();
}

        // ============================================
        // ××™×œ×•×™ ×¡×™× ×•×Ÿ ××©×¨×“×™×
        // ============================================

        function populateOfficeFilter() {
            const offices = [...new Set(analysisResults.map(r => r.office_num))].sort((a, b) => a - b);
            const select = document.getElementById('filterOffice');
            select.innerHTML = '<option value="">×›×œ ×”××©×¨×“×™×</option>';
            
            offices.forEach(office => {
                const option = document.createElement('option');
                option.value = office;
                option.textContent = office;
                select.appendChild(option);
            });
        }
        function populateGradeFilter(results) {
    const gradeSelect = document.getElementById('filterGrade');
    // ×—×™×œ×•×¥ ×“×¨×’×•×ª ×™×™×—×•×“×™×•×ª, ×¡×™× ×•×Ÿ null×™× ×•××™×•×Ÿ
    const grades = [...new Set(results.map(r => r.grade))]
                    .filter(g => g != null)
                    .sort((a, b) => a - b);

    gradeSelect.innerHTML = '<option value="">×›×œ ×”×“×¨×’×•×ª</option>';
    grades.forEach(grade => {
        gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
    });
}

        // ============================================
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        // ============================================

      function updateStats() {
    const totalEmployees = Object.keys(employeesData).length;
    const employeesWithChange = analysisResults.length;
    const employeesWithDifferences = analysisResults91091.length;
    const newEmployees = analysisResults.filter(r => r.status === 'NEW').length;
    const terminatedEmployees = analysisResults.filter(r => r.status === 'TERMINATED').length;
    const explained = analysisResults.filter(r => r.status === 'GREEN').length;
    const unexplained = analysisResults.filter(r => r.status === 'RED').length;

    // âœ… ×¢×“×›×•×Ÿ ×¨×§ ×× ×”××œ×× ×˜×™× ×§×™×™××™× (×¡×˜×˜×™×¡×˜×™×§×•×ª ×™×©× ×•×ª)
    const updateIfExists = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };
    
    updateIfExists('totalEmployees', totalEmployees);
    updateIfExists('employeesWithChange', employeesWithChange);
    updateIfExists('employeesWithDifferences', employeesWithDifferences);
    updateIfExists('explained', explained);
    updateIfExists('unexplained', unexplained);
    updateIfExists('newEmployees', newEmployees);
    updateIfExists('terminatedEmployees', terminatedEmployees);
    
    // âœ… ×§×¨×™××” ×œ×¢×“×›×•×Ÿ ×”×¡×¨×’×œ ×”×—×“×©
    updateStatsSidebar();
}
function displayResults(filteredData = null) {
    const data = filteredData || analysisResults;
    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="padding:30px;color:#999;">×œ× × ××¦××• ×ª×•×¦××•×ª</td></tr>';
        return;
    }

    data.forEach((row, index) => {
        // ×©×•×¨×” ×¨××©×™×ª
        const tr = document.createElement('tr');
        tr.className = 'expandable-row';
        tr.onclick = () => toggleDetailRow(index);
        
        // ×˜×™×¤×•×œ ×‘×¢×•×‘×“ ×—×“×©/××•×¤×¡×§
        let statusText, changeClass, statusClass;
        
        if (row.status === 'NEW') {
            statusText = 'ğŸ†• ×¢×•×‘×“ ×—×“×©';
            changeClass = 'status-green';
            statusClass = 'status-green';
        } else if (row.status === 'TERMINATED') {
            statusText = 'â›” ×¢×•×‘×“ ××•×¤×¡×§';
            changeClass = 'status-red';
            statusClass = 'status-red';
        } else {
            statusText = row.status === 'GREEN' ? 'âœ… × ××¦× ×”×¡×‘×¨' : 'âŒ ×œ×œ× ×”×¡×‘×¨';
            changeClass = row.change >= 0 ? 'status-green' : 'status-red';
            statusClass = row.status.toLowerCase();
        }
        
        tr.innerHTML = `
            <td>${row.id_num} <span class="expand-icon" id="icon-${index}">â–¼</span></td>
            <td>${row.office_num}</td>
             <td>${row.grade}</td>           <!-- ğŸ†• ×—×“×© -->
             <td>${row.maamad}</td>      
            <td>${formatCurrency(row.current_regular)}</td>
            <td>${formatCurrency(row.previous_regular)}</td>
            <td class="${changeClass}">${formatChange(row.change)}</td>
            <td><strong>${row.reason_text}</strong></td>
          
            <td class="status-${statusClass}">${statusText}</td>
        `;
        tbody.appendChild(tr);
        
        // ×©×•×¨×ª ×¤×™×¨×•×˜ ××ª×¨×—×‘×ª
        const detailTr = document.createElement('tr');
        detailTr.className = 'detail-row';
        detailTr.id = `detail-${index}`;
        
        // ×‘× ×™×™×ª ×ª×•×›×Ÿ ×”×¤×™×¨×•×˜
        const detailHTML = buildDetailContent(row);
        
        detailTr.innerHTML = `
            <td colspan="9">
                <div class="detail-content">
                    ${detailHTML}
                </div>
            </td>
        `;
        tbody.appendChild(detailTr);
    });
}
// ============================================
// ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×©×•×¨×ª ×¤×™×¨×•×˜
// ============================================

function toggleDetailRow(index) {
    const detailRow = document.getElementById(`detail-${index}`);
    const icon = document.getElementById(`icon-${index}`);
    
    if (detailRow.classList.contains('open')) {
        detailRow.classList.remove('open');
        icon.classList.remove('open');
    } else {
        detailRow.classList.add('open');
        icon.classList.add('open');
    }
}

// ============================================
// ×‘× ×™×™×ª ×ª×•×›×Ÿ ×¤×™×¨×•×˜ ××¦×˜×‘×¨
// ============================================
function buildDetailContent(row) {
    let html = '<div class="detail-section">';
    
    // ×›×•×ª×¨×ª
    html += `<strong>ğŸ“Š ×¤×™×¨×•×˜ ××¦×˜×‘×¨ ×œ×¢×•×‘×“ ${row.id_num}:</strong>`;
    
    // ×‘×“×™×§×” ×× ×™×© explanations ××¤×•×¨×˜×•×ª
    if (!row.explanations || row.explanations.length === 0) {
        // ××™×Ÿ ×¤×™×¨×•×˜ - ×›× ×¨××” ×¢×•×‘×“ ×—×“×© ××• ××•×¤×¡×§
        html += '<div class="detail-item">';
        if (row.status === 'NEW') {
            html += 'ğŸ†• ×¢×•×‘×“ ×—×“×© - ×œ× ×”×™×” ×ª×©×œ×•× ×‘×—×•×“×© ×”×§×•×“×';
        } else if (row.status === 'TERMINATED') {
            html += 'â›” ×¢×•×‘×“ ××•×¤×¡×§ - ××™×Ÿ ×ª×©×œ×•× ×‘×—×•×“×© ×”× ×•×›×—×™';
        } else {
            html += 'â„¹ï¸ ×œ× × ××¦××• ×”×¡×‘×¨×™× ×œ×©×™× ×•×™';
        }
        html += '</div>';
    } else {
        // ×™×© explanations - ×”×¦×’ ×›×œ ××—×“
        row.explanations.forEach(exp => {
            const amountClass = exp.amount >= 0 ? 'success' : 'error';
            const amountFormatted = (exp.amount >= 0 ? '+' : '') + exp.amount.toFixed(2) + ' â‚ª';
            
            html += `<div class="detail-item ${amountClass}">`;
            html += `âœ“ ${exp.text}: ${exp.detail} (${amountFormatted})`;
            html += `</div>`;
        });
        
        // ×§×• ×”×¤×¨×“×”
        html += '<div style="border-top: 2px solid #ddd; margin: 10px 0;"></div>';
        
        // ×¡×™×›×•× ××¦×˜×‘×¨
        if (row.totalExplained !== undefined && row.totalChange !== undefined) {
            const gap = Math.abs(row.totalChange - row.totalExplained);
            
            html += `<div class="detail-item"><strong>×¡×”"×› ×”×•×¡×‘×¨:</strong> ${row.totalExplained.toFixed(2)} â‚ª</div>`;
            html += `<div class="detail-item"><strong>×©×™× ×•×™ ×‘×¤×•×¢×œ:</strong> ${row.totalChange.toFixed(2)} â‚ª</div>`;
            
            if (gap <= 300) {
                html += `<div class="detail-item success"><strong>×”×¤×¨×©:</strong> ${gap.toFixed(2)} â‚ª âœ…</div>`;
            } else {
                html += `<div class="detail-item error"><strong>×”×¤×¨×©:</strong> ${gap.toFixed(2)} â‚ª ğŸ”´ × ×“×¨×© ×”×¡×‘×¨!</div>`;
            }
        }
    }
    
    html += '</div>';
    
    
    
    if (row.status === 'GREEN') {
        html += `<div class="detail-item success">âœ… ×”×¡×‘×¨ ××œ× × ××¦×</div>`;
    } else if (row.status === 'RED') {
        html += `<div class="detail-item error">âŒ × ×“×¨×©×ª ×‘×“×™×§×” ×™×“× ×™×ª</div>`;
    } else if (row.status === 'NEW') {
        html += `<div class="detail-item success">âœ… ×¢×•×‘×“ ×—×“×©</div>`;
    } else if (row.status === 'TERMINATED') {
        html += `<div class="detail-item">â„¹ï¸ ×¢×•×‘×“ ××•×¤×¡×§</div>`;
    }
    
    html += '</div>';
    
    return html;
}

// ============================================
// ×”×¦×’×ª ×ª×•×¦××•×ª - 91091 (×”×¤×¨×©×™×)
// ============================================

function displayResults91091(filteredData = null) {
    const data = filteredData || analysisResults91091;
    const tbody = document.getElementById('resultsBody91091');
    
    if (!tbody) {
        console.error('âŒ ×œ× × ××¦× resultsBody91091');
        return;
    }
    
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding:30px;color:#999;">×œ× × ××¦××• ×ª×•×¦××•×ª</td></tr>';
        return;
    }

    data.forEach(row => {
        const tr = document.createElement('tr');
        
        // ×˜×™×¤×•×œ ×‘×¢×•×‘×“ ×—×“×©/××•×¤×¡×§
        let statusText, changeClass, statusClass;
        
        if (row.status === 'NEW') {
            statusText = 'ğŸ†• ×¢×•×‘×“ ×—×“×©';
            changeClass = 'status-green';
            statusClass = 'status-green';
        } else if (row.status === 'TERMINATED') {
            statusText = 'â›” ×¢×•×‘×“ ××•×¤×¡×§';
            changeClass = 'status-red';
            statusClass = 'status-red';
        } else {
            statusText = row.status === 'GREEN' ? 'âœ… × ××¦× ×”×¡×‘×¨' : 'âŒ ×œ×œ× ×”×¡×‘×¨';
            changeClass = row.change >= 0 ? 'status-green' : 'status-red';
            statusClass = row.status.toLowerCase();
        }
        
       tr.innerHTML = `
    <td>${row.id_num}</td>
    <td>${row.office_num}</td>
    <td>${row.grade || '-'}</td>
    <td>${row.maamad || '-'}</td>
    <td>${formatCurrency(row.current_regular)}</td>
    <td class="${changeClass}">${formatCurrency(row.change)}</td>
    <td><strong>${row.reason_text}</strong></td>
    <td style="text-align:right;padding-right:20px;">${row.explanation_detail}</td>
    <td class="status-${statusClass}">${statusText}</td>
`;
        tbody.appendChild(tr);
    });
    
    console.log(`ğŸ“Š ×”×•×¦×’×• ${data.length} ×©×•×¨×•×ª ×‘×˜×‘×œ×ª 91091`);
}
    function displayResultsZikufim(filteredData = null) {
    const data = filteredData || analysisResultsZikufim;
    const tbody = document.getElementById('resultsBodyZikufim');
    
    if (!tbody) {
        console.error('âŒ ×œ× × ××¦× resultsBodyZikufim');
        return;
    }
    
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="padding:30px;color:#999;">×œ× × ××¦××• ×ª×•×¦××•×ª</td></tr>';
        return;
    }

    data.forEach(row => {
        const tr = document.createElement('tr');
        const changeClass = row.change >= 0 ? 'status-green' : 'status-red';
        
      tr.innerHTML = `
    <td>${row.id_num}</td>
    <td>${row.office_num}</td>
    <td>${row.grade || '-'}</td>
    <td>${row.maamad || '-'}</td>
    <td class="${changeClass}">${formatCurrency(row.change)}</td>
    <td><strong>${row.reason_text}</strong></td>
    <td style="text-align:right;padding-right:20px;">${row.explanation_detail}</td>
    <td class="status-green">âœ… × ××¦× ×”×¡×‘×¨</td>
`;
        tbody.appendChild(tr);
    });
    
    console.log(`ğŸ“Š ×”×•×¦×’×• ${data.length} ×©×•×¨×•×ª ×‘×˜×‘×œ×ª ×–×§×™×¤×•×ª`);
}



function applyFilters() {
    const filterEmployee = document.getElementById('filterEmployee').value.trim();
    const filterOffice = document.getElementById('filterOffice').value;
     const filterGrade = document.getElementById('filterGrade').value;
      const filterMaamad = document.getElementById('filterMaamad').value;
    const filterStatus = document.getElementById('filterStatus').value;
    const filterReason = document.getElementById('filterReason').value;

    let filtered = analysisResults.filter(row => {
        if (filterEmployee && !row.id_num.toString().includes(filterEmployee)) return false;
        if (filterOffice && row.office_num.toString() !== filterOffice) return false;
         if (filterGrade && (row.grade === null || row.grade === undefined || row.grade.toString() !== filterGrade)) return false;
            if (filterGrade && (row.grade === null || row.grade === undefined || row.grade.toString() !== filterGrade)) return false;
        if (filterStatus && row.status !== filterStatus) return false;
        

        // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×™×‘×ª ×©×™× ×•×™
        if (filterReason) {
            if (filterReason === 'PENSION') {
                // ×›×œ ×”×©×™× ×•×™×™× ×”×¤× ×¡×™×•× ×™×™×
                if (row.reason_code !== 'PENSION') return false;
                
            } else if (filterReason === 'PENSION_GRADE') {
                // ×¨×§ ×¤× ×¡×™×•× ×™ ×¢× ×“×¨×’×”/×“×™×¨×•×’
                if (row.reason_code !== 'PENSION') return false;
                if (!row.explanation_detail.includes('×“×¨×’×”') && 
                    !row.explanation_detail.includes('×“×™×¨×•×’')) return false;
                    
            } else if (filterReason === 'PENSION_SENIORITY') {
                // ×¨×§ ×¤× ×¡×™×•× ×™ ×¢× ×•×ª×§ (×œ× ×¢×•×‘×“×™ ××—×§×¨)
                if (row.reason_code !== 'PENSION') return false;
                if (!row.explanation_detail.includes('×•×ª×§')) return false;
                if (row.explanation_detail.includes('×¢×•×‘×“×™ ××—×§×¨')) return false; // â† ×œ× ×¢×•×‘×“×™ ××—×§×¨!
                
            } else if (filterReason === 'PENSION_RESEARCH') {
                // ×¨×§ ×¢×•×‘×“×™ ××—×§×¨
                if (row.reason_code !== 'PENSION') return false;
                if (!row.explanation_detail.includes('×¢×•×‘×“×™ ××—×§×¨')) return false;
                
            } else if (filterReason === 'PENSION_POSITION') {
                // ×¨×§ ×¤× ×¡×™×•× ×™ ×¢× ×ª×¤×§×™×“
                if (row.reason_code !== 'PENSION') return false;
                if (!row.explanation_detail.includes('×ª×¤×§×™×“')) return false;
                
            } else if (filterReason === 'PENSION_UNEXPLAINED') {
                // ×¨×§ ×¤× ×¡×™×•× ×™ ×œ×œ× ×”×¡×‘×¨ × ×•×¡×£
                if (row.reason_code !== 'PENSION') return false;
                if (!row.explanation_detail.includes('×œ×œ× ×”×¡×‘×¨ × ×•×¡×£')) return false;
                
            } else {
                // ×©××¨ ×”×¡×™× ×•× ×™× - ×¨×’×™×œ
                if (row.reason_code !== filterReason) return false;
            }
        }
        
        return true;
    });

    displayResults(filtered);
    showMessage('loadMessage', `ğŸ” × ××¦××• ${filtered.length} ×ª×•×¦××•×ª ××ª××™××•×ª ×œ×¡×™× ×•×Ÿ`, 'info');
}
        // ============================================
        // ×™×™×¦×•× ×œExcel ×¢× ×¡×™×‘×ª ×©×™× ×•×™!
        // ============================================

        function exportToExcel() {
            const data = [];
            const tbody = document.getElementById('resultsBody');
            const rows = tbody.getElementsByTagName('tr');

            // ×›×•×ª×¨×•×ª
            data.push(['××¡×¤×¨ ×–×”×•×ª', '×“×™×¨×•×’', '××¢××“', '×©×•×˜×£ × ×•×›×—×™', '×©×•×˜×£ ×§×•×“×', '×©×™× ×•×™', '×¡×™×‘×ª ×©×™× ×•×™', '×”×¡×‘×¨ ××¤×•×¨×˜', '×¡×˜×˜×•×¡']);

            // × ×ª×•× ×™×
            Array.from(rows).forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length > 0) {
                    const rowData = Array.from(cells).map(cell => 
                        cell.textContent.replace(' â‚ª', '').replace('âœ… ', '').replace('âŒ ', '')
                    );
                    data.push(rowData);
                }
            });

            // ×™×¦×™×¨×ª workbook
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [
                { wch: 12 }, { wch: 8 }, { wch: 12 }, { wch: 12 }, 
                { wch: 12 }, { wch: 15 }, { wch: 50 }, { wch: 12 }
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '×‘×§×¨×ª ×©×›×¨');

            const fileName = `salary_control_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showMessage('loadMessage', `âœ… ×”×§×•×‘×¥ ${fileName} ×™×•×¦× ×‘×”×¦×œ×—×”!`, 'success');
        }
        // ============================================
// ×‘×“×™×§×ª ×¡×‘×™×¨×•×ª ×©×™× ×•×™×™×
// ============================================

function validateChangeLogic(row) {
    const validations = [];
    
    // ×‘×“×™×§×” 1: ×©×™× ×•×™ ×“×¨×’×”/×“×™×¨×•×’ - ×¦×¤×•×™×” ×¢×œ×™×™×”
    if (row.reason_code === 'PENSION' && 
        (row.explanation_detail.includes('×“×¨×’×”') || row.explanation_detail.includes('×“×™×¨×•×’'))) {
        if (row.change < 0) {
            validations.push({
                severity: 'error',
                reason: `×©×™× ×•×™ ×“×¨×’×”/×“×™×¨×•×’ ××š ×”×©×›×¨ ×™×¨×“ ×‘-${Math.abs(row.change).toFixed(2)} â‚ª`
            });
        }
    }
    
    // ×‘×“×™×§×” 2: ×©×™× ×•×™ ×•×ª×§ - ×¦×¤×•×™×” ×¢×œ×™×™×”
    if (row.reason_code === 'PENSION' && row.explanation_detail.includes('×•×ª×§')) {
        if (row.change < 0) {
            validations.push({
                severity: 'error',
                reason: `×©×™× ×•×™ ×•×ª×§ ××š ×”×©×›×¨ ×™×¨×“ ×‘-${Math.abs(row.change).toFixed(2)} â‚ª`
            });
        }
    }
    
    // ×‘×“×™×§×” 3: ×œ× × ××¦× ×”×¡×‘×¨
    if (row.reason_code === 'UNKNOWN') {
        validations.push({
            severity: 'warning',
            reason: '×œ× × ××¦× ×”×¡×‘×¨ ×œ×©×™× ×•×™ ×‘×©×›×¨'
        });
    }
    
    // ×‘×“×™×§×” 4: ×©×™× ×•×™ ×¤× ×¡×™×•× ×™ ×œ×œ× ×”×¡×‘×¨
    if (row.reason_code === 'PENSION' && row.explanation_detail.includes('×œ×œ× ×”×¡×‘×¨ × ×•×¡×£')) {
        validations.push({
            severity: 'warning',
            reason: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™ ×œ×œ× ×–×™×”×•×™ ×¡×™×‘×” ××“×•×™×§×ª'
        });
    }
    
    return validations;
}

// ============================================
// ×¡×™× ×•×Ÿ ×¨×©×•××•×ª ×œ×‘×“×™×§×” ×™×“× ×™×ª
// ============================================

function getRecordsNeedingReview() {
    return analysisResults.filter(row => {
        const validations = validateChangeLogic(row);
        return validations.length > 0;
    }).map(row => ({
        ...row,
        validations: validateChangeLogic(row),
        userNotes: localStorage.getItem(`review_${row.id_num}_${row.current_regular}`) || '',
        approved: localStorage.getItem(`approved_${row.id_num}_${row.current_regular}`) === 'true'
    }));
}

// ============================================
// ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×”×¤×× ×œ
// ============================================

function toggleSidePanel() {
    const panel = document.getElementById('sidePanel');
    panel.classList.toggle('open');
    
    if (panel.classList.contains('open')) {
        displayReviewList();
    }
}

// ============================================
// ×”×¦×’×ª ×¨×©×™××ª ×‘×“×™×§×” ×™×“× ×™×ª
// ============================================

function displayReviewList() {
    const reviewList = document.getElementById('reviewList');
    const records = getRecordsNeedingReview();
    
    if (records.length === 0) {
        reviewList.innerHTML = `
            <div style="text-align:center; padding:50px; color:#999;">
                <div style="font-size:3em;">âœ…</div>
                <h3>××™×Ÿ ×¨×©×•××•×ª ×©×“×•×¨×©×•×ª ×‘×“×™×§×”!</h3>
                <p>×›×œ ×”×©×™× ×•×™×™× × ×¨××™× ×ª×§×™× ×™×</p>
            </div>
        `;
        return;
    }
    
    reviewList.innerHTML = records.map((row, index) => {
        const severity = row.validations[0].severity;
        const approvedClass = row.approved ? 'review-approved' : '';
        
        return `
            <div class="review-item ${severity} ${approvedClass}">
                <h3>×¢×•×‘×“ ${row.id_num} | ××©×¨×“ ${row.office_num}</h3>
                <div style="margin: 10px 0;">
                    <strong>×©×™× ×•×™:</strong> 
                    <span style="color: ${row.change >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                        ${formatChange(row.change)}
                    </span>
                </div>
                <div style="margin: 10px 0;">
                    <strong>×”×¡×‘×¨ ××¢×¨×›×ª:</strong> ${row.explanation_detail}
                </div>
                <div style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    ${row.validations.map(v => `
                        <div style="color: ${v.severity === 'error' ? '#e74c3c' : '#f39c12'}; font-weight: bold; margin: 5px 0;">
                            ${v.severity === 'error' ? 'ğŸ”´' : 'âš ï¸'} ${v.reason}
                        </div>
                    `).join('')}
                </div>
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                        ×”×¢×¨×•×ª/×”×¡×‘×¨ ×œ××©×ª××©:
                    </label>
                    <textarea 
                        class="review-notes" 
                        id="notes_${index}"
                        placeholder="×”×–×Ÿ ×”×¡×‘×¨ ×œ××” ×”×©×™× ×•×™ ×ª×§×™×Ÿ ××• ××” ×¦×¨×™×š ×œ×‘×“×•×§..."
                        ${row.approved ? 'disabled' : ''}
                    >${row.userNotes}</textarea>
                </div>
                ${!row.approved ? `
                    <button class="review-approve" onclick="approveReview(${index}, '${row.id_num}', ${row.current_regular})">
                        âœ“ ××©×¨ ×•×©××•×¨
                    </button>
                ` : `
                    <div style="color: #27ae60; font-weight: bold; margin-top: 10px;">
                        âœ… ××•×©×¨ ×•× ×‘×“×§
                    </div>
                `}
            </div>
        `;
    }).join('');
}

// ============================================
// ××™×©×•×¨ ×•×©××™×¨×ª ×”×¢×¨×”
// ============================================

function approveReview(index, empId, currentAmount) {
    const notes = document.getElementById(`notes_${index}`).value;
    const key = `${empId}_${currentAmount}`;
    
    localStorage.setItem(`review_${key}`, notes);
    localStorage.setItem(`approved_${key}`, 'true');
    
    displayReviewList();
    updateReviewCount();
    
    showMessage('loadMessage', 'âœ… ×”×¨×©×•××” ××•×©×¨×” ×•× ×©××¨×”', 'success');
}

// ============================================
// ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”×¨×©×•××•×ª ×‘×›×¤×ª×•×¨
// ============================================

function updateReviewCount() {
    const records = getRecordsNeedingReview();
    const unapproved = records.filter(r => !r.approved).length;
    
    const floatBtn = document.getElementById('floatBtn');
    const badge = document.getElementById('reviewCount');
    
    if (unapproved > 0) {
        floatBtn.style.display = 'block';
        badge.textContent = unapproved;
    } else {
        floatBtn.style.display = 'none';
    }
}
// ============================================
        // ×¤×•× ×§×¦×™×•×ª ×œ×¡×¨×’×œ ×”×—×¨×™×’×™× - ×–×× ×™
        // ============================================
        
        function openDetailPanel(type) {
            console.log('×¤×•×ª×— ×¤×× ×œ:', type);
            const panel = document.getElementById('detailPanel');
            if (panel) {
                panel.classList.add('open');
                document.getElementById('detailPanelTitle').textContent = 'ğŸ“‹ ×—×¨×™×’×™×';
                
                // ×”×¦×’ ××ª ×”×—×¨×™×’×™×!
                showExceptionsInPanel(type);
            }
        }
        
        function closeDetailPanel() {
            const panel = document.getElementById('detailPanel');
            if (panel) {
                panel.classList.remove('open');
            }
        }
        
        // ============================================
        // ×¢×“×›×•×Ÿ ×”×¡×¨×’×œ ×¢× ××¡×¤×¨×™ ×—×¨×™×’×™×
        // ============================================
        
function updateExceptionsSidebar() {
    const withExceptions = analysisResults.filter(r => r.hasExceptions);
    
    // ×¡×¤×™×¨×” - ×›×œ ×¢×•×‘×“ ×‘×§×˜×’×•×¨×™×” ××—×ª ×‘×œ×‘×“!
    const exceptionCounts = {};
    exceptionTypes.forEach(et => {
        exceptionCounts[et.type] = 0;
    });
    
    // ğŸ¯ ×›×œ ×¢×•×‘×“ - ×§×˜×’×•×¨×™×” ××—×ª ×‘×œ×‘×“ ×œ×¤×™ ×¡×“×¨ ×¢×“×™×¤×•×™×•×ª!
    withExceptions.forEach(row => {
        // ××¦× ××ª ×”-type ×”×¨××©×•×Ÿ (×‘×¡×“×¨ ×¢×“×™×¤×•×™×•×ª)
        let primaryType = null;
        for (let et of exceptionTypes) {
            if (row.exceptions.some(ex => ex.type === et.type)) {
                primaryType = et.type;
                break;  // â† ×¢×¦×•×¨! ×–×• ×”×§×˜×’×•×¨×™×” ×”×¨××©×•× ×™×ª!
            }
        }
        // ×¡×¤×•×¨ ×¨×§ ×‘×§×˜×’×•×¨×™×” ×”×¨××©×•× ×™×ª
        if (primaryType && exceptionCounts.hasOwnProperty(primaryType)) {
            exceptionCounts[primaryType]++;
        }
    });
    
    // ×¡×¤×™×¨×ª ×××•×©×¨×™×
    const approved = withExceptions.filter(row => {
        const noteKey = `note_${row.id_num}_${currentMonth}`;
        return localStorage.getItem(`approved_${noteKey}`) === 'true';
    }).length;
    
    const pending = withExceptions.length - approved;
    
    document.getElementById('newCount').textContent = pending;
    document.getElementById('existingCount').textContent = approved;
    document.getElementById('resolvedCount').textContent = 0;
    
    // ×¤×™×œ×•×— ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª
    const breakdown = document.getElementById('exceptionsBreakdown');
    let html = '';
    let hasExceptions = false;
    
    // ×‘×“×™×§×” ×× ×™×© ×§×˜×’×•×¨×™×•×ª
    for (let count of Object.values(exceptionCounts)) {
        if (count > 0) hasExceptions = true;
    }
    
    if (!hasExceptions) {
        breakdown.innerHTML = '<div style="color:#999;">××™×Ÿ ×—×¨×™×’×™×</div>';
        return;
    }
    
    // ×›×•×ª×¨×ª ×¢× toggle
    html = '<div style="cursor:pointer; padding:8px; background:rgba(255,255,255,0.1); border-radius:5px; margin-bottom:10px; user-select:none;" onclick="toggleExceptionsCategories()"><strong>ğŸ“Š ×§×˜×’×•×¨×™×•×ª ×—×¨×™×’×™×</strong> <span style="float:left; font-weight:bold;" id="catToggle">âˆ’</span></div>';
    html += '<div id="exceptionsCatList" style="display:block; margin-left:10px;">';
    
    // ×”×¦×’×ª ×§×˜×’×•×¨×™×•×ª
    exceptionTypes.forEach(et => {
        const count = exceptionCounts[et.type];
        if (count > 0) {
            html += `<div class="breakdown-item" onclick="openDetailPanel('${et.type}')" style="cursor:pointer; padding:6px; margin:5px 0; background:rgba(255,255,255,0.05); border-radius:4px;">
                ${et.icon} ${et.label}: <strong>${count}</strong>
            </div>`;
        }
    });
    
    html += '</div>';
    breakdown.innerHTML = html;
    
    console.log('âœ… ×¢×•×“×›×Ÿ ×”×¡×¨×’×œ:', exceptionCounts);
}

function toggleExceptionsCategories() {
    const list = document.getElementById('exceptionsCatList');
    const toggle = document.getElementById('catToggle');
    if (list.style.display === 'none') {
        list.style.display = 'block';
        toggle.textContent = 'âˆ’';
    } else {
        list.style.display = 'none';
        toggle.textContent = '+';
    }
}
function toggleExceptionsCategories() {
    const list = document.getElementById('exceptionsCatList');
    const toggle = document.getElementById('catToggle');
    
    if (list.style.display === 'none') {
        list.style.display = 'block';
        toggle.textContent = 'âˆ’';
    } else {
        list.style.display = 'none';
        toggle.textContent = '+';
    }
}
        // ============================================
        // ×”×¦×’×ª ×—×¨×™×’×™× ×‘×¤×× ×œ - ×’×¨×¡×” ×¤×©×•×˜×”
        // ============================================
         function showExceptionsInPanel(type) {
            let withExceptions = analysisResults.filter(r => r.hasExceptions);
            
            if (type !== 'all' && type !== 'new' && type !== 'existing' && type !== 'resolved') {
    withExceptions = withExceptions.filter(r => {
        // ××¦× ××ª ×”-primary type ×©×œ ×”×¢×•×‘×“
        let primaryType = null;
        for (let et of exceptionTypes) {
            if (r.exceptions.some(ex => ex.type === et.type)) {
                primaryType = et.type;
                break;
            }
        }
        // ×”×¦×’ ×¨×§ ×× ×–×” ×”-primary type!
        return primaryType === type;
    });
}
            
            const content = document.getElementById('detailPanelContent');
            
            if (withExceptions.length === 0) {
                content.innerHTML = `
                    <div style="text-align:center; padding:50px; color:#999;">
                        <div style="font-size:3em;">âœ…</div>
                        <h3>××™×Ÿ ×—×¨×™×’×™×!</h3>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = withExceptions.map(row => {
                const exceptionsHtml = row.exceptions.map(ex => `
                    <div style="background: ${ex.severity === 'error' ? '#fadbd8' : '#fff3cd'}; 
                                padding: 8px; 
                                border-radius: 5px; 
                                margin: 5px 0;
                                border-left: 4px solid ${ex.severity === 'error' ? '#e74c3c' : '#f39c12'};">
                        ${ex.severity === 'error' ? 'ğŸ”´' : 'âš ï¸'} ${ex.reason}
                    </div>
                `).join('');
                
                const noteKey = `note_${row.id_num}_${currentMonth}`;
                const savedNote = localStorage.getItem(noteKey) || '';
                const isApproved = localStorage.getItem(`approved_${noteKey}`) === 'true';
                
                return `
                    <div class="exception-card ${isApproved ? 'approved' : ''}" 
                         style="border: 2px solid ${isApproved ? '#27ae60' : '#ddd'}; 
                                padding: 15px; margin-bottom: 15px; border-radius: 8px;
                                background: ${isApproved ? '#d5f4e6' : 'white'};">
                        <h3 style="margin: 0 0 10px 0;">×¢×•×‘×“ ${row.id_num} | ××©×¨×“ ${row.office_num}</h3>
                        <div style="margin: 10px 0;">
                            <strong>×©×™× ×•×™:</strong> 
                            <span style="color: ${row.change >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                                ${formatChange(row.change)}
                            </span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>×”×¡×‘×¨ ××¢×¨×›×ª:</strong> ${row.explanation_detail}
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>×—×¨×™×’×™×:</strong>
                            ${exceptionsHtml}
                        </div>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #ddd;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                                ×”×¢×¨×•×ª/×”×¡×‘×¨:
                            </label>
                            <textarea 
                                id="note_${row.id_num}" 
                                class="exception-notes" 
                                placeholder="×”×–×Ÿ ×”×¡×‘×¨ ×œ××” ×”×©×™× ×•×™ ×ª×§×™×Ÿ ××• ××” ×¦×¨×™×š ×œ×‘×“×•×§..."
                                ${isApproved ? 'disabled' : ''}
                            >${savedNote}</textarea>
                            
                            ${!isApproved ? `
                                <button class="btn-approve" onclick="approveException('${row.id_num}', '${currentMonth}')">
                                    âœ“ ××©×¨ ×•×©××•×¨
                                </button>
                            ` : `
                                <div style="color: #27ae60; font-weight: bold; margin-top: 10px;">
                                    âœ… ××•×©×¨ ×•× ×‘×“×§
                                    <button class="btn-approve" onclick="unapproveException('${row.id_num}', '${currentMonth}')" 
                                            style="background: #f39c12; margin-right: 10px;">
                                        ğŸ”„ ×‘×˜×œ ××™×©×•×¨
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        // ============================================
        // ××™×©×•×¨ ×—×¨×™×’ ×•×©××™×¨×ª ×”×¢×¨×”
        // ============================================
        
        function approveException(empId, month) {
            const noteKey = `note_${empId}_${month}`;
            const note = document.getElementById(`note_${empId}`).value;
            
            localStorage.setItem(noteKey, note);
            localStorage.setItem(`approved_${noteKey}`, 'true');
            
            console.log('âœ… ××•×©×¨ ×—×¨×™×’ ×œ×¢×•×‘×“:', empId);
            
            // ×¨×¢× ×•×Ÿ ×”×¤×× ×œ
            showExceptionsInPanel('all');
            
            // ×¨×¢× ×•×Ÿ ×”×¡×¨×’×œ
            updateExceptionsSidebar();
        }
        
        function unapproveException(empId, month) {
            const noteKey = `note_${empId}_${month}`;
            localStorage.removeItem(`approved_${noteKey}`);
            
            console.log('ğŸ”„ ×‘×•×˜×œ ××™×©×•×¨ ×œ×¢×•×‘×“:', empId);
            
            // ×¨×¢× ×•×Ÿ ×”×¤×× ×œ
            showExceptionsInPanel('all');
            
            // ×¨×¢× ×•×Ÿ ×”×¡×¨×’×œ
            updateExceptionsSidebar();
        }
        // ============================================
        // ×©××™×¨×ª Snapshot ××•×˜×•××˜×™
        // ============================================
        
       async function saveSnapshot() {
            try {
                console.log('ğŸ’¾ ××ª×—×™×œ ×©××™×¨×ª Snapshot...');
                console.log('   ×—×•×“×© × ×•×›×—×™:', currentMonth);
                console.log('   ×—×•×“×© ×§×•×“×:', previousMonth);
                
                const db = await openDB();
                console.log('   DB × ×¤×ª×—');
                
                const snapshot = {
                    id: `snapshot_${Date.now()}`,
                    runDate: new Date().toISOString(),
                    salaryMonth: currentMonth,
                    previousMonth: previousMonth,
                    totalRecords: analysisResults.length,
                    exceptionsCount: analysisResults.filter(r => r.hasExceptions).length,
                    data: analysisResults.filter(r => r.hasExceptions)
                };
                
                console.log('   Snapshot × ×•×¦×¨:', snapshot.id);
                console.log('   ×—×¨×™×’×™×:', snapshot.exceptionsCount);
                
                const tx = db.transaction('snapshots', 'readwrite');
                await tx.objectStore('snapshots').put(snapshot);
                
                console.log('ğŸ’¾ Snapshot × ×©××¨ ×‘×”×¦×œ×—×”!');
                
                // ×¢×“×›×•×Ÿ ×¨×©×™××ª Snapshots
                await loadSnapshotsList();
                
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×©××™×¨×ª Snapshot:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª Snapshot: ' + error.message);
            }
        }
        // ============================================
        // ×˜×¢×™× ×ª ×¨×©×™××ª Snapshots
        // ============================================
        
       async function loadSnapshotsList() {
    try {
        const db = await openDB();
        
        const snapshots = await new Promise((resolve, reject) => {
            const tx = db.transaction('snapshots', 'readonly');
            const store = tx.objectStore('snapshots');
            const request = store.getAll();
            
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
        });
        
        console.log('ğŸ“Š × ×˜×¢× ×•', snapshots.length, 'snapshots');
        
        const list = document.getElementById('snapshotsList');
        if (!list) {
            console.warn('âš ï¸ Element snapshotsList ×œ× × ××¦×');
            return;
        }
        
        if (snapshots.length === 0) {
            list.innerHTML = '<div style="color:#999;">××™×Ÿ snapshots</div>';
            return;
        }
        
        snapshots.sort((a, b) => new Date(b.runDate) - new Date(a.runDate));
        
        list.innerHTML = snapshots.map((snap, index) => {
            const date = new Date(snap.runDate);
            const dateStr = `${date.toLocaleDateString('he-IL')} ${date.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'})}`;
            
            return `
                <div class="snapshot-item ${index === 0 ? 'active' : ''}" style="position: relative;">
                    <div onclick="loadSnapshot('${snap.id}')" style="cursor: pointer;">
                        ğŸ“¸ ${dateStr}
                        <div style="font-size:0.8em;opacity:0.8;">
                            ×—×•×“×©: ${snap.salaryMonth} | ${snap.exceptionsCount} ×—×¨×™×’×™×
                        </div>
                    </div>
                    
                    <button class="delete-snapshot-btn" 
                            onclick="event.stopPropagation(); deleteSnapshot('${snap.id}');"
                            title="××—×§ snapshot ×–×”">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `;
        }).join('');
        
        console.log('âœ… ×¨×©×™××ª Snapshots ×¢×•×“×›× ×”');
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª Snapshots:', error);
    }
}
async function deleteSnapshot(snapshotId) {
    // ××™×©×•×¨ ××—×™×§×”
    if (!confirm('â“ ×”×× ×œ××—×•×§ snapshot ×–×”?\n×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××—×¨×™ ×”××—×™×§×”.')) {
        return;
    }
    
    try {
        console.log('ğŸ—‘ï¸ ××•×—×§ snapshot:', snapshotId);
        
        const db = await openDB();
        
        await new Promise((resolve, reject) => {
            const tx = db.transaction('snapshots', 'readwrite');
            const store = tx.objectStore('snapshots');
            const request = store.delete(snapshotId);
            
            request.onsuccess = () => {
                console.log('âœ… Snapshot × ××—×§');
                resolve();
            };
            
            request.onerror = () => {
                console.error('âŒ ×©×’×™××” ×‘××—×™×§×”:', request.error);
                reject(request.error);
            };
        });
        
        // ×¨×¢× ×•×Ÿ ×”×¨×©×™××”
        await loadSnapshotsList();
        
        alert('âœ… Snapshot × ××—×§ ×‘×”×¦×œ×—×”!');
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘××—×™×§×ª Snapshot:', error);
        alert('âŒ ×©×’×™××” ×‘××—×™×§×”: ' + error.message);
    }
}
async function deleteAllSnapshots() {
    if (!confirm('âš ï¸ ×”×× ×œ××—×•×§ ××ª ×›×œ ×”-Snapshots?\n×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”!')) {
        return;
    }
    
    if (!confirm('âš ï¸ ××™×©×•×¨ ××—×¨×•×Ÿ - ×‘×××ª ×œ××—×•×§ ×”×›×œ?')) {
        return;
    }
    
    try {
        console.log('ğŸ—‘ï¸ ××•×—×§ ××ª ×›×œ ×”-Snapshots...');
        
        const db = await openDB();
        
        await new Promise((resolve, reject) => {
            const tx = db.transaction('snapshots', 'readwrite');
            const store = tx.objectStore('snapshots');
            const request = store.clear();
            
            request.onsuccess = () => {
                console.log('âœ… ×›×œ ×”-Snapshots × ××—×§×•');
                resolve();
            };
            
            request.onerror = () => {
                console.error('âŒ ×©×’×™××” ×‘××—×™×§×”:', request.error);
                reject(request.error);
            };
        });
        
        await loadSnapshotsList();
        alert('âœ… ×›×œ ×”-Snapshots × ××—×§×•!');
        
    } catch (error) {
        console.error('âŒ ×©×’×™××”:', error);
        alert('âŒ ×©×’×™××” ×‘××—×™×§×”: ' + error.message);
    }
}
        // ============================================
        // ×˜×¢×™× ×ª Snapshot ×¡×¤×¦×™×¤×™
        // ============================================
        
        async function loadSnapshot(snapshotId) {
            try {
                const db = await openDB();
                const tx = db.transaction('snapshots', 'readonly');
                const snapshot = await tx.objectStore('snapshots').get(snapshotId);
                
                if (snapshot) {
                    console.log('ğŸ“‚ ×˜×•×¢×Ÿ Snapshot:', snapshotId);
                    alert(`Snapshot: ${new Date(snapshot.runDate).toLocaleString('he-IL')}\n` +
                          `×—×•×“×© ×©×›×¨: ${snapshot.salaryMonth}\n` +
                          `×—×¨×™×’×™×: ${snapshot.exceptionsCount}`);
                }
                
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª Snapshot:', error);
            }
        }
        async function compareSnapshots() {
    try {
        const db = await openDB();
        
        const snapshots = await new Promise((resolve, reject) => {
            const tx = db.transaction('snapshots', 'readonly');
            const store = tx.objectStore('snapshots');
            const request = store.getAll();
            
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
        });
        
        if (snapshots.length < 2) {
            alert('âŒ × ×“×¨×©×™× ×œ×¤×—×•×ª 2 Snapshots ×›×“×™ ×œ×”×©×•×•×ª');
            return;
        }
        
        // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (××”×—×“×© ×œ×™×©×Ÿ)
        snapshots.sort((a, b) => new Date(b.runDate) - new Date(a.runDate));
        
        // ×¤×ª×™×—×ª ×¤×× ×œ ×‘×—×™×¨×”
        showComparisonPanel(snapshots);
        
    } catch (error) {
        console.error('âŒ ×©×’×™××”:', error);
        alert('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª Snapshots');
    }
}
function showComparisonPanel(snapshots) {
    const panel = document.getElementById('detailPanel');
    const title = document.getElementById('detailPanelTitle');
    const content = document.getElementById('detailPanelContent');
    
    title.textContent = 'ğŸ”„ ×”×©×•×•××ª Snapshots';
    
    const options = snapshots.map((snap, index) => {
        const date = new Date(snap.runDate);
        const dateStr = `${date.toLocaleDateString('he-IL')} ${date.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'})}`;
        return `<option value="${snap.id}">${index === 0 ? 'ğŸ†• ' : ''}${dateStr} (${snap.exceptionsCount} ×—×¨×™×’×™×)</option>`;
    }).join('');
    
    content.innerHTML = `
        <div style="padding: 20px;">
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>ğŸ’¡ ×”×¡×‘×¨:</strong><br>
                ×‘×—×¨/×™ 2 Snapshots ×›×“×™ ×œ×¨××•×ª ××” ×”×©×ª× ×” ×‘×™× ×™×”×:<br>
                â€¢ <span style="color: #27ae60;">ğŸ†• ×—×¨×™×’×™× ×—×“×©×™×</span> - ×”×•×¤×™×¢×• ×‘-Snapshot ×”×—×“×©<br>
                â€¢ <span style="color: #3498db;">ğŸ” ×—×¨×™×’×™× ×§×™×™××™×</span> - ×”×™×• ×’× ×‘×™×©×Ÿ ×•×’× ×‘×—×“×©<br>
                â€¢ <span style="color: #95a5a6;">âœ… ×—×¨×™×’×™× ×©× ×¤×ª×¨×•</span> - ×”×™×• ×‘×™×©×Ÿ, × ×¢×œ××• ×‘×—×“×©
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                        ğŸ“… Snapshot ×™×©×Ÿ (×‘×¡×™×¡ ×œ×”×©×•×•××”):
                    </label>
                    <select id="oldSnapshotSelect" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em;">
                        <option value="">×‘×—×¨/×™ Snapshot ×™×©×Ÿ...</option>
                        ${options}
                    </select>
                </div>
                
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                        ğŸ“… Snapshot ×—×“×© (× ×•×›×—×™):
                    </label>
                    <select id="newSnapshotSelect" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em;">
                        <option value="">×‘×—×¨/×™ Snapshot ×—×“×©...</option>
                        ${options}
                    </select>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn-primary" onclick="performComparison()" style="padding: 15px 40px; font-size: 1.1em;">
                    ğŸ” ×”×©×•×•×” ×¢×›×©×™×•
                </button>
            </div>
            
            <div id="comparisonResults" style="margin-top: 30px;"></div>
        </div>
    `;
    
    panel.classList.add('open');
    
    // ×‘×—×™×¨×” ××•×˜×•××˜×™×ª: ×”×—×“×© ×‘×™×•×ª×¨ vs ×”×©× ×™
    if (snapshots.length >= 2) {
        setTimeout(() => {
            document.getElementById('newSnapshotSelect').value = snapshots[0].id;
            document.getElementById('oldSnapshotSelect').value = snapshots[1].id;
        }, 100);
    }
}
async function performComparison() {
    const oldId = document.getElementById('oldSnapshotSelect').value;
    const newId = document.getElementById('newSnapshotSelect').value;
    
    if (!oldId || !newId) {
        alert('âŒ ×™×© ×œ×‘×—×•×¨ ×©× ×™ Snapshots');
        return;
    }
    
    if (oldId === newId) {
        alert('âŒ ×™×© ×œ×‘×—×•×¨ ×©× ×™ Snapshots ×©×•× ×™×');
        return;
    }
    
    try {
        const db = await openDB();
        
        // ×˜×¢×™× ×ª ×©× ×™ ×”-Snapshots
        const [oldSnap, newSnap] = await Promise.all([
            new Promise((resolve, reject) => {
                const tx = db.transaction('snapshots', 'readonly');
                const request = tx.objectStore('snapshots').get(oldId);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            }),
            new Promise((resolve, reject) => {
                const tx = db.transaction('snapshots', 'readonly');
                const request = tx.objectStore('snapshots').get(newId);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            })
        ]);
        
        console.log('ğŸ“Š Snapshots × ×˜×¢× ×•:', oldSnap, newSnap);
        
        // ×‘× ×™×™×ª ××¤×” ×©×œ ×—×¨×™×’×™× ×œ×¤×™ ×¢×•×‘×“
        const oldExceptions = new Map();
        oldSnap.data.forEach(row => {
            oldExceptions.set(row.id_num, row);
        });
        
        const newExceptions = new Map();
        newSnap.data.forEach(row => {
            newExceptions.set(row.id_num, row);
        });
        
        // ×¡×™×•×•×’ ×—×¨×™×’×™×
        const resolved = []; // × ×¤×ª×¨×•
        const existing = []; // ×§×™×™××™×
        const newOnes = [];  // ×—×“×©×™×
        
        // ×—×¨×™×’×™× ×©× ×¤×ª×¨×• - ×”×™×• ×‘×™×©×Ÿ, ××™×Ÿ ×‘×—×“×©
        oldExceptions.forEach((row, empId) => {
            if (!newExceptions.has(empId)) {
                resolved.push(row);
            }
        });
        
        // ×—×¨×™×’×™× ×—×“×©×™× ×•×§×™×™××™×
        newExceptions.forEach((row, empId) => {
            if (oldExceptions.has(empId)) {
                existing.push({
                    old: oldExceptions.get(empId),
                    new: row
                });
            } else {
                newOnes.push(row);
            }
        });
        
        console.log('ğŸ“Š ×ª×•×¦××•×ª:', {
            resolved: resolved.length,
            existing: existing.length,
            new: newOnes.length
        });
        
        // ×”×¦×’×ª ×”×ª×•×¦××•×ª
        displayComparisonResults(oldSnap, newSnap, resolved, existing, newOnes);
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×”×©×•×•××”:', error);
        alert('âŒ ×©×’×™××” ×‘×”×©×•×•××”');
    }
}
function displayComparisonResults(oldSnap, newSnap, resolved, existing, newOnes) {
    const resultsDiv = document.getElementById('comparisonResults');
    
    const oldDate = new Date(oldSnap.runDate).toLocaleString('he-IL');
    const newDate = new Date(newSnap.runDate).toLocaleString('he-IL');
    
    let html = `
        <div style="background: white; border: 2px solid #3498db; border-radius: 10px; padding: 20px;">
            <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">
                ğŸ“Š ×ª×•×¦××•×ª ×”×©×•×•××”
            </h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div>
                    <strong>ğŸ“… Snapshot ×™×©×Ÿ:</strong><br>
                    ${oldDate}<br>
                    <span style="color: #7f8c8d;">×—×¨×™×’×™×: ${oldSnap.exceptionsCount}</span>
                </div>
                <div>
                    <strong>ğŸ“… Snapshot ×—×“×©:</strong><br>
                    ${newDate}<br>
                    <span style="color: #7f8c8d;">×—×¨×™×’×™×: ${newSnap.exceptionsCount}</span>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: #d5f4e6; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #27ae60;">
                    <div style="font-size: 2em; font-weight: bold; color: #27ae60;">${newOnes.length}</div>
                    <div style="color: #27ae60; font-weight: bold;">ğŸ†• ×—×¨×™×’×™× ×—×“×©×™×</div>
                    <div style="font-size: 0.85em; color: #555;">×œ× ×”×™×• ×‘×™×©×Ÿ</div>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #3498db;">
                    <div style="font-size: 2em; font-weight: bold; color: #3498db;">${existing.length}</div>
                    <div style="color: #3498db; font-weight: bold;">ğŸ” ×—×¨×™×’×™× ×§×™×™××™×</div>
                    <div style="font-size: 0.85em; color: #555;">×”×™×• ×’× ×‘×™×©×Ÿ</div>
                </div>
                
                <div style="background: #ecf0f1; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #95a5a6;">
                    <div style="font-size: 2em; font-weight: bold; color: #95a5a6;">${resolved.length}</div>
                    <div style="color: #95a5a6; font-weight: bold;">âœ… × ×¤×ª×¨×•</div>
                    <div style="font-size: 0.85em; color: #555;">×”×™×• ×‘×™×©×Ÿ, × ×¢×œ××•</div>
                </div>
            </div>
    `;
    
    // ×—×¨×™×’×™× ×—×“×©×™×
    if (newOnes.length > 0) {
        html += `
            <div style="margin-top: 20px;">
                <h4 style="color: #27ae60; cursor: pointer;" onclick="document.getElementById('newExceptions').style.display = document.getElementById('newExceptions').style.display === 'none' ? 'block' : 'none'">
                    ğŸ†• ×—×¨×™×’×™× ×—×“×©×™× (${newOnes.length}) - ×œ×—×¥ ×œ×”×¦×’×”/×”×¡×ª×¨×”
                </h4>
                <div id="newExceptions" style="display: none;">
                    ${newOnes.map(row => `
                        <div style="background: #d5f4e6; padding: 10px; margin: 5px 0; border-radius: 5px; border-right: 4px solid #27ae60;">
                            <strong>×¢×•×‘×“ ${row.id_num}</strong> | ××©×¨×“ ${row.office_num}<br>
                            ×©×™× ×•×™: ${formatChange(row.change)}<br>
                            ${row.exceptions.map(ex => `<span style="font-size: 0.9em;">â€¢ ${ex.reason}</span>`).join('<br>')}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // ×—×¨×™×’×™× ×§×™×™××™×
    if (existing.length > 0) {
        html += `
            <div style="margin-top: 20px;">
                <h4 style="color: #3498db; cursor: pointer;" onclick="document.getElementById('existingExceptions').style.display = document.getElementById('existingExceptions').style.display === 'none' ? 'block' : 'none'">
                    ğŸ” ×—×¨×™×’×™× ×§×™×™××™× (${existing.length}) - ×›×‘×¨ ×‘×“×§×ª ×‘×¢×‘×¨
                </h4>
                <div id="existingExceptions" style="display: none;">
                    ${existing.map(pair => `
                        <div style="background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 5px; border-right: 4px solid #3498db;">
                            <strong>×¢×•×‘×“ ${pair.new.id_num}</strong> | ××©×¨×“ ${pair.new.office_num}<br>
                            ×©×™× ×•×™ ×™×©×Ÿ: ${formatChange(pair.old.change)} â†’ ×—×“×©: ${formatChange(pair.new.change)}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // ×—×¨×™×’×™× ×©× ×¤×ª×¨×•
    if (resolved.length > 0) {
        html += `
            <div style="margin-top: 20px;">
                <h4 style="color: #95a5a6; cursor: pointer;" onclick="document.getElementById('resolvedExceptions').style.display = document.getElementById('resolvedExceptions').style.display === 'none' ? 'block' : 'none'">
                    âœ… ×—×¨×™×’×™× ×©× ×¤×ª×¨×• (${resolved.length}) - ×›×‘×¨ ×œ× ×‘×—×“×©
                </h4>
                <div id="resolvedExceptions" style="display: none;">
                    ${resolved.map(row => `
                        <div style="background: #ecf0f1; padding: 10px; margin: 5px 0; border-radius: 5px; border-right: 4px solid #95a5a6;">
                            <strong>×¢×•×‘×“ ${row.id_num}</strong> | ××©×¨×“ ${row.office_num}<br>
                            ×©×™× ×•×™ ×©×”×™×”: ${formatChange(row.change)}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    html += `</div>`;
    
    resultsDiv.innerHTML = html;
}
function formatChange(change) {
    const color = change > 0 ? '#27ae60' : '#e74c3c';
    const sign = change > 0 ? '+' : '';
    return `<span style="color: ${color}; font-weight: bold;">${sign}${change.toFixed(2)} â‚ª</span>`;
}
function convertExcelDateToReadable(excelDate) {
    if (!excelDate) return '';
    
    // ×”××¨×” ×Excel serial number ×œ×ª××¨×™×š
    const date = new Date((excelDate - 25569) * 86400 * 1000);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    
    return `${day}.${month}.${year}`;
}
function switchTab(tabId) {
    console.log('ğŸ”„ switchTab:', tabId);
    
    // ×¡×’×•×¨ ××ª ×›×œ ×”×˜××‘×™×
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    // ×”×¡×¨ active ××›×œ ×”×›×¤×ª×•×¨×™×
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // ×¤×ª×— ××ª ×”×˜××‘ ×”× ×‘×—×¨
    const tabContent = document.getElementById(tabId);
    if (tabContent) {
        tabContent.style.display = 'block';
        tabContent.classList.add('active');
    }
    
    // ×¡××Ÿ ××ª ×”×›×¤×ª×•×¨ ×”××ª××™× ×›×¤×¢×™×œ
    const tabBtn = document.querySelector(`[onclick*="${tabId}"]`);
    if (tabBtn) {
        tabBtn.classList.add('active');
    }
    
    console.log('âœ… ×˜××‘ ×¤×¢×™×œ:', tabId);
}
// ============================================
// ×¢×“×›×•×Ÿ ×ª×’×™×•×ª ××¡×¤×¨×™× ×‘×˜××‘×™×
// ============================================

function updateTabBadges() {
    // ×¢×“×›×•×Ÿ ×˜××‘ 91090
    const count91090 = analysisResults ? analysisResults.length : 0;
    const badge91090 = document.getElementById('badge91090');
    if (badge91090) {
        badge91090.textContent = count91090;
    }
    
    // ×¢×“×›×•×Ÿ ×˜××‘ 91091
    const count91091 = analysisResults91091 ? analysisResults91091.length : 0;
    const badge91091 = document.getElementById('badge91091');
    if (badge91091) {
        badge91091.textContent = count91091;
    }
    
    console.log(`ğŸ”¢ ×ª×’×™×•×ª ×¢×•×“×›× ×•: 91090=${count91090}, 91091=${count91091}`);
    // ×¢×“×›×•×Ÿ ×˜××‘ ×–×§×™×¤×•×ª
    const countZikufim = analysisResultsZikufim ? analysisResultsZikufim.length : 0;
    const badgeZikufim = document.getElementById('badgeZikufim');
    if (badgeZikufim) {
        badgeZikufim.textContent = countZikufim;
    }
}
// ============================================
// ×¤×•× ×§×¦×™×•×ª ×œ×˜××‘×™× ×‘×¡×¨×’×œ
// ============================================

function toggleStatsTab(tabId) {
    const tab = document.getElementById(tabId);
    const arrow = document.getElementById('arrow' + tabId.replace('tab', '').replace('Stats', ''));
    
    if (tab.classList.contains('open')) {
        tab.classList.remove('open');
        tab.style.display = 'none';
        arrow.classList.remove('open');
    } else {
        tab.classList.add('open');
        tab.style.display = 'block';
        arrow.classList.add('open');
    }
}

function toggleStatsSubTab(subId) {
    const sub = document.getElementById(subId);
    const arrow = document.getElementById('arrow' + subId.replace('sub', ''));
    
    if (sub.classList.contains('open')) {
        sub.classList.remove('open');
        sub.style.display = 'none';
        arrow.classList.remove('open');
    } else {
        sub.classList.add('open');
        sub.style.display = 'block';
        arrow.classList.add('open');
    }
}
// ============================================
// ×”×¡×‘×¨×™× ×œ×§×˜×’×•×¨×™×•×ª - HELP SYSTEM
// ============================================

const categoryHelp = {
    'PENSION_GRADE': { title: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™ - ×“×™×¨×•×’', help: '×‘×“×•×§ ××™×¨×•×¢ 90144' },
    'PENSION_SENIORITY': { title: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™ - ×•×ª×§', help: '×‘×“×•×§ ××™×¨×•×¢ 90146' },
    'PENSION_POSITION': { title: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™ - ×ª×¤×§×™×“', help: '×‘×“×•×§ ××™×¨×•×¢ ×ª×¤×§×™×“' },
    'PENSION_STATUS': { title: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™ - ××¢××“', help: '×‘×“×•×§ ××ª ××¢××“ ×”×ª×¢×¡×•×§×”' },
    'PENSION_RESEARCH': { title: '×¢×•×‘×“×™ ××—×§×¨', help: '×‘×“×•×§ ××ª ××™×¨×•×¢ ×¢×•×‘×“×™ ××—×§×¨' },
    'ONE_TIME_VEHICLE': { title: '×‘×™×˜×•×— ×¨×›×‘', help: '×‘×“×•×§ ××™×¨×•×¢×™× 1491, 1492, 1493' },
    'ONE_TIME_HEALTH': { title: '×”×‘×¨××”', help: '×‘×“×•×§ ××™×¨×•×¢ 1342' },
    'ONE_TIME_JUBILEE': { title: '××¢× ×§ ×™×•×‘×œ', help: '×‘×“×•×§ ××™×¨×•×¢ 1360' },
    'ONE_TIME_CLOTHING': { title: '×‘×™×’×•×“', help: '×‘×“×•×§ ××™×¨×•×¢ 1320' },
    'ONE_TIME': { title: '×ª×©×œ×•× ×—×“-×¤×¢××™', help: '×‘×“×•×§ ××™×¨×•×¢×™× ×©×œ ×ª×©×œ×•××™× ×—×“-×¤×¢××™×™×' },
    'OVERTIME': { title: '×©×¢×•×ª × ×•×¡×¤×•×ª', help: '×‘×“×•×§ ×“×™×•×•×— ×‘××™×¨×•×¢ 90999' },
    'EXPENSES': { title: '×”×—×–×¨×™ ×”×•×¦××•×ª', help: '×‘×“×•×§ ××™×¨×•×¢×™ ×”×—×–×¨×™ ×”×•×¦××•×ª' },
    'FAMILY_STATUS': { title: '××¦×‘ ××©×¤×—×ª×™', help: '×‘×“×•×§ ××™×¨×•×¢ 90014' },
    'NEW': { title: '×¢×•×‘×“×™× ×—×“×©×™×', help: '×‘×“×•×§ ×ª××¨×™×š ×”×ª×—×œ×” ×—×“×©' },
    'TERMINATED': { title: '×¢×•×‘×“×™× ××•×¤×¡×§×™×', help: '×‘×“×•×§ ××™×¨×•×¢ 90158' },
    'RETRO_GRADE': { title: '×¨×˜×¨×•××§×˜×™×‘×™ - ×“×™×¨×•×’', help: '×‘×“×•×§ ××™×¨×•×¢ 90144 ×¨×˜×¨×•××§×˜×™×‘×™' },
    'RETRO_SENIORITY': { title: '×¨×˜×¨×•××§×˜×™×‘×™ - ×•×ª×§', help: '×‘×“×•×§ ××™×¨×•×¢ 90146 ×¨×˜×¨×•××§×˜×™×‘×™' },
    'RETRO_POSITION': { title: '×¨×˜×¨×•××§×˜×™×‘×™ - ×ª×¤×§×™×“', help: '×‘×“×•×§ ××™×¨×•×¢ ×ª×¤×§×™×“ ×¨×˜×¨×•××§×˜×™×‘×™' },
    'RETRO_TARIFF': { title: '×¨×˜×¨×•××§×˜×™×‘×™ - ×ª×¢×¨×™×£', help: '×‘×“×•×§ ××™×¨×•×¢ 91203 ×¨×˜×¨×•××§×˜×™×‘×™' },
    'RETRO_OVERTIME': { title: '×¨×˜×¨×•××§×˜×™×‘×™ - ×©×¢×•×ª × ×•×¡×¤×•×ª', help: '×‘×“×•×§ ×©×¢×•×ª × ×•×¡×¤×•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª' },
    'RETRO_EXPENSES': { title: '×¨×˜×¨×•××§×˜×™×‘×™ - ×”×•×¦××•×ª', help: '×‘×“×•×§ ×”×—×–×¨×™ ×”×•×¦××•×ª ×¨×˜×¨×•××§×˜×™×‘×™×•×ª' },
    'RETRO_ONE_TIME': { title: '×¨×˜×¨×•××§×˜×™×‘×™ - ×—×“ ×¤×¢××™', help: '×‘×“×•×§ ×ª×©×œ×•××™× ×—×“-×¤×¢××™×™× ×¨×˜×¨×•××§×˜×™×‘×™×™×' },
    'ZIKUF_VEHICLE': { title: '×”×¤×¨×©×™ ×–×§×™×¤×” - ×©×•×•×™ ×¨×›×‘', help: '×‘×“×•×§ ××™×¨×•×¢ 90253' }
};

function showHelpBanner(category) {
    if (!categoryHelp || !categoryHelp[category]) return;
    
    const help = categoryHelp[category];
    const oldBanner = document.getElementById('helpBanner');
    if (oldBanner) oldBanner.remove();
    
    const banner = document.createElement('div');
    banner.id = 'helpBanner';
    banner.style.cssText = 'background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; margin: 10px; border-radius: 8px;';
    banner.innerHTML = `<h3>ğŸ“š ${help.title}</h3><p style="white-space: pre-wrap;">${help.help}</p><button onclick="this.parentElement.remove()" style="background: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">×¡×’×•×¨</button>`;
    
    document.body.insertBefore(banner, document.body.firstChild);
}

// ============================================
// ×¢×“×›×•×Ÿ ××¡×¤×¨×™× ×‘×¡×¨×’×œ
// ============================================
function updateStatsSidebar() {
    const safeUpdate = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };
    
    // ============================================
    // ×©×•×˜×£ (91090)
    // ============================================
    
    const categoryCounts = {
        pension_grade: 0,
        pension_seniority: 0,
        pension_position: 0,
        pension_status: 0,
        pension_research: 0,
        overtime: 0,
        expenses: 0,
        one_time: 0,
        one_time_vehicle: 0,
        one_time_health: 0,
        one_time_jubilee: 0,
        one_time_clothing: 0,
        one_time_other: 0,
        family_status: 0,
        new_employees: 0,
        terminated_employees: 0,
        unknown: 0
    };
    
    const count91090 = analysisResults.length;
    safeUpdate('count91090Total', count91090);
    
    analysisResults.forEach(r => {
        // ×¡×¤×™×¨×” ×œ×¤×™ categories
        if (r.categories && r.categories.length > 0) {
            r.categories.forEach(cat => {
                if (cat === 'PENSION_GRADE') categoryCounts.pension_grade++;
                else if (cat === 'PENSION_SENIORITY') categoryCounts.pension_seniority++;
                else if (cat === 'PENSION_POSITION') categoryCounts.pension_position++;
                else if (cat === 'PENSION_STATUS') categoryCounts.pension_status++;
                else if (cat === 'PENSION_RESEARCH') categoryCounts.pension_research++;
                else if (cat === 'OVERTIME') categoryCounts.overtime++;
                else if (cat === 'EXPENSES') categoryCounts.expenses++;
                else if (cat === 'ONE_TIME') categoryCounts.one_time++;
                else if (cat === 'FAMILY_STATUS') categoryCounts.family_status++;
                else if (cat === 'NEW') categoryCounts.new_employees++;
                else if (cat === 'TERMINATED') categoryCounts.terminated_employees++;
                else if (cat === 'UNKNOWN') categoryCounts.unknown++;
            });
        }
        
        // ×¡×¤×™×¨×” ×œ×¤×™ reason_code (×‘× ×•×¡×£ ×œ-categories)
        if (r.reason_code === 'PENSION' && r.explanation_detail) {
            if (r.explanation_detail.includes('×“×¨×’×”') || r.explanation_detail.includes('×”×™×¨×•×’')) {
                categoryCounts.pension_grade++;
            } else if (r.explanation_detail.includes('×•×ª×§') && !r.explanation_detail.includes('×¢×•×‘×“×™ ××—×§×¨')) {
                categoryCounts.pension_seniority++;
            } else if (r.explanation_detail.includes('×ª×¤×§×™×“')) {
                categoryCounts.pension_position++;
            } else if (r.explanation_detail.includes('××¢××“')) {
                categoryCounts.pension_status++;
            } else if (r.explanation_detail.includes('×¢×•×‘×“×™ ××—×§×¨')) {
                categoryCounts.pension_research++;
            }
        }
        
        if (r.reason_code === 'OVERTIME') categoryCounts.overtime++;
        if (r.reason_code === 'EXPENSES') categoryCounts.expenses++;
        if (r.reason_code === 'ONE_TIME') categoryCounts.one_time++;
        if (r.reason_code === 'FAMILY_STATUS') categoryCounts.family_status++;
        if (r.reason_code === 'UNKNOWN') categoryCounts.unknown++;
        
        // ×¡×¤×™×¨×” ×œ×¤×™ status (×¢×‘×•×¨ NEW ×•-TERMINATED)
        if (r.status === 'NEW') categoryCounts.new_employees++;
        if (r.status === 'TERMINATED') categoryCounts.terminated_employees++;
        
        // ×¡×¤×•×¨ ×œ×¤×™ subCategory_oneTime
        if (r.subCategory_oneTime) {
            if (r.subCategory_oneTime === 'VEHICLE') categoryCounts.one_time_vehicle++;
            else if (r.subCategory_oneTime === 'HEALTH') categoryCounts.one_time_health++;
            else if (r.subCategory_oneTime === 'JUBILEE') categoryCounts.one_time_jubilee++;
            else if (r.subCategory_oneTime === 'CLOTHING') categoryCounts.one_time_clothing++;
            else categoryCounts.one_time_other++;
        }
    });
    
    // ×¢×“×›×Ÿ ××ª ×”-HTML ×©×œ ×©×•×˜×£
    const countPension = categoryCounts.pension_grade + 
                        categoryCounts.pension_seniority + 
                        categoryCounts.pension_position + 
                        categoryCounts.pension_status +
                        categoryCounts.pension_research;
    safeUpdate('countPension', countPension);
    safeUpdate('countPensionGrade', categoryCounts.pension_grade);
    safeUpdate('countPensionSeniority', categoryCounts.pension_seniority);
    safeUpdate('countPensionPosition', categoryCounts.pension_position);
    safeUpdate('countPensionStatus', categoryCounts.pension_status);
    safeUpdate('countPensionResearch', categoryCounts.pension_research);
    safeUpdate('countOvertime', categoryCounts.overtime);
    safeUpdate('countExpenses', categoryCounts.expenses);
    safeUpdate('countOneTime', categoryCounts.one_time);
    safeUpdate('countOneTimeVehicle', categoryCounts.one_time_vehicle);
    safeUpdate('countOneTimeHealth', categoryCounts.one_time_health);
    safeUpdate('countOneTimeJubilee', categoryCounts.one_time_jubilee);
    safeUpdate('countOneTimeClothing', categoryCounts.one_time_clothing);
    safeUpdate('countOneTimeOther', categoryCounts.one_time_other);
    safeUpdate('countFamilyStatus', categoryCounts.family_status);
    safeUpdate('countNewEmployees', categoryCounts.new_employees);
    safeUpdate('countTerminatedEmployees', categoryCounts.terminated_employees);
    safeUpdate('countUnknown91090', categoryCounts.unknown);
    
    // ============================================
    // ×”×¤×¨×©×™× (91091)
    // ============================================
    
    const retroCounts = {
        retro_grade: 0,
        retro_seniority: 0,
        retro_position: 0,
        retro_tariff: 0,
        retro_overtime: 0,
        retro_expenses: 0,
        retro_one_time: 0,
        retro_unknown: 0
    };
    
    const count91091 = analysisResults91091 ? analysisResults91091.length : 0;
    safeUpdate('count91091Total', count91091);
    
    if (analysisResults91091 && analysisResults91091.length > 0) {
        analysisResults91091.forEach(r => {
            if (r.reason_code === 'RETRO_GRADE') retroCounts.retro_grade++;
else if (r.reason_code === 'RETRO_SENIORITY') retroCounts.retro_seniority++;
else if (r.reason_code === 'RETRO_POSITION') retroCounts.retro_position++;
else if (r.reason_code === 'RETRO_TARIFF') retroCounts.retro_tariff++;
else if (r.reason_code === 'RETRO_OVERTIME') retroCounts.retro_overtime++;
else if (r.reason_code === 'RETRO_EXPENSES') retroCounts.retro_expenses++;
else if (r.reason_code === 'RETRO_ONE_TIME') retroCounts.retro_one_time++;
        });
    }
    
    // ×¢×“×›×Ÿ ××ª ×”-HTML ×©×œ ×”×¤×¨×©×™×
    safeUpdate('countRetroGrade', retroCounts.retro_grade);
    safeUpdate('countRetroSeniority', retroCounts.retro_seniority);
    safeUpdate('countRetroPosition', retroCounts.retro_position);
    safeUpdate('countRetroTariff', retroCounts.retro_tariff);
    safeUpdate('countRetroOvertime', retroCounts.retro_overtime);
    safeUpdate('countRetroExpenses', retroCounts.retro_expenses);
    safeUpdate('countRetroOneTime', retroCounts.retro_one_time);
    safeUpdate('countUnknown91091', retroCounts.retro_unknown);
    

    // ============================================
    // ×”×¤×¨×©×™ ×–×§×™×¤×•×ª
    // ============================================
    
    const countZikufim = analysisResultsZikufim ? analysisResultsZikufim.length : 0;
    safeUpdate('countZikufimTotal', countZikufim);
    
    const countZikufVehicle = analysisResultsZikufim ? 
        analysisResultsZikufim.filter(r => r.reason_code === 'ZIKUF_VEHICLE').length : 0;
    safeUpdate('countZikufVehicle', countZikufVehicle);
    // ============================================
    // ×¡×™×›×•×
    // ============================================
    
    const explained = analysisResults.filter(r => r.status === 'GREEN').length;
    const unexplained = analysisResults.filter(r => r.status === 'RED').length;
    safeUpdate('summaryExplained', explained);
    safeUpdate('summaryUnexplained', unexplained);
    
    console.log('âœ… ×¡×¨×’×œ ×¢×•×“×›×Ÿ!');
}
function filterByCategory(category) {
    // â­ ×¢×¦×™×¨×ª event propagation - ×—×•×‘×”!
    if (window.event) {
        window.event.stopPropagation();
    }
    console.log('ğŸ” ×¡×™× ×•×Ÿ ×œ×¤×™:', category);
    
    // ×”×¡×¨×ª active ××›×•×œ×
    document.querySelectorAll('.stats-category-item, .stats-sub-item, .stats-tab-header').forEach(el => {
        el.classList.remove('active');
    });
    
    // ×¡×™××•×Ÿ ×”×¤×¨×™×˜ ×©× ×œ×—×¥
    if (window.event && window.event.currentTarget) {
        window.event.currentTarget.classList.add('active');
    }
    
    let filtered = [];
    let targetTab = 'tab91090'; // ×‘×¨×™×¨×ª ××—×“×œ
    
    // ğŸ¯ ×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”
    switch(category) {
        case 'ALL_91090':
            filtered = analysisResults;
            targetTab = 'tab91090';
            break;
            
        case 'PENSION':
            filtered = analysisResults.filter(r => 
                (r.categories && r.categories.some(c => c.startsWith('PENSION'))) ||
                r.reason_code === 'PENSION'
            );
            targetTab = 'tab91090';
            break;
            
        case 'PENSION_GRADE':
            filtered = analysisResults.filter(r => 
                (r.categories && r.categories.includes('PENSION_GRADE')) ||
                (r.reason_code === 'PENSION' && 
                 (r.explanation_detail.includes('×“×¨×’×”') || r.explanation_detail.includes('×”×™×¨×•×’')))
            );
            targetTab = 'tab91090';
            break;
            
        case 'PENSION_SENIORITY':
            filtered = analysisResults.filter(r => 
                (r.categories && r.categories.includes('PENSION_SENIORITY')) ||
                (r.reason_code === 'PENSION' && 
                 r.explanation_detail.includes('×•×ª×§') &&
                 !r.explanation_detail.includes('×¢×•×‘×“×™ ××—×§×¨'))
            );
            targetTab = 'tab91090';
            break;
            
        case 'PENSION_POSITION':
            filtered = analysisResults.filter(r => 
                (r.categories && r.categories.includes('PENSION_POSITION')) ||
                (r.reason_code === 'PENSION' && r.explanation_detail.includes('×ª×¤×§×™×“'))
            );
            targetTab = 'tab91090';
            break;
            case 'PENSION_STATUS':  // â† ×”×•×¡×™×¤×™!
    filtered = analysisResults.filter(r => 
        (r.categories && r.categories.includes('PENSION_STATUS')) ||
        (r.reason_code === 'PENSION' && r.explanation_detail.includes('××¢××“'))
    );
    targetTab = 'tab91090';
    break;
            
        case 'PENSION_RESEARCH':
            filtered = analysisResults.filter(r => 
                (r.categories && r.categories.includes('PENSION_RESEARCH')) ||
                (r.reason_code === 'PENSION' && r.explanation_detail.includes('×¢×•×‘×“×™ ××—×§×¨'))
            );
            targetTab = 'tab91090';
            break;
            
        case 'OVERTIME':
            filtered = analysisResults.filter(r => 
                (r.categories && r.categories.includes('OVERTIME')) ||
                r.reason_code === 'OVERTIME'
            );
            targetTab = 'tab91090';
            break;

            
        case 'EXPENSES':
            filtered = analysisResults.filter(r => 
                (r.categories && r.categories.includes('EXPENSES')) ||
                r.reason_code === 'EXPENSES'
            );
            targetTab = 'tab91090';
            break;
             case 'ONE_TIME':  // â† ×”×•×¡×£ ××ª ×–×”!
            filtered = analysisResults.filter(r => r.reason_code === 'ONE_TIME');
            targetTab = 'tab91090';
            break;
            
      case 'ONE_TIME_VEHICLE':
    filtered = analysisResults.filter(r => r.subCategory_oneTime === 'VEHICLE');
    targetTab = 'tab91090';
    break;
    
case 'ONE_TIME_HEALTH':
    filtered = analysisResults.filter(r => r.subCategory_oneTime === 'HEALTH');
    targetTab = 'tab91090';
    break;
    
case 'ONE_TIME_JUBILEE':
    filtered = analysisResults.filter(r => r.subCategory_oneTime === 'JUBILEE');
    targetTab = 'tab91090';
    break;
    
case 'ONE_TIME_CLOTHING':
    filtered = analysisResults.filter(r => r.subCategory_oneTime === 'CLOTHING');
    targetTab = 'tab91090';
    break;
    
case 'ONE_TIME_OTHER':
    filtered = analysisResults.filter(r => r.subCategory_oneTime === 'OTHER');
    targetTab = 'tab91090';
    break;
            case 'FAMILY_STATUS':  // â† ×”×•×¡×™×¤×™!
    filtered = analysisResults.filter(r => 
        (r.categories && r.categories.includes('FAMILY_STATUS')) ||
        r.reason_code === 'FAMILY_STATUS'
    );
    targetTab = 'tab91090';
    break;
            
        case 'UNKNOWN_91090':
            filtered = analysisResults.filter(r => 
                (r.categories && r.categories.includes('UNKNOWN')) ||
                r.reason_code === 'UNKNOWN'
            );
            targetTab = 'tab91090';
            break;
            
        case 'NEW':
            filtered = analysisResults.filter(r => r.status === 'NEW');
            targetTab = 'tab91090';
            break;
            
        case 'TERMINATED':
            filtered = analysisResults.filter(r => r.status === 'TERMINATED');
            targetTab = 'tab91090';
            break;
            case 'ALL_91091':
            filtered = analysisResults91091;
            targetTab = 'tab91091';
            break;
            
        case 'RETRO_GRADE':
            filtered = analysisResults91091.filter(r => r.reason_code === 'RETRO_GRADE');
            targetTab = 'tab91091';
            break;
            
        case 'RETRO_SENIORITY':
            filtered = analysisResults91091.filter(r => r.reason_code === 'RETRO_SENIORITY');
            targetTab = 'tab91091';
            break;
            
        case 'RETRO_POSITION':
            filtered = analysisResults91091.filter(r => r.reason_code === 'RETRO_POSITION');
            targetTab = 'tab91091';
            break;
            
        case 'RETRO_TARIFF':
            filtered = analysisResults91091.filter(r => r.reason_code === 'RETRO_TARIFF');
            targetTab = 'tab91091';
            break;
            
        case 'RETRO_OVERTIME':
            filtered = analysisResults91091.filter(r => r.reason_code === 'RETRO_OVERTIME');
            targetTab = 'tab91091';
            break;
            
        case 'RETRO_EXPENSES':
            filtered = analysisResults91091.filter(r => r.reason_code === 'RETRO_EXPENSES');
            targetTab = 'tab91091';
            break;
            
        case 'RETRO_VEHICLE_BENEFITS':
            filtered = analysisResults91091.filter(r => r.reason_code === 'RETRO_VEHICLE_BENEFITS');
            targetTab = 'tab91091';
            break;
            
        case 'RETRO_ONE_TIME':
            filtered = analysisResults91091.filter(r => r.reason_code === 'RETRO_ONE_TIME');
            targetTab = 'tab91091';
            break;
            
        case 'UNKNOWN_91091':
            filtered = analysisResults91091.filter(r => 
                !['RETRO_GRADE', 'RETRO_SENIORITY', 'RETRO_POSITION', 'RETRO_TARIFF', 
                  'RETRO_OVERTIME', 'RETRO_EXPENSES', 'RETRO_VEHICLE_BENEFITS', 'RETRO_ONE_TIME']
                .includes(r.reason_code)
            );
            targetTab = 'tab91091';
            break;
            case 'ALL_ZIKUFIM':
            filtered = analysisResultsZikufim;
            targetTab = 'tabZikufim';
            break;
            
        case 'ZIKUF_VEHICLE':
            filtered = analysisResultsZikufim.filter(r => r.reason_code === 'ZIKUF_VEHICLE');
            targetTab = 'tabZikufim';
            break;
        default:
            filtered = analysisResults;
    }
    
    // ××¢×‘×¨ ×œ×˜××‘ ×”× ×›×•×Ÿ
    switchTab(targetTab);
    
   if (targetTab === 'tab91091') {
    displayResults91091(filtered);
} else if (targetTab === 'tabZikufim') {
    displayResultsZikufim(filtered);
} else {
    displayResults(filtered);
}
    // ×”×¦×’ ×¢×–×¨×” ×× ×§×™×™××ª ×œ×§×˜×’×•×¨×™×”
if (categoryHelp[category]) {
    showHelpBanner(category);
}
    
    // ×”×•×“×¢×” ×œ××©×ª××©
    showMessage('loadMessage', `ğŸ” ××•×¦×’×™× ${filtered.length} ×ª×•×¦××•×ª ××¡×•× × ×•×ª`, 'info');
    
    console.log(`âœ… ×¡×•× × ×• ${filtered.length} ×¨×©×•××•×ª`);
}
function showHelpBanner(category) {
    const help = categoryHelp[category];
    if (!help) return;
    
    // ×”×¡×¨ ×¢×–×¨×” ×™×©× ×” ×× ×§×™×™××ª
    const oldBanner = document.getElementById('helpBanner');
    if (oldBanner) oldBanner.remove();
    
    // ×‘× ×” banner ×—×“×©
    const banner = document.createElement('div');
    banner.id = 'helpBanner';
    banner.style.cssText = `
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    banner.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">ğŸ“š ${help.title}</h3>
                <p style="margin: 0; font-size: 0.95em; line-height: 1.5;">${help.help}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 4px; cursor: pointer; margin-left: 20px;">
                âœ•
            </button>
        </div>
    `;
 
const resultsContainer = document.querySelector('.result-grid') || 
                         document.querySelector('[class*="result"]') || 
                         document.querySelector('[id*="result"]');
    if (resultsContainer) {
        resultsContainer.insertBefore(banner, resultsContainer.firstChild);
    }
}
// ============================================
// ğŸ” ×¤×•× ×§×¦×™×™×ª DEBUG ×œ×§×•× ×¡×•×œ
// ============================================

window.debugPensionEmployee = function(idNum) {
    console.clear();
    
    const employee = employeesData[idNum];
    
    if (!employee) {
        console.error(`âŒ ×¢×•×‘×“ ${idNum} ×œ× × ××¦× ×‘××¢×¨×›×ª!`);
        return;
    }
    
    const current = employee.current.elements;
    const previous = employee.previous.elements;
    const currentQty = employee.current.quantities;
    const previousQty = employee.previous.quantities;
    
    console.log(`\n${'='.repeat(80)}`);
    console.log(`ğŸ“Š DEBUG - ×¢×•×‘×“ ${idNum} - × ×™×ª×•×— ×¤× ×¡×™×•× ×™ ××¤×•×¨×˜`);
    console.log('='.repeat(80));
    
    // 1. ×©×™× ×•×™ ×›×•×œ×œ
    const totalChange = (current[91090] || 0) - (previous[91090] || 0);
    console.log(`\nğŸ¯ ×©×™× ×•×™ ×›×•×œ×œ ×‘-91090: ${totalChange.toFixed(2)} â‚ª`);
    console.log(`   â€¢ × ×•×›×—×™: ${(current[91090] || 0).toFixed(2)} â‚ª`);
    console.log(`   â€¢ ×§×•×“×: ${(previous[91090] || 0).toFixed(2)} â‚ª`);
    
    // 2. ×‘×¨×•×˜×• ×¤× ×¡×™×”
    const current_91025_salaryDate = employee.current.salaryDates[91025] || '';
    const current_91025_refDate = employee.current.referenceDates[91025] || '';
    const isCurrent91025Regular = current_91025_salaryDate === current_91025_refDate && current_91025_salaryDate !== '';
    
    const previous_91025_salaryDate = employee.previous.salaryDates[91025] || '';
    const previous_91025_refDate = employee.previous.referenceDates[91025] || '';
    const isPrevious91025Regular = previous_91025_salaryDate === previous_91025_refDate && previous_91025_salaryDate !== '';
    
    const current_91025 = isCurrent91025Regular ? (current[91025] || 0) : 0;
    const previous_91025 = isPrevious91025Regular ? (previous[91025] || 0) : 0;
    const bruto_diff = current_91025 - previous_91025;
    
    console.log(`\nğŸ“Š ×‘×¨×•×˜×• ×¤× ×¡×™×” (91025):`);
    console.log(`   â€¢ × ×•×›×—×™: ${current_91025.toFixed(2)} â‚ª`);
    console.log(`   â€¢ ×§×•×“×: ${previous_91025.toFixed(2)} â‚ª`);
    console.log(`   â€¢ ×©×™× ×•×™ ×’×•×œ××™: ${bruto_diff.toFixed(2)} â‚ª`);
    
    // 3. ×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™
    const pensionOneTime = analyzePensionOneTime(employee);
    
    console.log(`\nğŸ’³ ×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™ (91013 ×¢× ×¡××œ×™× 1360, 1342):`);
    console.log(`   ğŸ“… ×—×•×“×© × ×•×›×—×™:`);
    if (pensionOneTime.current > 0) {
        console.log(`      â€¢ ×¡×”"×›: ${pensionOneTime.current.toFixed(2)} â‚ª`);
        pensionOneTime.currentDetails.forEach(d => console.log(`      â€¢ ${d}`));
    } else {
        console.log(`      â€¢ ××™×Ÿ ×ª×©×œ×•××™× (0.00 â‚ª)`);
    }
    
    console.log(`   ğŸ“… ×—×•×“×© ×§×•×“×:`);
    if (pensionOneTime.previous > 0) {
        console.log(`      â€¢ ×¡×”"×›: ${pensionOneTime.previous.toFixed(2)} â‚ª`);
        pensionOneTime.previousDetails.forEach(d => console.log(`      â€¢ ${d}`));
    } else {
        console.log(`      â€¢ ××™×Ÿ ×ª×©×œ×•××™× (0.00 â‚ª)`);
    }
    
    console.log(`   ğŸ’° ×©×™× ×•×™ ×‘×—×“ ×¤×¢××™ ×¤× ×¡×™×•× ×™: ${pensionOneTime.diff.toFixed(2)} â‚ª`);
    
    // 4. ×—×™×©×•×‘ ××ª×•×§×Ÿ
     adjustedBrutoDiff = bruto_diff - pensionOneTime.diff;
    
    console.log(`\nğŸ§® ×—×™×©×•×‘ ××ª×•×§×Ÿ:`);
    console.log(`   ${bruto_diff.toFixed(2)} (×‘×¨×•×˜×• ×’×•×œ××™) - ${pensionOneTime.diff.toFixed(2)} (×©×™× ×•×™ ×—×“ ×¤×¢××™) = ${adjustedBrutoDiff.toFixed(2)} â‚ª`);
    console.log(`   âœ… ×–×” ×”×¡×›×•× ×©×¦×¨×™×š ×œ×”×ª×•×•×¡×£ ×›"×¤× ×¡×™×•× ×™"`);
    
    // 5. ×ª×¢×¨×™×£ ××¡×œ
    const current_91203_salaryDate = employee.current.salaryDates[91203] || '';
    const current_91203_refDate = employee.current.referenceDates[91203] || '';
    const isCurrentRegular = current_91203_salaryDate === current_91203_refDate && current_91203_salaryDate !== '';
    
    const previous_91203_salaryDate = employee.previous.salaryDates[91203] || '';
    const previous_91203_refDate = employee.previous.referenceDates[91203] || '';
    const isPreviousRegular = previous_91203_salaryDate === previous_91203_refDate && previous_91203_salaryDate !== '';
    
    const current_91203 = isCurrentRegular ? (employee.current.tariffs[91203] || 0) : 0;
    const previous_91203 = isPreviousRegular ? (employee.previous.tariffs[91203] || 0) : 0;
    
    console.log(`\nğŸ“ˆ ×ª×¢×¨×™×£ ××¡×œ (91203):`);
    console.log(`   â€¢ × ×•×›×—×™: ${current_91203.toFixed(4)}`);
    console.log(`   â€¢ ×§×•×“×: ${previous_91203.toFixed(4)}`);
    console.log(`   â€¢ ×”×¤×¨×©: ${(current_91203 - previous_91203).toFixed(4)}`);
    console.log(`   â€¢ ×©×™× ×•×™ ××©××¢×•×ª×™? ${Math.abs(current_91203 - previous_91203) > 0.01 ? 'âœ“ ×›×Ÿ' : 'âœ— ×œ×'}`);
    
    // 6. ×©×™× ×•×™×™× ×¤× ×¡×™×•× ×™×™×
    console.log(`\nğŸ”§ ×©×™× ×•×™×™× ×¤× ×¡×™×•× ×™×™×:`);
    
    const current_90144_qty = currentQty[90144] || 0;
    const previous_90144_qty = previousQty[90144] || 0;
    console.log(`   ğŸ“Œ ×“×¨×’×” (90144): ${previous_90144_qty} â†’ ${current_90144_qty} ${current_90144_qty !== previous_90144_qty ? 'âœ“ ×©×™× ×•×™' : 'âœ— ×œ×œ× ×©×™× ×•×™'}`);
    
    const current_90146_qty = currentQty[90146] || 0;
    const previous_90146_qty = previousQty[90146] || 0;
    console.log(`   ğŸ“Œ ×•×ª×§ (90146): ${previous_90146_qty} â†’ ${current_90146_qty} ${current_90146_qty !== previous_90146_qty ? 'âœ“ ×©×™× ×•×™' : 'âœ— ×œ×œ× ×©×™× ×•×™'}`);
    
    const current_1507_salaryDate = employee.current.salaryDates[1507] || '';
    const current_1507_refDate = employee.current.referenceDates[1507] || '';
    const isCurrent1507Regular = current_1507_salaryDate === current_1507_refDate && current_1507_salaryDate !== '';
    
    const previous_1507_salaryDate = employee.previous.salaryDates[1507] || '';
    const previous_1507_refDate = employee.previous.referenceDates[1507] || '';
    const isPrevious1507Regular = previous_1507_salaryDate === previous_1507_refDate && previous_1507_salaryDate !== '';
    
    const current_1507_qty = isCurrent1507Regular ? (currentQty[1507] || 0) : 0;
    const previous_1507_qty = isPrevious1507Regular ? (previousQty[1507] || 0) : 0;
    console.log(`   ğŸ“Œ ×ª×¤×§×™×“ (1507): ${previous_1507_qty} â†’ ${current_1507_qty} ${current_1507_qty !== previous_1507_qty ? 'âœ“ ×©×™× ×•×™' : 'âœ— ×œ×œ× ×©×™× ×•×™'}`);
    
    // ğŸ’µ ×ª×©×œ×•× ×—×“ ×¤×¢××™ ×›×•×œ×œ (91013)
const current_91013_debug = rawData
    .filter(r => 
          r.id_num === idNum &&  // â† × ×›×•×Ÿ! âœ…
        r.SALARY_ELEMENT_NUM === 91013 && 
        r.SALARY_DATE === currentMonth &&
        r.REFERENCE_DATE === currentMonth
    )
    .reduce((sum, r) => sum + (r.AMOUNT || 0), 0);

const previous_91013_debug = rawData
    .filter(r => 
            r.id_num === idNum &&  // â† × ×›×•×Ÿ! âœ…
        r.SALARY_ELEMENT_NUM === 91013 && 
        r.SALARY_DATE === previousMonth &&
        r.REFERENCE_DATE === previousMonth
    )
    .reduce((sum, r) => sum + (r.AMOUNT || 0), 0);

console.log(`\nğŸ’µ ×ª×©×œ×•× ×—×“ ×¤×¢××™ ×›×•×œ×œ (91013):`);
console.log(`   â€¢ × ×•×›×—×™: ${current_91013_debug.toFixed(2)} â‚ª`);
console.log(`   â€¢ ×§×•×“×: ${previous_91013_debug.toFixed(2)} â‚ª`);
console.log(`   â€¢ ×©×™× ×•×™: ${(current_91013_debug - previous_91013_debug).toFixed(2)} â‚ª`);
    
    // 8. ×©×¢×•×ª × ×•×¡×¤×•×ª
    const current_4720_salaryDate = employee.current.salaryDates[4720] || '';
    const current_4720_refDate = employee.current.referenceDates[4720] || '';
    const isCurrent4720Regular = current_4720_salaryDate === current_4720_refDate && current_4720_salaryDate !== '';
    
    const previous_4720_salaryDate = employee.previous.salaryDates[4720] || '';
    const previous_4720_refDate = employee.previous.referenceDates[4720] || '';
    const isPrevious4720Regular = previous_4720_salaryDate === previous_4720_refDate && previous_4720_salaryDate !== '';
    
    const current_4720 = isCurrent4720Regular ? (current[4720] || 0) : 0;
    const previous_4720 = isPrevious4720Regular ? (previous[4720] || 0) : 0;
    const diff_4720 = current_4720 - previous_4720;
    
    console.log(`\nâ° ×©×¢×•×ª × ×•×¡×¤×•×ª (4720):`);
    console.log(`   â€¢ × ×•×›×—×™: ${current_4720.toFixed(2)} â‚ª`);
    console.log(`   â€¢ ×§×•×“×: ${previous_4720.toFixed(2)} â‚ª`);
    console.log(`   â€¢ ×©×™× ×•×™: ${diff_4720.toFixed(2)} â‚ª`);
    const diff_91013 = current_91013_debug - previous_91013_debug;  // â† ×”×•×¡×£ ××ª ×–×”!
    
    // 9. ×¡×™×›×•×
    console.log(`\n${'='.repeat(80)}`);
    console.log(`ğŸ“‹ ×¡×™×›×•× - ××” ×¦×¨×™×š ×œ×”×™×•×ª ××•×¡×‘×¨:`);
    console.log('='.repeat(80));
    console.log(`   âœ“ ×¤× ×¡×™×•× ×™ (adjustedBrutoDiff): ${adjustedBrutoDiff.toFixed(2)} â‚ª`);
    console.log(`   âœ“ ×—×“ ×¤×¢××™ (91013): ${diff_91013.toFixed(2)} â‚ª`);
    console.log(`   âœ“ ×©×¢×•×ª × ×•×¡×¤×•×ª (4720): ${diff_4720.toFixed(2)} â‚ª`);
    console.log(`   ğŸ“Š ×¡×”"×› ××•×¡×‘×¨: ${(adjustedBrutoDiff + diff_91013 + diff_4720).toFixed(2)} â‚ª`);
    console.log(`   ğŸ“Š ×©×™× ×•×™ ×‘×¤×•×¢×œ (91090): ${totalChange.toFixed(2)} â‚ª`);
    console.log(`   ğŸ“ ×”×¤×¨×©: ${(totalChange - (adjustedBrutoDiff + diff_91013 + diff_4720)).toFixed(2)} â‚ª`);
    console.log('='.repeat(80) + '\n');
    
    // 10. ×”×¦×’×ª ×ª×•×¦××ª findExplanation
    console.log(`\nğŸ¯ ×ª×•×¦××ª findExplanation ×‘×¤×•×¢×œ:`);
    const explanation = findExplanation(employee);
    console.log(explanation);
    console.log('\n');
};

console.log('âœ… ×¤×•× ×§×¦×™×™×ª debug ××•×›× ×”! ×”×§×œ×“: debugPensionEmployee("××¡×¤×¨_×ª×–")');
// ============================================
// ×¤×•× ×§×¦×™×•×ª ×œ×©×™×ª×•×£ × ×ª×•× ×™× ×¢× ××•×“×•×œ ×”×©×œ×™×¤×•×ª
// ============================================

async function initSharedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('SharedSalaryDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('sharedData')) {
                db.createObjectStore('sharedData');
                console.log('âœ… ×˜×‘×œ×ª sharedData × ×•×¦×¨×” ×œ×©×™×ª×•×£ × ×ª×•× ×™×');
            }
        };
    });
}

async function saveSharedData() {
    try {
        console.log('ğŸ”„ ×©×•××¨ × ×ª×•× ×™× ×œ×©×™×ª×•×£...');
        
        // ×‘×“×™×§×” ×©×™×© × ×ª×•× ×™×
        if (!employeesData || Object.keys(employeesData).length === 0) {
            console.error('âŒ ××™×Ÿ × ×ª×•× ×™× ×œ×©××™×¨×”!');
            return false;
        }
        
        const db = await initSharedDB();
        const transaction = db.transaction(['sharedData'], 'readwrite');
        const store = transaction.objectStore('sharedData');
        
        const dataPackage = {
            employeesData: employeesData,
            currentMonth: currentMonth,
            previousMonth: previousMonth,
            timestamp: new Date().toISOString(),
            totalEmployees: Object.keys(employeesData).length,
            rawData: rawData // ×©××™×¨×ª ×”× ×ª×•× ×™× ×”×’×•×œ××™×™× ×× × ×¦×¨×š
        };
        
        console.log(`ğŸ“¦ ×©×•××¨ ${dataPackage.totalEmployees} ×¢×•×‘×“×™× ×œ×©×™×ª×•×£...`);
        
        const request = store.put(dataPackage, 'currentData');
        
        return new Promise((resolve, reject) => {
            request.onsuccess = () => {
                console.log('âœ… × ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×” ×œ×©×™×ª×•×£!');
                // ×”×•×“×¢×” ×œ×—×œ×•× ×•×ª ××—×¨×™× ×©×”× ×ª×•× ×™× ×¢×•×“×›× ×•
                localStorage.setItem('sharedDataUpdated', new Date().toISOString());
                resolve(true);
            };
            request.onerror = () => {
                console.error('âŒ ×©×’×™××” ×‘×©××™×¨×”:', request.error);
                reject(request.error);
            };
        });
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™× ×œ×©×™×ª×•×£:', error);
        return false;
    }
}

async function saveRawDataToDB() {
    try {
        console.log('ğŸ”„ ×©×•××¨ × ×ª×•× ×™× ×’×•×œ××™×™× ×œ×©×™×ª×•×£...');
        
        // ×‘×“×™×§×” ×©×™×© × ×ª×•× ×™×
        if (!rawData || rawData.length === 0) {
            console.error('âŒ ××™×Ÿ × ×ª×•× ×™× ×’×•×œ××™×™× ×œ×©××™×¨×”!');
            return false;
        }
        
        const db = await initSharedDB();
        const transaction = db.transaction(['sharedData'], 'readwrite');
        const store = transaction.objectStore('sharedData');
        
        // ×©××™×¨×ª ×”× ×ª×•× ×™× ×”×’×•×œ××™×™× ×›××• ×©×”×
        const dataPackage = {
            rawData: rawData,  // â† ×›×œ ×”× ×ª×•× ×™× ××”××§×¡×œ!
            currentMonth: currentMonth,
            previousMonth: previousMonth,
            timestamp: new Date().toISOString(),
            totalRows: rawData.length,
            
            // × ×ª×•× ×™× × ×•×¡×¤×™× ×©×¢×©×•×™×™× ×œ×¢×–×•×¨
            uniqueEmployees: [...new Set(rawData.map(row => row.id_num))].length,
            uniqueSymbols: [...new Set(rawData.map(row => row.SALARY_ELEMENT_NUM))],
            
            // ×’× ×©×•××¨×™× ××ª ×”× ×ª×•× ×™× ×”××¢×•×‘×“×™× ×× ×¨×•×¦×™×
            employeesData: employeesData  // ××•×¤×¦×™×•× ×œ×™
        };
        
        console.log(`ğŸ“¦ ×©×•××¨ ${dataPackage.totalRows} ×©×•×¨×•×ª × ×ª×•× ×™×...`);
        console.log(`ğŸ‘¥ ${dataPackage.uniqueEmployees} ×¢×•×‘×“×™× ×™×™×—×•×“×™×™×`);
        console.log(`ğŸ”¢ ${dataPackage.uniqueSymbols.length} ×¡××œ×™ ×©×›×¨ ×©×•× ×™×`);
        
        const request = store.put(dataPackage, 'currentData');
        
        return new Promise((resolve, reject) => {
            request.onsuccess = () => {
                console.log('âœ… × ×ª×•× ×™× ×’×•×œ××™×™× × ×©××¨×• ×‘×”×¦×œ×—×”!');
                
                // ×”×•×“×¢×” ×œ×—×œ×•× ×•×ª ××—×¨×™× ×©×”× ×ª×•× ×™× ×¢×•×“×›× ×•
                localStorage.setItem('sharedDataUpdated', new Date().toISOString());
                
                // ×”×¦×’×ª ×”×•×“×¢×” ×œ××©×ª××©
                showDataSavedMessage();
                
                resolve(true);
            };
            request.onerror = () => {
                console.error('âŒ ×©×’×™××” ×‘×©××™×¨×”:', request.error);
                reject(request.error);
            };
        });
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™×:', error);
        return false;
    }
}

// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×” ×¢×œ ×©××™×¨×” ××•×¦×œ×—×ª
function showDataSavedMessage() {
    // ×× ×™×© ×›×‘×¨ ××–×•×¨ ×”×•×“×¢×•×ª, ×”×©×ª××© ×‘×•
    const messageArea = document.getElementById('loadMessage') || 
                       document.querySelector('.message');
    
    if (messageArea) {
        messageArea.innerHTML = `
            <div class="message success">
                âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×•× ×’×™×©×™× ×œ××•×“×•×œ ×”×©×œ×™×¤×•×ª | 
                ${rawData.length} ×©×•×¨×•×ª | 
                ${[...new Set(rawData.map(r => r.id_num))].length} ×¢×•×‘×“×™×
            </div>
        `;
    }
}

// ×¤×•× ×§×¦×™×” ×œ×¤×ª×™×—×ª ××•×“×•×œ ×”×©×œ×™×¤×•×ª
function openPopulationQuery() {
    // ×§×•×“× × ×•×•×“× ×©×™×© × ×ª×•× ×™×
    if (!rawData || rawData.length === 0) {
        alert('×™×© ×œ×˜×¢×•×Ÿ ×§×‘×¦×™× ×ª×—×™×œ×”');
        return;
    }
    
    // ×©×•××¨×™× ××ª ×”× ×ª×•× ×™× ×”×¢×“×›× ×™×™× ×‘×™×•×ª×¨
    saveRawDataToDB().then(() => {
        console.log('ğŸ“‚ ×¤×•×ª×— ××•×“×•×œ ×©×œ×™×¤×•×ª...');
        window.open('population_query.html', '_blank');
    }).catch(error => {
        console.error('âŒ ×©×’×™××”:', error);
        alert('×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™×. × ×¡×™ ×©×•×‘.');
    });
}
    </script>
    <!-- ×¡×¨×’×œ ×—×¨×™×’×™× -->
    <div class="exceptions-sidebar" id="exceptionsSidebar">
        <h2>ğŸ“Š ×—×¨×™×’×™×</h2>
        
        <div class="exception-stat exception-new" onclick="openDetailPanel('new')">
            <div class="exception-stat-number" id="newCount">0</div>
            <div class="exception-stat-label">ğŸ†• ×—×¨×™×’×™× ×—×“×©×™×</div>
        </div>
        <!-- ×¤×™×œ×•×— ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª -->
<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
    <h3 style="font-size: 1em; margin-bottom: 10px;">ğŸ“Š ×¤×™×œ×•×— ×œ×¤×™ ×¡×•×’:</h3>
    <div id="exceptionsBreakdown" style="font-size: 0.85em; line-height: 1.8;">
        <!-- ×™×ª××œ× ×“×™× ××™×ª -->
    </div>
</div>
        <div class="exception-stat exception-existing" onclick="openDetailPanel('existing')">
            <div class="exception-stat-number" id="existingCount">0</div>
            <div class="exception-stat-label">â†”ï¸ ×—×¨×™×’×™× ×§×™×™××™×</div>
        </div>
        
        <div class="exception-stat exception-resolved" onclick="openDetailPanel('resolved')">
            <div class="exception-stat-number" id="resolvedCount">0</div>
            <div class="exception-stat-label">âœ… ×—×¨×™×’×™× ×©× ×¤×ª×¨×•</div>
        </div>
        
        <button class="btn-sidebar" onclick="openDetailPanel('all')">
            ğŸ“‹ ×”×¦×’ ×”×›×œ
        </button>
        <div class="exception-stat exception-resolved" onclick="openDetailPanel('resolved')">
            <div class="exception-stat-number" id="resolvedCount">0</div>
            <div class="exception-stat-label">âœ… ×—×¨×™×’×™× ×©× ×¤×ª×¨×•</div>
        </div>
        
        <button class="btn-sidebar" onclick="openDetailPanel('all')">
            ğŸ“‹ ×”×¦×’ ×”×›×œ
        </button>
        
        <!-- ×¤×™×œ×•×— ××¤×•×¨×˜ -->
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
            <h3 style="font-size: 1em; margin-bottom: 10px;">ğŸ“Š ×¤×™×œ×•×— ×œ×¤×™ ×¡×•×’:</h3>
            <div id="exceptionsBreakdown" style="font-size: 0.85em; line-height: 1.8;">
                <!-- ×™×•×•×¦×¨ ×“×™× ××™×ª -->
            </div>
        </div>
        
        <div class="snapshots-list">
            <h3 style="font-size: 1.1em; margin-bottom: 10px;">ğŸ“¸ Snapshots</h3>
            <div id="snapshotsList">
                <!-- ×™×•×•×¦×¨ ×“×™× ××™×ª -->
            </div>
            <button class="btn-sidebar" onclick="compareSnapshots()" style="background: #9b59b6;">
                ğŸ”„ ×”×©×•×•×” Snapshots
            </button>
            <button class="btn-sidebar" onclick="deleteAllSnapshots()" style="background: #e74c3c; margin-top: 5px;">
    ğŸ—‘ï¸ ××—×§ ××ª ×›×œ ×”-Snapshots
</button>
        </div>
    </div>

    <!-- ×¤×× ×œ ××¤×•×¨×˜ -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-panel-header">
            <h2 id="detailPanelTitle">ğŸ“‹ ×—×¨×™×’×™× ××¤×•×¨×˜×™×</h2>
            <button class="detail-panel-close" onclick="closeDetailPanel()">Ã—</button>
        </div>
        <div class="detail-panel-content" id="detailPanelContent">
            <!-- ×ª×•×›×Ÿ ×™×™×•×•×¦×¨ ×“×™× ××™×ª -->
        </div>
    </div>
   <!-- ×¡×¨×’×œ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×××œ×™ - ××™× ×˜×¨××§×˜×™×‘×™ -->
<div class="stats-sidebar" id="statsSidebar">
    <h2>ğŸ“Š × ×™×ª×•×— × ×ª×•× ×™×</h2>
    
    <!-- ×˜××‘: ×©×•×˜×£ (91090) -->
    <div class="stats-tab-section">
        <div class="stats-tab-header" onclick="toggleStatsTab('tab91090Stats'); filterByCategory('ALL_91090')">
            <span class="stats-tab-title">ğŸ“ˆ ×©×•×˜×£</span>
            <span class="stats-tab-count" id="count91090Total">0</span>
            <span class="stats-tab-arrow" id="arrow91090Stats">â–¼</span>
        </div>
        
        <div class="stats-tab-content" id="tab91090Stats">
            <!-- ×¤× ×¡×™×•× ×™ -->
            <div class="stats-category-item" onclick="toggleStatsSubTab('subPension'); filterByCategory('PENSION')">
                <span class="stats-item-icon">ğŸ”§</span>
                <span class="stats-item-label">×©×™× ×•×™ ×¤× ×¡×™×•× ×™</span>
                <span class="stats-item-count" id="countPension">0</span>
                <span class="stats-sub-arrow" id="arrowPension">â–¸</span>
            </div>
            
            <div class="stats-sub-content" id="subPension">
                <div class="stats-sub-item" onclick="filterByCategory('PENSION_GRADE')">
                    <span class="stats-sub-label">â”œâ”€ ×“×¨×’×”/×“×™×¨×•×’</span>
                    <span class="stats-sub-count" id="countPensionGrade">0</span>
                </div>
                <div class="stats-sub-item" onclick="filterByCategory('PENSION_SENIORITY')">
                    <span class="stats-sub-label">â”œâ”€ ×•×ª×§</span>
                    <span class="stats-sub-count" id="countPensionSeniority">0</span>
                </div>
                <div class="stats-sub-item" onclick="filterByCategory('PENSION_POSITION')">
                    <span class="stats-sub-label">â”œâ”€ ×ª×¤×§×™×“</span>
                    <span class="stats-sub-count" id="countPensionPosition">0</span>
                </div>
                <!-- ××¢××“ ×ª×¢×¡×•×§×ª×™ - ×—×“×©! -->
        <div class="stats-sub-item" onclick="filterByCategory('PENSION_STATUS')">
            <span class="stats-item-label">â”œâ”€ ğŸ‘¤ ××¢××“ ×ª×¢×¡×•×§×ª×™</span>
            <span class="stats-item-count" id="countPensionStatus">0</span>
        </div>
                <div class="stats-sub-item" onclick="filterByCategory('PENSION_RESEARCH')">
                    <span class="stats-sub-label">â””â”€ ×¢×•×‘×“×™ ××—×§×¨</span>
                    <span class="stats-sub-count" id="countPensionResearch">0</span>
                </div>
            </div>
            
            <!-- ×©×¢×•×ª × ×•×¡×¤×•×ª -->
          <div class="stats-category-item" onclick="filterByCategory('OVERTIME')">
                <span class="stats-item-icon">â°</span>
                <span class="stats-item-label">×©×¢×•×ª × ×•×¡×¤×•×ª</span>
                <span class="stats-item-count" id="countOvertime">0</span>
            </div>
            
            <!-- ×”×•×¦××•×ª -->
            <div class="stats-category-item" onclick="filterByCategory('EXPENSES')">
                <span class="stats-item-icon">ğŸ’µ</span>
                <span class="stats-item-label">×”×—×–×¨×™ ×”×•×¦××•×ª</span>
                <span class="stats-item-count" id="countExpenses">0</span>
            </div>
            
           <!-- ×ª×©×œ×•× ×—×“ ×¤×¢××™ -->
<div class="stats-category-item" onclick="toggleStatsSubTab('subOneTime'); filterByCategory('ONE_TIME')">
    <span class="stats-item-icon">ğŸ’³</span>
    <span class="stats-item-label">×ª×©×œ×•× ×—×“ ×¤×¢××™</span>
    <span class="stats-item-count" id="countOneTime">0</span>
    <span class="stats-sub-arrow" id="arrowOneTime">â–¸</span>
</div>

<div class="stats-sub-content" id="subOneTime">
    <div class="stats-sub-item" onclick="filterByCategory('ONE_TIME_VEHICLE')">
        <span class="stats-sub-label">â”œâ”€ ğŸš— ×‘×™×˜×•×— ×¨×›×‘</span>
        <span class="stats-sub-count" id="countOneTimeVehicle">0</span>
    </div>
    <div class="stats-sub-item" onclick="filterByCategory('ONE_TIME_HEALTH')">
        <span class="stats-sub-label">â”œâ”€ ğŸ’Š ×”×‘×¨××”</span>
        <span class="stats-sub-count" id="countOneTimeHealth">0</span>
    </div>
    <div class="stats-sub-item" onclick="filterByCategory('ONE_TIME_JUBILEE')">
        <span class="stats-sub-label">â”œâ”€ ğŸ‰ ××¢× ×§ ×™×•×‘×œ</span>
        <span class="stats-sub-count" id="countOneTimeJubilee">0</span>
    </div>
    <div class="stats-sub-item" onclick="filterByCategory('ONE_TIME_CLOTHING')">
        <span class="stats-sub-label">â”œâ”€ ğŸ‘” ×‘×™×’×•×“</span>
        <span class="stats-sub-count" id="countOneTimeClothing">0</span>
    </div>
    <div class="stats-sub-item" onclick="filterByCategory('ONE_TIME_OTHER')">
        <span class="stats-sub-label">â””â”€ ğŸ’µ ××—×¨</span>
        <span class="stats-sub-count" id="countOneTimeOther">0</span>
    </div>
</div>
            <!-- ××¦×‘ ××©×¤×—×ª×™/×™×œ×“×™× - ×—×“×©! -->
    <div class="stats-category-item" onclick="filterByCategory('FAMILY_STATUS')">
        <span class="stats-item-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
        <span class="stats-item-label">××¦×‘ ××©×¤×—×ª×™/×™×œ×“×™×</span>
        <span class="stats-item-count" id="countFamilyStatus">0</span>
    </div>
            <!-- ×¢×•×‘×“×™× ×—×“×©×™× - ×—×“×©! -->
    <div class="stats-category-item" onclick="filterByCategory('NEW')">
        <span class="stats-item-icon">ğŸ†•</span>
        <span class="stats-item-label">×¢×•×‘×“×™× ×—×“×©×™×</span>
        <span class="stats-item-count" id="countNewEmployees">0</span>
    </div>
    
    <!-- ×¢×•×‘×“×™× ××•×¤×¡×§×™× - ×—×“×©! -->
    <div class="stats-category-item" onclick="filterByCategory('TERMINATED')">
        <span class="stats-item-icon">ğŸšª</span>
        <span class="stats-item-label">×¢×•×‘×“×™× ××•×¤×¡×§×™×</span>
        <span class="stats-item-count" id="countTerminatedEmployees">0</span>
    </div>
            <!-- ×œ×œ× ×”×¡×‘×¨ -->
            <div class="stats-category-item stats-item-warning" onclick="filterByCategory('UNKNOWN_91090')">
                <span class="stats-item-icon">âš ï¸</span>
                <span class="stats-item-label">×œ×œ× ×”×¡×‘×¨</span>
                <span class="stats-item-count" id="countUnknown91090">0</span>
            </div>
        </div>
    </div>
    
 <!-- ×˜××‘: ×”×¤×¨×©×™× (91091) -->
<div class="stats-tab-section">
    <div class="stats-tab-header" onclick="toggleStatsTab('tab91091Stats'); filterByCategory('ALL_91091')">
        <span class="stats-tab-title">ğŸ’° ×”×¤×¨×©×™×</span>
        <span class="stats-tab-count" id="count91091Total">0</span>
        <span class="stats-tab-arrow" id="arrow91091Stats">â–¼</span>
    </div>
    
<div class="stats-tab-content" id="tab91091Stats">
        <!-- ×¨×˜×¨×•××§×˜×™×‘×™ ×“×¨×’×” -->
        <div class="stats-category-item" onclick="event.stopPropagation(); filterByCategory('RETRO_GRADE')">
            <span class="stats-item-icon">ğŸ”™</span>
            <span class="stats-item-label">×¨×˜×¨×• - ×“×¨×’×”</span>
            <span class="stats-item-count" id="countRetroGrade">0</span>
        </div>
        
        <!-- ×¨×˜×¨×•××§×˜×™×‘×™ ×•×ª×§ -->
        <div class="stats-category-item" onclick="event.stopPropagation(); filterByCategory('RETRO_SENIORITY')">
            <span class="stats-item-icon">ğŸ”™</span>
            <span class="stats-item-label">×¨×˜×¨×• - ×•×ª×§</span>
            <span class="stats-item-count" id="countRetroSeniority">0</span>
        </div>
        
        <!-- ×¨×˜×¨×•××§×˜×™×‘×™ ×ª×¤×§×™×“ -->
        <div class="stats-category-item" onclick="event.stopPropagation(); filterByCategory('RETRO_POSITION')">
            <span class="stats-item-icon">ğŸ”™</span>
            <span class="stats-item-label">×¨×˜×¨×• - ×ª×¤×§×™×“</span>
            <span class="stats-item-count" id="countRetroPosition">0</span>
        </div>
        
        <!-- ×¨×˜×¨×•××§×˜×™×‘×™ ×©×¢×•×ª × ×•×¡×¤×•×ª -->
        <div class="stats-category-item" onclick="event.stopPropagation(); filterByCategory('RETRO_OVERTIME')">
            <span class="stats-item-icon">ğŸ”™</span>
            <span class="stats-item-label">×¨×˜×¨×• - ×©×¢×•×ª × ×•×¡×¤×•×ª</span>
            <span class="stats-item-count" id="countRetroOvertime">0</span>
        </div>
        
        <!-- ×¨×˜×¨×•××§×˜×™×‘×™ ×—×“ ×¤×¢××™ -->
        <div class="stats-category-item" onclick="event.stopPropagation(); filterByCategory('RETRO_ONE_TIME')">
            <span class="stats-item-icon">ğŸ”™</span>
            <span class="stats-item-label">×¨×˜×¨×• - ×—×“ ×¤×¢××™</span>
            <span class="stats-item-count" id="countRetroOneTime">0</span>
        </div>
        <!-- ×¨×˜×¨×•××§×˜×™×‘×™ ×ª×¢×¨×™×£ â† ×—×¡×¨! -->
<div class="stats-category-item" onclick="event.stopPropagation(); filterByCategory('RETRO_TARIFF')">
    <span class="stats-item-icon">ğŸ”™</span>
    <span class="stats-item-label">×¨×˜×¨×• - ×ª×¢×¨×™×£</span>
    <span class="stats-item-count" id="countRetroTariff">0</span>
</div>

<!-- ×¨×˜×¨×•××§×˜×™×‘×™ ×”×•×¦××•×ª â† ×—×¡×¨! -->
<div class="stats-category-item" onclick="event.stopPropagation(); filterByCategory('RETRO_EXPENSES')">
    <span class="stats-item-icon">ğŸ”™</span>
    <span class="stats-item-label">×¨×˜×¨×• - ×”×•×¦××•×ª</span>
    <span class="stats-item-count" id="countRetroExpenses">0</span>
</div>
        <!-- ×œ×œ× ×”×¡×‘×¨ -->
        <div class="stats-category-item stats-item-warning" onclick="event.stopPropagation(); filterByCategory('UNKNOWN_91091')">
            <span class="stats-item-icon">âš ï¸</span>
            <span class="stats-item-label">×œ×œ× ×”×¡×‘×¨</span>
            <span class="stats-item-count" id="countUnknown91091">0</span>
        </div>
        
    </div>
</div> 
<!-- ×˜××‘: ×”×¤×¨×©×™ ×–×§×™×¤×•×ª -->
<div class="stats-tab-section">
    <div class="stats-tab-header" onclick="toggleStatsTab('tabZikufimStats'); filterByCategory('ALL_ZIKUFIM')">
        <span class="stats-tab-title">ğŸš— ×”×¤×¨×©×™ ×–×§×™×¤×•×ª</span>
        <span class="stats-tab-count" id="countZikufimTotal">0</span>
        <span class="stats-tab-arrow" id="arrowZikufimStats">â–¼</span>
    </div>
    
    <div class="stats-tab-content" id="tabZikufimStats">
        <div class="stats-category-item" onclick="filterByCategory('ZIKUF_VEHICLE')">
            <span class="stats-item-icon">ğŸš—</span>
            <span class="stats-item-label">×©×•×•×™ ×¨×›×‘</span>
            <span class="stats-item-count" id="countZikufVehicle">0</span>
        </div>
    </div>
</div>
</body>
</html>
