<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×‘×§×¨×ª ×©×›×¨ - ×’×¨×¡×” ××œ××”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .section { padding: 30px; border-bottom: 1px solid #e9ecef; }
        .section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5em; }
        .folder-select-area {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border: 3px dashed #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .folder-select-area:hover { border-color: #3498db; background: #e3f2fd; }
        .folder-select-area.loaded { border-color: #27ae60; background: #d5f4e6; }
        .folder-icon { font-size: 4em; margin-bottom: 15px; }
        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-success { background: #27ae60; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 1em; opacity: 0.9; }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .filter-item { display: flex; flex-direction: column; }
        .filter-item label { font-weight: bold; color: #555; margin-bottom: 5px; }
        .filter-item input, .filter-item select { padding: 10px; border: 2px solid #ddd; border-radius: 5px; }
        .table-container { overflow-x: auto; margin-top: 20px; max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; }
        tr:hover { background: #f8f9fa; }
        .status-green { background: #d5f4e6; color: #27ae60; font-weight: bold; }
        .status-red { background: #fadbd8; color: #e74c3c; font-weight: bold; }
        .hidden { display: none; }
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; }
        .message.success { background: #d5f4e6; color: #27ae60; border: 2px solid #27ae60; }
        .message.error { background: #fadbd8; color: #e74c3c; border: 2px solid #e74c3c; }
        .message.info { background: #e3f2fd; color: #3498db; border: 2px solid #3498db; }
        /* ×›×¤×ª×•×¨ ×¦×£ */
.float-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    font-size: 1.5em;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
    transition: all 0.3s;
    z-index: 1000;
    display: none;
}

.float-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 30px rgba(231, 76, 60, 0.6);
}

.float-btn-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #f39c12;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7em;
    font-weight: bold;
}

/* ×¤×× ×œ ×¦×“ */
.side-panel {
    position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 20px rgba(0,0,0,0.3);
    transition: right 0.3s;
    z-index: 2000;
    overflow-y: auto;
}

.side-panel.open {
    right: 0;
}

.side-panel-header {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.side-panel-close {
    background: none;
    border: none;
    color: white;
    font-size: 2em;
    cursor: pointer;
}

.side-panel-content {
    padding: 20px;
}

.review-item {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
}

.review-item.warning {
    border-color: #f39c12;
    background: #fff3cd;
}

.review-item.error {
    border-color: #e74c3c;
    background: #fadbd8;
}

.review-notes {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 5px;
    margin: 10px 0;
    min-height: 60px;
    font-family: inherit;
}

.review-approve {
    background: #27ae60;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 5px;
}

.review-approve:hover {
    background: #229954;
}

.review-approved {
    background: #d5f4e6;
    border-color: #27ae60;
}

    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ××¢×¨×›×ª ×‘×§×¨×ª ×©×›×¨ - ×’×¨×¡×” ××œ××”</h1>
            <p>× ×™×ª×•×— ××¤×•×¨×˜ ×©×œ ×©×™× ×•×™×™× ×‘×ª×©×œ×•××™× ×©×•×˜×¤×™× ×¢× ×”×¡×‘×¨×™× ××•×˜×•××˜×™×™×</p>
        </div>

        <div class="section">
            <h2>ğŸ“‚ ×˜×¢×™× ×ª × ×ª×•× ×™×</h2>
            <div class="folder-select-area" id="fileArea" onclick="document.getElementById('fileInput').click()">
                <div class="folder-icon">ğŸ“„</div>
                <h3>×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥ Excel</h3>
                <p>×§×•×‘×¥ ×”××™×•×¦× ××”-View: V_SALARY_RAW_DATA</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            <div id="loadMessage"></div>
        </div>

        <div class="section hidden" id="statsSection">
            <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalEmployees">0</div>
                    <div class="stat-label">×¡×š ×”×›×œ ×¢×•×‘×“×™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="employeesWithChange">0</div>
                    <div class="stat-label">×¢×•×‘×“×™× ×¢× ×©×™× ×•×™ ×‘×©×•×˜×£</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="explained">0</div>
                    <div class="stat-label">× ××¦× ×”×¡×‘×¨ âœ…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unexplained">0</div>
                    <div class="stat-label">×œ×œ× ×”×¡×‘×¨ âš ï¸</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
    <div class="stat-number" id="newEmployees">0</div>
    <div class="stat-label">×¢×•×‘×“×™× ×—×“×©×™× ğŸ†•</div>
</div>
<div class="stat-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
    <div class="stat-number" id="terminatedEmployees">0</div>
    <div class="stat-label">×¢×•×‘×“×™× ××•×¤×¡×§×™× â›”</div>
</div>
            </div>
        </div>

        <div class="section hidden" id="filtersSection">
            <h2>ğŸ” ×¡×™× ×•× ×™×</h2>
            <div class="filters-grid">
                <div class="filter-item">
                    <label>××¡×¤×¨ ×¢×•×‘×“</label>
                    <input type="text" id="filterEmployee" placeholder="×”×§×œ×“ ××¡×¤×¨ ×–×”×•×ª">
                </div>
                <div class="filter-item">
                    <label>××©×¨×“</label>
                    <select id="filterOffice"><option value="">×›×œ ×”××©×¨×“×™×</option></select>
                </div>
                <div class="filter-item">
                    <label>×¡×˜×˜×•×¡</label>
                    <select id="filterStatus">
                        <option value="">×”×›×œ</option>
                        <option value="GREEN">× ××¦× ×”×¡×‘×¨ âœ…</option>
                        <option value="RED">×œ×œ× ×”×¡×‘×¨ âŒ</option>
                    </select>
                </div>
               <div class="filter-item">
    <label>×¡×™×‘×ª ×©×™× ×•×™</label>
    <select id="filterReason">
        <option value="">×›×œ ×”×¡×™×‘×•×ª</option>
        <option value="NEW">×¢×•×‘×“ ×—×“×© ğŸ†•</option>
        <option value="TERMINATED">×¢×•×‘×“ ××•×¤×¡×§ â›”</option>
        <option value="PENSION">×©×™× ×•×™ ×¤× ×¡×™×•× ×™ (×›×•×œ×œ)</option>
        <option value="PENSION_GRADE">â”œâ”€ ×©×™× ×•×™ ×“×¨×’×”/×“×™×¨×•×’</option>
        <option value="PENSION_SENIORITY">â”œâ”€ ×©×™× ×•×™ ×•×ª×§</option>
        <option value="PENSION_UNEXPLAINED">â””â”€ ×œ×œ× ×”×¡×‘×¨ × ×•×¡×£</option>
        <option value="OVERTIME">×©×¢×•×ª × ×•×¡×¤×•×ª</option>
        <option value="EXPENSES">×”×—×–×¨×™ ×”×•×¦××•×ª</option>
        <option value="ONE_TIME">×ª×©×œ×•× ×—×“ ×¤×¢××™</option>
        <option value="UNKNOWN">×œ×œ× ×”×¡×‘×¨</option>
    </select>
</div>
            </div>
            <button class="btn-primary" onclick="applyFilters()">ğŸ” ×¡× ×Ÿ</button>
            <button class="btn-primary btn-success" onclick="exportToExcel()">ğŸ“¥ ×™×™×¦×•× ×œExcel</button>
        </div>

        <div class="section hidden" id="resultsSection">
            <h2>ğŸ“‹ ×ª×•×¦××•×ª - ×¢×•×‘×“×™× ×¢× ×©×™× ×•×™ ×‘×©×•×˜×£ (91090)</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>××¡×¤×¨ ×–×”×•×ª</th>
                            <th>××©×¨×“</th>
                            <th>×©×•×˜×£ × ×•×›×—×™</th>
                            <th>×©×•×˜×£ ×§×•×“×</th>
                            <th>×©×™× ×•×™</th>
                            <th>×¡×™×‘×ª ×©×™× ×•×™</th>
                            <th>×”×¡×‘×¨ ××¤×•×¨×˜</th>
                            <th>×¡×˜×˜×•×¡</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        // ============================================
        let rawData = [];              // ×›×œ ×”× ×ª×•× ×™× ×”×’×•×œ××™×™× ××”×§×•×‘×¥
        let employeesData = {};        // × ×ª×•× ×™× ×××•×¨×’× ×™× ×œ×¤×™ ×¢×•×‘×“
        let analysisResults = [];      // ×ª×•×¦××•×ª ×”× ×™×ª×•×—
        let currentMonth = null;       // ×—×•×“×© × ×•×›×—×™
        let previousMonth = null;      // ×—×•×“×© ×§×•×“×

        // ============================================
        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
        // ============================================

        function showMessage(elementId, text, type) {
            document.getElementById(elementId).innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function formatCurrency(number) {
            return number.toLocaleString('he-IL', { minimumFractionDigits: 2 }) + ' â‚ª';
        }

        function formatChange(number) {
            return number.toLocaleString('he-IL', { minimumFractionDigits: 2, signDisplay: 'always' }) + ' â‚ª';
        }

        // ============================================
        // ×˜×¢×™× ×ª ×§×•×‘×¥
        // ============================================

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) {
                showMessage('loadMessage', '×œ× × ×‘×—×¨ ×§×•×‘×¥', 'error');
                return;
            }

            showMessage('loadMessage', 'â³ ×˜×•×¢×Ÿ ×§×•×‘×¥ ×•×× ×ª×— × ×ª×•× ×™×...', 'info');

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                rawData = XLSX.utils.sheet_to_json(firstSheet);

                console.log(`âœ… × ×˜×¢× ×• ${rawData.length} ×¨×©×•××•×ª ×’×•×œ××™×•×ª`);

                identifyMonths();
                organizeDataByEmployee();
                analyzeData();
                updateUIAfterLoad();

            } catch (error) {
                console.error('âŒ ×©×’×™××”:', error);
                showMessage('loadMessage', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ' + error.message, 'error');
            }
        });

        // ============================================
        // ×–×™×”×•×™ ×—×•×“×©×™× (× ×•×›×—×™/×§×•×“×)
        // ============================================

        function identifyMonths() {
            const uniqueDates = [...new Set(rawData.map(row => row.SALARY_DATE))].sort();
            
            if (uniqueDates.length >= 2) {
                previousMonth = uniqueDates[0];
                currentMonth = uniqueDates[uniqueDates.length - 1];
            } else if (uniqueDates.length === 1) {
                currentMonth = uniqueDates[0];
                previousMonth = null;
                showMessage('loadMessage', 'âš ï¸ × ××¦× ×¨×§ ×—×•×“×© ××—×“ - ×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ×”×©×•×•××”', 'error');
            } else {
                showMessage('loadMessage', 'âŒ ×œ× × ××¦××• ×ª××¨×™×›×™× ×ª×§×™× ×™× ×‘×§×•×‘×¥', 'error');
                return;
            }

            console.log(`ğŸ“… ×—×•×“×© × ×•×›×—×™: ${currentMonth}, ×—×•×“×© ×§×•×“×: ${previousMonth}`);
        }

        // ============================================
        // ××¨×’×•×Ÿ × ×ª×•× ×™× ×œ×¤×™ ×¢×•×‘×“ - ×©××™×¨×ª ×›×œ ×”×©×“×•×ª!
        // ============================================

        function organizeDataByEmployee() {
            employeesData = {};

            rawData.forEach(row => {
                const empId = row.id_num;

                // ×™×¦×™×¨×ª ×¨×©×•××ª ×¢×•×‘×“ ×× ×œ× ×§×™×™××ª
                if (!employeesData[empId]) {
                    employeesData[empId] = {
                        id_num: empId,
                        office_num: row.OFFICE_NUM,
                        current: {
                            elements: {},      // AMOUNT
                            quantities: {},    // QUANTITY
                            percentages: {},   // PERCENTAGE
                            tariffs: {},       // TARIFF
                            elementNames: {},  // ELEMENT_NAME
                            salaryDates: {},   // SALARY_DATE
                            referenceDates: {} // REFERENCE_DATE
                        },
                        previous: {
                            elements: {},
                            quantities: {},
                            percentages: {},
                            tariffs: {},
                            elementNames: {},
                            salaryDates: {},
                            referenceDates: {}
                        }
                    };
                }

                // ×§×‘×™×¢×ª ×¡×•×’ ×—×•×“×©
                const monthType = row.SALARY_DATE === currentMonth ? 'current' : 'previous';
                const elementNum = row.SALARY_ELEMENT_NUM;

                // ×©××™×¨×ª ×›×œ ×”×©×“×•×ª!
                employeesData[empId][monthType].elements[elementNum] = row.AMOUNT || 0;
                employeesData[empId][monthType].quantities[elementNum] = row.QUANTITY || 0;
                employeesData[empId][monthType].percentages[elementNum] = row.PERCENTAGE || 0;
                employeesData[empId][monthType].tariffs[elementNum] = row.TARIFF || 0;
                employeesData[empId][monthType].elementNames[elementNum] = row.ELEMENT_NAME || '';
                employeesData[empId][monthType].salaryDates[elementNum] = row.SALARY_DATE || '';
                employeesData[empId][monthType].referenceDates[elementNum] = row.REFERENCE_DATE || '';
            });

            console.log(`ğŸ‘¥ ×××•×¨×’× ×™× ${Object.keys(employeesData).length} ×¢×•×‘×“×™×`);
        }

        // ============================================
        // × ×™×ª×•×— × ×ª×•× ×™×
        // ============================================

        function analyzeData() {
            analysisResults = [];

  Object.values(employeesData).forEach(employee => {
        // ×©×œ×™×¤×ª ×¡×›×•××™ ×©×•×˜×£ (91090)
        const current_91090 = employee.current.elements[91090] || 0;
        const previous_91090 = employee.previous.elements[91090] || 0;
        const change = current_91090 - previous_91090;

        // ======================================
        // ×–×™×”×•×™ ×¢×•×‘×“ ×—×“×© / ××•×¤×¡×§
        // ======================================
        
        // ×¢×•×‘×“ ××•×¤×¡×§: ×—×•×“×© × ×•×›×—×™ = 0
        if (current_91090 === 0 && previous_91090 > 0) {
            analysisResults.push({
                id_num: employee.id_num,
                office_num: employee.office_num,
                current_regular: 0,
                previous_regular: previous_91090,
                change: -previous_91090,
                reason_code: 'TERMINATED',
                reason_text: '×¢×•×‘×“ ××•×¤×¡×§',
                explanation_detail: '×¢×•×‘×“ ×”×•×¤×¡×§ - ××™×Ÿ ×ª×©×œ×•× ×‘×—×•×“×© × ×•×›×—×™',
                status: 'TERMINATED'
            });
            return; // ×œ× ×××©×™×›×™× ×œ×‘×“×™×§×•×ª
        }

        // ×¢×•×‘×“ ×—×“×©: ×—×•×“×© ×§×•×“× = 0
        if (previous_91090 === 0 && current_91090 > 0) {
            analysisResults.push({
                id_num: employee.id_num,
                office_num: employee.office_num,
                current_regular: current_91090,
                previous_regular: 0,
                change: current_91090,
                reason_code: 'NEW',
                reason_text: '×¢×•×‘×“ ×—×“×©',
                explanation_detail: '×¢×•×‘×“ ×—×“×© - ×œ× ×”×™×” ×ª×©×œ×•× ×‘×—×•×“×© ×§×•×“×',
                status: 'NEW'
            });
            return; // ×œ× ×××©×™×›×™× ×œ×‘×“×™×§×•×ª
        }
                // × ×™×ª×•×— ×¨×§ ×× ×™×© ×©×™× ×•×™
                if (Math.abs(change) > 0.01) {
                    // ××¦×™××ª ×”×¡×‘×¨ ×œ×©×™× ×•×™ - ×¤×•× ×§×¦×™×” × ×¤×¨×“×ª!
                    const explanation = findExplanation(employee);
                    
                    analysisResults.push({
                        id_num: employee.id_num,
                        office_num: employee.office_num,
                        current_regular: current_91090,
                        previous_regular: previous_91090,
                        change: change,
                        reason_code: explanation.code,
                        reason_text: explanation.text,
                        explanation_detail: explanation.detail,
                        status: explanation.status
                    });
                }
            });

            console.log(`ğŸ” × ××¦××• ${analysisResults.length} ×¢×•×‘×“×™× ×¢× ×©×™× ×•×™ ×‘×©×•×˜×£`);
        }

        // ============================================
        // ×¤×•× ×§×¦×™×” × ×¤×¨×“×ª ×œ××¦×™××ª ×”×¡×‘×¨!
        // ============================================

        // ============================================
// ×¤×•× ×§×¦×™×” × ×¤×¨×“×ª ×œ××¦×™××ª ×”×¡×‘×¨ - ×’×¨×¡×” ××ª×•×§× ×ª!
// ============================================
// ============================================
// ×¤×•× ×§×¦×™×” ×œ× ×™×ª×•×— ×ª×©×œ×•××™× ×—×“ ×¤×¢××™×™× (91013)
// ============================================

function analyzeOneTimePayments(employee) {
    const empId = employee.id_num;
    
    // ××¦×™××ª ×›×œ ×”×¨×©×•××•×ª ×©×œ 91013 ×¢×‘×•×¨ ×¢×•×‘×“ ×–×”
    // ×¨×§ ×ª×©×œ×•××™× ×©×•×˜×¤×™×: SALARY_DATE = REFERENCE_DATE
    const emp91013Records = rawData.filter(row => 
        row.id_num === empId && 
        row.SALARY_ELEMENT_NUM === 91013 &&
        row.SALARY_DATE === row.REFERENCE_DATE
    );
    
    console.log(`ğŸ” ×¢×•×‘×“ ${empId}: × ××¦××• ${emp91013Records.length} ×¨×©×•××•×ª 91013 ×©×•×˜×¤×•×ª`);
    
    if (emp91013Records.length === 0) {
        return '×ª×©×œ×•× ×—×“ ×¤×¢××™ - ×œ× × ××¦××• ×ª×©×œ×•××™× ×©×•×˜×¤×™×';
    }
    
    // ×§×™×‘×•×¥ ×œ×¤×™ ×—×•×“×© ×¢×¨×š (REFERENCE_DATE)
    const byReferenceDate = {};
    
    emp91013Records.forEach(record => {
        const refDate = record.REFERENCE_DATE || '';
        const quantity = record.QUANTITY || 0;
        const amount = record.AMOUNT || 0;
        
        console.log(`  ğŸ“Œ QUANTITY=${quantity}, AMOUNT=${amount}, REF_DATE=${refDate}`);
        
        // ×”×ª×¢×œ× ××¡××œ×™× 8000-9000
        if (quantity >= 8000 && quantity <= 9000) {
            console.log(`  â­ï¸  ××ª×¢×œ× ××¡××œ ${quantity} (×˜×•×•×— 8000-9000)`);
            return;
        }
        
        if (!byReferenceDate[refDate]) {
            byReferenceDate[refDate] = {
                carInsurance: { symbols: [], total: 0 },
                health: { symbols: [], total: 0 },
                clothing: { symbols: [], total: 0 },
                other: { symbols: [], total: 0 }
            };
        }
        
        // ×¡×™×•×•×’ ×œ×¤×™ QUANTITY
        if ([1491, 1492, 1493].includes(quantity)) {
            byReferenceDate[refDate].carInsurance.symbols.push(quantity);
            byReferenceDate[refDate].carInsurance.total += amount;
            console.log(`  ğŸš— ×‘×™×˜×•×— ×¨×›×‘: +${amount}`);
        } else if (quantity === 1342) {
            byReferenceDate[refDate].health.symbols.push(quantity);
            byReferenceDate[refDate].health.total += amount;
            console.log(`  ğŸ’Š ×”×‘×¨××”: +${amount}`);
        } else if (quantity === 1320) {
            byReferenceDate[refDate].clothing.symbols.push(quantity);
            byReferenceDate[refDate].clothing.total += amount;
            console.log(`  ğŸ‘” ×‘×™×’×•×“: +${amount}`);
        } else {
            byReferenceDate[refDate].other.symbols.push(quantity);
            byReferenceDate[refDate].other.total += amount;
            console.log(`  â“ ××—×¨ (${quantity}): +${amount}`);
        }
    });
    
    // ×‘× ×™×™×ª ×”×¡×‘×¨
    const explanations = [];
    
    Object.keys(byReferenceDate).sort().forEach(refDate => {
        const data = byReferenceDate[refDate];
        
        // ×‘×™×˜×•×— ×¨×›×‘
        if (data.carInsurance.total > 0) {
            explanations.push(
                `×‘×™×˜×•×— ×¨×›×‘ - ${data.carInsurance.total.toFixed(2)} â‚ª (×¡××œ×™×: ${data.carInsurance.symbols.join(', ')})`
            );
        }
        
        // ×”×‘×¨××”
        if (data.health.total > 0) {
            explanations.push(
                `×”×‘×¨××” - ${data.health.total.toFixed(2)} â‚ª`
            );
        }
        
        // ×‘×™×’×•×“
        if (data.clothing.total > 0) {
            explanations.push(
                `×‘×™×’×•×“ - ${data.clothing.total.toFixed(2)} â‚ª`
            );
        }
        
        // ××—×¨
        if (data.other.symbols.length > 0) {
            const uniqueSymbols = [...new Set(data.other.symbols)];
            uniqueSymbols.forEach(sym => {
                explanations.push(`×ª×©×œ×•× ×—×“ ×¤×¢××™ - ×¡××œ ${sym}`);
            });
        }
    });
    
    const result = explanations.length > 0 ? explanations.join(' | ') : '×ª×©×œ×•× ×—×“ ×¤×¢××™ - ×œ× ×–×•×”×”';
    console.log(`  âœ… ×”×¡×‘×¨ ×¡×•×¤×™: ${result}`);
    
    return result;
}
function findExplanation(employee) {
    const current = employee.current.elements;
    const previous = employee.previous.elements;
    const currentQty = employee.current.quantities;
    const previousQty = employee.previous.quantities;

    // ======================================
    // ======================================
// ×‘×“×™×§×” 1: ×©×™× ×•×™ ×‘×ª×¢×¨×™×£ ××¡×œ (91203)
// ======================================
// ======================================
// ×‘×“×™×§×” 1: ×©×™× ×•×™ ×‘×ª×¢×¨×™×£ ××¡×œ (91203)
// ×—×©×•×‘: ×¨×§ ×ª×©×œ×•× ×©×•×˜×£! (SALARY_DATE = REFERENCE_DATE)
// ======================================

// ×‘×“×™×§×” ×©×–×” ×ª×©×œ×•× ×©×•×˜×£ ×‘×—×•×“×© × ×•×›×—×™
const current_91203_salaryDate = employee.current.salaryDates[91203] || '';
const current_91203_refDate = employee.current.referenceDates[91203] || '';
const isCurrentRegular = current_91203_salaryDate === current_91203_refDate && current_91203_salaryDate !== '';

// ×‘×“×™×§×” ×©×–×” ×ª×©×œ×•× ×©×•×˜×£ ×‘×—×•×“×© ×§×•×“×
const previous_91203_salaryDate = employee.previous.salaryDates[91203] || '';
const previous_91203_refDate = employee.previous.referenceDates[91203] || '';
const isPreviousRegular = previous_91203_salaryDate === previous_91203_refDate && previous_91203_salaryDate !== '';

// ×©×œ×™×¤×ª ×ª×¢×¨×™×£ ×¨×§ ×× ×–×” ×ª×©×œ×•× ×©×•×˜×£
const current_91203 = isCurrentRegular ? (employee.current.tariffs[91203] || 0) : 0;
const previous_91203 = isPreviousRegular ? (employee.previous.tariffs[91203] || 0) : 0;

// ×¨×§ ×× ×©× ×™ ×”×—×•×“×©×™× ×”× ×©×•×˜×¤×™× ×•×™×© ×©×™× ×•×™
if (isCurrentRegular && isPreviousRegular && Math.abs(current_91203 - previous_91203) > 0.01) {
        // ×™×© ×©×™× ×•×™ ×¤× ×¡×™×•× ×™ - × ××©×™×š ×œ×‘×“×•×§ 90144 ×•-90146
        
        let found90144 = false;
        let found90146 = false;
        let explanation = '';

        // ======================================
        // ×‘×“×™×§×ª 90144 - ×“×¨×’×”/×“×™×¨×•×’
        // ======================================
        const current_90144_amt = current[90144] || 0;
        const previous_90144_amt = previous[90144] || 0;
        const current_90144_qty = currentQty[90144] || 0;
        const previous_90144_qty = previousQty[90144] || 0;
        
        const amountChanged = Math.abs(current_90144_amt - previous_90144_amt) > 0.01;
        const quantityChanged = current_90144_qty !== previous_90144_qty;
        
        if (amountChanged || quantityChanged) {
            found90144 = true;
            
            if (amountChanged && quantityChanged) {
                explanation += `×©×™× ×•×™ ×¤× ×¡×™×•× ×™: ×©×™× ×•×™ ×“×™×¨×•×’ (×-${previous_90144_amt.toFixed(2)} ×œ-${current_90144_amt.toFixed(2)}) ×•×“×¨×’×” (×-${previous_90144_qty} ×œ-${current_90144_qty})`;
            } else if (amountChanged) {
                explanation += `×©×™× ×•×™ ×¤× ×¡×™×•× ×™: ×©×™× ×•×™ ×“×™×¨×•×’ ×-${previous_90144_amt.toFixed(2)} ×œ-${current_90144_amt.toFixed(2)}`;
            } else {
                explanation += `×©×™× ×•×™ ×¤× ×¡×™×•× ×™: ×©×™× ×•×™ ×“×¨×’×” ×-${previous_90144_qty} ×œ-${current_90144_qty}`;
            }
        }

        // ======================================
       // ======================================
// ×‘×“×™×§×ª 90146 - ×•×ª×§
// ×¡×•×’ ×”×•×ª×§ = AMOUNT, QUANTITY = ×”×¢×¨×š ×©×”×©×ª× ×”
// ======================================
const current_90146_amt = current[90146] || 0;
const previous_90146_amt = previous[90146] || 0;
const current_90146_qty = currentQty[90146] || 0;
const previous_90146_qty = previousQty[90146] || 0;

if (current_90146_qty !== previous_90146_qty && (current_90146_amt > 0 || previous_90146_amt > 0)) {
    found90146 = true;
    
    if (explanation) {
        explanation += ' + ';
    }
    
    // ×¡×•×’ ×”×•×ª×§ ×-AMOUNT (× ×©×ª××© ×‘×—×•×“×© ×”× ×•×›×—×™, ××• ×§×•×“× ×× ××™×Ÿ × ×•×›×—×™)
    const vatakType = current_90146_amt > 0 ? current_90146_amt : previous_90146_amt;
    
    // ×”×¦×’×ª ×”×©×™× ×•×™ ×‘-QUANTITY
    explanation += `×©×™× ×•×™ ×‘×•×ª×§ ××¡×•×’ ${vatakType} - QUANTITY ×”×©×ª× ×” ×-${previous_90146_qty} ×œ-${current_90146_qty}`;
}

        // ======================================
        // ×× ×œ× × ××¦× 90144 ××• 90146
        // ======================================
        if (!found90144 && !found90146) {
            return {
                code: 'PENSION',
                text: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™',
                detail: `×©×™× ×•×™ ×ª×¢×¨×™×£ ×©×¢×” ×-${previous_91203.toFixed(2)} ×œ-${current_91203.toFixed(2)} ×œ×œ× ×”×¡×‘×¨ × ×•×¡×£`,
                status: 'GREEN'
            };
        }

        // ××¦×× ×• ×”×¡×‘×¨
        return {
            code: 'PENSION',
            text: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™',
            detail: explanation,
            status: 'GREEN'
        };
    }

    // ======================================
    // ×× ××™×Ÿ ×©×™× ×•×™ ×¤× ×¡×™×•× ×™ - ×‘×“×™×§×•×ª ×¨×’×™×œ×•×ª
    // ======================================

// ======================================
    // ×‘×“×™×§×” 4: ×©×™× ×•×™ ×©×¢×•×ª × ×•×¡×¤×•×ª (4720)
    // ×¨×§ ×ª×©×œ×•× ×©×•×˜×£: SALARY_DATE = REFERENCE_DATE
    // ======================================
    
    // ×‘×“×™×§×” ×©×–×” ×ª×©×œ×•× ×©×•×˜×£ ×‘×—×•×“×© × ×•×›×—×™
    const current_4720_salaryDate = employee.current.salaryDates[4720] || '';
    const current_4720_refDate = employee.current.referenceDates[4720] || '';
    const isCurrent4720Regular = current_4720_salaryDate === current_4720_refDate && current_4720_salaryDate !== '';
    
    // ×‘×“×™×§×” ×©×–×” ×ª×©×œ×•× ×©×•×˜×£ ×‘×—×•×“×© ×§×•×“×
    const previous_4720_salaryDate = employee.previous.salaryDates[4720] || '';
    const previous_4720_refDate = employee.previous.referenceDates[4720] || '';
    const isPrevious4720Regular = previous_4720_salaryDate === previous_4720_refDate && previous_4720_salaryDate !== '';
    
    // ×©×œ×™×¤×ª ×¡×›×•× ×¨×§ ×× ×–×” ×ª×©×œ×•× ×©×•×˜×£
    const current_4720 = isCurrent4720Regular ? (current[4720] || 0) : 0;
    const previous_4720 = isPrevious4720Regular ? (previous[4720] || 0) : 0;
    
    // ×× ×™×© ×©×™× ×•×™ ×‘×©×¢×•×ª × ×•×¡×¤×•×ª ×©×•×˜×¤×•×ª
    if ((isCurrent4720Regular || isPrevious4720Regular) && Math.abs(current_4720 - previous_4720) > 0.01) {
        const diff = current_4720 - previous_4720;
        return {
            code: 'OVERTIME',
            text: '×©×™× ×•×™ ×©×¢×•×ª × ×•×¡×¤×•×ª',
            detail: `×©×¢×•×ª × ×•×¡×¤×•×ª ×”×©×ª× ×• ×-${previous_4720.toFixed(2)} ×œ-${current_4720.toFixed(2)} (×”×¤×¨×©: ${diff > 0 ? '+' : ''}${diff.toFixed(2)} â‚ª)`,
            status: 'GREEN'
        };
    }
// ======================================
    // ×‘×“×™×§×” 5: ×©×™× ×•×™ ×”×—×–×¨×™ ×”×•×¦××•×ª (4717)
    // ×¨×§ ×ª×©×œ×•× ×©×•×˜×£: SALARY_DATE = REFERENCE_DATE
    // ======================================
    
    // ×‘×“×™×§×” ×©×–×” ×ª×©×œ×•× ×©×•×˜×£ ×‘×—×•×“×© × ×•×›×—×™
    const current_4717_salaryDate = employee.current.salaryDates[4717] || '';
    const current_4717_refDate = employee.current.referenceDates[4717] || '';
    const isCurrent4717Regular = current_4717_salaryDate === current_4717_refDate && current_4717_salaryDate !== '';
    
    // ×‘×“×™×§×” ×©×–×” ×ª×©×œ×•× ×©×•×˜×£ ×‘×—×•×“×© ×§×•×“×
    const previous_4717_salaryDate = employee.previous.salaryDates[4717] || '';
    const previous_4717_refDate = employee.previous.referenceDates[4717] || '';
    const isPrevious4717Regular = previous_4717_salaryDate === previous_4717_refDate && previous_4717_salaryDate !== '';
    
    // ×©×œ×™×¤×ª ×¡×›×•× ×¨×§ ×× ×–×” ×ª×©×œ×•× ×©×•×˜×£
    const current_4717 = isCurrent4717Regular ? (current[4717] || 0) : 0;
    const previous_4717 = isPrevious4717Regular ? (previous[4717] || 0) : 0;
    
    // ×× ×™×© ×©×™× ×•×™ ×‘×”×—×–×¨×™ ×”×•×¦××•×ª ×©×•×˜×¤×•×ª
    if ((isCurrent4717Regular || isPrevious4717Regular) && Math.abs(current_4717 - previous_4717) > 0.01) {
        const diff = current_4717 - previous_4717;
        return {
            code: 'EXPENSES',
            text: '×”×—×–×¨×™ ×”×•×¦××•×ª',
            detail: `×”×—×–×¨×™ ×”×•×¦××•×ª ×”×©×ª× ×• ×-${previous_4717.toFixed(2)} ×œ-${current_4717.toFixed(2)} (×”×¤×¨×©: ${diff > 0 ? '+' : ''}${diff.toFixed(2)} â‚ª)`,
            status: 'GREEN'
        };
    }
    // ======================================
    // ×‘×“×™×§×” 6 : ×ª×©×œ×•× ×—×“ ×¤×¢××™ (91013)
    // ======================================
    const current_91013 = current[91013] || 0;
    const previous_91013 = previous[91013] || 0;

    if (current_91013 > 0 || previous_91013 > 0) {
        // × ×™×ª×•×— ××¤×•×¨×˜ ×©×œ ×ª×©×œ×•××™× ×—×“ ×¤×¢××™×™×
        const oneTimeAnalysis = analyzeOneTimePayments(employee);
        
        return {
            code: 'ONE_TIME',
            text: '×ª×©×œ×•× ×—×“ ×¤×¢××™',
            detail: oneTimeAnalysis,
            status: 'GREEN'
        };
    }

    // ======================================
    // ×œ× × ××¦× ×”×¡×‘×¨
    // ======================================
    return {
        code: 'UNKNOWN',
        text: '×œ×œ× ×”×¡×‘×¨',
        detail: '×œ× × ××¦× ×”×¡×‘×¨ ×œ×©×™× ×•×™ - ×“×•×¨×© ×‘×“×™×§×” ×™×“× ×™×ª',
        status: 'RED'
    };
}  // â† ×¢×›×©×™×• ×”×¤×•× ×§×¦×™×” ×ª×§×™× ×”!
       // ============================================
        // ×¢×“×›×•×Ÿ UI ××—×¨×™ ×˜×¢×™× ×”
        // ============================================

        function updateUIAfterLoad() {
            document.getElementById('fileArea').classList.add('loaded');
            document.getElementById('fileArea').innerHTML = `
                <div class="folder-icon">âœ…</div>
                <h3>×”×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!</h3>
                <p>${rawData.length} ×¨×©×•××•×ª | ×—×•×“×© × ×•×›×—×™: ${currentMonth} | ×—×•×“×© ×§×•×“×: ${previousMonth}</p>
            `;

            showMessage('loadMessage', 
                `âœ… ${rawData.length} ×¨×©×•××•×ª × ×˜×¢× ×• | ${analysisResults.length} ×¢×•×‘×“×™× ×¢× ×©×™× ×•×™ ×‘×©×•×˜×£`, 
                'success');

            populateOfficeFilter();
            updateStats();
            displayResults();

            document.getElementById('statsSection').classList.remove('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
             updateReviewCount();
        }

        // ============================================
        // ××™×œ×•×™ ×¡×™× ×•×Ÿ ××©×¨×“×™×
        // ============================================

        function populateOfficeFilter() {
            const offices = [...new Set(analysisResults.map(r => r.office_num))].sort((a, b) => a - b);
            const select = document.getElementById('filterOffice');
            select.innerHTML = '<option value="">×›×œ ×”××©×¨×“×™×</option>';
            
            offices.forEach(office => {
                const option = document.createElement('option');
                option.value = office;
                option.textContent = office;
                select.appendChild(option);
            });
        }

        // ============================================
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        // ============================================

       function updateStats() {
    const totalEmployees = Object.keys(employeesData).length;
    const employeesWithChange = analysisResults.length;
    const newEmployees = analysisResults.filter(r => r.status === 'NEW').length;
    const terminatedEmployees = analysisResults.filter(r => r.status === 'TERMINATED').length;
    const explained = analysisResults.filter(r => r.status === 'GREEN').length;
    const unexplained = analysisResults.filter(r => r.status === 'RED').length;

            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('employeesWithChange').textContent = employeesWithChange;
            document.getElementById('explained').textContent = explained;
            document.getElementById('unexplained').textContent = unexplained;
            document.getElementById('newEmployees').textContent = newEmployees;
document.getElementById('terminatedEmployees').textContent = terminatedEmployees;
        }

        // ============================================
        // ×”×¦×’×ª ×ª×•×¦××•×ª
        // ============================================

       function displayResults(filteredData = null) {
    const data = filteredData || analysisResults;
    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding:30px;color:#999;">×œ× × ××¦××• ×ª×•×¦××•×ª</td></tr>';
        return;
    }

    data.forEach(row => {
        const tr = document.createElement('tr');
        
        // ×˜×™×¤×•×œ ×‘×¢×•×‘×“ ×—×“×©/××•×¤×¡×§
        let statusText, changeClass, statusClass;
        
        if (row.status === 'NEW') {
            statusText = 'ğŸ†• ×¢×•×‘×“ ×—×“×©';
            changeClass = 'status-green';
            statusClass = 'status-green';
        } else if (row.status === 'TERMINATED') {
            statusText = 'â›” ×¢×•×‘×“ ××•×¤×¡×§';
            changeClass = 'status-red';
            statusClass = 'status-red';
        } else {
            statusText = row.status === 'GREEN' ? 'âœ… × ××¦× ×”×¡×‘×¨' : 'âŒ ×œ×œ× ×”×¡×‘×¨';
            changeClass = row.change >= 0 ? 'status-green' : 'status-red';
            statusClass = row.status.toLowerCase();
        }
                
                tr.innerHTML = `
            <td>${row.id_num}</td>
            <td>${row.office_num}</td>
            <td>${formatCurrency(row.current_regular)}</td>
            <td>${formatCurrency(row.previous_regular)}</td>
            <td class="${changeClass}">${formatChange(row.change)}</td>
            <td><strong>${row.reason_text}</strong></td>
            <td style="text-align:right;padding-right:20px;">${row.explanation_detail}</td>
            <td class="status-${statusClass}">${statusText}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        // ============================================
        // ×”×—×œ×ª ×¡×™× ×•× ×™×
        // ============================================

      function applyFilters() {
    const filterEmployee = document.getElementById('filterEmployee').value.trim();
    const filterOffice = document.getElementById('filterOffice').value;
    const filterStatus = document.getElementById('filterStatus').value;
    const filterReason = document.getElementById('filterReason').value;

    let filtered = analysisResults.filter(row => {
        if (filterEmployee && !row.id_num.toString().includes(filterEmployee)) return false;
        if (filterOffice && row.office_num.toString() !== filterOffice) return false;
        if (filterStatus && row.status !== filterStatus) return false;
        
        // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×™×‘×ª ×©×™× ×•×™
        if (filterReason) {
            if (filterReason === 'PENSION') {
                // ×›×œ ×”×©×™× ×•×™×™× ×”×¤× ×¡×™×•× ×™×™×
                if (row.reason_code !== 'PENSION') return false;
                
            } else if (filterReason === 'PENSION_GRADE') {
                // ×¨×§ ×¤× ×¡×™×•× ×™ ×¢× ×“×¨×’×”/×“×™×¨×•×’
                if (row.reason_code !== 'PENSION') return false;
                if (!row.explanation_detail.includes('×“×¨×’×”') && 
                    !row.explanation_detail.includes('×“×™×¨×•×’')) return false;
                    
            } else if (filterReason === 'PENSION_SENIORITY') {
                // ×¨×§ ×¤× ×¡×™×•× ×™ ×¢× ×•×ª×§
                if (row.reason_code !== 'PENSION') return false;
                if (!row.explanation_detail.includes('×•×ª×§')) return false;
                
            } else if (filterReason === 'PENSION_UNEXPLAINED') {
                // ×¨×§ ×¤× ×¡×™×•× ×™ ×œ×œ× ×”×¡×‘×¨ × ×•×¡×£
                if (row.reason_code !== 'PENSION') return false;
                if (!row.explanation_detail.includes('×œ×œ× ×”×¡×‘×¨ × ×•×¡×£')) return false;
                
            } else {
                // ×©××¨ ×”×¡×™× ×•× ×™× - ×¨×’×™×œ
                if (row.reason_code !== filterReason) return false;
            }
        }
        
        return true;
    });

    displayResults(filtered);
    showMessage('loadMessage', `ğŸ” × ××¦××• ${filtered.length} ×ª×•×¦××•×ª ××ª××™××•×ª ×œ×¡×™× ×•×Ÿ`, 'info');
}
        // ============================================
        // ×™×™×¦×•× ×œExcel ×¢× ×¡×™×‘×ª ×©×™× ×•×™!
        // ============================================

        function exportToExcel() {
            const data = [];
            const tbody = document.getElementById('resultsBody');
            const rows = tbody.getElementsByTagName('tr');

            // ×›×•×ª×¨×•×ª
            data.push(['××¡×¤×¨ ×–×”×•×ª', '××©×¨×“', '×©×•×˜×£ × ×•×›×—×™', '×©×•×˜×£ ×§×•×“×', '×©×™× ×•×™', '×¡×™×‘×ª ×©×™× ×•×™', '×”×¡×‘×¨ ××¤×•×¨×˜', '×¡×˜×˜×•×¡']);

            // × ×ª×•× ×™×
            Array.from(rows).forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length > 0) {
                    const rowData = Array.from(cells).map(cell => 
                        cell.textContent.replace(' â‚ª', '').replace('âœ… ', '').replace('âŒ ', '')
                    );
                    data.push(rowData);
                }
            });

            // ×™×¦×™×¨×ª workbook
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [
                { wch: 12 }, { wch: 8 }, { wch: 12 }, { wch: 12 }, 
                { wch: 12 }, { wch: 15 }, { wch: 50 }, { wch: 12 }
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '×‘×§×¨×ª ×©×›×¨');

            const fileName = `salary_control_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showMessage('loadMessage', `âœ… ×”×§×•×‘×¥ ${fileName} ×™×•×¦× ×‘×”×¦×œ×—×”!`, 'success');
        }
        // ============================================
// ×‘×“×™×§×ª ×¡×‘×™×¨×•×ª ×©×™× ×•×™×™×
// ============================================

function validateChangeLogic(row) {
    const validations = [];
    
    // ×‘×“×™×§×” 1: ×©×™× ×•×™ ×“×¨×’×”/×“×™×¨×•×’ - ×¦×¤×•×™×” ×¢×œ×™×™×”
    if (row.reason_code === 'PENSION' && 
        (row.explanation_detail.includes('×“×¨×’×”') || row.explanation_detail.includes('×“×™×¨×•×’'))) {
        if (row.change < 0) {
            validations.push({
                severity: 'error',
                reason: `×©×™× ×•×™ ×“×¨×’×”/×“×™×¨×•×’ ××š ×”×©×›×¨ ×™×¨×“ ×‘-${Math.abs(row.change).toFixed(2)} â‚ª`
            });
        }
    }
    
    // ×‘×“×™×§×” 2: ×©×™× ×•×™ ×•×ª×§ - ×¦×¤×•×™×” ×¢×œ×™×™×”
    if (row.reason_code === 'PENSION' && row.explanation_detail.includes('×•×ª×§')) {
        if (row.change < 0) {
            validations.push({
                severity: 'error',
                reason: `×©×™× ×•×™ ×•×ª×§ ××š ×”×©×›×¨ ×™×¨×“ ×‘-${Math.abs(row.change).toFixed(2)} â‚ª`
            });
        }
    }
    
    // ×‘×“×™×§×” 3: ×œ× × ××¦× ×”×¡×‘×¨
    if (row.reason_code === 'UNKNOWN') {
        validations.push({
            severity: 'warning',
            reason: '×œ× × ××¦× ×”×¡×‘×¨ ×œ×©×™× ×•×™ ×‘×©×›×¨'
        });
    }
    
    // ×‘×“×™×§×” 4: ×©×™× ×•×™ ×¤× ×¡×™×•× ×™ ×œ×œ× ×”×¡×‘×¨
    if (row.reason_code === 'PENSION' && row.explanation_detail.includes('×œ×œ× ×”×¡×‘×¨ × ×•×¡×£')) {
        validations.push({
            severity: 'warning',
            reason: '×©×™× ×•×™ ×¤× ×¡×™×•× ×™ ×œ×œ× ×–×™×”×•×™ ×¡×™×‘×” ××“×•×™×§×ª'
        });
    }
    
    return validations;
}

// ============================================
// ×¡×™× ×•×Ÿ ×¨×©×•××•×ª ×œ×‘×“×™×§×” ×™×“× ×™×ª
// ============================================

function getRecordsNeedingReview() {
    return analysisResults.filter(row => {
        const validations = validateChangeLogic(row);
        return validations.length > 0;
    }).map(row => ({
        ...row,
        validations: validateChangeLogic(row),
        userNotes: localStorage.getItem(`review_${row.id_num}_${row.current_regular}`) || '',
        approved: localStorage.getItem(`approved_${row.id_num}_${row.current_regular}`) === 'true'
    }));
}

// ============================================
// ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×”×¤×× ×œ
// ============================================

function toggleSidePanel() {
    const panel = document.getElementById('sidePanel');
    panel.classList.toggle('open');
    
    if (panel.classList.contains('open')) {
        displayReviewList();
    }
}

// ============================================
// ×”×¦×’×ª ×¨×©×™××ª ×‘×“×™×§×” ×™×“× ×™×ª
// ============================================

function displayReviewList() {
    const reviewList = document.getElementById('reviewList');
    const records = getRecordsNeedingReview();
    
    if (records.length === 0) {
        reviewList.innerHTML = `
            <div style="text-align:center; padding:50px; color:#999;">
                <div style="font-size:3em;">âœ…</div>
                <h3>××™×Ÿ ×¨×©×•××•×ª ×©×“×•×¨×©×•×ª ×‘×“×™×§×”!</h3>
                <p>×›×œ ×”×©×™× ×•×™×™× × ×¨××™× ×ª×§×™× ×™×</p>
            </div>
        `;
        return;
    }
    
    reviewList.innerHTML = records.map((row, index) => {
        const severity = row.validations[0].severity;
        const approvedClass = row.approved ? 'review-approved' : '';
        
        return `
            <div class="review-item ${severity} ${approvedClass}">
                <h3>×¢×•×‘×“ ${row.id_num} | ××©×¨×“ ${row.office_num}</h3>
                <div style="margin: 10px 0;">
                    <strong>×©×™× ×•×™:</strong> 
                    <span style="color: ${row.change >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                        ${formatChange(row.change)}
                    </span>
                </div>
                <div style="margin: 10px 0;">
                    <strong>×”×¡×‘×¨ ××¢×¨×›×ª:</strong> ${row.explanation_detail}
                </div>
                <div style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    ${row.validations.map(v => `
                        <div style="color: ${v.severity === 'error' ? '#e74c3c' : '#f39c12'}; font-weight: bold; margin: 5px 0;">
                            ${v.severity === 'error' ? 'ğŸ”´' : 'âš ï¸'} ${v.reason}
                        </div>
                    `).join('')}
                </div>
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                        ×”×¢×¨×•×ª/×”×¡×‘×¨ ×œ××©×ª××©:
                    </label>
                    <textarea 
                        class="review-notes" 
                        id="notes_${index}"
                        placeholder="×”×–×Ÿ ×”×¡×‘×¨ ×œ××” ×”×©×™× ×•×™ ×ª×§×™×Ÿ ××• ××” ×¦×¨×™×š ×œ×‘×“×•×§..."
                        ${row.approved ? 'disabled' : ''}
                    >${row.userNotes}</textarea>
                </div>
                ${!row.approved ? `
                    <button class="review-approve" onclick="approveReview(${index}, '${row.id_num}', ${row.current_regular})">
                        âœ“ ××©×¨ ×•×©××•×¨
                    </button>
                ` : `
                    <div style="color: #27ae60; font-weight: bold; margin-top: 10px;">
                        âœ… ××•×©×¨ ×•× ×‘×“×§
                    </div>
                `}
            </div>
        `;
    }).join('');
}

// ============================================
// ××™×©×•×¨ ×•×©××™×¨×ª ×”×¢×¨×”
// ============================================

function approveReview(index, empId, currentAmount) {
    const notes = document.getElementById(`notes_${index}`).value;
    const key = `${empId}_${currentAmount}`;
    
    localStorage.setItem(`review_${key}`, notes);
    localStorage.setItem(`approved_${key}`, 'true');
    
    displayReviewList();
    updateReviewCount();
    
    showMessage('loadMessage', 'âœ… ×”×¨×©×•××” ××•×©×¨×” ×•× ×©××¨×”', 'success');
}

// ============================================
// ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”×¨×©×•××•×ª ×‘×›×¤×ª×•×¨
// ============================================

function updateReviewCount() {
    const records = getRecordsNeedingReview();
    const unapproved = records.filter(r => !r.approved).length;
    
    const floatBtn = document.getElementById('floatBtn');
    const badge = document.getElementById('reviewCount');
    
    if (unapproved > 0) {
        floatBtn.style.display = 'block';
        badge.textContent = unapproved;
    } else {
        floatBtn.style.display = 'none';
    }
}
    </script>
    <!-- ×›×¤×ª×•×¨ ×¦×£ -->
<button class="float-btn" id="floatBtn" onclick="toggleSidePanel()">
    <div>âš ï¸</div>
    <div class="float-btn-badge" id="reviewCount">0</div>
</button>

<!-- ×¤×× ×œ ×¦×“ -->
<div class="side-panel" id="sidePanel">
    <div class="side-panel-header">
        <h2>ğŸ” ×“×•×¨×© ×‘×“×™×§×” ×™×“× ×™×ª</h2>
        <button class="side-panel-close" onclick="toggleSidePanel()">Ã—</button>
    </div>
    <div class="side-panel-content" id="reviewList">
        <!-- ×ª×•×›×Ÿ ×™×™×•×•×¦×¨ ×“×™× ××™×ª -->
    </div>
</div>
</body>
</html>
